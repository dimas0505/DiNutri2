
===== ./api/index.ts =====
import express from "express";
import { registerRoutes } from "../server/routes.js";

const app = express();

app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// Registrar rotas
await registerRoutes(app);

export default app;
===== ./client/public/sw.js =====
const CACHE_NAME = 'dinutri-v1'; // Production cache version
const STATIC_CACHE = `${CACHE_NAME}-static`;
const DYNAMIC_CACHE = `${CACHE_NAME}-dynamic`;

// Assets to cache on install
const STATIC_ASSETS = [
  '/',
  '/manifest.json',
  // Icons
  '/icon-192x192.png',
  '/icon-512x512.png',
  '/logo_dinutri.png'
];

// Install event - cache static assets
self.addEventListener('install', (event) => {
  console.log('Service Worker installing with cache:', CACHE_NAME);
  event.waitUntil(
    caches.open(STATIC_CACHE)
      .then((cache) => {
        console.log('Caching static assets');
        return cache.addAll(STATIC_ASSETS); // Cache '/' on install for offline fallback
      })
      .catch((error) => {
        console.log('Error caching static assets:', error);
      })
  );
  // Don't skip waiting immediately - wait for user action
});

// Activate event - clean up old caches
self.addEventListener('activate', (event) => {
  console.log('Service Worker activating with cache:', CACHE_NAME);
  event.waitUntil(
    caches.keys()
      .then((cacheNames) => {
        return Promise.all(
          cacheNames
            .filter((cacheName) => {
              // Delete all caches that start with 'dinutri-' but are not the current ones
              return cacheName.startsWith('dinutri-') &&
                     cacheName !== STATIC_CACHE &&
                     cacheName !== DYNAMIC_CACHE;
            })
            .map((cacheName) => {
              console.log('Deleting old cache:', cacheName);
              return caches.delete(cacheName);
            })
        );
      })
      .then(() => {
        console.log('Cache cleanup completed');
        // Take control of all existing clients immediately
        return self.clients.claim();
      })
  );
});

// Fetch event - serve from cache, fallback to network
self.addEventListener('fetch', (event) => {
  const { request } = event;

  // Skip non-GET requests and Chrome extension requests
  if (request.method !== 'GET' || request.url.startsWith('chrome-extension://')) {
    return;
  }

  // Handle API requests with network-first strategy
  if (request.url.includes('/api/')) {
    event.respondWith(
      fetch(request)
        .then((response) => {
          // Clone response for caching
          const responseClone = response.clone();
          caches.open(DYNAMIC_CACHE)
            .then((cache) => {
              cache.put(request, responseClone);
            });
          return response;
        })
        .catch(() => {
          // Fallback to cache if network fails
          return caches.match(request);
        })
    );
    return;
  }
  
  // Network-first for navigation requests (HTML pages)
  if (request.mode === 'navigate') {
    event.respondWith(
      fetch(request)
        .then((networkResponse) => {
          // Cache the new page for offline access
          const responseClone = networkResponse.clone();
          caches.open(STATIC_CACHE).then((cache) => {
            cache.put(request.url, responseClone);
          });
          return networkResponse;
        })
        .catch(() => {
          // If network fails, serve the cached HTML
          return caches.match(request.url) || caches.match('/');
        })
    );
    return;
  }

  // Handle other static assets with cache-first strategy
  event.respondWith(
    caches.match(request)
      .then((response) => {
        // Return from cache if found
        if (response) {
          return response;
        }

        // If not in cache, fetch from network and cache it
        return fetch(request)
          .then((fetchResponse) => {
            // Cache successful responses
            if (fetchResponse.status === 200) {
              const responseClone = fetchResponse.clone();
              caches.open(DYNAMIC_CACHE)
                .then((cache) => {
                  cache.put(request, responseClone);
                });
            }
            return fetchResponse;
          });
      })
  );
});

// Background sync for offline functionality
self.addEventListener('sync', (event) => {
  if (event.tag === 'background-sync') {
    console.log('Background sync triggered');
    event.waitUntil(
      // Implement offline sync logic here
      Promise.resolve()
    );
  }
});

// Push notification handler
self.addEventListener('push', (event) => {
  console.log('Push message received');

  if (event.data) {
    const data = event.data.json();
    const options = {
      body: data.body,
      icon: '/icon-192x192.png',
      badge: '/icon-72x72.png',
      vibrate: [100, 50, 100],
      data: {
        dateOfArrival: Date.now(),
        primaryKey: data.primaryKey || 1
      },
      actions: [
        {
          action: 'explore',
          title: 'Ver detalhes',
          icon: '/icon-192x192.png'
        },
        {
          action: 'close',
          title: 'Fechar',
          icon: '/icon-192x192.png'
        }
      ]
    };

    event.waitUntil(
      self.registration.showNotification(data.title || 'DiNutri', options)
    );
  }
});

// Notification click handler
self.addEventListener('notificationclick', (event) => {
  console.log('Notification click received');

  event.notification.close();

  if (event.action === 'explore') {
    event.waitUntil(
      clients.openWindow('/')
    );
  }
});

// Message handler for update commands
self.addEventListener('message', (event) => {
  console.log('Message received in SW:', event.data);

  if (event.data && event.data.action === 'SKIP_WAITING') {
    console.log('SKIP_WAITING message received, updating service worker...');
    self.skipWaiting().then(() => {
      console.log('Service worker skipped waiting successfully');
      // Notify all clients that the new SW is ready
      self.clients.matchAll().then((clients) => {
        clients.forEach((client) => {
          client.postMessage({ action: 'SW_UPDATED' });
        });
      });
    });
  }
});
===== ./client/src/App.tsx =====
import { Switch, Route, Redirect } from "wouter";
import { queryClient } from "./lib/queryClient";
import { QueryClientProvider } from "@tanstack/react-query";
import { Toaster } from "@/components/ui/toaster";
import { TooltipProvider } from "@/components/ui/tooltip";
import { useAuth } from "@/hooks/useAuth";
import InstallPWA from "@/components/InstallPWA";
import NotFound from "@/pages/not-found";
import Landing from "@/pages/landing";
import Home from "@/pages/home";
import PatientsPage from "@/pages/nutritionist/patients";
import NewPatientPage from "@/pages/nutritionist/new-patient";
import PatientDetailsPage from "@/pages/nutritionist/patient-details";
import EditPatientPage from "@/pages/nutritionist/edit-patient";
import PrescriptionEditorPage from "@/pages/nutritionist/prescription-editor";
import PatientPrescriptionView from "@/pages/patient/prescription-view";
import PrescriptionPrintPage from "@/pages/patient/prescription-print";
import PatientRegisterPage from "@/pages/patient/patient-register";
import AnamnesePage from "@/pages/public/anamnese";
import FollowUpAnamnesePage from "@/pages/public/follow-up-anamnese";
import AdminDashboard from "@/pages/admin/dashboard";
import CreateUserPage from "@/pages/admin/create-user";
import AdminProfilePage from "@/pages/admin/profile";
import EditUserPage from "@/pages/admin/edit-user";

function Router() {
  const { isAuthenticated, isLoading, isAdmin, isNutritionist, isPatient } = useAuth();

  if (isLoading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-4"></div>
          <p className="text-muted-foreground">Carregando...</p>
        </div>
      </div>
    );
  }

  return (
    <Switch>
      {/* Rotas Públicas */}
      <Route path="/" component={isAuthenticated ? Home : Landing} />
      <Route path="/anamnese" component={AnamnesePage} />
      <Route path="/anamnese/retorno" component={FollowUpAnamnesePage} />

      {/* Rota de Registro do Paciente (após login com convite) */}
      {isAuthenticated && isPatient && (
        <Route path="/patient/register" component={PatientRegisterPage} />
      )}

      {/* Rotas de Administrador */}
      {isAuthenticated && isAdmin && (
        <>
          <Route path="/admin" component={AdminDashboard} />
          <Route path="/admin/create-user" component={CreateUserPage} />
          <Route path="/admin/profile" component={AdminProfilePage} />
          <Route path="/admin/users/:id" component={EditUserPage} />
        </>
      )}

      {/* Rotas de Nutricionista */}
      {isAuthenticated && isNutritionist && (
        <>
          <Route path="/patients" component={PatientsPage} />
          <Route path="/patients/new" component={NewPatientPage} />
          <Route path="/patients/:id" component={PatientDetailsPage} />
          <Route path="/patients/:id/edit" component={EditPatientPage} />
          <Route path="/prescriptions/:id/edit" component={PrescriptionEditorPage} />
        </>
      )}

      {/* Rotas de Paciente (já registrado) */}
      {isAuthenticated && isPatient && (
        <>
          <Route path="/patient/prescription" component={PatientPrescriptionView} />
          <Route path="/prescriptions/:id/print" component={PrescriptionPrintPage} />
        </>
      )}

      {/* Redirecionamento se logado mas tentando acessar rota inválida */}
      {isAuthenticated && (
        <Redirect to="/" />
      )}
      
      {/* Rota 404 */}
      <Route component={NotFound} />
    </Switch>
  );
}

function App() {
  return (
    <QueryClientProvider client={queryClient}>
      <TooltipProvider>
        <Toaster />
        <Router />
        <InstallPWA />
      </TooltipProvider>
    </QueryClientProvider>
  );
}

export default App;
===== ./client/src/components/diary/food-photo-modal.tsx =====
import { useState, useRef } from "react";
import { useMutation, useQueryClient } from "@tanstack/react-query";
import { upload } from '@vercel/blob/client';
import { Dialog, DialogContent, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { useToast } from "@/hooks/use-toast";
import { apiRequest } from "@/lib/queryClient";
import type { MealData } from "@shared/schema";
import { Upload, Loader2 } from "lucide-react";

interface FoodPhotoModalProps {
  isOpen: boolean;
  onClose: () => void;
  meal: MealData;
  prescriptionId: string;
}

export default function FoodPhotoModal({ isOpen, onClose, meal, prescriptionId }: FoodPhotoModalProps) {
  const [file, setFile] = useState<File | null>(null);
  const [notes, setNotes] = useState("");
  const [previewUrl, setPreviewUrl] = useState<string | null>(null);
  const fileInputRef = useRef<HTMLInputElement>(null);
  const { toast } = useToast();
  const queryClient = useQueryClient();

  const handleClose = () => {
    setFile(null);
    if (previewUrl) {
      URL.revokeObjectURL(previewUrl);
    }
    setPreviewUrl(null);
    setNotes("");
    onClose();
  };

  const uploadMutation = useMutation({
    mutationFn: async () => {
      if (!file) throw new Error("Nenhum arquivo selecionado.");

      // ETAPA 1: O SDK do Vercel Blob faz o upload, chamando a rota do nosso backend
      // que lida com a autorização de forma segura e à prova de CORS.
      const newBlob = await upload(file.name, file, {
        access: 'public',
        handleUploadUrl: '/api/food-diary/upload',
      });

      // ETAPA 2: Salvar a URL final no nosso banco de dados.
      const entryPayload = {
        prescriptionId,
        mealId: meal.id,
        imageUrl: newBlob.url,
        notes,
        date: new Date().toISOString().split('T')[0],
      };
      await apiRequest("POST", "/api/food-diary/entries", entryPayload);
    },
    onSuccess: () => {
      toast({ title: "Sucesso!", description: "Foto da refeição enviada." });
      queryClient.invalidateQueries({ queryKey: ['/api/food-diary/entries', prescriptionId] });
      handleClose();
    },
    onError: (error: any) => {
      console.error("Upload error:", error);
      toast({ title: "Erro", description: error.message || "Não foi possível enviar a foto.", variant: "destructive" });
    },
  });

  const handleFileChange = (event: React.ChangeEvent<HTMLInputElement>) => {
    const selectedFile = event.target.files?.[0];
    if (selectedFile) {
      if (selectedFile.size > 4.5 * 1024 * 1024) { // Limite de 4.5MB do plano Hobby da Vercel
        toast({
          title: "Arquivo muito grande",
          description: "O tamanho máximo do arquivo é de 4.5MB.",
          variant: "destructive",
        });
        return;
      }
      setFile(selectedFile);
      if (previewUrl) {
        URL.revokeObjectURL(previewUrl);
      }
      setPreviewUrl(URL.createObjectURL(selectedFile));
    }
  };

  const handleTriggerUpload = () => {
    fileInputRef.current?.click();
  };

  const handleSubmit = (event: React.FormEvent) => {
    event.preventDefault();
    uploadMutation.mutate();
  };

  return (
    <Dialog open={isOpen} onOpenChange={handleClose}>
      <DialogContent>
        <DialogHeader><DialogTitle>Foto do Diário para: {meal.name}</DialogTitle></DialogHeader>
        <form onSubmit={handleSubmit} className="space-y-4">
          <Input type="file" accept="image/*" onChange={handleFileChange} ref={fileInputRef} className="hidden" />
          
          {previewUrl ? (
            <div className="text-center space-y-2">
              <img src={previewUrl} alt="Preview" className="max-h-60 w-auto mx-auto rounded-md border" />
              <Button type="button" variant="link" onClick={handleTriggerUpload}>Trocar foto</Button>
            </div>
          ) : (
            <Button type="button" variant="outline" className="w-full h-32 border-dashed flex-col" onClick={handleTriggerUpload}>
              <Upload className="h-8 w-8 text-muted-foreground mb-2" />
              <span>Clique para selecionar uma foto</span>
            </Button>
          )}

          <Textarea placeholder="Adicionar observações (opcional)..." value={notes} onChange={(e) => setNotes(e.target.value)} />
          
          <Button type="submit" className="w-full" disabled={!file || uploadMutation.isPending}>
            {uploadMutation.isPending ? (
              <>
                <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                Enviando...
              </>
            ) : (
              "Enviar Foto"
            )}
          </Button>
        </form>
      </DialogContent>
    </Dialog>
  );
}
===== ./client/src/components/InstallPWA.tsx =====
import { useState } from 'react';
import { usePWA } from '@/hooks/use-pwa';
import { Button } from '@/components/ui/button';
import { Download, X, Smartphone } from 'lucide-react';

export default function InstallPWA() {
  const { canInstall, install, isInstalled } = usePWA();
  const [isVisible, setIsVisible] = useState(true);

  // Don't show if already installed or can't install
  if (isInstalled || !canInstall || !isVisible) {
    return null;
  }

  const handleInstall = async () => {
    const success = await install();
    if (success) {
      setIsVisible(false);
    }
  };

  const handleDismiss = () => {
    setIsVisible(false);
  };

  return (
    <div className="fixed bottom-4 left-4 right-4 md:left-auto md:right-4 md:max-w-sm z-50">
      <div className="bg-card border border-border rounded-lg shadow-lg p-4 backdrop-blur-sm">
        <div className="flex items-start gap-3">
          <div className="flex-shrink-0">
            <div className="w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center">
              <Smartphone className="w-5 h-5 text-primary" />
            </div>
          </div>
          
          <div className="flex-1 min-w-0">
            <h3 className="font-medium text-sm text-foreground mb-1">
              Instalar DiNutri
            </h3>
            <p className="text-xs text-muted-foreground mb-3">
              Adicione o DiNutri à sua tela inicial para acesso rápido e experiência nativa.
            </p>
            
            <div className="flex gap-2">
              <Button
                onClick={handleInstall}
                size="sm"
                className="flex-1 h-8 text-xs"
              >
                <Download className="w-3 h-3 mr-1" />
                Instalar
              </Button>
              
              <Button
                onClick={handleDismiss}
                variant="ghost"
                size="sm"
                className="h-8 w-8 p-0"
              >
                <X className="w-3 h-3" />
              </Button>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}
===== ./client/src/components/layout/header.tsx =====
import { LogOut, ArrowLeft } from "lucide-react";
import { Button } from "@/components/ui/button";
import { useAuth } from "@/hooks/useAuth";
import { useIsMobile } from "@/hooks/use-mobile";
import { MobileHeader } from "@/components/mobile";
import { DiNutriLogo } from "@/components/ui/dinutri-logo";
import { cn } from "@/lib/utils";

interface HeaderProps {
  title?: string;
  subtitle?: string;
  leftElement?: React.ReactNode;
  rightElement?: React.ReactNode;
  children?: React.ReactNode;
  showBack?: boolean;
  onBack?: () => void;
  drawerContent?: React.ReactNode;
  className?: string;
}

export default function Header({ 
  title, 
  subtitle, 
  leftElement, 
  rightElement, 
  children, 
  showBack,
  onBack,
  drawerContent,
  className
}: HeaderProps) {
  const { user } = useAuth();
  const isMobile = useIsMobile();

  const handleLogout = () => {
    // Redireciona diretamente para a rota de logout que fará o redirecionamento
    window.location.href = "/api/logout";
  };

  const handleBack = () => {
    if (onBack) {
      onBack();
    } else {
      window.history.back();
    }
  };

  // On mobile, use the MobileHeader component
  if (isMobile) {
    return (
      <MobileHeader
        title={title}
        subtitle={subtitle}
        leftElement={leftElement}
        rightElement={rightElement}
        showBack={showBack}
        onBack={onBack}
        drawerContent={drawerContent}
        className={className}
      >
        {children}
      </MobileHeader>
    );
  }

  // Desktop header
  return (
    <header className={cn("bg-card border-b border-border px-4 py-3", className)}>
      <div className="max-w-7xl mx-auto flex items-center justify-between">
        <div className="flex items-center space-x-4">
          {showBack && (
            <Button
              variant="ghost"
              size="sm"
              onClick={handleBack}
              title="Voltar"
              className="h-8 w-8 p-0"
            >
              <ArrowLeft className="h-4 w-4" />
              <span className="sr-only">Voltar</span>
            </Button>
          )}
          {leftElement}
          {children ? (
            children
          ) : (
            <div className="flex items-center space-x-4">
              <DiNutriLogo size="sm" variant="full" />
              {title && (
                <>
                  <span className="text-muted-foreground">|</span>
                  <div>
                    <span className="text-foreground font-medium" data-testid="text-page-title">{title}</span>
                    {subtitle && (
                      <p className="text-sm text-muted-foreground" data-testid="text-page-subtitle">{subtitle}</p>
                    )}
                  </div>
                </>
              )}
            </div>
          )}
        </div>
        <div className="flex items-center space-x-4">
          {rightElement}
          <span className="text-sm text-muted-foreground" data-testid="text-user-name">
            {(user as any)?.firstName || (user as any)?.email}
          </span>
          <Button
            variant="ghost"
            size="sm"
            onClick={handleLogout}
            title="Sair"
            data-testid="button-logout"
          >
            <LogOut className="h-4 w-4" />
          </Button>
        </div>
      </div>
    </header>
  );
}
===== ./client/src/components/layout/mobile-layout.tsx =====
import * as React from "react";
import { useIsMobile } from "@/hooks/use-mobile";
import { MobileHeader } from "@/components/mobile";
import { BottomNavigation } from "@/components/mobile";
import { useAuth } from "@/hooks/useAuth";
import { Home, Users, FileText, User, Menu, LogOut, Shield, UserPlus, Settings } from "lucide-react";
import { useLocation } from "wouter";
import { cn } from "@/lib/utils";

interface MobileLayoutProps {
  children: React.ReactNode;
  title?: string;
  subtitle?: string;
  showBack?: boolean;
  onBack?: () => void;
  className?: string;
  showBottomNav?: boolean;
  drawerContent?: React.ReactNode;
}

export function MobileLayout({
  children,
  title,
  subtitle,
  showBack = false,
  onBack,
  className,
  showBottomNav = true,
  drawerContent,
}: MobileLayoutProps) {
  const isMobile = useIsMobile();
  const { isNutritionist, isPatient } = useAuth();
  const [location, setLocation] = useLocation();

  // Navigation items based on user role
  const getNavigationItems = () => {
    if (isNutritionist) {
      return [
        {
          id: 'patients',
          label: 'Pacientes',
          icon: Users,
          href: '/patients',
          active: location.startsWith('/patients'),
        },
        {
          id: 'profile',
          label: 'Perfil',
          icon: User,
          href: '/profile',
          active: location.startsWith('/profile'),
        },
      ];
    } else if (isPatient) {
      return [
        {
          id: 'home',
          label: 'Início',
          icon: Home,
          href: '/',
          active: location === '/',
        },
        {
          id: 'prescription',
          label: 'Prescrição',
          icon: FileText,
          href: '/patient/prescription',
          active: location.startsWith('/patient/prescription'),
        },
        {
          id: 'profile',
          label: 'Perfil',
          icon: User,
          href: '/patient/profile',
          active: location.startsWith('/patient/profile'),
        },
      ];
    }
    return [];
  };

  const handleBottomNavClick = (item: any) => {
    setLocation(item.href);
  };

  if (!isMobile) {
    // Return children without mobile layout on desktop
    return <div className={className}>{children}</div>;
  }

  return (
    <div className="min-h-screen bg-background">
      <MobileHeader
        title={title}
        subtitle={subtitle}
        showBack={showBack}
        onBack={onBack}
        drawerContent={drawerContent}
      />
      
      <main className={cn(
        "mobile-container",
        showBottomNav && "pb-20", // Add padding for bottom navigation
        className
      )}>
        {children}
      </main>

      {showBottomNav && (
        <BottomNavigation
          items={getNavigationItems()}
          onItemClick={handleBottomNavClick}
        />
      )}
    </div>
  );
}

// Default drawer content for authenticated users
interface DefaultMobileDrawerProps {
  onProfileClick?: () => void;
}

export function DefaultMobileDrawer({ onProfileClick }: DefaultMobileDrawerProps = {}) {
  const { isNutritionist, isPatient, isAdmin } = useAuth();
  const [, setLocation] = useLocation();

  const handleLogout = () => {
    // Redireciona diretamente para a rota de logout que fará o redirecionamento
    window.location.href = "/api/logout";
  };

  const navigationItems = [
    ...(isAdmin ? [
      { label: 'Painel Principal', href: '/admin', icon: Shield, action: 'navigate' },
      { label: 'Criar Usuário', href: '/admin/create-user', icon: UserPlus, action: 'navigate' },
      { label: 'Meu Perfil', href: '/admin/profile', icon: Settings, action: 'navigate' },
    ] : []),
    ...(isNutritionist ? [
      { label: 'Pacientes', href: '/patients', icon: Users, action: 'navigate' },
      { label: 'Nova Prescrição', href: '/patients/new', icon: FileText, action: 'navigate' },
    ] : []),
    ...(isPatient ? [
      { label: 'Minha Prescrição', href: '/patient/prescription', icon: FileText, action: 'navigate' },
      { label: 'Perfil', href: '', icon: User, action: 'profile' },
    ] : []),
  ];

  const handleItemClick = (item: any) => {
    if (item.action === 'navigate') {
      setLocation(item.href);
    } else if (item.action === 'profile' && onProfileClick) {
      onProfileClick();
    }
  };

  return (
    <div className="space-y-2">
      {navigationItems.map((item, index) => {
        const Icon = item.icon;
        return (
          <button
            key={`${item.label}-${index}`}
            onClick={() => handleItemClick(item)}
            className="w-full flex items-center space-x-3 px-4 py-3 text-left hover:bg-accent rounded-lg transition-colors"
          >
            <Icon className="h-5 w-5" />
            <span>{item.label}</span>
          </button>
        );
      })}
      
      {/* Separator and logout option */}
      {navigationItems.length > 0 && (
        <div className="border-t pt-2 mt-4">
          <button
            onClick={handleLogout}
            className="w-full flex items-center space-x-3 px-4 py-3 text-left hover:bg-accent rounded-lg transition-colors text-red-600 hover:text-red-700"
          >
            <LogOut className="h-5 w-5" />
            <span>Sair</span>
          </button>
        </div>
      )}
    </div>
  );
}
===== ./client/src/components/meal/meal-menu-screen.tsx =====
import { useState } from "react";
import { X, Camera, Heart, Image } from "lucide-react";
import { Button } from "@/components/ui/button";
import { useToast } from "@/hooks/use-toast";
import MoodRegistrationModal from "@/components/mood/mood-registration-modal";
import MealSubstitutionModal from "@/components/meal/meal-substitution-modal";
import FoodPhotoModal from "@/components/diary/food-photo-modal";
import type { MealData, MealItemData } from "@shared/schema";

interface MealMenuScreenProps {
  meal: MealData;
  prescriptionId: string;
  patientId: string;
  onClose: () => void;
}

export default function MealMenuScreen({
  meal,
  prescriptionId,
  patientId,
  onClose,
}: MealMenuScreenProps) {
  const [showMoodModal, setShowMoodModal] = useState(false);
  const [showSubstitutionModal, setShowSubstitutionModal] = useState(false);
  const [showPhotoModal, setShowPhotoModal] = useState(false);
  const [selectedItemForSubstitution, setSelectedItemForSubstitution] = useState<MealItemData | null>(null);
  const { toast } = useToast();

  const handlePhotoAction = () => {
    setShowPhotoModal(true);
  };

  const handleMoodAction = () => {
    setShowMoodModal(true);
  };

  const handleSubstitutionClick = (item: MealItemData) => {
    setSelectedItemForSubstitution(item);
    setShowSubstitutionModal(true);
  };

  const handleSubstitutionModalClose = () => {
    setShowSubstitutionModal(false);
    setSelectedItemForSubstitution(null);
  };

  return (
    <div className="fixed inset-0 bg-white z-50 flex flex-col">
      {/* Header */}
      <div className="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4 shadow-lg">
        <div className="flex items-center justify-between">
          <h1 className="text-xl font-semibold">{meal.name}</h1>
          <Button
            variant="ghost"
            size="sm"
            onClick={onClose}
            className="text-white hover:bg-white/20 p-2"
          >
            <X className="h-6 w-6" />
          </Button>
        </div>
      </div>

      {/* Content */}
      <div className="flex-1 overflow-y-auto p-4 space-y-6">
        {/* Menu da refeição */}
        <div>
          <h2 className="text-lg font-medium text-gray-800 mb-4">Menu da refeição</h2>
          <div className="grid grid-cols-2 gap-4">
            {/* Foto para o diário alimentar */}
            <Button
              onClick={handlePhotoAction}
              className="h-20 flex flex-col items-center justify-center space-y-2 bg-gradient-to-br from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white rounded-lg shadow-md transition-all duration-200 hover:shadow-lg"
            >
              <Camera className="h-6 w-6" />
              <span className="text-xs font-medium text-center">
                Foto para o diário alimentar
              </span>
            </Button>

            {/* Registrar humor na refeição */}
            <Button
              onClick={handleMoodAction}
              className="h-20 flex flex-col items-center justify-center space-y-2 bg-gradient-to-br from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white rounded-lg shadow-md transition-all duration-200 hover:shadow-lg"
            >
              <Heart className="h-6 w-6" />
              <span className="text-xs font-medium text-center">
                Registrar humor na refeição
              </span>
            </Button>
          </div>
        </div>

        {/* Lista de Alimentos */}
        <div>
          <h2 className="text-lg font-medium text-gray-800 mb-4">Alimentos desta refeição</h2>
          <div className="space-y-3">
            {meal.items.map((item) => (
              <div
                key={item.id}
                className="bg-white border border-gray-200 rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow duration-200"
              >
                <div className="flex justify-between items-start">
                  <div className="flex-1">
                    <h3 className="font-medium text-gray-900 mb-1">
                      {item.description}
                    </h3>
                    <p className="text-sm text-gray-600 mb-3">
                      {item.amount}
                    </p>
                    
                    {/* Botão de substituição */}
                    <Button
                      onClick={() => handleSubstitutionClick(item)}
                      variant="outline"
                      size="sm"
                      className="text-blue-600 border-blue-200 hover:bg-blue-50 hover:border-blue-300 transition-colors duration-200"
                    >
                      Ver opções de substituição
                    </Button>
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>

        {/* Observações da refeição */}
        {meal.notes && (
          <div className="bg-gradient-to-r from-blue-50 to-blue-100 p-4 rounded-lg border border-blue-200">
            <h3 className="font-medium text-gray-800 mb-2 flex items-center">
              <Image className="h-4 w-4 mr-2 text-blue-600" />
              Observações
            </h3>
            <p className="text-sm text-gray-700">{meal.notes}</p>
          </div>
        )}
      </div>

      {/* Modals */}
      <MoodRegistrationModal
        isOpen={showMoodModal}
        onClose={() => setShowMoodModal(false)}
        meal={meal}
        prescriptionId={prescriptionId}
        patientId={patientId}
      />

      <MealSubstitutionModal
        isOpen={showSubstitutionModal}
        onClose={handleSubstitutionModalClose}
        foodName={selectedItemForSubstitution?.description || ""}
        substitutes={selectedItemForSubstitution?.substitutes || []}
      />

      <FoodPhotoModal
        isOpen={showPhotoModal}
        onClose={() => setShowPhotoModal(false)}
        meal={meal}
        prescriptionId={prescriptionId}
      />
    </div>
  );
}
===== ./client/src/components/meal/meal-substitution-modal.tsx =====
import { Dialog, DialogContent, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";

interface MealSubstitutionModalProps {
  isOpen: boolean;
  onClose: () => void;
  foodName: string;
  substitutes: string[];
}

export default function MealSubstitutionModal({
  isOpen,
  onClose,
  foodName,
  substitutes,
}: MealSubstitutionModalProps) {
  return (
    <Dialog open={isOpen} onOpenChange={onClose}>
      <DialogContent className="sm:max-w-md p-0 gap-0 mx-auto">
        {/* Header */}
        <DialogHeader className="p-4 pb-2">
          <DialogTitle className="text-lg font-semibold text-gray-800 text-left">
            Opções de Substituição
          </DialogTitle>
          <p className="text-sm text-gray-600 text-left">
            Para: {foodName}
          </p>
        </DialogHeader>

        {/* Content */}
        <div className="p-4 pt-2">
          {substitutes && substitutes.length > 0 ? (
            <div className="space-y-2">
              {substitutes.map((substitute, index) => (
                <div 
                  key={index} 
                  className="p-3 bg-gradient-to-r from-blue-50 to-blue-100 rounded-lg border border-blue-200"
                >
                  <p className="text-sm text-gray-700">• {substitute}</p>
                </div>
              ))}
            </div>
          ) : (
            <div className="text-center py-8 text-gray-500">
              <p className="text-sm">Nenhuma opção de substituição disponível</p>
            </div>
          )}
        </div>

        {/* Footer */}
        <div className="p-4 pt-0">
          <Button 
            onClick={onClose}
            className="w-full bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white"
          >
            Fechar
          </Button>
        </div>
      </DialogContent>
    </Dialog>
  );
}
===== ./client/src/components/mobile/bottom-navigation.tsx =====
import * as React from "react";
import { cn } from "@/lib/utils";
import { LucideIcon } from "lucide-react";

interface BottomNavItem {
  id: string;
  label: string;
  icon: LucideIcon;
  href?: string;
  onClick?: () => void;
  badge?: string | number;
  active?: boolean;
}

interface BottomNavigationProps {
  items: BottomNavItem[];
  className?: string;
  onItemClick?: (item: BottomNavItem) => void;
}

export function BottomNavigation({ items, className, onItemClick }: BottomNavigationProps) {
  const handleItemClick = (item: BottomNavItem) => {
    if (onItemClick) {
      onItemClick(item);
    }
    if (item.onClick) {
      item.onClick();
    }
    if (item.href) {
      window.location.href = item.href;
    }
  };

  return (
    <nav 
      className={cn(
        "fixed bottom-0 left-0 right-0 z-50 md:hidden",
        "bg-background border-t border-border",
        "px-2 py-1",
        "safe-area-inset-bottom",
        className
      )}
    >
      <div className="flex items-center justify-around max-w-screen-sm mx-auto">
        {items.map((item) => {
          const Icon = item.icon;
          return (
            <button
              key={item.id}
              onClick={() => handleItemClick(item)}
              className={cn(
                "flex flex-col items-center justify-center",
                "min-h-[60px] px-2 py-2",
                "text-xs font-medium",
                "transition-colors duration-200",
                "relative",
                "focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",
                "active:scale-95 transition-transform",
                item.active 
                  ? "text-primary" 
                  : "text-muted-foreground hover:text-foreground"
              )}
            >
              <div className="relative mb-1">
                <Icon className="h-5 w-5" />
                {item.badge && (
                  <span className={cn(
                    "absolute -top-2 -right-2",
                    "flex items-center justify-center",
                    "min-w-[18px] h-[18px] px-1",
                    "bg-destructive text-destructive-foreground",
                    "text-xs font-bold rounded-full",
                    "border-2 border-background"
                  )}>
                    {item.badge}
                  </span>
                )}
              </div>
              <span className="truncate max-w-[60px]">{item.label}</span>
            </button>
          );
        })}
      </div>
    </nav>
  );
}
===== ./client/src/components/mobile/card.tsx =====
import * as React from "react";
import { cn } from "@/lib/utils";
import { useIsMobile } from "@/hooks/use-mobile";

interface MobileCardProps extends React.HTMLAttributes<HTMLDivElement> {
  children: React.ReactNode;
  padding?: "none" | "sm" | "md" | "lg";
  interactive?: boolean;
  touchOptimized?: boolean;
}

export function MobileCard({ 
  className, 
  children, 
  padding = "md",
  interactive = false,
  touchOptimized = true,
  ...props 
}: MobileCardProps) {
  const isMobile = useIsMobile();

  const paddingClasses = {
    none: "",
    sm: "p-2 sm:p-3",
    md: "p-4 sm:p-6",
    lg: "p-6 sm:p-8",
  };

  return (
    <div
      className={cn(
        "rounded-lg border bg-card text-card-foreground shadow-sm",
        paddingClasses[padding],
        interactive && [
          "cursor-pointer transition-all duration-200",
          "hover:shadow-md active:scale-[0.98]",
          isMobile && touchOptimized && "active:bg-accent/50",
        ],
        className
      )}
      {...props}
    >
      {children}
    </div>
  );
}

interface MobileCardHeaderProps extends React.HTMLAttributes<HTMLDivElement> {
  children: React.ReactNode;
}

export function MobileCardHeader({ className, children, ...props }: MobileCardHeaderProps) {
  return (
    <div
      className={cn("flex flex-col space-y-1.5 pb-4", className)}
      {...props}
    >
      {children}
    </div>
  );
}

interface MobileCardTitleProps extends React.HTMLAttributes<HTMLHeadingElement> {
  children: React.ReactNode;
  size?: "sm" | "md" | "lg";
}

export function MobileCardTitle({ className, children, size = "md", ...props }: MobileCardTitleProps) {
  const sizeClasses = {
    sm: "text-base sm:text-lg",
    md: "text-lg sm:text-xl",
    lg: "text-xl sm:text-2xl",
  };

  return (
    <h3
      className={cn(
        "font-semibold leading-none tracking-tight",
        sizeClasses[size],
        className
      )}
      {...props}
    >
      {children}
    </h3>
  );
}

interface MobileCardDescriptionProps extends React.HTMLAttributes<HTMLParagraphElement> {
  children: React.ReactNode;
}

export function MobileCardDescription({ className, children, ...props }: MobileCardDescriptionProps) {
  return (
    <p
      className={cn("text-sm text-muted-foreground", className)}
      {...props}
    >
      {children}
    </p>
  );
}

interface MobileCardContentProps extends React.HTMLAttributes<HTMLDivElement> {
  children: React.ReactNode;
}

export function MobileCardContent({ className, children, ...props }: MobileCardContentProps) {
  return (
    <div className={cn("space-y-4", className)} {...props}>
      {children}
    </div>
  );
}

interface MobileCardFooterProps extends React.HTMLAttributes<HTMLDivElement> {
  children: React.ReactNode;
}

export function MobileCardFooter({ className, children, ...props }: MobileCardFooterProps) {
  return (
    <div
      className={cn("flex items-center justify-between pt-4", className)}
      {...props}
    >
      {children}
    </div>
  );
}
===== ./client/src/components/mobile/drawer.tsx =====
import * as React from "react";
import { Menu, X } from "lucide-react";
import { Button } from "@/components/ui/button";
import { Sheet, SheetContent, SheetTrigger, SheetTitle } from "@/components/ui/sheet";
import { cn } from "@/lib/utils";

interface MobileDrawerProps {
  children: React.ReactNode;
  title?: string;
  trigger?: React.ReactNode;
  className?: string;
  side?: "left" | "right" | "top" | "bottom";
}

export function MobileDrawer({ 
  children, 
  title = "Menu",
  trigger,
  className,
  side = "left"
}: MobileDrawerProps) {
  const [open, setOpen] = React.useState(false);

  const defaultTrigger = (
    <Button variant="ghost" size="sm" className="md:hidden">
      <Menu className="h-5 w-5" />
      <span className="sr-only">Abrir menu</span>
    </Button>
  );

  return (
    <Sheet open={open} onOpenChange={setOpen}>
      <SheetTrigger asChild>
        {trigger || defaultTrigger}
      </SheetTrigger>
      <SheetContent 
        side={side} 
        className={cn("w-[300px] sm:w-[400px]", className)}
      >
        <SheetTitle className="sr-only">{title}</SheetTitle>
        <div className="flex flex-col h-full">
          <div className="flex items-center pb-4 border-b">
            <h2 className="text-lg font-semibold">{title}</h2>
          </div>
          <div className="flex-1 py-4 overflow-y-auto">
            {children}
          </div>
        </div>
      </SheetContent>
    </Sheet>
  );
}
===== ./client/src/components/mobile/header.tsx =====
import * as React from "react";
import { LogOut, Menu, ArrowLeft } from "lucide-react";
import { Button } from "@/components/ui/button";
import { useAuth } from "@/hooks/useAuth";
import { useIsMobile } from "@/hooks/use-mobile";
import { DiNutriLogo } from "@/components/ui/dinutri-logo";
import { cn } from "@/lib/utils";
import { MobileDrawer } from "./drawer";

interface MobileHeaderProps {
  title?: string;
  subtitle?: string;
  showBack?: boolean;
  onBack?: () => void;
  leftElement?: React.ReactNode;
  rightElement?: React.ReactNode;
  children?: React.ReactNode;
  className?: string;
  drawerContent?: React.ReactNode;
}

export function MobileHeader({ 
  title, 
  subtitle, 
  showBack = false,
  onBack,
  leftElement, 
  rightElement, 
  children,
  className,
  drawerContent
}: MobileHeaderProps) {
  const { user } = useAuth();
  const isMobile = useIsMobile();

  const handleLogout = () => {
    // Redireciona diretamente para a rota de logout que fará o redirecionamento
    window.location.href = "/api/logout";
  };

  const handleBack = () => {
    if (onBack) {
      onBack();
    } else {
      window.history.back();
    }
  };

  if (!isMobile) {
    return null; // Use regular header on desktop
  }

  return (
    <header className={cn(
      "bg-card border-b border-border px-4 py-3",
      "safe-area-inset-top",
      className
    )}>
      <div className="flex items-center justify-between">
        <div className="flex items-center space-x-3">
          {showBack ? (
            <Button 
              variant="ghost" 
              size="sm" 
              onClick={handleBack}
              className="h-8 w-8 p-0"
            >
              <ArrowLeft className="h-4 w-4" />
              <span className="sr-only">Voltar</span>
            </Button>
          ) : drawerContent ? (
            <MobileDrawer title="Menu">
              {drawerContent}
            </MobileDrawer>
          ) : null}
          
          {leftElement}
          
          {children ? (
            children
          ) : (
            <div className="flex items-center space-x-3">
              <DiNutriLogo size="sm" variant="full" />
              {title && (
                <>
                  <span className="text-muted-foreground text-sm">|</span>
                  <div>
                    <span className="text-foreground font-medium text-sm truncate max-w-[120px]">
                      {title}
                    </span>
                    {subtitle && (
                      <p className="text-xs text-muted-foreground truncate max-w-[120px]">
                        {subtitle}
                      </p>
                    )}
                  </div>
                </>
              )}
            </div>
          )}
        </div>
        
        <div className="flex items-center space-x-2">
          {rightElement}
          
          <div className="flex items-center space-x-2">
            <span className="text-xs text-muted-foreground truncate max-w-[80px]">
              {(user as any)?.firstName || (user as any)?.email}
            </span>
            <Button
              variant="ghost"
              size="sm"
              onClick={handleLogout}
              title="Sair"
              className="h-8 w-8 p-0"
            >
              <LogOut className="h-3 w-3" />
              <span className="sr-only">Sair</span>
            </Button>
          </div>
        </div>
      </div>
    </header>
  );
}
===== ./client/src/components/mobile/index.ts =====
export { MobileDrawer } from './drawer';
export { BottomNavigation } from './bottom-navigation';
export { MobileHeader } from './header';
export { MobileCard, MobileCardHeader, MobileCardTitle, MobileCardDescription, MobileCardContent, MobileCardFooter } from './card';
===== ./client/src/components/mood/mood-registration-modal.tsx =====
import { useState, useEffect } from "react";
import { useMutation, useQuery, useQueryClient } from "@tanstack/react-query";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { useToast } from "@/hooks/use-toast";
import { apiRequest } from "@/lib/queryClient";
import type { MoodType, MealData } from "@shared/schema";

interface MoodRegistrationModalProps {
  isOpen: boolean;
  onClose: () => void;
  meal: MealData;
  prescriptionId: string;
  patientId: string;
}

interface MoodEntryData {
  id?: string;
  moodBefore?: MoodType;
  moodAfter?: MoodType;
  notes?: string;
}

const moodOptions = [
  { value: "very_sad" as MoodType, emoji: "😢" },
  { value: "sad" as MoodType, emoji: "😔" },
  { value: "neutral" as MoodType, emoji: "😐" },
  { value: "happy" as MoodType, emoji: "😊" },
  { value: "very_happy" as MoodType, emoji: "😍" },
];

function MoodRegistrationModal({
  isOpen,
  onClose,
  meal,
  prescriptionId,
  patientId,
}: MoodRegistrationModalProps) {
  const { toast } = useToast();
  const queryClient = useQueryClient();
  const [moodBefore, setMoodBefore] = useState<MoodType | undefined>();
  const [moodAfter, setMoodAfter] = useState<MoodType | undefined>();

  const today = new Date().toISOString().split('T')[0];

  // Buscar registro de humor existente para hoje
  const { data: existingMoodEntry, isLoading } = useQuery<MoodEntryData>({
    queryKey: ["/api/mood-entries", prescriptionId, meal.id, today],
    enabled: isOpen,
    retry: false,
  });

  // Atualizar estado quando dados existentes chegarem
  useEffect(() => {
    if (existingMoodEntry) {
      setMoodBefore(existingMoodEntry.moodBefore);
      setMoodAfter(existingMoodEntry.moodAfter);
    } else {
      setMoodBefore(undefined);
      setMoodAfter(undefined);
    }
  }, [existingMoodEntry]);

  const saveMoodMutation = useMutation({
    mutationFn: async (data: {
      moodBefore?: MoodType;
      moodAfter?: MoodType;
    }) => {
      const payload = {
        patientId,
        prescriptionId,
        mealId: meal.id,
        date: today,
        ...data,
      };

      if (existingMoodEntry?.id) {
        return await apiRequest("PUT", `/api/mood-entries/${existingMoodEntry.id}`, payload);
      } else {
        return await apiRequest("POST", "/api/mood-entries", payload);
      }
    },
    onSuccess: () => {
      toast({
        title: "Humor registrado!",
        description: "Seu humor foi salvo com sucesso.",
      });
      queryClient.invalidateQueries({ 
        queryKey: ["/api/mood-entries", prescriptionId, meal.id, today] 
      });
      onClose();
    },
    onError: (error: any) => {
      console.error("Error saving mood:", error);
      toast({
        title: "Erro",
        description: "Não foi possível salvar seu humor. Tente novamente.",
        variant: "destructive",
      });
    },
  });

  const handleSave = () => {
    if (!moodBefore && !moodAfter) {
      toast({
        title: "Selecione um humor",
        description: "Você precisa registrar pelo menos o humor antes ou depois da refeição.",
        variant: "destructive",
      });
      return;
    }

    saveMoodMutation.mutate({
      moodBefore,
      moodAfter,
    });
  };

  const handleClose = () => {
    onClose();
  };

  if (isLoading) {
    return (
      <Dialog open={isOpen} onOpenChange={handleClose}>
        <DialogContent className="sm:max-w-md">
          <div className="flex items-center justify-center py-8">
            <div className="animate-spin rounded-full h-6 w-6 border-b-2 border-primary"></div>
          </div>
        </DialogContent>
      </Dialog>
    );
  }

  return (
    <Dialog open={isOpen} onOpenChange={handleClose}>
      <DialogContent className="sm:max-w-sm p-0 gap-0 mx-auto">
        {/* Header */}
        <DialogHeader className="p-4 pb-0">
          <DialogTitle className="text-lg font-semibold">
            {meal.name}
          </DialogTitle>
          <p className="text-sm text-muted-foreground">Menu da refeição</p>
        </DialogHeader>

        {/* Content */}
        <div className="p-4 space-y-6">
          {/* Humor antes da refeição */}
          <div className="bg-white p-4 rounded-lg space-y-4">
            <h3 className="text-center text-sm font-medium">
              Seu humor ANTES da refeição?
            </h3>
            <div className="flex justify-center space-x-2">
              {moodOptions.map((option) => (
                <button
                  key={`before-${option.value}`}
                  onClick={() => setMoodBefore(option.value)}
                  className={`w-12 h-12 text-2xl rounded-full transition-all ${
                    moodBefore === option.value
                      ? 'ring-2 ring-blue-500 bg-blue-50'
                      : 'hover:bg-gray-50'
                  }`}
                >
                  {option.emoji}
                </button>
              ))}
            </div>
          </div>

          {/* Humor após a refeição */}
          <div className="bg-white p-4 rounded-lg space-y-4">
            <h3 className="text-center text-sm font-medium">
              Seu humor APÓS a refeição?
            </h3>
            <div className="flex justify-center space-x-2">
              {moodOptions.map((option) => (
                <button
                  key={`after-${option.value}`}
                  onClick={() => setMoodAfter(option.value)}
                  className={`w-12 h-12 text-2xl rounded-full transition-all ${
                    moodAfter === option.value
                      ? 'ring-2 ring-blue-500 bg-blue-50'
                      : 'hover:bg-gray-50'
                  }`}
                >
                  {option.emoji}
                </button>
              ))}
            </div>
          </div>

          {/* Botão Avançar */}
          <Button 
            onClick={handleSave}
            disabled={saveMoodMutation.isPending || (!moodBefore && !moodAfter)}
            className="w-full bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white"
          >
            {saveMoodMutation.isPending ? "Salvando..." : "Avançar >>"}
          </Button>
        </div>
      </DialogContent>
    </Dialog>
  );
}

export default MoodRegistrationModal;
===== ./client/src/components/mood/mood-selector.tsx =====
import { useState } from "react";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Textarea } from "@/components/ui/textarea";
import { cn } from "@/lib/utils";
import type { MoodType } from "@shared/schema";

interface MoodSelectorProps {
  title: string;
  selectedMood?: MoodType;
  onMoodChange: (mood: MoodType) => void;
  notes?: string;
  onNotesChange?: (notes: string) => void;
  showNotes?: boolean;
}

const moodOptions = [
  {
    value: "very_sad" as MoodType,
    emoji: "😢",
    label: "Muito triste",
    color: "text-red-500",
    bgColor: "bg-red-50 hover:bg-red-100",
    selectedBg: "bg-red-100 border-red-500",
  },
  {
    value: "sad" as MoodType,
    emoji: "😔",
    label: "Triste",
    color: "text-orange-500",
    bgColor: "bg-orange-50 hover:bg-orange-100",
    selectedBg: "bg-orange-100 border-orange-500",
  },
  {
    value: "neutral" as MoodType,
    emoji: "😐",
    label: "Neutro",
    color: "text-gray-500",
    bgColor: "bg-gray-50 hover:bg-gray-100",
    selectedBg: "bg-gray-100 border-gray-500",
  },
  {
    value: "happy" as MoodType,
    emoji: "😊",
    label: "Feliz",
    color: "text-green-500",
    bgColor: "bg-green-50 hover:bg-green-100",
    selectedBg: "bg-green-100 border-green-500",
  },
  {
    value: "very_happy" as MoodType,
    emoji: "😁",
    label: "Muito feliz",
    color: "text-blue-500",
    bgColor: "bg-blue-50 hover:bg-blue-100",
    selectedBg: "bg-blue-100 border-blue-500",
  },
];

export function MoodSelector({
  title,
  selectedMood,
  onMoodChange,
  notes,
  onNotesChange,
  showNotes = false,
}: MoodSelectorProps) {
  return (
    <Card>
      <CardHeader>
        <CardTitle className="text-lg">{title}</CardTitle>
      </CardHeader>
      <CardContent className="space-y-4">
        <div className="grid grid-cols-5 gap-2">
          {moodOptions.map((option) => (
            <Button
              key={option.value}
              variant="outline"
              className={cn(
                "h-20 flex-col space-y-2 border-2 transition-all",
                option.bgColor,
                selectedMood === option.value
                  ? option.selectedBg
                  : "border-gray-200"
              )}
              onClick={() => onMoodChange(option.value)}
            >
              <span className="text-2xl">{option.emoji}</span>
              <span className={cn("text-xs font-medium", option.color)}>
                {option.label}
              </span>
            </Button>
          ))}
        </div>

        {showNotes && onNotesChange && (
          <div className="space-y-2">
            <label className="text-sm font-medium text-muted-foreground">
              Observações (opcional)
            </label>
            <Textarea
              placeholder="Como você se sente? Adicione observações sobre seu humor..."
              value={notes || ""}
              onChange={(e) => onNotesChange(e.target.value)}
              className="min-h-[80px]"
            />
          </div>
        )}
      </CardContent>
    </Card>
  );
}
===== ./client/src/components/prescription/bulk-substitute-modal.tsx =====
import { useState } from "react";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Textarea } from "@/components/ui/textarea";
import { useToast } from "@/hooks/use-toast";

interface BulkSubstituteModalProps {
  isOpen: boolean;
  onClose: () => void;
  onAddSubstitutes: (substitutes: string[]) => void;
}

export default function BulkSubstituteModal({
  isOpen,
  onClose,
  onAddSubstitutes,
}: BulkSubstituteModalProps) {
  const [bulkText, setBulkText] = useState("");
  const { toast } = useToast();

  const handleAdd = () => {
    if (!bulkText.trim()) {
      toast({
        title: "Nenhum texto inserido",
        description: "Por favor, cole a lista de substitutos na área de texto.",
        variant: "destructive",
      });
      return;
    }

    // Separa por nova linha ou ponto e vírgula, limpa e ordena
    const parsedSubstitutes = bulkText
      .split(/[\n;]/) // Separa por nova linha OU ponto e vírgula
      .map(item => item.trim()) // Remove espaços em branco extras
      .filter(item => item.length > 0); // Remove linhas vazias

    if (parsedSubstitutes.length === 0) {
      toast({
        title: "Formato inválido",
        description: "Não foi possível encontrar itens válidos no texto colado.",
        variant: "destructive",
      });
      return;
    }

    onAddSubstitutes(parsedSubstitutes);
    setBulkText(""); // Limpa o campo após adicionar
    onClose();
  };

  return (
    <Dialog open={isOpen} onOpenChange={onClose}>
      <DialogContent className="sm:max-w-lg">
        <DialogHeader>
          <DialogTitle>Adicionar Substitutos em Lote</DialogTitle>
          <DialogDescription>
            Cole sua lista de substitutos abaixo. Separe cada item com uma
            quebra de linha (Enter) ou ponto e vírgula (;).
          </DialogDescription>
        </DialogHeader>
        <div className="py-4">
          <Textarea
            placeholder="Exemplo:
Pão integral - 1 fatia
Tapioca - 2 colheres de sopa
..."
            className="min-h-[200px]"
            value={bulkText}
            onChange={(e) => setBulkText(e.target.value)}
          />
        </div>
        <DialogFooter>
          <Button type="button" variant="secondary" onClick={onClose}>
            Cancelar
          </Button>
          <Button type="button" onClick={handleAdd}>
            Adicionar Substitutos
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
===== ./client/src/components/prescription/meal-editor.tsx =====
import { useState } from "react";
import { GripVertical, Trash2, Plus, X, ChevronUp, ChevronDown } from "lucide-react";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Card, CardContent } from "@/components/ui/card";
import MealItemEditor from "./meal-item-editor";
import type { MealData, MealItemData } from "@shared/schema";
import { v4 as uuidv4 } from 'uuid';

interface MealEditorProps {
  meal: MealData;
  onUpdate: (meal: MealData) => void;
  onDelete: () => void;
  onMoveUp?: () => void;
  onMoveDown?: () => void;
}

export default function MealEditor({ meal, onUpdate, onDelete, onMoveUp, onMoveDown }: MealEditorProps) {
  const updateMealName = (name: string) => {
    onUpdate({ ...meal, name });
  };

  const updateMealNotes = (notes: string) => {
    onUpdate({ ...meal, notes });
  };

  const addItem = () => {
    const newItem: MealItemData = {
      id: uuidv4(),
      description: "",
      amount: "",
    };
    onUpdate({ ...meal, items: [...meal.items, newItem] });
  };

  const updateItem = (itemId: string, updatedItem: MealItemData) => {
    const updatedItems = meal.items.map(item => 
      item.id === itemId ? updatedItem : item
    );
    onUpdate({ ...meal, items: updatedItems });
  };

  const deleteItem = (itemId: string) => {
    const updatedItems = meal.items.filter(item => item.id !== itemId);
    onUpdate({ ...meal, items: updatedItems });
  };

  const moveItem = (fromIndex: number, toIndex: number) => {
    const newItems = [...meal.items];
    const [moved] = newItems.splice(fromIndex, 1);
    newItems.splice(toIndex, 0, moved);
    onUpdate({ ...meal, items: newItems });
  };

  return (
    <Card className="shadow-xl border-2 border-rose-100 dark:border-rose-900/30 bg-gradient-to-br from-rose-50 via-card to-pink-50 dark:from-rose-950/20 dark:via-card dark:to-pink-950/20">
      <div className="p-4 sm:p-6 border-b border-rose-200 dark:border-rose-800 bg-gradient-to-r from-rose-100/50 via-rose-50/30 to-pink-100/50 dark:from-rose-900/30 dark:via-rose-950/20 dark:to-pink-900/30">
        <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
          <div className="flex items-center space-x-3 w-full sm:w-auto">
            <div className="cursor-move text-muted-foreground hover:text-foreground transition-colors p-2 rounded-lg hover:bg-muted/30 shadow-sm">
              <GripVertical className="h-5 w-5" />
            </div>
            <Input
              className="text-lg sm:text-xl font-semibold bg-background/80 border-2 border-rose-200 dark:border-rose-800 outline-none focus-visible:ring-2 focus-visible:ring-rose-300 focus-visible:border-rose-400 dark:focus-visible:ring-rose-700 dark:focus-visible:border-rose-600 rounded-lg px-4 py-3 min-w-0 flex-1 shadow-sm"
              value={meal.name}
              onChange={(e) => updateMealName(e.target.value)}
              placeholder="Nome da refeição"
              data-testid={`input-meal-name-${meal.id}`}
            />
          </div>
          <div className="flex space-x-2 w-full sm:w-auto justify-end">
            {onMoveUp && (
              <Button
                variant="ghost"
                size="sm"
                onClick={onMoveUp}
                title="Mover para cima"
                data-testid={`button-move-meal-up-${meal.id}`}
                className="hover:bg-rose-100 dark:hover:bg-rose-900/30 shadow-sm border border-rose-200 dark:border-rose-800"
              >
                <ChevronUp className="h-4 w-4" />
              </Button>
            )}
            {onMoveDown && (
              <Button
                variant="ghost"
                size="sm"
                onClick={onMoveDown}
                title="Mover para baixo"
                data-testid={`button-move-meal-down-${meal.id}`}
                className="hover:bg-rose-100 dark:hover:bg-rose-900/30 shadow-sm border border-rose-200 dark:border-rose-800"
              >
                <ChevronDown className="h-4 w-4" />
              </Button>
            )}
            <Button
              variant="ghost"
              size="sm"
              onClick={onDelete}
              className="text-destructive hover:text-destructive/80 hover:bg-destructive/20 shadow-sm border border-destructive/30"
              title="Excluir refeição"
              data-testid={`button-delete-meal-${meal.id}`}
            >
              <Trash2 className="h-4 w-4" />
            </Button>
          </div>
        </div>
      </div>

      <CardContent className="p-4 sm:p-6 space-y-6">
        {/* Lista de itens */}
        <div className="space-y-4">
          {meal.items.map((item, index) => (
            <MealItemEditor
              key={item.id}
              item={item}
              onUpdate={(updatedItem) => updateItem(item.id, updatedItem)}
              onDelete={() => deleteItem(item.id)}
              onMoveUp={index > 0 ? () => moveItem(index, index - 1) : undefined}
              onMoveDown={index < meal.items.length - 1 ? () => moveItem(index, index + 1) : undefined}
            />
          ))}
        </div>

        {/* Botão para adicionar item */}
        <Button
          variant="outline"
          size="lg"
          onClick={addItem}
          className="w-full border-dashed border-3 border-rose-300 dark:border-rose-700 h-14 hover:bg-rose-50 hover:border-rose-400 dark:hover:bg-rose-950/30 dark:hover:border-rose-600 text-rose-700 dark:text-rose-300 shadow-md"
          data-testid={`button-add-item-${meal.id}`}
        >
          <Plus className="h-5 w-5 mr-2" />
          Adicionar Item
        </Button>

        {/* Observações da refeição */}
        <div className="space-y-3 pt-4 border-t border-rose-200 dark:border-rose-800">
          <label className="text-sm font-semibold text-rose-700 dark:text-rose-300">
            Observações da Refeição
          </label>
          <Textarea
            placeholder="Observações específicas desta refeição..."
            value={meal.notes || ""}
            onChange={(e) => updateMealNotes(e.target.value)}
            className="min-h-[100px] bg-background/80 border-2 border-rose-200 dark:border-rose-800 focus-visible:ring-2 focus-visible:ring-rose-300 focus-visible:border-rose-400 dark:focus-visible:ring-rose-700 dark:focus-visible:border-rose-600 shadow-inner"
            data-testid={`textarea-meal-notes-${meal.id}`}
          />
        </div>
      </CardContent>
    </Card>
  );
}
===== ./client/src/components/prescription/meal-item-editor.tsx =====
import { useState } from "react";
import { GripVertical, X, ChevronUp, ChevronDown, Plus, Trash2 } from "lucide-react";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Badge } from "@/components/ui/badge";
import { Checkbox } from "@/components/ui/checkbox"; // Importando o Checkbox
import { Collapsible, CollapsibleContent, CollapsibleTrigger } from "@/components/ui/collapsible";
import type { MealItemData } from "@shared/schema";
import BulkSubstituteModal from "./bulk-substitute-modal";
import { useToast } from "@/hooks/use-toast";

interface MealItemEditorProps {
  item: MealItemData;
  onUpdate: (item: MealItemData) => void;
  onDelete: () => void;
  onMoveUp?: () => void;
  onMoveDown?: () => void;
}

export default function MealItemEditor({ item, onUpdate, onDelete, onMoveUp, onMoveDown }: MealItemEditorProps) {
  const [isSubstitutesOpen, setIsSubstitutesOpen] = useState(!!item.substitutes && item.substitutes.length > 0);
  const [isBulkModalOpen, setIsBulkModalOpen] = useState(false);
  const [newSubstitute, setNewSubstitute] = useState("");
  const [selectedSubstitutes, setSelectedSubstitutes] = useState<Set<number>>(new Set());
  const { toast } = useToast();

  const updateDescription = (description: string) => {
    onUpdate({ ...item, description });
  };

  const updateAmount = (amount: string) => {
    onUpdate({ ...item, amount });
  };

  const addSubstitute = () => {
    if (newSubstitute.trim()) {
      const substitutes = (item.substitutes || []).concat(newSubstitute.trim());
      substitutes.sort((a, b) => a.localeCompare(b)); // Mantém a ordem
      onUpdate({ 
        ...item, 
        substitutes: substitutes
      });
      setNewSubstitute("");
    }
  };
  
  const handleAddBulkSubstitutes = (newSubstitutes: string[]) => {
    const currentSubstitutes = item.substitutes || [];
    const existingSet = new Set(currentSubstitutes.map(s => s.trim().toLowerCase()));

    const uniqueNewItems = newSubstitutes.filter(
      sub => !existingSet.has(sub.trim().toLowerCase())
    );

    if (uniqueNewItems.length === 0) {
      toast({
        title: "Nenhum item novo",
        description: "Todos os substitutos da lista já existem ou a lista está vazia.",
      });
      return;
    }

    const combined = [...currentSubstitutes, ...uniqueNewItems];
    combined.sort((a, b) => a.localeCompare(b));

    onUpdate({
      ...item,
      substitutes: combined,
    });
    
    toast({
      title: "Sucesso!",
      description: `${uniqueNewItems.length} novo(s) substituto(s) foram adicionados.`,
    });
  };

  const removeSubstitute = (index: number) => {
    const substitutes = item.substitutes || [];
    const updatedSubstitutes = substitutes.filter((_, i) => i !== index);
    onUpdate({ 
      ...item, 
      substitutes: updatedSubstitutes.length > 0 ? updatedSubstitutes : undefined 
    });
    // Limpa a seleção após a remoção para evitar inconsistências
    setSelectedSubstitutes(new Set());
  };

  const handleToggleSelect = (index: number) => {
    const newSelection = new Set(selectedSubstitutes);
    if (newSelection.has(index)) {
      newSelection.delete(index);
    } else {
      newSelection.add(index);
    }
    setSelectedSubstitutes(newSelection);
  };

  const handleSelectAll = (checked: boolean) => {
    if (checked) {
      const allIndices = new Set(item.substitutes?.map((_, index) => index) || []);
      setSelectedSubstitutes(allIndices);
    } else {
      setSelectedSubstitutes(new Set());
    }
  };

  const handleDeleteSelected = () => {
    if (selectedSubstitutes.size === 0) return;

    const updatedSubstitutes = (item.substitutes || []).filter(
      (_, index) => !selectedSubstitutes.has(index)
    );

    onUpdate({
      ...item,
      substitutes: updatedSubstitutes.length > 0 ? updatedSubstitutes : undefined,
    });
    
    toast({
        title: "Itens removidos",
        description: `${selectedSubstitutes.size} substituto(s) foram excluídos.`
    });
    
    setSelectedSubstitutes(new Set()); // Limpa a seleção
  };

  const handleKeyPress = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      addSubstitute();
    }
  };

  const allSelected = selectedSubstitutes.size > 0 && selectedSubstitutes.size === (item.substitutes?.length || 0);
  const someSelected = selectedSubstitutes.size > 0 && !allSelected;

  return (
    <>
      <div className="bg-gradient-to-br from-cyan-50 via-background to-blue-50 dark:from-cyan-950/20 dark:via-background dark:to-blue-950/20 border-2 border-cyan-200 dark:border-cyan-800 rounded-xl p-3 sm:p-4 space-y-4 shadow-lg hover:shadow-xl transition-shadow">
        {/* Linha principal do item */}
        <div className="flex flex-col sm:flex-row items-start sm:items-center space-y-3 sm:space-y-0 sm:space-x-4">
          <div className="cursor-move text-muted-foreground hover:text-foreground transition-colors p-2 rounded-md hover:bg-cyan-100 dark:hover:bg-cyan-900/30 shadow-sm border border-cyan-200 dark:border-cyan-800">
            <GripVertical className="h-4 w-4" />
          </div>
          <div className="flex-1 w-full space-y-3 sm:space-y-0 sm:grid sm:grid-cols-2 sm:gap-4">
            <Input
              type="text"
              placeholder="Ex: Pão francês"
              className="text-sm bg-background/80 border-2 border-cyan-200 dark:border-cyan-800 focus-visible:ring-2 focus-visible:ring-cyan-300 focus-visible:border-cyan-400 dark:focus-visible:ring-cyan-700 dark:focus-visible:border-cyan-600 shadow-sm"
              value={item.description}
              onChange={(e) => updateDescription(e.target.value)}
              data-testid={`input-item-description-${item.id}`}
            />
            <Input
              type="text"
              placeholder="Ex: 1 unidade (50g)"
              className="text-sm bg-background/80 border-2 border-cyan-200 dark:border-cyan-800 focus-visible:ring-2 focus-visible:ring-cyan-300 focus-visible:border-cyan-400 dark:focus-visible:ring-cyan-700 dark:focus-visible:border-cyan-600 shadow-sm"
              value={item.amount}
              onChange={(e) => updateAmount(e.target.value)}
              data-testid={`input-item-amount-${item.id}`}
            />
          </div>
          <div className="flex space-x-2 w-full sm:w-auto justify-end">
            {onMoveUp && (
              <Button
                variant="ghost"
                size="sm"
                onClick={onMoveUp}
                title="Mover para cima"
                data-testid={`button-move-item-up-${item.id}`}
                className="hover:bg-cyan-100 dark:hover:bg-cyan-900/30 shadow-sm border border-cyan-200 dark:border-cyan-800"
              >
                <ChevronUp className="h-3 w-3" />
              </Button>
            )}
            {onMoveDown && (
              <Button
                variant="ghost"
                size="sm"
                onClick={onMoveDown}
                title="Mover para baixo"
                data-testid={`button-move-item-down-${item.id}`}
                className="hover:bg-cyan-100 dark:hover:bg-cyan-900/30 shadow-sm border border-cyan-200 dark:border-cyan-800"
              >
                <ChevronDown className="h-3 w-3" />
              </Button>
            )}
            <Button
              variant="ghost"
              size="sm"
              onClick={onDelete}
              className="text-destructive hover:text-destructive/80 hover:bg-destructive/20 shadow-sm border border-destructive/30"
              data-testid={`button-delete-item-${item.id}`}
            >
              <X className="h-4 w-4" />
            </Button>
          </div>
        </div>

        {/* Seção de substitutos */}
        <Collapsible open={isSubstitutesOpen} onOpenChange={setIsSubstitutesOpen}>
          <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between pt-3 border-t border-cyan-200 dark:border-cyan-800 space-y-3 sm:space-y-0">
            <div className="flex flex-col sm:flex-row sm:items-center space-y-2 sm:space-y-0 sm:space-x-4 w-full sm:w-auto">
              <CollapsibleTrigger asChild>
                <Button 
                  variant="ghost" 
                  size="sm" 
                  className="text-xs text-cyan-700 dark:text-cyan-300 hover:text-cyan-900 dark:hover:text-cyan-100 p-3 h-auto rounded-lg hover:bg-cyan-100 dark:hover:bg-cyan-900/30 shadow-sm border border-cyan-200 dark:border-cyan-800 w-full sm:w-auto justify-center sm:justify-start"
                >
                  <Plus className="h-3 w-3 mr-2" />
                  {item.substitutes && item.substitutes.length > 0 
                    ? `${item.substitutes.length} substituto(s)`
                    : "Adicionar substitutos"
                  }
                </Button>
              </CollapsibleTrigger>
              <Button
                type="button"
                variant="ghost"
                size="sm"
                className="text-xs text-cyan-700 dark:text-cyan-300 hover:text-cyan-900 dark:hover:text-cyan-100 p-3 h-auto rounded-lg hover:bg-cyan-100 dark:hover:bg-cyan-900/30 shadow-sm border border-cyan-200 dark:border-cyan-800 w-full sm:w-auto justify-center sm:justify-start"
                onClick={() => setIsBulkModalOpen(true)}
              >
                <Plus className="h-3 w-3 mr-2" />
                Adicionar em lote
              </Button>
            </div>
            
            {!isSubstitutesOpen && item.substitutes && item.substitutes.length > 0 && (
              <div className="flex flex-wrap gap-2 w-full sm:w-auto">
                {item.substitutes.slice(0, 3).map((substitute, index) => (
                  <Badge key={index} variant="secondary" className="text-xs px-3 py-1 shadow-sm bg-cyan-100 dark:bg-cyan-900/30 text-cyan-800 dark:text-cyan-200">
                    {substitute}
                  </Badge>
                ))}
                {item.substitutes.length > 3 && (
                  <Badge variant="outline" className="text-xs px-3 py-1 shadow-sm border-cyan-300 dark:border-cyan-700 text-cyan-700 dark:text-cyan-300">
                    +{item.substitutes.length - 3}
                  </Badge>
                )}
              </div>
            )}
          </div>

          <CollapsibleContent className="space-y-4 mt-4">
            {/* Controles de seleção em lote */}
            {item.substitutes && item.substitutes.length > 0 && (
              <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between p-4 bg-cyan-50 dark:bg-cyan-950/20 rounded-lg border-2 border-cyan-200 dark:border-cyan-800 shadow-inner space-y-3 sm:space-y-0">
                <div className="flex items-center space-x-3">
                   <Checkbox
                    id={`select-all-${item.id}`}
                    checked={allSelected}
                    onCheckedChange={(checked) => handleSelectAll(Boolean(checked))}
                    aria-label="Selecionar todos"
                    className="border-cyan-400 dark:border-cyan-600"
                  />
                  <label htmlFor={`select-all-${item.id}`} className="text-sm font-medium text-cyan-800 dark:text-cyan-200">
                    Selecionar Todos
                  </label>
                </div>
                <Button
                  variant="destructive"
                  size="sm"
                  onClick={handleDeleteSelected}
                  disabled={selectedSubstitutes.size === 0}
                  className="shadow-md w-full sm:w-auto"
                >
                  <Trash2 className="h-3 w-3 mr-2" />
                  Excluir ({selectedSubstitutes.size})
                </Button>
              </div>
            )}

            {/* Lista de substitutos editáveis */}
            {item.substitutes && item.substitutes.length > 0 && (
              <div className="space-y-3">
                {item.substitutes.map((substitute, index) => (
                  <div key={index} className="flex items-center space-x-3 bg-cyan-50 dark:bg-cyan-950/20 rounded-lg p-4 border-2 border-cyan-200 dark:border-cyan-800 shadow-sm">
                    <Checkbox
                      id={`sub-${item.id}-${index}`}
                      checked={selectedSubstitutes.has(index)}
                      onCheckedChange={() => handleToggleSelect(index)}
                      className="border-cyan-400 dark:border-cyan-600"
                    />
                    <label htmlFor={`sub-${item.id}-${index}`} className="text-sm flex-1 cursor-pointer text-cyan-800 dark:text-cyan-200 font-medium">
                      {substitute}
                    </label>
                    <Button
                      variant="ghost"
                      size="sm"
                      onClick={() => removeSubstitute(index)}
                      className="h-8 w-8 p-0 text-destructive hover:text-destructive/80 hover:bg-destructive/20 shadow-sm border border-destructive/30"
                    >
                      <Trash2 className="h-3 w-3" />
                    </Button>
                  </div>
                ))}
              </div>
            )}

            {/* Input para adicionar novo substituto */}
            <div className="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3 pt-3">
              <Input
                type="text"
                placeholder="Ex: Pão integral, Tapioca..."
                className="text-sm bg-background/80 border-2 border-cyan-200 dark:border-cyan-800 focus-visible:ring-2 focus-visible:ring-cyan-300 focus-visible:border-cyan-400 dark:focus-visible:ring-cyan-700 dark:focus-visible:border-cyan-600 shadow-sm flex-1"
                value={newSubstitute}
                onChange={(e) => setNewSubstitute(e.target.value)}
                onKeyPress={handleKeyPress}
              />
              <Button
                type="button"
                variant="outline"
                size="sm"
                onClick={addSubstitute}
                disabled={!newSubstitute.trim()}
                className="px-6 shadow-md border-2 border-cyan-300 dark:border-cyan-700 bg-cyan-50 dark:bg-cyan-950/20 hover:bg-cyan-100 dark:hover:bg-cyan-900/30 text-cyan-800 dark:text-cyan-200 w-full sm:w-auto"
              >
                <Plus className="h-3 w-3 mr-2" />
                Adicionar
              </Button>
            </div>
          </CollapsibleContent>
        </Collapsible>
      </div>

      <BulkSubstituteModal
        isOpen={isBulkModalOpen}
        onClose={() => setIsBulkModalOpen(false)}
        onAddSubstitutes={handleAddBulkSubstitutes}
      />
    </>
  );
}
===== ./client/src/components/prescription/meal-viewer.tsx =====
import { useState, useEffect } from "react";
import { Info, ChevronDown, ChevronUp, Heart, MessageSquare, Camera, Maximize2 } from "lucide-react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { useQuery } from "@tanstack/react-query";
import MoodRegistrationModal from "@/components/mood/mood-registration-modal";
import FoodPhotoModal from "@/components/diary/food-photo-modal";
import MealMenuScreen from "@/components/meal/meal-menu-screen";
import type { MealData } from "@shared/schema";

interface MealViewerProps {
  meal: MealData;
  prescriptionId?: string;
  patientId?: string;
  autoExpand?: boolean; // Nova prop
}

interface MoodEntry {
  id: string;
  moodBefore?: string;
  moodAfter?: string;
  notes?: string;
  date: string;
}

// Função para fazer requisições API (temporária, até implementarmos a API completa)
async function apiRequest(method: string, url: string, data?: any) {
  const response = await fetch(url, {
    method,
    headers: {
      'Content-Type': 'application/json',
    },
    body: data ? JSON.stringify(data) : undefined,
  });
  
  if (!response.ok) {
    throw new Error(`API Error: ${response.status}`);
  }
  
  return response.json();
}

export default function MealViewer({ meal, prescriptionId, patientId, autoExpand = false }: MealViewerProps) {
  const [isExpanded, setIsExpanded] = useState(autoExpand);
  const [showMoodModal, setShowMoodModal] = useState(false);
  const [showPhotoModal, setShowPhotoModal] = useState(false);
  const [showFullScreenMenu, setShowFullScreenMenu] = useState(false);
  const [showSubstitutes, setShowSubstitutes] = useState<{ [key: string]: boolean }>({});

  const today = new Date().toISOString().split('T')[0];

  useEffect(() => {
    if (autoExpand) {
      setIsExpanded(true);
    }
  }, [autoExpand]);

  const { data: moodEntry } = useQuery<MoodEntry>({
    queryKey: ["/api/mood-entries", prescriptionId, meal.id, today],
    queryFn: async () => {
      if (!prescriptionId) return null;
      try {
        return await apiRequest("GET", `/api/mood-entries/${prescriptionId}/${meal.id}/${today}`);
      } catch (error) {
        return null;
      }
    },
    enabled: !!prescriptionId,
  });

  const handlePhotoAction = () => {
    setShowPhotoModal(true);
  };

  const handleMoodRegistration = () => {
    setShowMoodModal(true);
  };

  const toggleSubstitutes = (itemId: string) => {
    setShowSubstitutes(prev => ({
      ...prev,
      [itemId]: !prev[itemId]
    }));
  };

  return (
    <>
      <Card>
        <CardHeader 
          className={`pb-4 bg-accent/5 transition-colors ${
            !autoExpand ? 'cursor-pointer hover:bg-accent/10' : ''
          }`}
          onClick={!autoExpand ? () => setIsExpanded(!isExpanded) : undefined}
        >
          <div className="flex items-center justify-between">
            <CardTitle data-testid={`text-meal-name-${meal.id}`}>
              {meal.name}
            </CardTitle>
            <div className="flex items-center space-x-2">
              {moodEntry && (
                <div className="flex items-center space-x-1 text-sm text-muted-foreground">
                  <Heart className="h-4 w-4 text-pink-500" />
                  <span>Registrado</span>
                </div>
              )}
              {!autoExpand && (
                isExpanded ? (
                  <ChevronUp className="h-5 w-5 text-muted-foreground" />
                ) : (
                  <ChevronDown className="h-5 w-5 text-muted-foreground" />
                )
              )}
            </div>
          </div>
        </CardHeader>
        
        <CardContent className="p-4">
          {isExpanded && (
            <>
              <div className="mb-4">
                <div className="flex items-center justify-between mb-3">
                  <h4 className="text-sm font-medium text-muted-foreground">Menu da refeição</h4>
                  <Button
                    onClick={() => setShowFullScreenMenu(true)}
                    variant="outline"
                    size="sm"
                    className="text-blue-600 border-blue-200 hover:bg-blue-50 hover:border-blue-300"
                  >
                    <Maximize2 className="h-4 w-4 mr-1" />
                    Tela Completa
                  </Button>
                </div>
                <div className="grid grid-cols-2 gap-3 mb-4">
                  <Button
                    onClick={handlePhotoAction}
                    className="h-20 flex flex-col items-center justify-center space-y-2 bg-gradient-to-br from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white rounded-lg"
                  >
                    <Camera className="h-6 w-6" />
                    <div className="text-xs text-center leading-tight">
                      <div>Foto para o</div>
                      <div>diário alimentar</div>
                    </div>
                  </Button>
                  
                  <Button
                    onClick={handleMoodRegistration}
                    className="h-20 flex flex-col items-center justify-center space-y-2 bg-gradient-to-br from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white rounded-lg"
                  >
                    <Heart className="h-6 w-6" />
                    <div className="text-xs text-center leading-tight">
                      <div>Registrar humor</div>
                      <div>na refeição</div>
                    </div>
                  </Button>
                </div>
              </div>

              <div className="space-y-4">
                <h4 className="text-sm font-medium text-muted-foreground">Alimentos</h4>
                
                {meal.items.map((item) => (
                  <div key={item.id} className="space-y-2">
                    <div className="flex flex-col space-y-1">
                      <div className="flex items-start justify-between">
                        <div className="flex-1">
                          <div className="font-medium text-gray-900" data-testid={`text-item-description-${item.id}`}>
                            {item.description}
                          </div>
                          <div className="text-sm text-muted-foreground" data-testid={`text-item-amount-${item.id}`}>
                            {item.amount}
                          </div>
                        </div>
                      </div>
                      
                      {item.substitutes && item.substitutes.length > 0 && (
                        <div className="ml-4">
                          <button
                            onClick={() => toggleSubstitutes(item.id)}
                            className="text-sm text-blue-600 hover:text-blue-700 flex items-center space-x-1"
                          >
                            <span>↪</span>
                            <span>Ver opções de substituição</span>
                          </button>
                          
                          {showSubstitutes[item.id] && (
                            <div className="mt-2 ml-4 space-y-1">
                              {item.substitutes.map((substitute, index) => (
                                <div key={index} className="text-sm text-gray-600">
                                  • {substitute}
                                </div>
                              ))}
                            </div>
                          )}
                        </div>
                      )}
                    </div>
                  </div>
                ))}
              </div>

              {meal.notes && (
                <div className="mt-6 bg-muted/30 p-3 rounded-md">
                  <p className="text-sm text-muted-foreground flex items-start space-x-2" data-testid={`text-meal-notes-${meal.id}`}>
                    <Info className="h-4 w-4 mt-0.5 flex-shrink-0" />
                    <span>{meal.notes}</span>
                  </p>
                </div>
              )}
            </>
          )}
        </CardContent>
      </Card>

      {prescriptionId && (
        <MoodRegistrationModal
          isOpen={showMoodModal}
          onClose={() => setShowMoodModal(false)}
          meal={meal}
          prescriptionId={prescriptionId}
          patientId={patientId || ""}
        />
      )}
      
      {prescriptionId && (
        <FoodPhotoModal
          isOpen={showPhotoModal}
          onClose={() => setShowPhotoModal(false)}
          meal={meal}
          prescriptionId={prescriptionId}
        />
      )}

      {showFullScreenMenu && prescriptionId && (
        <MealMenuScreen
          meal={meal}
          prescriptionId={prescriptionId}
          patientId={patientId || ""}
          onClose={() => setShowFullScreenMenu(false)}
        />
      )}
    </>
  );
}
===== ./client/src/components/ui/accordion.tsx =====
import * as React from "react"
import * as AccordionPrimitive from "@radix-ui/react-accordion"
import { ChevronDown } from "lucide-react"

import { cn } from "@/lib/utils"

const Accordion = AccordionPrimitive.Root

const AccordionItem = React.forwardRef<
  React.ElementRef<typeof AccordionPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Item>
>(({ className, ...props }, ref) => (
  <AccordionPrimitive.Item
    ref={ref}
    className={cn("border-b", className)}
    {...props}
  />
))
AccordionItem.displayName = "AccordionItem"

const AccordionTrigger = React.forwardRef<
  React.ElementRef<typeof AccordionPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>
>(({ className, children, ...props }, ref) => (
  <AccordionPrimitive.Header className="flex">
    <AccordionPrimitive.Trigger
      ref={ref}
      className={cn(
        "flex flex-1 items-center justify-between py-4 font-medium transition-all hover:underline [&[data-state=open]>svg]:rotate-180",
        className
      )}
      {...props}
    >
      {children}
      <ChevronDown className="h-4 w-4 shrink-0 transition-transform duration-200" />
    </AccordionPrimitive.Trigger>
  </AccordionPrimitive.Header>
))
AccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName

const AccordionContent = React.forwardRef<
  React.ElementRef<typeof AccordionPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Content>
>(({ className, children, ...props }, ref) => (
  <AccordionPrimitive.Content
    ref={ref}
    className="overflow-hidden text-sm transition-all data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down"
    {...props}
  >
    <div className={cn("pb-4 pt-0", className)}>{children}</div>
  </AccordionPrimitive.Content>
))

AccordionContent.displayName = AccordionPrimitive.Content.displayName

export { Accordion, AccordionItem, AccordionTrigger, AccordionContent }

===== ./client/src/components/ui/alert-dialog.tsx =====
import * as React from "react"
import * as AlertDialogPrimitive from "@radix-ui/react-alert-dialog"

import { cn } from "@/lib/utils"
import { buttonVariants } from "@/components/ui/button"

const AlertDialog = AlertDialogPrimitive.Root

const AlertDialogTrigger = AlertDialogPrimitive.Trigger

const AlertDialogPortal = AlertDialogPrimitive.Portal

const AlertDialogOverlay = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Overlay
    className={cn(
      "fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
      className
    )}
    {...props}
    ref={ref}
  />
))
AlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName

const AlertDialogContent = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Content>
>(({ className, ...props }, ref) => (
  <AlertDialogPortal>
    <AlertDialogOverlay />
    <AlertDialogPrimitive.Content
      ref={ref}
      className={cn(
        "fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",
        className
      )}
      {...props}
    />
  </AlertDialogPortal>
))
AlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName

const AlertDialogHeader = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col space-y-2 text-center sm:text-left",
      className
    )}
    {...props}
  />
)
AlertDialogHeader.displayName = "AlertDialogHeader"

const AlertDialogFooter = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",
      className
    )}
    {...props}
  />
)
AlertDialogFooter.displayName = "AlertDialogFooter"

const AlertDialogTitle = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Title>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Title
    ref={ref}
    className={cn("text-lg font-semibold", className)}
    {...props}
  />
))
AlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName

const AlertDialogDescription = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Description>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Description
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
AlertDialogDescription.displayName =
  AlertDialogPrimitive.Description.displayName

const AlertDialogAction = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Action>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Action>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Action
    ref={ref}
    className={cn(buttonVariants(), className)}
    {...props}
  />
))
AlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName

const AlertDialogCancel = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Cancel>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Cancel>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Cancel
    ref={ref}
    className={cn(
      buttonVariants({ variant: "outline" }),
      "mt-2 sm:mt-0",
      className
    )}
    {...props}
  />
))
AlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName

export {
  AlertDialog,
  AlertDialogPortal,
  AlertDialogOverlay,
  AlertDialogTrigger,
  AlertDialogContent,
  AlertDialogHeader,
  AlertDialogFooter,
  AlertDialogTitle,
  AlertDialogDescription,
  AlertDialogAction,
  AlertDialogCancel,
}

===== ./client/src/components/ui/alert.tsx =====
import * as React from "react"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const alertVariants = cva(
  "relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground",
  {
    variants: {
      variant: {
        default: "bg-background text-foreground",
        destructive:
          "border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

const Alert = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>
>(({ className, variant, ...props }, ref) => (
  <div
    ref={ref}
    role="alert"
    className={cn(alertVariants({ variant }), className)}
    {...props}
  />
))
Alert.displayName = "Alert"

const AlertTitle = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLHeadingElement>
>(({ className, ...props }, ref) => (
  <h5
    ref={ref}
    className={cn("mb-1 font-medium leading-none tracking-tight", className)}
    {...props}
  />
))
AlertTitle.displayName = "AlertTitle"

const AlertDescription = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLParagraphElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("text-sm [&_p]:leading-relaxed", className)}
    {...props}
  />
))
AlertDescription.displayName = "AlertDescription"

export { Alert, AlertTitle, AlertDescription }

===== ./client/src/components/ui/aspect-ratio.tsx =====
import * as AspectRatioPrimitive from "@radix-ui/react-aspect-ratio"

const AspectRatio = AspectRatioPrimitive.Root

export { AspectRatio }

===== ./client/src/components/ui/avatar.tsx =====
"use client"

import * as React from "react"
import * as AvatarPrimitive from "@radix-ui/react-avatar"

import { cn } from "@/lib/utils"

const Avatar = React.forwardRef<
  React.ElementRef<typeof AvatarPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>
>(({ className, ...props }, ref) => (
  <AvatarPrimitive.Root
    ref={ref}
    className={cn(
      "relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full",
      className
    )}
    {...props}
  />
))
Avatar.displayName = AvatarPrimitive.Root.displayName

const AvatarImage = React.forwardRef<
  React.ElementRef<typeof AvatarPrimitive.Image>,
  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>
>(({ className, ...props }, ref) => (
  <AvatarPrimitive.Image
    ref={ref}
    className={cn("aspect-square h-full w-full", className)}
    {...props}
  />
))
AvatarImage.displayName = AvatarPrimitive.Image.displayName

const AvatarFallback = React.forwardRef<
  React.ElementRef<typeof AvatarPrimitive.Fallback>,
  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>
>(({ className, ...props }, ref) => (
  <AvatarPrimitive.Fallback
    ref={ref}
    className={cn(
      "flex h-full w-full items-center justify-center rounded-full bg-muted",
      className
    )}
    {...props}
  />
))
AvatarFallback.displayName = AvatarPrimitive.Fallback.displayName

export { Avatar, AvatarImage, AvatarFallback }

===== ./client/src/components/ui/badge.tsx =====
import * as React from "react"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const badgeVariants = cva(
  "inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",
  {
    variants: {
      variant: {
        default:
          "border-transparent bg-primary text-primary-foreground hover:bg-primary/80",
        secondary:
          "border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",
        destructive:
          "border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",
        outline: "text-foreground",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

export interface BadgeProps
  extends React.HTMLAttributes<HTMLDivElement>,
    VariantProps<typeof badgeVariants> {}

function Badge({ className, variant, ...props }: BadgeProps) {
  return (
    <div className={cn(badgeVariants({ variant }), className)} {...props} />
  )
}

export { Badge, badgeVariants }

===== ./client/src/components/ui/breadcrumb.tsx =====
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { ChevronRight, MoreHorizontal } from "lucide-react"

import { cn } from "@/lib/utils"

const Breadcrumb = React.forwardRef<
  HTMLElement,
  React.ComponentPropsWithoutRef<"nav"> & {
    separator?: React.ReactNode
  }
>(({ ...props }, ref) => <nav ref={ref} aria-label="breadcrumb" {...props} />)
Breadcrumb.displayName = "Breadcrumb"

const BreadcrumbList = React.forwardRef<
  HTMLOListElement,
  React.ComponentPropsWithoutRef<"ol">
>(({ className, ...props }, ref) => (
  <ol
    ref={ref}
    className={cn(
      "flex flex-wrap items-center gap-1.5 break-words text-sm text-muted-foreground sm:gap-2.5",
      className
    )}
    {...props}
  />
))
BreadcrumbList.displayName = "BreadcrumbList"

const BreadcrumbItem = React.forwardRef<
  HTMLLIElement,
  React.ComponentPropsWithoutRef<"li">
>(({ className, ...props }, ref) => (
  <li
    ref={ref}
    className={cn("inline-flex items-center gap-1.5", className)}
    {...props}
  />
))
BreadcrumbItem.displayName = "BreadcrumbItem"

const BreadcrumbLink = React.forwardRef<
  HTMLAnchorElement,
  React.ComponentPropsWithoutRef<"a"> & {
    asChild?: boolean
  }
>(({ asChild, className, ...props }, ref) => {
  const Comp = asChild ? Slot : "a"

  return (
    <Comp
      ref={ref}
      className={cn("transition-colors hover:text-foreground", className)}
      {...props}
    />
  )
})
BreadcrumbLink.displayName = "BreadcrumbLink"

const BreadcrumbPage = React.forwardRef<
  HTMLSpanElement,
  React.ComponentPropsWithoutRef<"span">
>(({ className, ...props }, ref) => (
  <span
    ref={ref}
    role="link"
    aria-disabled="true"
    aria-current="page"
    className={cn("font-normal text-foreground", className)}
    {...props}
  />
))
BreadcrumbPage.displayName = "BreadcrumbPage"

const BreadcrumbSeparator = ({
  children,
  className,
  ...props
}: React.ComponentProps<"li">) => (
  <li
    role="presentation"
    aria-hidden="true"
    className={cn("[&>svg]:w-3.5 [&>svg]:h-3.5", className)}
    {...props}
  >
    {children ?? <ChevronRight />}
  </li>
)
BreadcrumbSeparator.displayName = "BreadcrumbSeparator"

const BreadcrumbEllipsis = ({
  className,
  ...props
}: React.ComponentProps<"span">) => (
  <span
    role="presentation"
    aria-hidden="true"
    className={cn("flex h-9 w-9 items-center justify-center", className)}
    {...props}
  >
    <MoreHorizontal className="h-4 w-4" />
    <span className="sr-only">More</span>
  </span>
)
BreadcrumbEllipsis.displayName = "BreadcrumbElipssis"

export {
  Breadcrumb,
  BreadcrumbList,
  BreadcrumbItem,
  BreadcrumbLink,
  BreadcrumbPage,
  BreadcrumbSeparator,
  BreadcrumbEllipsis,
}

===== ./client/src/components/ui/button.tsx =====
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const buttonVariants = cva(
  "inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",
  {
    variants: {
      variant: {
        default: "bg-primary text-primary-foreground hover:bg-primary/90",
        destructive:
          "bg-destructive text-destructive-foreground hover:bg-destructive/90",
        outline:
          "border border-input bg-background hover:bg-accent hover:text-accent-foreground",
        secondary:
          "bg-secondary text-secondary-foreground hover:bg-secondary/80",
        ghost: "hover:bg-accent hover:text-accent-foreground",
        link: "text-primary underline-offset-4 hover:underline",
      },
      size: {
        default: "h-10 px-4 py-2",
        sm: "h-9 rounded-md px-3",
        lg: "h-11 rounded-md px-8",
        icon: "h-10 w-10",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

export interface ButtonProps
  extends React.ButtonHTMLAttributes<HTMLButtonElement>,
    VariantProps<typeof buttonVariants> {
  asChild?: boolean
}

const Button = React.forwardRef<HTMLButtonElement, ButtonProps>(
  ({ className, variant, size, asChild = false, ...props }, ref) => {
    const Comp = asChild ? Slot : "button"
    return (
      <Comp
        className={cn(buttonVariants({ variant, size, className }))}
        ref={ref}
        {...props}
      />
    )
  }
)
Button.displayName = "Button"

export { Button, buttonVariants }

===== ./client/src/components/ui/calendar.tsx =====
import * as React from "react"
import { ChevronLeft, ChevronRight } from "lucide-react"
import { DayPicker } from "react-day-picker"

import { cn } from "@/lib/utils"
import { buttonVariants } from "@/components/ui/button"

export type CalendarProps = React.ComponentProps<typeof DayPicker>

function Calendar({
  className,
  classNames,
  showOutsideDays = true,
  ...props
}: CalendarProps) {
  return (
    <DayPicker
      showOutsideDays={showOutsideDays}
      className={cn("p-3", className)}
      classNames={{
        months: "flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0",
        month: "space-y-4",
        caption: "flex justify-center pt-1 relative items-center",
        caption_label: "text-sm font-medium",
        nav: "space-x-1 flex items-center",
        nav_button: cn(
          buttonVariants({ variant: "outline" }),
          "h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100"
        ),
        nav_button_previous: "absolute left-1",
        nav_button_next: "absolute right-1",
        table: "w-full border-collapse space-y-1",
        head_row: "flex",
        head_cell:
          "text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]",
        row: "flex w-full mt-2",
        cell: "h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20",
        day: cn(
          buttonVariants({ variant: "ghost" }),
          "h-9 w-9 p-0 font-normal aria-selected:opacity-100"
        ),
        day_range_end: "day-range-end",
        day_selected:
          "bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground",
        day_today: "bg-accent text-accent-foreground",
        day_outside:
          "day-outside text-muted-foreground aria-selected:bg-accent/50 aria-selected:text-muted-foreground",
        day_disabled: "text-muted-foreground opacity-50",
        day_range_middle:
          "aria-selected:bg-accent aria-selected:text-accent-foreground",
        day_hidden: "invisible",
        ...classNames,
      }}
      components={{
        IconLeft: ({ className, ...props }) => (
          <ChevronLeft className={cn("h-4 w-4", className)} {...props} />
        ),
        IconRight: ({ className, ...props }) => (
          <ChevronRight className={cn("h-4 w-4", className)} {...props} />
        ),
      }}
      {...props}
    />
  )
}
Calendar.displayName = "Calendar"

export { Calendar }

===== ./client/src/components/ui/card.tsx =====
import * as React from "react"

import { cn } from "@/lib/utils"

const Card = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn(
      "rounded-lg border bg-card text-card-foreground shadow-sm",
      className
    )}
    {...props}
  />
))
Card.displayName = "Card"

const CardHeader = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("flex flex-col space-y-1.5 p-6", className)}
    {...props}
  />
))
CardHeader.displayName = "CardHeader"

const CardTitle = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn(
      "text-2xl font-semibold leading-none tracking-tight",
      className
    )}
    {...props}
  />
))
CardTitle.displayName = "CardTitle"

const CardDescription = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
CardDescription.displayName = "CardDescription"

const CardContent = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div ref={ref} className={cn("p-6 pt-0", className)} {...props} />
))
CardContent.displayName = "CardContent"

const CardFooter = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("flex items-center p-6 pt-0", className)}
    {...props}
  />
))
CardFooter.displayName = "CardFooter"

export { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent }

===== ./client/src/components/ui/carousel.tsx =====
import * as React from "react"
import useEmblaCarousel, {
  type UseEmblaCarouselType,
} from "embla-carousel-react"
import { ArrowLeft, ArrowRight } from "lucide-react"

import { cn } from "@/lib/utils"
import { Button } from "@/components/ui/button"

type CarouselApi = UseEmblaCarouselType[1]
type UseCarouselParameters = Parameters<typeof useEmblaCarousel>
type CarouselOptions = UseCarouselParameters[0]
type CarouselPlugin = UseCarouselParameters[1]

type CarouselProps = {
  opts?: CarouselOptions
  plugins?: CarouselPlugin
  orientation?: "horizontal" | "vertical"
  setApi?: (api: CarouselApi) => void
}

type CarouselContextProps = {
  carouselRef: ReturnType<typeof useEmblaCarousel>[0]
  api: ReturnType<typeof useEmblaCarousel>[1]
  scrollPrev: () => void
  scrollNext: () => void
  canScrollPrev: boolean
  canScrollNext: boolean
} & CarouselProps

const CarouselContext = React.createContext<CarouselContextProps | null>(null)

function useCarousel() {
  const context = React.useContext(CarouselContext)

  if (!context) {
    throw new Error("useCarousel must be used within a <Carousel />")
  }

  return context
}

const Carousel = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement> & CarouselProps
>(
  (
    {
      orientation = "horizontal",
      opts,
      setApi,
      plugins,
      className,
      children,
      ...props
    },
    ref
  ) => {
    const [carouselRef, api] = useEmblaCarousel(
      {
        ...opts,
        axis: orientation === "horizontal" ? "x" : "y",
      },
      plugins
    )
    const [canScrollPrev, setCanScrollPrev] = React.useState(false)
    const [canScrollNext, setCanScrollNext] = React.useState(false)

    const onSelect = React.useCallback((api: CarouselApi) => {
      if (!api) {
        return
      }

      setCanScrollPrev(api.canScrollPrev())
      setCanScrollNext(api.canScrollNext())
    }, [])

    const scrollPrev = React.useCallback(() => {
      api?.scrollPrev()
    }, [api])

    const scrollNext = React.useCallback(() => {
      api?.scrollNext()
    }, [api])

    const handleKeyDown = React.useCallback(
      (event: React.KeyboardEvent<HTMLDivElement>) => {
        if (event.key === "ArrowLeft") {
          event.preventDefault()
          scrollPrev()
        } else if (event.key === "ArrowRight") {
          event.preventDefault()
          scrollNext()
        }
      },
      [scrollPrev, scrollNext]
    )

    React.useEffect(() => {
      if (!api || !setApi) {
        return
      }

      setApi(api)
    }, [api, setApi])

    React.useEffect(() => {
      if (!api) {
        return
      }

      onSelect(api)
      api.on("reInit", onSelect)
      api.on("select", onSelect)

      return () => {
        api?.off("select", onSelect)
      }
    }, [api, onSelect])

    return (
      <CarouselContext.Provider
        value={{
          carouselRef,
          api: api,
          opts,
          orientation:
            orientation || (opts?.axis === "y" ? "vertical" : "horizontal"),
          scrollPrev,
          scrollNext,
          canScrollPrev,
          canScrollNext,
        }}
      >
        <div
          ref={ref}
          onKeyDownCapture={handleKeyDown}
          className={cn("relative", className)}
          role="region"
          aria-roledescription="carousel"
          {...props}
        >
          {children}
        </div>
      </CarouselContext.Provider>
    )
  }
)
Carousel.displayName = "Carousel"

const CarouselContent = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => {
  const { carouselRef, orientation } = useCarousel()

  return (
    <div ref={carouselRef} className="overflow-hidden">
      <div
        ref={ref}
        className={cn(
          "flex",
          orientation === "horizontal" ? "-ml-4" : "-mt-4 flex-col",
          className
        )}
        {...props}
      />
    </div>
  )
})
CarouselContent.displayName = "CarouselContent"

const CarouselItem = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => {
  const { orientation } = useCarousel()

  return (
    <div
      ref={ref}
      role="group"
      aria-roledescription="slide"
      className={cn(
        "min-w-0 shrink-0 grow-0 basis-full",
        orientation === "horizontal" ? "pl-4" : "pt-4",
        className
      )}
      {...props}
    />
  )
})
CarouselItem.displayName = "CarouselItem"

const CarouselPrevious = React.forwardRef<
  HTMLButtonElement,
  React.ComponentProps<typeof Button>
>(({ className, variant = "outline", size = "icon", ...props }, ref) => {
  const { orientation, scrollPrev, canScrollPrev } = useCarousel()

  return (
    <Button
      ref={ref}
      variant={variant}
      size={size}
      className={cn(
        "absolute  h-8 w-8 rounded-full",
        orientation === "horizontal"
          ? "-left-12 top-1/2 -translate-y-1/2"
          : "-top-12 left-1/2 -translate-x-1/2 rotate-90",
        className
      )}
      disabled={!canScrollPrev}
      onClick={scrollPrev}
      {...props}
    >
      <ArrowLeft className="h-4 w-4" />
      <span className="sr-only">Previous slide</span>
    </Button>
  )
})
CarouselPrevious.displayName = "CarouselPrevious"

const CarouselNext = React.forwardRef<
  HTMLButtonElement,
  React.ComponentProps<typeof Button>
>(({ className, variant = "outline", size = "icon", ...props }, ref) => {
  const { orientation, scrollNext, canScrollNext } = useCarousel()

  return (
    <Button
      ref={ref}
      variant={variant}
      size={size}
      className={cn(
        "absolute h-8 w-8 rounded-full",
        orientation === "horizontal"
          ? "-right-12 top-1/2 -translate-y-1/2"
          : "-bottom-12 left-1/2 -translate-x-1/2 rotate-90",
        className
      )}
      disabled={!canScrollNext}
      onClick={scrollNext}
      {...props}
    >
      <ArrowRight className="h-4 w-4" />
      <span className="sr-only">Next slide</span>
    </Button>
  )
})
CarouselNext.displayName = "CarouselNext"

export {
  type CarouselApi,
  Carousel,
  CarouselContent,
  CarouselItem,
  CarouselPrevious,
  CarouselNext,
}

===== ./client/src/components/ui/chart.tsx =====
"use client"

import * as React from "react"
import * as RechartsPrimitive from "recharts"

import { cn } from "@/lib/utils"

// Format: { THEME_NAME: CSS_SELECTOR }
const THEMES = { light: "", dark: ".dark" } as const

export type ChartConfig = {
  [k in string]: {
    label?: React.ReactNode
    icon?: React.ComponentType
  } & (
    | { color?: string; theme?: never }
    | { color?: never; theme: Record<keyof typeof THEMES, string> }
  )
}

type ChartContextProps = {
  config: ChartConfig
}

const ChartContext = React.createContext<ChartContextProps | null>(null)

function useChart() {
  const context = React.useContext(ChartContext)

  if (!context) {
    throw new Error("useChart must be used within a <ChartContainer />")
  }

  return context
}

const ChartContainer = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div"> & {
    config: ChartConfig
    children: React.ComponentProps<
      typeof RechartsPrimitive.ResponsiveContainer
    >["children"]
  }
>(({ id, className, children, config, ...props }, ref) => {
  const uniqueId = React.useId()
  const chartId = `chart-${id || uniqueId.replace(/:/g, "")}`

  return (
    <ChartContext.Provider value={{ config }}>
      <div
        data-chart={chartId}
        ref={ref}
        className={cn(
          "flex aspect-video justify-center text-xs [&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-none [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-sector]:outline-none [&_.recharts-surface]:outline-none",
          className
        )}
        {...props}
      >
        <ChartStyle id={chartId} config={config} />
        <RechartsPrimitive.ResponsiveContainer>
          {children}
        </RechartsPrimitive.ResponsiveContainer>
      </div>
    </ChartContext.Provider>
  )
})
ChartContainer.displayName = "Chart"

const ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {
  const colorConfig = Object.entries(config).filter(
    ([, config]) => config.theme || config.color
  )

  if (!colorConfig.length) {
    return null
  }

  return (
    <style
      dangerouslySetInnerHTML={{
        __html: Object.entries(THEMES)
          .map(
            ([theme, prefix]) => `
${prefix} [data-chart=${id}] {
${colorConfig
  .map(([key, itemConfig]) => {
    const color =
      itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||
      itemConfig.color
    return color ? `  --color-${key}: ${color};` : null
  })
  .join("\n")}
}
`
          )
          .join("\n"),
      }}
    />
  )
}

const ChartTooltip = RechartsPrimitive.Tooltip

const ChartTooltipContent = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<typeof RechartsPrimitive.Tooltip> &
    React.ComponentProps<"div"> & {
      hideLabel?: boolean
      hideIndicator?: boolean
      indicator?: "line" | "dot" | "dashed"
      nameKey?: string
      labelKey?: string
    }
>(
  (
    {
      active,
      payload,
      className,
      indicator = "dot",
      hideLabel = false,
      hideIndicator = false,
      label,
      labelFormatter,
      labelClassName,
      formatter,
      color,
      nameKey,
      labelKey,
    },
    ref
  ) => {
    const { config } = useChart()

    const tooltipLabel = React.useMemo(() => {
      if (hideLabel || !payload?.length) {
        return null
      }

      const [item] = payload
      const key = `${labelKey || item?.dataKey || item?.name || "value"}`
      const itemConfig = getPayloadConfigFromPayload(config, item, key)
      const value =
        !labelKey && typeof label === "string"
          ? config[label as keyof typeof config]?.label || label
          : itemConfig?.label

      if (labelFormatter) {
        return (
          <div className={cn("font-medium", labelClassName)}>
            {labelFormatter(value, payload)}
          </div>
        )
      }

      if (!value) {
        return null
      }

      return <div className={cn("font-medium", labelClassName)}>{value}</div>
    }, [
      label,
      labelFormatter,
      payload,
      hideLabel,
      labelClassName,
      config,
      labelKey,
    ])

    if (!active || !payload?.length) {
      return null
    }

    const nestLabel = payload.length === 1 && indicator !== "dot"

    return (
      <div
        ref={ref}
        className={cn(
          "grid min-w-[8rem] items-start gap-1.5 rounded-lg border border-border/50 bg-background px-2.5 py-1.5 text-xs shadow-xl",
          className
        )}
      >
        {!nestLabel ? tooltipLabel : null}
        <div className="grid gap-1.5">
          {payload.map((item, index) => {
            const key = `${nameKey || item.name || item.dataKey || "value"}`
            const itemConfig = getPayloadConfigFromPayload(config, item, key)
            const indicatorColor = color || item.payload.fill || item.color

            return (
              <div
                key={item.dataKey}
                className={cn(
                  "flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5 [&>svg]:text-muted-foreground",
                  indicator === "dot" && "items-center"
                )}
              >
                {formatter && item?.value !== undefined && item.name ? (
                  formatter(item.value, item.name, item, index, item.payload)
                ) : (
                  <>
                    {itemConfig?.icon ? (
                      <itemConfig.icon />
                    ) : (
                      !hideIndicator && (
                        <div
                          className={cn(
                            "shrink-0 rounded-[2px] border-[--color-border] bg-[--color-bg]",
                            {
                              "h-2.5 w-2.5": indicator === "dot",
                              "w-1": indicator === "line",
                              "w-0 border-[1.5px] border-dashed bg-transparent":
                                indicator === "dashed",
                              "my-0.5": nestLabel && indicator === "dashed",
                            }
                          )}
                          style={
                            {
                              "--color-bg": indicatorColor,
                              "--color-border": indicatorColor,
                            } as React.CSSProperties
                          }
                        />
                      )
                    )}
                    <div
                      className={cn(
                        "flex flex-1 justify-between leading-none",
                        nestLabel ? "items-end" : "items-center"
                      )}
                    >
                      <div className="grid gap-1.5">
                        {nestLabel ? tooltipLabel : null}
                        <span className="text-muted-foreground">
                          {itemConfig?.label || item.name}
                        </span>
                      </div>
                      {item.value && (
                        <span className="font-mono font-medium tabular-nums text-foreground">
                          {item.value.toLocaleString()}
                        </span>
                      )}
                    </div>
                  </>
                )}
              </div>
            )
          })}
        </div>
      </div>
    )
  }
)
ChartTooltipContent.displayName = "ChartTooltip"

const ChartLegend = RechartsPrimitive.Legend

const ChartLegendContent = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div"> &
    Pick<RechartsPrimitive.LegendProps, "payload" | "verticalAlign"> & {
      hideIcon?: boolean
      nameKey?: string
    }
>(
  (
    { className, hideIcon = false, payload, verticalAlign = "bottom", nameKey },
    ref
  ) => {
    const { config } = useChart()

    if (!payload?.length) {
      return null
    }

    return (
      <div
        ref={ref}
        className={cn(
          "flex items-center justify-center gap-4",
          verticalAlign === "top" ? "pb-3" : "pt-3",
          className
        )}
      >
        {payload.map((item) => {
          const key = `${nameKey || item.dataKey || "value"}`
          const itemConfig = getPayloadConfigFromPayload(config, item, key)

          return (
            <div
              key={item.value}
              className={cn(
                "flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3 [&>svg]:text-muted-foreground"
              )}
            >
              {itemConfig?.icon && !hideIcon ? (
                <itemConfig.icon />
              ) : (
                <div
                  className="h-2 w-2 shrink-0 rounded-[2px]"
                  style={{
                    backgroundColor: item.color,
                  }}
                />
              )}
              {itemConfig?.label}
            </div>
          )
        })}
      </div>
    )
  }
)
ChartLegendContent.displayName = "ChartLegend"

// Helper to extract item config from a payload.
function getPayloadConfigFromPayload(
  config: ChartConfig,
  payload: unknown,
  key: string
) {
  if (typeof payload !== "object" || payload === null) {
    return undefined
  }

  const payloadPayload =
    "payload" in payload &&
    typeof payload.payload === "object" &&
    payload.payload !== null
      ? payload.payload
      : undefined

  let configLabelKey: string = key

  if (
    key in payload &&
    typeof payload[key as keyof typeof payload] === "string"
  ) {
    configLabelKey = payload[key as keyof typeof payload] as string
  } else if (
    payloadPayload &&
    key in payloadPayload &&
    typeof payloadPayload[key as keyof typeof payloadPayload] === "string"
  ) {
    configLabelKey = payloadPayload[
      key as keyof typeof payloadPayload
    ] as string
  }

  return configLabelKey in config
    ? config[configLabelKey]
    : config[key as keyof typeof config]
}

export {
  ChartContainer,
  ChartTooltip,
  ChartTooltipContent,
  ChartLegend,
  ChartLegendContent,
  ChartStyle,
}

===== ./client/src/components/ui/checkbox.tsx =====
import * as React from "react"
import * as CheckboxPrimitive from "@radix-ui/react-checkbox"
import { Check } from "lucide-react"

import { cn } from "@/lib/utils"

const Checkbox = React.forwardRef<
  React.ElementRef<typeof CheckboxPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>
>(({ className, ...props }, ref) => (
  <CheckboxPrimitive.Root
    ref={ref}
    className={cn(
      "peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground",
      className
    )}
    {...props}
  >
    <CheckboxPrimitive.Indicator
      className={cn("flex items-center justify-center text-current")}
    >
      <Check className="h-4 w-4" />
    </CheckboxPrimitive.Indicator>
  </CheckboxPrimitive.Root>
))
Checkbox.displayName = CheckboxPrimitive.Root.displayName

export { Checkbox }

===== ./client/src/components/ui/collapsible.tsx =====
"use client"

import * as React from "react"
import * as CollapsiblePrimitive from "@radix-ui/react-collapsible"

const Collapsible = CollapsiblePrimitive.Root

const CollapsibleTrigger = CollapsiblePrimitive.CollapsibleTrigger

const CollapsibleContent = CollapsiblePrimitive.CollapsibleContent

export { Collapsible, CollapsibleTrigger, CollapsibleContent }
===== ./client/src/components/ui/command.tsx =====
import * as React from "react"
import { type DialogProps } from "@radix-ui/react-dialog"
import { Command as CommandPrimitive } from "cmdk"
import { Search } from "lucide-react"

import { cn } from "@/lib/utils"
import { Dialog, DialogContent } from "@/components/ui/dialog"

const Command = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive>
>(({ className, ...props }, ref) => (
  <CommandPrimitive
    ref={ref}
    className={cn(
      "flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground",
      className
    )}
    {...props}
  />
))
Command.displayName = CommandPrimitive.displayName

const CommandDialog = ({ children, ...props }: DialogProps) => {
  return (
    <Dialog {...props}>
      <DialogContent className="overflow-hidden p-0 shadow-lg">
        <Command className="[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5">
          {children}
        </Command>
      </DialogContent>
    </Dialog>
  )
}

const CommandInput = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Input>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input>
>(({ className, ...props }, ref) => (
  <div className="flex items-center border-b px-3" cmdk-input-wrapper="">
    <Search className="mr-2 h-4 w-4 shrink-0 opacity-50" />
    <CommandPrimitive.Input
      ref={ref}
      className={cn(
        "flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50",
        className
      )}
      {...props}
    />
  </div>
))

CommandInput.displayName = CommandPrimitive.Input.displayName

const CommandList = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.List>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.List>
>(({ className, ...props }, ref) => (
  <CommandPrimitive.List
    ref={ref}
    className={cn("max-h-[300px] overflow-y-auto overflow-x-hidden", className)}
    {...props}
  />
))

CommandList.displayName = CommandPrimitive.List.displayName

const CommandEmpty = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Empty>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Empty>
>((props, ref) => (
  <CommandPrimitive.Empty
    ref={ref}
    className="py-6 text-center text-sm"
    {...props}
  />
))

CommandEmpty.displayName = CommandPrimitive.Empty.displayName

const CommandGroup = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Group>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Group>
>(({ className, ...props }, ref) => (
  <CommandPrimitive.Group
    ref={ref}
    className={cn(
      "overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground",
      className
    )}
    {...props}
  />
))

CommandGroup.displayName = CommandPrimitive.Group.displayName

const CommandSeparator = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <CommandPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 h-px bg-border", className)}
    {...props}
  />
))
CommandSeparator.displayName = CommandPrimitive.Separator.displayName

const CommandItem = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Item>
>(({ className, ...props }, ref) => (
  <CommandPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected='true']:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",
      className
    )}
    {...props}
  />
))

CommandItem.displayName = CommandPrimitive.Item.displayName

const CommandShortcut = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLSpanElement>) => {
  return (
    <span
      className={cn(
        "ml-auto text-xs tracking-widest text-muted-foreground",
        className
      )}
      {...props}
    />
  )
}
CommandShortcut.displayName = "CommandShortcut"

export {
  Command,
  CommandDialog,
  CommandInput,
  CommandList,
  CommandEmpty,
  CommandGroup,
  CommandItem,
  CommandShortcut,
  CommandSeparator,
}

===== ./client/src/components/ui/context-menu.tsx =====
import * as React from "react"
import * as ContextMenuPrimitive from "@radix-ui/react-context-menu"
import { Check, ChevronRight, Circle } from "lucide-react"

import { cn } from "@/lib/utils"

const ContextMenu = ContextMenuPrimitive.Root

const ContextMenuTrigger = ContextMenuPrimitive.Trigger

const ContextMenuGroup = ContextMenuPrimitive.Group

const ContextMenuPortal = ContextMenuPrimitive.Portal

const ContextMenuSub = ContextMenuPrimitive.Sub

const ContextMenuRadioGroup = ContextMenuPrimitive.RadioGroup

const ContextMenuSubTrigger = React.forwardRef<
  React.ElementRef<typeof ContextMenuPrimitive.SubTrigger>,
  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubTrigger> & {
    inset?: boolean
  }
>(({ className, inset, children, ...props }, ref) => (
  <ContextMenuPrimitive.SubTrigger
    ref={ref}
    className={cn(
      "flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground",
      inset && "pl-8",
      className
    )}
    {...props}
  >
    {children}
    <ChevronRight className="ml-auto h-4 w-4" />
  </ContextMenuPrimitive.SubTrigger>
))
ContextMenuSubTrigger.displayName = ContextMenuPrimitive.SubTrigger.displayName

const ContextMenuSubContent = React.forwardRef<
  React.ElementRef<typeof ContextMenuPrimitive.SubContent>,
  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubContent>
>(({ className, ...props }, ref) => (
  <ContextMenuPrimitive.SubContent
    ref={ref}
    className={cn(
      "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]",
      className
    )}
    {...props}
  />
))
ContextMenuSubContent.displayName = ContextMenuPrimitive.SubContent.displayName

const ContextMenuContent = React.forwardRef<
  React.ElementRef<typeof ContextMenuPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Content>
>(({ className, ...props }, ref) => (
  <ContextMenuPrimitive.Portal>
    <ContextMenuPrimitive.Content
      ref={ref}
      className={cn(
        "z-50 max-h-[--radix-context-menu-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md animate-in fade-in-80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]",
        className
      )}
      {...props}
    />
  </ContextMenuPrimitive.Portal>
))
ContextMenuContent.displayName = ContextMenuPrimitive.Content.displayName

const ContextMenuItem = React.forwardRef<
  React.ElementRef<typeof ContextMenuPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Item> & {
    inset?: boolean
  }
>(({ className, inset, ...props }, ref) => (
  <ContextMenuPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      inset && "pl-8",
      className
    )}
    {...props}
  />
))
ContextMenuItem.displayName = ContextMenuPrimitive.Item.displayName

const ContextMenuCheckboxItem = React.forwardRef<
  React.ElementRef<typeof ContextMenuPrimitive.CheckboxItem>,
  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.CheckboxItem>
>(({ className, children, checked, ...props }, ref) => (
  <ContextMenuPrimitive.CheckboxItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    checked={checked}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <ContextMenuPrimitive.ItemIndicator>
        <Check className="h-4 w-4" />
      </ContextMenuPrimitive.ItemIndicator>
    </span>
    {children}
  </ContextMenuPrimitive.CheckboxItem>
))
ContextMenuCheckboxItem.displayName =
  ContextMenuPrimitive.CheckboxItem.displayName

const ContextMenuRadioItem = React.forwardRef<
  React.ElementRef<typeof ContextMenuPrimitive.RadioItem>,
  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.RadioItem>
>(({ className, children, ...props }, ref) => (
  <ContextMenuPrimitive.RadioItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <ContextMenuPrimitive.ItemIndicator>
        <Circle className="h-2 w-2 fill-current" />
      </ContextMenuPrimitive.ItemIndicator>
    </span>
    {children}
  </ContextMenuPrimitive.RadioItem>
))
ContextMenuRadioItem.displayName = ContextMenuPrimitive.RadioItem.displayName

const ContextMenuLabel = React.forwardRef<
  React.ElementRef<typeof ContextMenuPrimitive.Label>,
  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Label> & {
    inset?: boolean
  }
>(({ className, inset, ...props }, ref) => (
  <ContextMenuPrimitive.Label
    ref={ref}
    className={cn(
      "px-2 py-1.5 text-sm font-semibold text-foreground",
      inset && "pl-8",
      className
    )}
    {...props}
  />
))
ContextMenuLabel.displayName = ContextMenuPrimitive.Label.displayName

const ContextMenuSeparator = React.forwardRef<
  React.ElementRef<typeof ContextMenuPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <ContextMenuPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 my-1 h-px bg-border", className)}
    {...props}
  />
))
ContextMenuSeparator.displayName = ContextMenuPrimitive.Separator.displayName

const ContextMenuShortcut = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLSpanElement>) => {
  return (
    <span
      className={cn(
        "ml-auto text-xs tracking-widest text-muted-foreground",
        className
      )}
      {...props}
    />
  )
}
ContextMenuShortcut.displayName = "ContextMenuShortcut"

export {
  ContextMenu,
  ContextMenuTrigger,
  ContextMenuContent,
  ContextMenuItem,
  ContextMenuCheckboxItem,
  ContextMenuRadioItem,
  ContextMenuLabel,
  ContextMenuSeparator,
  ContextMenuShortcut,
  ContextMenuGroup,
  ContextMenuPortal,
  ContextMenuSub,
  ContextMenuSubContent,
  ContextMenuSubTrigger,
  ContextMenuRadioGroup,
}

===== ./client/src/components/ui/dialog.tsx =====
"use client"

import * as React from "react"
import * as DialogPrimitive from "@radix-ui/react-dialog"
import { X } from "lucide-react"

import { cn } from "@/lib/utils"

const Dialog = DialogPrimitive.Root

const DialogTrigger = DialogPrimitive.Trigger

const DialogPortal = DialogPrimitive.Portal

const DialogClose = DialogPrimitive.Close

const DialogOverlay = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Overlay
    ref={ref}
    className={cn(
      "fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
      className
    )}
    {...props}
  />
))
DialogOverlay.displayName = DialogPrimitive.Overlay.displayName

const DialogContent = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>
>(({ className, children, ...props }, ref) => (
  <DialogPortal>
    <DialogOverlay />
    <DialogPrimitive.Content
      ref={ref}
      className={cn(
        "fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",
        // Mobile optimizations
        "max-h-[85vh] overflow-y-auto",
        "max-w-[calc(100vw-2rem)]",
        "sm:max-w-lg sm:max-h-none",
        className
      )}
      {...props}
    >
      {children}
      <DialogPrimitive.Close className="absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground">
        <X className="h-4 w-4" />
        <span className="sr-only">Close</span>
      </DialogPrimitive.Close>
    </DialogPrimitive.Content>
  </DialogPortal>
))
DialogContent.displayName = DialogPrimitive.Content.displayName

const DialogHeader = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col space-y-1.5 text-center sm:text-left",
      className
    )}
    {...props}
  />
)
DialogHeader.displayName = "DialogHeader"

const DialogFooter = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",
      className
    )}
    {...props}
  />
)
DialogFooter.displayName = "DialogFooter"

const DialogTitle = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Title
    ref={ref}
    className={cn(
      "text-lg font-semibold leading-none tracking-tight",
      className
    )}
    {...props}
  />
))
DialogTitle.displayName = DialogPrimitive.Title.displayName

const DialogDescription = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Description
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
DialogDescription.displayName = DialogPrimitive.Description.displayName

export {
  Dialog,
  DialogPortal,
  DialogOverlay,
  DialogClose,
  DialogTrigger,
  DialogContent,
  DialogHeader,
  DialogFooter,
  DialogTitle,
  DialogDescription,
}
===== ./client/src/components/ui/dinutri-bottom-nav.tsx =====
import * as React from "react";
import { cn } from "@/lib/utils";
import { Home, FileText, User } from "lucide-react";

interface DNutriBottomNavProps {
  className?: string;
  onItemClick?: (item: string) => void;
  activeItem?: string;
}

export function DNutriBottomNav({ className, onItemClick, activeItem = "home" }: DNutriBottomNavProps) {
  const navItems = [
    { id: "home", icon: Home, label: "Início" },
    { id: "prescription", icon: FileText, label: "Prescrição" },
    { id: "profile", icon: User, label: "Perfil" },
  ];

  const handleItemClick = (itemId: string) => {
    if (onItemClick) {
      onItemClick(itemId);
    }
  };

  return (
    <nav 
      className={cn(
        "fixed bottom-0 left-0 right-0 z-50 md:hidden",
        // Purple gradient background
        "bg-gradient-to-r from-[var(--dn-header-from)] to-[var(--dn-header-to)]",
        "px-2 py-2",
        "safe-area-inset-bottom",
        className
      )}
    >
      <div className="flex items-center justify-around max-w-screen-sm mx-auto">
        {navItems.map((item) => {
          const Icon = item.icon;
          const isActive = activeItem === item.id;
          
          return (
            <button
              key={item.id}
              onClick={() => handleItemClick(item.id)}
              className={cn(
                "flex flex-col items-center justify-center",
                "min-h-[60px] px-3 py-2",
                "text-xs font-medium",
                "transition-all duration-200",
                "relative",
                "focus:outline-none focus:ring-2 focus:ring-white focus:ring-offset-2 focus:ring-offset-purple-500",
                "active:scale-95",
                isActive 
                  ? "text-white" 
                  : "text-white/70 hover:text-white"
              )}
            >
              <div className="relative mb-1">
                <Icon className="h-5 w-5" />
              </div>
              <span className="truncate max-w-[60px] text-white">{item.label}</span>
            </button>
          );
        })}
      </div>
    </nav>
  );
}
===== ./client/src/components/ui/dinutri-logo.tsx =====
import React from "react";
import { cn } from "@/lib/utils";

interface DiNutriLogoProps {
  className?: string;
  size?: "sm" | "md" | "lg" | "xl";
  variant?: "full" | "icon";
}

// As classes de tamanho agora controlam a altura da imagem.
// A largura se ajustará automaticamente para manter a proporção.
const sizeClasses = {
  sm: "h-8",
  md: "h-10",
  lg: "h-12",
  xl: "h-16"
};

export function DiNutriLogo({ 
  className, 
  size = "md", 
  variant = "full" 
}: DiNutriLogoProps) {
  // Define a URL base para as imagens na pasta /public
  const baseUrl = "/";
  
  // Define qual imagem usar com base na variante.
  // Se a variante for 'icon', ele tentará carregar 'logo_dinutri_icon.png'.
  // Se a variante for 'full', ele carregará 'logo_dinutri.png'.
  const imageUrl = variant === 'icon' 
    ? `${baseUrl}logo_dinutri_icon.png` 
    : `${baseUrl}logo_dinutri.png`;

  // Imagem de fallback caso a imagem do ícone não exista.
  const fallbackUrl = `${baseUrl}logo_dinutri.png`;

  return (
    <img
      src={imageUrl}
      alt="DiNutri Logo"
      // Este evento é acionado se a imagem do ícone não for encontrada,
      // carregando a imagem completa como uma alternativa.
      onError={(e) => {
        const target = e.target as HTMLImageElement;
        // Evita um loop infinito se o fallback também falhar
        if (target.src !== window.location.origin + fallbackUrl) {
          target.onerror = null; // Limpa o handler para evitar loops
          target.src = fallbackUrl;
        }
      }}
      className={cn(
        "w-auto object-contain", // Mantém a proporção da imagem
        sizeClasses[size],
        className
      )}
    />
  );
}
===== ./client/src/components/ui/drawer.tsx =====
"use client"

import * as React from "react"
import { Drawer as DrawerPrimitive } from "vaul"

import { cn } from "@/lib/utils"

const Drawer = ({
  shouldScaleBackground = true,
  ...props
}: React.ComponentProps<typeof DrawerPrimitive.Root>) => (
  <DrawerPrimitive.Root
    shouldScaleBackground={shouldScaleBackground}
    {...props}
  />
)
Drawer.displayName = "Drawer"

const DrawerTrigger = DrawerPrimitive.Trigger

const DrawerPortal = DrawerPrimitive.Portal

const DrawerClose = DrawerPrimitive.Close

const DrawerOverlay = React.forwardRef<
  React.ElementRef<typeof DrawerPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <DrawerPrimitive.Overlay
    ref={ref}
    className={cn("fixed inset-0 z-50 bg-black/80", className)}
    {...props}
  />
))
DrawerOverlay.displayName = DrawerPrimitive.Overlay.displayName

const DrawerContent = React.forwardRef<
  React.ElementRef<typeof DrawerPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Content>
>(({ className, children, ...props }, ref) => (
  <DrawerPortal>
    <DrawerOverlay />
    <DrawerPrimitive.Content
      ref={ref}
      className={cn(
        "fixed inset-x-0 bottom-0 z-50 mt-24 flex h-auto flex-col rounded-t-[10px] border bg-background",
        className
      )}
      {...props}
    >
      <div className="mx-auto mt-4 h-2 w-[100px] rounded-full bg-muted" />
      {children}
    </DrawerPrimitive.Content>
  </DrawerPortal>
))
DrawerContent.displayName = "DrawerContent"

const DrawerHeader = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn("grid gap-1.5 p-4 text-center sm:text-left", className)}
    {...props}
  />
)
DrawerHeader.displayName = "DrawerHeader"

const DrawerFooter = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn("mt-auto flex flex-col gap-2 p-4", className)}
    {...props}
  />
)
DrawerFooter.displayName = "DrawerFooter"

const DrawerTitle = React.forwardRef<
  React.ElementRef<typeof DrawerPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Title>
>(({ className, ...props }, ref) => (
  <DrawerPrimitive.Title
    ref={ref}
    className={cn(
      "text-lg font-semibold leading-none tracking-tight",
      className
    )}
    {...props}
  />
))
DrawerTitle.displayName = DrawerPrimitive.Title.displayName

const DrawerDescription = React.forwardRef<
  React.ElementRef<typeof DrawerPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Description>
>(({ className, ...props }, ref) => (
  <DrawerPrimitive.Description
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
DrawerDescription.displayName = DrawerPrimitive.Description.displayName

export {
  Drawer,
  DrawerPortal,
  DrawerOverlay,
  DrawerTrigger,
  DrawerClose,
  DrawerContent,
  DrawerHeader,
  DrawerFooter,
  DrawerTitle,
  DrawerDescription,
}

===== ./client/src/components/ui/dropdown-menu.tsx =====
import * as React from "react"
import * as DropdownMenuPrimitive from "@radix-ui/react-dropdown-menu"
import { Check, ChevronRight, Circle } from "lucide-react"

import { cn } from "@/lib/utils"

const DropdownMenu = DropdownMenuPrimitive.Root

const DropdownMenuTrigger = DropdownMenuPrimitive.Trigger

const DropdownMenuGroup = DropdownMenuPrimitive.Group

const DropdownMenuPortal = DropdownMenuPrimitive.Portal

const DropdownMenuSub = DropdownMenuPrimitive.Sub

const DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup

const DropdownMenuSubTrigger = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {
    inset?: boolean
  }
>(({ className, inset, children, ...props }, ref) => (
  <DropdownMenuPrimitive.SubTrigger
    ref={ref}
    className={cn(
      "flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",
      inset && "pl-8",
      className
    )}
    {...props}
  >
    {children}
    <ChevronRight className="ml-auto" />
  </DropdownMenuPrimitive.SubTrigger>
))
DropdownMenuSubTrigger.displayName =
  DropdownMenuPrimitive.SubTrigger.displayName

const DropdownMenuSubContent = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>
>(({ className, ...props }, ref) => (
  <DropdownMenuPrimitive.SubContent
    ref={ref}
    className={cn(
      "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]",
      className
    )}
    {...props}
  />
))
DropdownMenuSubContent.displayName =
  DropdownMenuPrimitive.SubContent.displayName

const DropdownMenuContent = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>
>(({ className, sideOffset = 4, ...props }, ref) => (
  <DropdownMenuPrimitive.Portal>
    <DropdownMenuPrimitive.Content
      ref={ref}
      sideOffset={sideOffset}
      className={cn(
        "z-50 max-h-[var(--radix-dropdown-menu-content-available-height)] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]",
        className
      )}
      {...props}
    />
  </DropdownMenuPrimitive.Portal>
))
DropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName

const DropdownMenuItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {
    inset?: boolean
  }
>(({ className, inset, ...props }, ref) => (
  <DropdownMenuPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",
      inset && "pl-8",
      className
    )}
    {...props}
  />
))
DropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName

const DropdownMenuCheckboxItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>
>(({ className, children, checked, ...props }, ref) => (
  <DropdownMenuPrimitive.CheckboxItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    checked={checked}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <DropdownMenuPrimitive.ItemIndicator>
        <Check className="h-4 w-4" />
      </DropdownMenuPrimitive.ItemIndicator>
    </span>
    {children}
  </DropdownMenuPrimitive.CheckboxItem>
))
DropdownMenuCheckboxItem.displayName =
  DropdownMenuPrimitive.CheckboxItem.displayName

const DropdownMenuRadioItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>
>(({ className, children, ...props }, ref) => (
  <DropdownMenuPrimitive.RadioItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <DropdownMenuPrimitive.ItemIndicator>
        <Circle className="h-2 w-2 fill-current" />
      </DropdownMenuPrimitive.ItemIndicator>
    </span>
    {children}
  </DropdownMenuPrimitive.RadioItem>
))
DropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName

const DropdownMenuLabel = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Label>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {
    inset?: boolean
  }
>(({ className, inset, ...props }, ref) => (
  <DropdownMenuPrimitive.Label
    ref={ref}
    className={cn(
      "px-2 py-1.5 text-sm font-semibold",
      inset && "pl-8",
      className
    )}
    {...props}
  />
))
DropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName

const DropdownMenuSeparator = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <DropdownMenuPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 my-1 h-px bg-muted", className)}
    {...props}
  />
))
DropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName

const DropdownMenuShortcut = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLSpanElement>) => {
  return (
    <span
      className={cn("ml-auto text-xs tracking-widest opacity-60", className)}
      {...props}
    />
  )
}
DropdownMenuShortcut.displayName = "DropdownMenuShortcut"

export {
  DropdownMenu,
  DropdownMenuTrigger,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuCheckboxItem,
  DropdownMenuRadioItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuShortcut,
  DropdownMenuGroup,
  DropdownMenuPortal,
  DropdownMenuSub,
  DropdownMenuSubContent,
  DropdownMenuSubTrigger,
  DropdownMenuRadioGroup,
}

===== ./client/src/components/ui/form.tsx =====
"use client"

import * as React from "react"
import * as LabelPrimitive from "@radix-ui/react-label"
import { Slot } from "@radix-ui/react-slot"
import {
  Controller,
  FormProvider,
  useFormContext,
  type ControllerProps,
  type FieldPath,
  type FieldValues,
} from "react-hook-form"

import { cn } from "@/lib/utils"
import { Label } from "@/components/ui/label"

const Form = FormProvider

type FormFieldContextValue<
  TFieldValues extends FieldValues = FieldValues,
  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>
> = {
  name: TName
}

const FormFieldContext = React.createContext<FormFieldContextValue>(
  {} as FormFieldContextValue
)

const FormField = <
  TFieldValues extends FieldValues = FieldValues,
  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>
>({
  ...props
}: ControllerProps<TFieldValues, TName>) => {
  return (
    <FormFieldContext.Provider value={{ name: props.name }}>
      <Controller {...props} />
    </FormFieldContext.Provider>
  )
}

const useFormField = () => {
  const fieldContext = React.useContext(FormFieldContext)
  const itemContext = React.useContext(FormItemContext)
  const { getFieldState, formState } = useFormContext()

  const fieldState = getFieldState(fieldContext.name, formState)

  if (!fieldContext) {
    throw new Error("useFormField should be used within <FormField>")
  }

  const { id } = itemContext

  return {
    id,
    name: fieldContext.name,
    formItemId: `${id}-form-item`,
    formDescriptionId: `${id}-form-item-description`,
    formMessageId: `${id}-form-item-message`,
    ...fieldState,
  }
}

type FormItemContextValue = {
  id: string
}

const FormItemContext = React.createContext<FormItemContextValue>(
  {} as FormItemContextValue
)

const FormItem = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => {
  const id = React.useId()

  return (
    <FormItemContext.Provider value={{ id }}>
      <div ref={ref} className={cn("space-y-2", className)} {...props} />
    </FormItemContext.Provider>
  )
})
FormItem.displayName = "FormItem"

const FormLabel = React.forwardRef<
  React.ElementRef<typeof LabelPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>
>(({ className, ...props }, ref) => {
  const { error, formItemId } = useFormField()

  return (
    <Label
      ref={ref}
      className={cn(error && "text-destructive", className)}
      htmlFor={formItemId}
      {...props}
    />
  )
})
FormLabel.displayName = "FormLabel"

const FormControl = React.forwardRef<
  React.ElementRef<typeof Slot>,
  React.ComponentPropsWithoutRef<typeof Slot>
>(({ ...props }, ref) => {
  const { error, formItemId, formDescriptionId, formMessageId } = useFormField()

  return (
    <Slot
      ref={ref}
      id={formItemId}
      aria-describedby={
        !error
          ? `${formDescriptionId}`
          : `${formDescriptionId} ${formMessageId}`
      }
      aria-invalid={!!error}
      {...props}
    />
  )
})
FormControl.displayName = "FormControl"

const FormDescription = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLParagraphElement>
>(({ className, ...props }, ref) => {
  const { formDescriptionId } = useFormField()

  return (
    <p
      ref={ref}
      id={formDescriptionId}
      className={cn("text-sm text-muted-foreground", className)}
      {...props}
    />
  )
})
FormDescription.displayName = "FormDescription"

const FormMessage = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLParagraphElement>
>(({ className, children, ...props }, ref) => {
  const { error, formMessageId } = useFormField()
  const body = error ? String(error?.message ?? "") : children

  if (!body) {
    return null
  }

  return (
    <p
      ref={ref}
      id={formMessageId}
      className={cn("text-sm font-medium text-destructive", className)}
      {...props}
    >
      {body}
    </p>
  )
})
FormMessage.displayName = "FormMessage"

export {
  useFormField,
  Form,
  FormItem,
  FormLabel,
  FormControl,
  FormDescription,
  FormMessage,
  FormField,
}

===== ./client/src/components/ui/goal-card.tsx =====
import * as React from "react";
import { cn } from "@/lib/utils";

interface GoalCardProps {
  goal: string;
  className?: string;
}

export function GoalCard({ goal, className }: GoalCardProps) {
  return (
    <div
      className={cn(
        // Layout and positioning
        "bg-white/10 backdrop-blur-sm border border-white/20",
        "rounded-xl px-6 py-4 mx-4 mb-6",
        // Shadow and styling
        "shadow-md",
        // Text styling
        "text-center",
        className
      )}
    >
      <h2 className="text-white text-xl font-semibold">
        {goal}
      </h2>
    </div>
  );
}
===== ./client/src/components/ui/header-dinutri.tsx =====
import * as React from "react";
import { cn } from "@/lib/utils";
import { DiNutriLogo } from "@/components/ui/dinutri-logo";
import { GoalCard } from "@/components/ui/goal-card";
import { useAuth } from "@/hooks/useAuth";
import { MobileDrawer } from "@/components/mobile/drawer";
import { DefaultMobileDrawer } from "@/components/layout/mobile-layout";

interface HeaderDNutriProps {
  className?: string;
  showGoalCard?: boolean;
  goalText?: string;
  onProfileClick?: () => void;
}

export function HeaderDNutri({ 
  className, 
  showGoalCard = true, 
  goalText = "Seu Plano Alimentar",
  onProfileClick
}: HeaderDNutriProps) {
  const { user } = useAuth();
  const userName = (user as any)?.firstName || (user as any)?.email?.split('@')[0] || "Usuário";

  return (
    <header 
      className={cn(
        // Purple gradient background
        "bg-gradient-to-r from-[var(--dn-header-from)] to-[var(--dn-header-to)]",
        // Layout
        "px-4 py-3 pb-0",
        // Safe area for mobile
        "safe-area-inset-top",
        className
      )}
    >
      {/* Top bar with hamburger menu, logo and user chip */}
      <div className="flex items-center justify-between mb-4">
        {/* Left side: Hamburger menu + Logo */}
        <div className="flex items-center space-x-3">
          {/* Hamburger menu */}
          <MobileDrawer title="Menu">
            <DefaultMobileDrawer onProfileClick={onProfileClick} />
          </MobileDrawer>
          
          {/* Logo */}
          <DiNutriLogo 
            size="sm" 
            variant="full" 
            className="h-8 brightness-0 invert" // Make logo white
          />
        </div>
        
        {/* Right side: User chip (display only) */}
        <div 
          className="bg-white/20 backdrop-blur-sm rounded-full px-4 py-2"
          aria-label={`Usuário: ${userName}`}
        >
          <span className="text-white text-sm font-medium">
            {userName}
          </span>
        </div>
      </div>

      {/* Goal card */}
      {showGoalCard && (
        <GoalCard goal={goalText} />
      )}
    </header>
  );
}
===== ./client/src/components/ui/hover-card.tsx =====
"use client"

import * as React from "react"
import * as HoverCardPrimitive from "@radix-ui/react-hover-card"

import { cn } from "@/lib/utils"

const HoverCard = HoverCardPrimitive.Root

const HoverCardTrigger = HoverCardPrimitive.Trigger

const HoverCardContent = React.forwardRef<
  React.ElementRef<typeof HoverCardPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof HoverCardPrimitive.Content>
>(({ className, align = "center", sideOffset = 4, ...props }, ref) => (
  <HoverCardPrimitive.Content
    ref={ref}
    align={align}
    sideOffset={sideOffset}
    className={cn(
      "z-50 w-64 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-hover-card-content-transform-origin]",
      className
    )}
    {...props}
  />
))
HoverCardContent.displayName = HoverCardPrimitive.Content.displayName

export { HoverCard, HoverCardTrigger, HoverCardContent }

===== ./client/src/components/ui/input-otp.tsx =====
import * as React from "react"
import { OTPInput, OTPInputContext } from "input-otp"
import { Dot } from "lucide-react"

import { cn } from "@/lib/utils"

const InputOTP = React.forwardRef<
  React.ElementRef<typeof OTPInput>,
  React.ComponentPropsWithoutRef<typeof OTPInput>
>(({ className, containerClassName, ...props }, ref) => (
  <OTPInput
    ref={ref}
    containerClassName={cn(
      "flex items-center gap-2 has-[:disabled]:opacity-50",
      containerClassName
    )}
    className={cn("disabled:cursor-not-allowed", className)}
    {...props}
  />
))
InputOTP.displayName = "InputOTP"

const InputOTPGroup = React.forwardRef<
  React.ElementRef<"div">,
  React.ComponentPropsWithoutRef<"div">
>(({ className, ...props }, ref) => (
  <div ref={ref} className={cn("flex items-center", className)} {...props} />
))
InputOTPGroup.displayName = "InputOTPGroup"

const InputOTPSlot = React.forwardRef<
  React.ElementRef<"div">,
  React.ComponentPropsWithoutRef<"div"> & { index: number }
>(({ index, className, ...props }, ref) => {
  const inputOTPContext = React.useContext(OTPInputContext)
  const { char, hasFakeCaret, isActive } = inputOTPContext.slots[index]

  return (
    <div
      ref={ref}
      className={cn(
        "relative flex h-10 w-10 items-center justify-center border-y border-r border-input text-sm transition-all first:rounded-l-md first:border-l last:rounded-r-md",
        isActive && "z-10 ring-2 ring-ring ring-offset-background",
        className
      )}
      {...props}
    >
      {char}
      {hasFakeCaret && (
        <div className="pointer-events-none absolute inset-0 flex items-center justify-center">
          <div className="h-4 w-px animate-caret-blink bg-foreground duration-1000" />
        </div>
      )}
    </div>
  )
})
InputOTPSlot.displayName = "InputOTPSlot"

const InputOTPSeparator = React.forwardRef<
  React.ElementRef<"div">,
  React.ComponentPropsWithoutRef<"div">
>(({ ...props }, ref) => (
  <div ref={ref} role="separator" {...props}>
    <Dot />
  </div>
))
InputOTPSeparator.displayName = "InputOTPSeparator"

export { InputOTP, InputOTPGroup, InputOTPSlot, InputOTPSeparator }

===== ./client/src/components/ui/input.tsx =====
import * as React from "react"

import { cn } from "@/lib/utils"

const Input = React.forwardRef<HTMLInputElement, React.ComponentProps<"input">>(
  ({ className, type, ...props }, ref) => {
    return (
      <input
        type={type}
        className={cn(
          "flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
          className
        )}
        ref={ref}
        {...props}
      />
    )
  }
)
Input.displayName = "Input"

export { Input }

===== ./client/src/components/ui/label.tsx =====
import * as React from "react"
import * as LabelPrimitive from "@radix-ui/react-label"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const labelVariants = cva(
  "text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"
)

const Label = React.forwardRef<
  React.ElementRef<typeof LabelPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &
    VariantProps<typeof labelVariants>
>(({ className, ...props }, ref) => (
  <LabelPrimitive.Root
    ref={ref}
    className={cn(labelVariants(), className)}
    {...props}
  />
))
Label.displayName = LabelPrimitive.Root.displayName

export { Label }

===== ./client/src/components/ui/meal-card.tsx =====
import * as React from "react";
import { cn } from "@/lib/utils";
import { LucideIcon } from "lucide-react";

interface MealCardProps {
  title: string;
  icon: LucideIcon;
  onClick?: () => void;
  className?: string;
}

export function MealCard({ title, icon: Icon, onClick, className }: MealCardProps) {
  return (
    <button
      onClick={onClick}
      className={cn(
        // Base styles
        "w-full h-24 rounded-xl shadow-md transition-all duration-200",
        // Gradient background (salmon to peach)
        "bg-gradient-to-r from-[var(--dn-meal-from)] to-[var(--dn-meal-to)]",
        // Layout
        "flex items-center justify-start px-6 gap-4",
        // Text styling
        "text-white font-semibold text-lg",
        // Hover effects
        "hover:scale-[1.02] hover:shadow-lg",
        // Focus styles for accessibility
        "focus:outline-none focus:ring-2 focus:ring-white focus:ring-offset-2 focus:ring-offset-purple-500",
        className
      )}
      aria-label={`Acessar ${title}`}
    >
      <Icon className="h-6 w-6 text-white flex-shrink-0" />
      <span className="text-white">{title}</span>
    </button>
  );
}
===== ./client/src/components/ui/menubar.tsx =====
"use client"

import * as React from "react"
import * as MenubarPrimitive from "@radix-ui/react-menubar"
import { Check, ChevronRight, Circle } from "lucide-react"

import { cn } from "@/lib/utils"

function MenubarMenu({
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Menu>) {
  return <MenubarPrimitive.Menu {...props} />
}

function MenubarGroup({
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Group>) {
  return <MenubarPrimitive.Group {...props} />
}

function MenubarPortal({
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Portal>) {
  return <MenubarPrimitive.Portal {...props} />
}

function MenubarRadioGroup({
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.RadioGroup>) {
  return <MenubarPrimitive.RadioGroup {...props} />
}

function MenubarSub({
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Sub>) {
  return <MenubarPrimitive.Sub data-slot="menubar-sub" {...props} />
}

const Menubar = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Root>
>(({ className, ...props }, ref) => (
  <MenubarPrimitive.Root
    ref={ref}
    className={cn(
      "flex h-10 items-center space-x-1 rounded-md border bg-background p-1",
      className
    )}
    {...props}
  />
))
Menubar.displayName = MenubarPrimitive.Root.displayName

const MenubarTrigger = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Trigger>
>(({ className, ...props }, ref) => (
  <MenubarPrimitive.Trigger
    ref={ref}
    className={cn(
      "flex cursor-default select-none items-center rounded-sm px-3 py-1.5 text-sm font-medium outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground",
      className
    )}
    {...props}
  />
))
MenubarTrigger.displayName = MenubarPrimitive.Trigger.displayName

const MenubarSubTrigger = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.SubTrigger>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubTrigger> & {
    inset?: boolean
  }
>(({ className, inset, children, ...props }, ref) => (
  <MenubarPrimitive.SubTrigger
    ref={ref}
    className={cn(
      "flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground",
      inset && "pl-8",
      className
    )}
    {...props}
  >
    {children}
    <ChevronRight className="ml-auto h-4 w-4" />
  </MenubarPrimitive.SubTrigger>
))
MenubarSubTrigger.displayName = MenubarPrimitive.SubTrigger.displayName

const MenubarSubContent = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.SubContent>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubContent>
>(({ className, ...props }, ref) => (
  <MenubarPrimitive.SubContent
    ref={ref}
    className={cn(
      "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]",
      className
    )}
    {...props}
  />
))
MenubarSubContent.displayName = MenubarPrimitive.SubContent.displayName

const MenubarContent = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Content>
>(
  (
    { className, align = "start", alignOffset = -4, sideOffset = 8, ...props },
    ref
  ) => (
    <MenubarPrimitive.Portal>
      <MenubarPrimitive.Content
        ref={ref}
        align={align}
        alignOffset={alignOffset}
        sideOffset={sideOffset}
        className={cn(
          "z-50 min-w-[12rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]",
          className
        )}
        {...props}
      />
    </MenubarPrimitive.Portal>
  )
)
MenubarContent.displayName = MenubarPrimitive.Content.displayName

const MenubarItem = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Item> & {
    inset?: boolean
  }
>(({ className, inset, ...props }, ref) => (
  <MenubarPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      inset && "pl-8",
      className
    )}
    {...props}
  />
))
MenubarItem.displayName = MenubarPrimitive.Item.displayName

const MenubarCheckboxItem = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.CheckboxItem>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.CheckboxItem>
>(({ className, children, checked, ...props }, ref) => (
  <MenubarPrimitive.CheckboxItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    checked={checked}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <MenubarPrimitive.ItemIndicator>
        <Check className="h-4 w-4" />
      </MenubarPrimitive.ItemIndicator>
    </span>
    {children}
  </MenubarPrimitive.CheckboxItem>
))
MenubarCheckboxItem.displayName = MenubarPrimitive.CheckboxItem.displayName

const MenubarRadioItem = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.RadioItem>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.RadioItem>
>(({ className, children, ...props }, ref) => (
  <MenubarPrimitive.RadioItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <MenubarPrimitive.ItemIndicator>
        <Circle className="h-2 w-2 fill-current" />
      </MenubarPrimitive.ItemIndicator>
    </span>
    {children}
  </MenubarPrimitive.RadioItem>
))
MenubarRadioItem.displayName = MenubarPrimitive.RadioItem.displayName

const MenubarLabel = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.Label>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Label> & {
    inset?: boolean
  }
>(({ className, inset, ...props }, ref) => (
  <MenubarPrimitive.Label
    ref={ref}
    className={cn(
      "px-2 py-1.5 text-sm font-semibold",
      inset && "pl-8",
      className
    )}
    {...props}
  />
))
MenubarLabel.displayName = MenubarPrimitive.Label.displayName

const MenubarSeparator = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <MenubarPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 my-1 h-px bg-muted", className)}
    {...props}
  />
))
MenubarSeparator.displayName = MenubarPrimitive.Separator.displayName

const MenubarShortcut = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLSpanElement>) => {
  return (
    <span
      className={cn(
        "ml-auto text-xs tracking-widest text-muted-foreground",
        className
      )}
      {...props}
    />
  )
}
MenubarShortcut.displayname = "MenubarShortcut"

export {
  Menubar,
  MenubarMenu,
  MenubarTrigger,
  MenubarContent,
  MenubarItem,
  MenubarSeparator,
  MenubarLabel,
  MenubarCheckboxItem,
  MenubarRadioGroup,
  MenubarRadioItem,
  MenubarPortal,
  MenubarSubContent,
  MenubarSubTrigger,
  MenubarGroup,
  MenubarSub,
  MenubarShortcut,
}

===== ./client/src/components/ui/navigation-menu.tsx =====
import * as React from "react"
import * as NavigationMenuPrimitive from "@radix-ui/react-navigation-menu"
import { cva } from "class-variance-authority"
import { ChevronDown } from "lucide-react"

import { cn } from "@/lib/utils"

const NavigationMenu = React.forwardRef<
  React.ElementRef<typeof NavigationMenuPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Root>
>(({ className, children, ...props }, ref) => (
  <NavigationMenuPrimitive.Root
    ref={ref}
    className={cn(
      "relative z-10 flex max-w-max flex-1 items-center justify-center",
      className
    )}
    {...props}
  >
    {children}
    <NavigationMenuViewport />
  </NavigationMenuPrimitive.Root>
))
NavigationMenu.displayName = NavigationMenuPrimitive.Root.displayName

const NavigationMenuList = React.forwardRef<
  React.ElementRef<typeof NavigationMenuPrimitive.List>,
  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.List>
>(({ className, ...props }, ref) => (
  <NavigationMenuPrimitive.List
    ref={ref}
    className={cn(
      "group flex flex-1 list-none items-center justify-center space-x-1",
      className
    )}
    {...props}
  />
))
NavigationMenuList.displayName = NavigationMenuPrimitive.List.displayName

const NavigationMenuItem = NavigationMenuPrimitive.Item

const navigationMenuTriggerStyle = cva(
  "group inline-flex h-10 w-max items-center justify-center rounded-md bg-background px-4 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus:outline-none disabled:pointer-events-none disabled:opacity-50 data-[state=open]:text-accent-foreground data-[state=open]:bg-accent/50 data-[state=open]:hover:bg-accent data-[state=open]:focus:bg-accent"
)

const NavigationMenuTrigger = React.forwardRef<
  React.ElementRef<typeof NavigationMenuPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Trigger>
>(({ className, children, ...props }, ref) => (
  <NavigationMenuPrimitive.Trigger
    ref={ref}
    className={cn(navigationMenuTriggerStyle(), "group", className)}
    {...props}
  >
    {children}{" "}
    <ChevronDown
      className="relative top-[1px] ml-1 h-3 w-3 transition duration-200 group-data-[state=open]:rotate-180"
      aria-hidden="true"
    />
  </NavigationMenuPrimitive.Trigger>
))
NavigationMenuTrigger.displayName = NavigationMenuPrimitive.Trigger.displayName

const NavigationMenuContent = React.forwardRef<
  React.ElementRef<typeof NavigationMenuPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Content>
>(({ className, ...props }, ref) => (
  <NavigationMenuPrimitive.Content
    ref={ref}
    className={cn(
      "left-0 top-0 w-full data-[motion^=from-]:animate-in data-[motion^=to-]:animate-out data-[motion^=from-]:fade-in data-[motion^=to-]:fade-out data-[motion=from-end]:slide-in-from-right-52 data-[motion=from-start]:slide-in-from-left-52 data-[motion=to-end]:slide-out-to-right-52 data-[motion=to-start]:slide-out-to-left-52 md:absolute md:w-auto ",
      className
    )}
    {...props}
  />
))
NavigationMenuContent.displayName = NavigationMenuPrimitive.Content.displayName

const NavigationMenuLink = NavigationMenuPrimitive.Link

const NavigationMenuViewport = React.forwardRef<
  React.ElementRef<typeof NavigationMenuPrimitive.Viewport>,
  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Viewport>
>(({ className, ...props }, ref) => (
  <div className={cn("absolute left-0 top-full flex justify-center")}>
    <NavigationMenuPrimitive.Viewport
      className={cn(
        "origin-top-center relative mt-1.5 h-[var(--radix-navigation-menu-viewport-height)] w-full overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-90 md:w-[var(--radix-navigation-menu-viewport-width)]",
        className
      )}
      ref={ref}
      {...props}
    />
  </div>
))
NavigationMenuViewport.displayName =
  NavigationMenuPrimitive.Viewport.displayName

const NavigationMenuIndicator = React.forwardRef<
  React.ElementRef<typeof NavigationMenuPrimitive.Indicator>,
  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Indicator>
>(({ className, ...props }, ref) => (
  <NavigationMenuPrimitive.Indicator
    ref={ref}
    className={cn(
      "top-full z-[1] flex h-1.5 items-end justify-center overflow-hidden data-[state=visible]:animate-in data-[state=hidden]:animate-out data-[state=hidden]:fade-out data-[state=visible]:fade-in",
      className
    )}
    {...props}
  >
    <div className="relative top-[60%] h-2 w-2 rotate-45 rounded-tl-sm bg-border shadow-md" />
  </NavigationMenuPrimitive.Indicator>
))
NavigationMenuIndicator.displayName =
  NavigationMenuPrimitive.Indicator.displayName

export {
  navigationMenuTriggerStyle,
  NavigationMenu,
  NavigationMenuList,
  NavigationMenuItem,
  NavigationMenuContent,
  NavigationMenuTrigger,
  NavigationMenuLink,
  NavigationMenuIndicator,
  NavigationMenuViewport,
}

===== ./client/src/components/ui/pagination.tsx =====
import * as React from "react"
import { ChevronLeft, ChevronRight, MoreHorizontal } from "lucide-react"

import { cn } from "@/lib/utils"
import { ButtonProps, buttonVariants } from "@/components/ui/button"

const Pagination = ({ className, ...props }: React.ComponentProps<"nav">) => (
  <nav
    role="navigation"
    aria-label="pagination"
    className={cn("mx-auto flex w-full justify-center", className)}
    {...props}
  />
)
Pagination.displayName = "Pagination"

const PaginationContent = React.forwardRef<
  HTMLUListElement,
  React.ComponentProps<"ul">
>(({ className, ...props }, ref) => (
  <ul
    ref={ref}
    className={cn("flex flex-row items-center gap-1", className)}
    {...props}
  />
))
PaginationContent.displayName = "PaginationContent"

const PaginationItem = React.forwardRef<
  HTMLLIElement,
  React.ComponentProps<"li">
>(({ className, ...props }, ref) => (
  <li ref={ref} className={cn("", className)} {...props} />
))
PaginationItem.displayName = "PaginationItem"

type PaginationLinkProps = {
  isActive?: boolean
} & Pick<ButtonProps, "size"> &
  React.ComponentProps<"a">

const PaginationLink = ({
  className,
  isActive,
  size = "icon",
  ...props
}: PaginationLinkProps) => (
  <a
    aria-current={isActive ? "page" : undefined}
    className={cn(
      buttonVariants({
        variant: isActive ? "outline" : "ghost",
        size,
      }),
      className
    )}
    {...props}
  />
)
PaginationLink.displayName = "PaginationLink"

const PaginationPrevious = ({
  className,
  ...props
}: React.ComponentProps<typeof PaginationLink>) => (
  <PaginationLink
    aria-label="Go to previous page"
    size="default"
    className={cn("gap-1 pl-2.5", className)}
    {...props}
  >
    <ChevronLeft className="h-4 w-4" />
    <span>Previous</span>
  </PaginationLink>
)
PaginationPrevious.displayName = "PaginationPrevious"

const PaginationNext = ({
  className,
  ...props
}: React.ComponentProps<typeof PaginationLink>) => (
  <PaginationLink
    aria-label="Go to next page"
    size="default"
    className={cn("gap-1 pr-2.5", className)}
    {...props}
  >
    <span>Next</span>
    <ChevronRight className="h-4 w-4" />
  </PaginationLink>
)
PaginationNext.displayName = "PaginationNext"

const PaginationEllipsis = ({
  className,
  ...props
}: React.ComponentProps<"span">) => (
  <span
    aria-hidden
    className={cn("flex h-9 w-9 items-center justify-center", className)}
    {...props}
  >
    <MoreHorizontal className="h-4 w-4" />
    <span className="sr-only">More pages</span>
  </span>
)
PaginationEllipsis.displayName = "PaginationEllipsis"

export {
  Pagination,
  PaginationContent,
  PaginationEllipsis,
  PaginationItem,
  PaginationLink,
  PaginationNext,
  PaginationPrevious,
}

===== ./client/src/components/ui/popover.tsx =====
import * as React from "react"
import * as PopoverPrimitive from "@radix-ui/react-popover"

import { cn } from "@/lib/utils"

const Popover = PopoverPrimitive.Root

const PopoverTrigger = PopoverPrimitive.Trigger

const PopoverContent = React.forwardRef<
  React.ElementRef<typeof PopoverPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>
>(({ className, align = "center", sideOffset = 4, ...props }, ref) => (
  <PopoverPrimitive.Portal>
    <PopoverPrimitive.Content
      ref={ref}
      align={align}
      sideOffset={sideOffset}
      className={cn(
        "z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-popover-content-transform-origin]",
        className
      )}
      {...props}
    />
  </PopoverPrimitive.Portal>
))
PopoverContent.displayName = PopoverPrimitive.Content.displayName

export { Popover, PopoverTrigger, PopoverContent }

===== ./client/src/components/ui/profile-modal.tsx =====
import * as React from "react";
import { Dialog, DialogContent, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import { Card, CardContent } from "@/components/ui/card";
import { User, Mail, Calendar, Ruler, Weight, FileText } from "lucide-react";
import type { Patient } from "@shared/schema";

interface ProfileModalProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  patient: Patient | null;
}

export function ProfileModal({ open, onOpenChange, patient }: ProfileModalProps) {
  if (!patient) return null;

  const formatDate = (dateString: string | null) => {
    if (!dateString) return "Não informado";
    try {
      const date = new Date(dateString);
      return date.toLocaleDateString('pt-BR');
    } catch {
      return dateString;
    }
  };

  const getSexLabel = (sex: string | null) => {
    switch (sex) {
      case "M": return "Masculino";
      case "F": return "Feminino";
      case "Outro": return "Outro";
      default: return "Não informado";
    }
  };

  const profileItems = [
    {
      icon: User,
      label: "Nome",
      value: patient.name || "Não informado"
    },
    {
      icon: Mail,
      label: "Email",
      value: patient.email || "Não informado"
    },
    {
      icon: Calendar,
      label: "Data de Nascimento",
      value: formatDate(patient.birthDate)
    },
    {
      icon: User,
      label: "Sexo",
      value: getSexLabel(patient.sex)
    },
    {
      icon: Ruler,
      label: "Altura",
      value: patient.heightCm ? `${patient.heightCm} cm` : "Não informado"
    },
    {
      icon: Weight,
      label: "Peso",
      value: patient.weightKg ? `${patient.weightKg} kg` : "Não informado"
    }
  ];

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="w-[90vw] max-w-[90vw] sm:max-w-md mx-0 left-[50%] right-auto translate-x-[-50%]">
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2">
            <User className="h-5 w-5" />
            Meu Perfil
          </DialogTitle>
        </DialogHeader>
        
        <div className="space-y-4">
          {profileItems.map((item, index) => {
            const Icon = item.icon;
            return (
              <Card key={index} className="border-l-4 border-l-purple-500">
                <CardContent className="p-4">
                  <div className="flex items-center gap-3">
                    <div className="flex-shrink-0">
                      <Icon className="h-5 w-5 text-purple-600" />
                    </div>
                    <div className="flex-1 min-w-0">
                      <p className="text-sm font-medium text-gray-900">
                        {item.label}
                      </p>
                      <p className="text-sm text-gray-600 truncate">
                        {item.value}
                      </p>
                    </div>
                  </div>
                </CardContent>
              </Card>
            );
          })}
          
          {patient.notes && (
            <Card className="border-l-4 border-l-purple-500">
              <CardContent className="p-4">
                <div className="flex items-start gap-3">
                  <div className="flex-shrink-0">
                    <FileText className="h-5 w-5 text-purple-600" />
                  </div>
                  <div className="flex-1 min-w-0">
                    <p className="text-sm font-medium text-gray-900 mb-1">
                      Observações
                    </p>
                    <p className="text-sm text-gray-600 whitespace-pre-wrap">
                      {patient.notes}
                    </p>
                  </div>
                </div>
              </CardContent>
            </Card>
          )}
        </div>
      </DialogContent>
    </Dialog>
  );
}
===== ./client/src/components/ui/progress.tsx =====
"use client"

import * as React from "react"
import * as ProgressPrimitive from "@radix-ui/react-progress"

import { cn } from "@/lib/utils"

const Progress = React.forwardRef<
  React.ElementRef<typeof ProgressPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root>
>(({ className, value, ...props }, ref) => (
  <ProgressPrimitive.Root
    ref={ref}
    className={cn(
      "relative h-4 w-full overflow-hidden rounded-full bg-secondary",
      className
    )}
    {...props}
  >
    <ProgressPrimitive.Indicator
      className="h-full w-full flex-1 bg-primary transition-all"
      style={{ transform: `translateX(-${100 - (value || 0)}%)` }}
    />
  </ProgressPrimitive.Root>
))
Progress.displayName = ProgressPrimitive.Root.displayName

export { Progress }

===== ./client/src/components/ui/radio-group.tsx =====
import * as React from "react"
import * as RadioGroupPrimitive from "@radix-ui/react-radio-group"
import { Circle } from "lucide-react"

import { cn } from "@/lib/utils"

const RadioGroup = React.forwardRef<
  React.ElementRef<typeof RadioGroupPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Root>
>(({ className, ...props }, ref) => {
  return (
    <RadioGroupPrimitive.Root
      className={cn("grid gap-2", className)}
      {...props}
      ref={ref}
    />
  )
})
RadioGroup.displayName = RadioGroupPrimitive.Root.displayName

const RadioGroupItem = React.forwardRef<
  React.ElementRef<typeof RadioGroupPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Item>
>(({ className, ...props }, ref) => {
  return (
    <RadioGroupPrimitive.Item
      ref={ref}
      className={cn(
        "aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",
        className
      )}
      {...props}
    >
      <RadioGroupPrimitive.Indicator className="flex items-center justify-center">
        <Circle className="h-2.5 w-2.5 fill-current text-current" />
      </RadioGroupPrimitive.Indicator>
    </RadioGroupPrimitive.Item>
  )
})
RadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName

export { RadioGroup, RadioGroupItem }

===== ./client/src/components/ui/resizable.tsx =====
"use client"

import { GripVertical } from "lucide-react"
import * as ResizablePrimitive from "react-resizable-panels"

import { cn } from "@/lib/utils"

const ResizablePanelGroup = ({
  className,
  ...props
}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) => (
  <ResizablePrimitive.PanelGroup
    className={cn(
      "flex h-full w-full data-[panel-group-direction=vertical]:flex-col",
      className
    )}
    {...props}
  />
)

const ResizablePanel = ResizablePrimitive.Panel

const ResizableHandle = ({
  withHandle,
  className,
  ...props
}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {
  withHandle?: boolean
}) => (
  <ResizablePrimitive.PanelResizeHandle
    className={cn(
      "relative flex w-px items-center justify-center bg-border after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0 [&[data-panel-group-direction=vertical]>div]:rotate-90",
      className
    )}
    {...props}
  >
    {withHandle && (
      <div className="z-10 flex h-4 w-3 items-center justify-center rounded-sm border bg-border">
        <GripVertical className="h-2.5 w-2.5" />
      </div>
    )}
  </ResizablePrimitive.PanelResizeHandle>
)

export { ResizablePanelGroup, ResizablePanel, ResizableHandle }

===== ./client/src/components/ui/scroll-area.tsx =====
import * as React from "react"
import * as ScrollAreaPrimitive from "@radix-ui/react-scroll-area"

import { cn } from "@/lib/utils"

const ScrollArea = React.forwardRef<
  React.ElementRef<typeof ScrollAreaPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>
>(({ className, children, ...props }, ref) => (
  <ScrollAreaPrimitive.Root
    ref={ref}
    className={cn("relative overflow-hidden", className)}
    {...props}
  >
    <ScrollAreaPrimitive.Viewport className="h-full w-full rounded-[inherit]">
      {children}
    </ScrollAreaPrimitive.Viewport>
    <ScrollBar />
    <ScrollAreaPrimitive.Corner />
  </ScrollAreaPrimitive.Root>
))
ScrollArea.displayName = ScrollAreaPrimitive.Root.displayName

const ScrollBar = React.forwardRef<
  React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,
  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>
>(({ className, orientation = "vertical", ...props }, ref) => (
  <ScrollAreaPrimitive.ScrollAreaScrollbar
    ref={ref}
    orientation={orientation}
    className={cn(
      "flex touch-none select-none transition-colors",
      orientation === "vertical" &&
        "h-full w-2.5 border-l border-l-transparent p-[1px]",
      orientation === "horizontal" &&
        "h-2.5 flex-col border-t border-t-transparent p-[1px]",
      className
    )}
    {...props}
  >
    <ScrollAreaPrimitive.ScrollAreaThumb className="relative flex-1 rounded-full bg-border" />
  </ScrollAreaPrimitive.ScrollAreaScrollbar>
))
ScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName

export { ScrollArea, ScrollBar }

===== ./client/src/components/ui/select.tsx =====
"use client"

import * as React from "react"
import * as SelectPrimitive from "@radix-ui/react-select"
import { Check, ChevronDown, ChevronUp } from "lucide-react"

import { cn } from "@/lib/utils"

const Select = SelectPrimitive.Root

const SelectGroup = SelectPrimitive.Group

const SelectValue = SelectPrimitive.Value

const SelectTrigger = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>
>(({ className, children, ...props }, ref) => (
  <SelectPrimitive.Trigger
    ref={ref}
    className={cn(
      "flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background data-[placeholder]:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1",
      className
    )}
    {...props}
  >
    {children}
    <SelectPrimitive.Icon asChild>
      <ChevronDown className="h-4 w-4 opacity-50" />
    </SelectPrimitive.Icon>
  </SelectPrimitive.Trigger>
))
SelectTrigger.displayName = SelectPrimitive.Trigger.displayName

const SelectScrollUpButton = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.ScrollUpButton
    ref={ref}
    className={cn(
      "flex cursor-default items-center justify-center py-1",
      className
    )}
    {...props}
  >
    <ChevronUp className="h-4 w-4" />
  </SelectPrimitive.ScrollUpButton>
))
SelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName

const SelectScrollDownButton = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.ScrollDownButton
    ref={ref}
    className={cn(
      "flex cursor-default items-center justify-center py-1",
      className
    )}
    {...props}
  >
    <ChevronDown className="h-4 w-4" />
  </SelectPrimitive.ScrollDownButton>
))
SelectScrollDownButton.displayName =
  SelectPrimitive.ScrollDownButton.displayName

const SelectContent = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>
>(({ className, children, position = "popper", ...props }, ref) => (
  <SelectPrimitive.Portal>
    <SelectPrimitive.Content
      ref={ref}
      className={cn(
        "relative z-50 max-h-[--radix-select-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-select-content-transform-origin]",
        position === "popper" &&
          "data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",
        className
      )}
      position={position}
      {...props}
    >
      <SelectScrollUpButton />
      <SelectPrimitive.Viewport
        className={cn(
          "p-1",
          position === "popper" &&
            "h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"
        )}
      >
        {children}
      </SelectPrimitive.Viewport>
      <SelectScrollDownButton />
    </SelectPrimitive.Content>
  </SelectPrimitive.Portal>
))
SelectContent.displayName = SelectPrimitive.Content.displayName

const SelectLabel = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Label>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.Label
    ref={ref}
    className={cn("py-1.5 pl-8 pr-2 text-sm font-semibold", className)}
    {...props}
  />
))
SelectLabel.displayName = SelectPrimitive.Label.displayName

const SelectItem = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>
>(({ className, children, ...props }, ref) => (
  <SelectPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <SelectPrimitive.ItemIndicator>
        <Check className="h-4 w-4" />
      </SelectPrimitive.ItemIndicator>
    </span>

    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>
  </SelectPrimitive.Item>
))
SelectItem.displayName = SelectPrimitive.Item.displayName

const SelectSeparator = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 my-1 h-px bg-muted", className)}
    {...props}
  />
))
SelectSeparator.displayName = SelectPrimitive.Separator.displayName

export {
  Select,
  SelectGroup,
  SelectValue,
  SelectTrigger,
  SelectContent,
  SelectLabel,
  SelectItem,
  SelectSeparator,
  SelectScrollUpButton,
  SelectScrollDownButton,
}

===== ./client/src/components/ui/separator.tsx =====
import * as React from "react"
import * as SeparatorPrimitive from "@radix-ui/react-separator"

import { cn } from "@/lib/utils"

const Separator = React.forwardRef<
  React.ElementRef<typeof SeparatorPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>
>(
  (
    { className, orientation = "horizontal", decorative = true, ...props },
    ref
  ) => (
    <SeparatorPrimitive.Root
      ref={ref}
      decorative={decorative}
      orientation={orientation}
      className={cn(
        "shrink-0 bg-border",
        orientation === "horizontal" ? "h-[1px] w-full" : "h-full w-[1px]",
        className
      )}
      {...props}
    />
  )
)
Separator.displayName = SeparatorPrimitive.Root.displayName

export { Separator }

===== ./client/src/components/ui/sheet.tsx =====
"use client"

import * as React from "react"
import * as SheetPrimitive from "@radix-ui/react-dialog"
import { cva, type VariantProps } from "class-variance-authority"
import { X } from "lucide-react"

import { cn } from "@/lib/utils"

const Sheet = SheetPrimitive.Root

const SheetTrigger = SheetPrimitive.Trigger

const SheetClose = SheetPrimitive.Close

const SheetPortal = SheetPrimitive.Portal

const SheetOverlay = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <SheetPrimitive.Overlay
    className={cn(
      "fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
      className
    )}
    {...props}
    ref={ref}
  />
))
SheetOverlay.displayName = SheetPrimitive.Overlay.displayName

const sheetVariants = cva(
  "fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500",
  {
    variants: {
      side: {
        top: "inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top",
        bottom:
          "inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom",
        left: "inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm",
        right:
          "inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm",
      },
    },
    defaultVariants: {
      side: "right",
    },
  }
)

interface SheetContentProps
  extends React.ComponentPropsWithoutRef<typeof SheetPrimitive.Content>,
    VariantProps<typeof sheetVariants> {}

const SheetContent = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Content>,
  SheetContentProps
>(({ side = "right", className, children, ...props }, ref) => (
  <SheetPortal>
    <SheetOverlay />
    <SheetPrimitive.Content
      ref={ref}
      className={cn(sheetVariants({ side }), className)}
      {...props}
    >
      {children}
      <SheetPrimitive.Close className="absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary">
        <X className="h-4 w-4" />
        <span className="sr-only">Close</span>
      </SheetPrimitive.Close>
    </SheetPrimitive.Content>
  </SheetPortal>
))
SheetContent.displayName = SheetPrimitive.Content.displayName

const SheetHeader = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col space-y-2 text-center sm:text-left",
      className
    )}
    {...props}
  />
)
SheetHeader.displayName = "SheetHeader"

const SheetFooter = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",
      className
    )}
    {...props}
  />
)
SheetFooter.displayName = "SheetFooter"

const SheetTitle = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Title>
>(({ className, ...props }, ref) => (
  <SheetPrimitive.Title
    ref={ref}
    className={cn("text-lg font-semibold text-foreground", className)}
    {...props}
  />
))
SheetTitle.displayName = SheetPrimitive.Title.displayName

const SheetDescription = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Description>
>(({ className, ...props }, ref) => (
  <SheetPrimitive.Description
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
SheetDescription.displayName = SheetPrimitive.Description.displayName

export {
  Sheet,
  SheetPortal,
  SheetOverlay,
  SheetTrigger,
  SheetClose,
  SheetContent,
  SheetHeader,
  SheetFooter,
  SheetTitle,
  SheetDescription,
}

===== ./client/src/components/ui/sidebar.tsx =====
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { VariantProps, cva } from "class-variance-authority"
import { PanelLeft } from "lucide-react"

import { useIsMobile } from "@/hooks/use-mobile"
import { cn } from "@/lib/utils"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Separator } from "@/components/ui/separator"
import {
  Sheet,
  SheetContent,
  SheetDescription,
  SheetHeader,
  SheetTitle,
} from "@/components/ui/sheet"
import { Skeleton } from "@/components/ui/skeleton"
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from "@/components/ui/tooltip"

const SIDEBAR_COOKIE_NAME = "sidebar_state"
const SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7
const SIDEBAR_WIDTH = "16rem"
const SIDEBAR_WIDTH_MOBILE = "18rem"
const SIDEBAR_WIDTH_ICON = "3rem"
const SIDEBAR_KEYBOARD_SHORTCUT = "b"

type SidebarContextProps = {
  state: "expanded" | "collapsed"
  open: boolean
  setOpen: (open: boolean) => void
  openMobile: boolean
  setOpenMobile: (open: boolean) => void
  isMobile: boolean
  toggleSidebar: () => void
}

const SidebarContext = React.createContext<SidebarContextProps | null>(null)

function useSidebar() {
  const context = React.useContext(SidebarContext)
  if (!context) {
    throw new Error("useSidebar must be used within a SidebarProvider.")
  }

  return context
}

const SidebarProvider = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div"> & {
    defaultOpen?: boolean
    open?: boolean
    onOpenChange?: (open: boolean) => void
  }
>(
  (
    {
      defaultOpen = true,
      open: openProp,
      onOpenChange: setOpenProp,
      className,
      style,
      children,
      ...props
    },
    ref
  ) => {
    const isMobile = useIsMobile()
    const [openMobile, setOpenMobile] = React.useState(false)

    // This is the internal state of the sidebar.
    // We use openProp and setOpenProp for control from outside the component.
    const [_open, _setOpen] = React.useState(defaultOpen)
    const open = openProp ?? _open
    const setOpen = React.useCallback(
      (value: boolean | ((value: boolean) => boolean)) => {
        const openState = typeof value === "function" ? value(open) : value
        if (setOpenProp) {
          setOpenProp(openState)
        } else {
          _setOpen(openState)
        }

        // This sets the cookie to keep the sidebar state.
        document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`
      },
      [setOpenProp, open]
    )

    // Helper to toggle the sidebar.
    const toggleSidebar = React.useCallback(() => {
      return isMobile
        ? setOpenMobile((open) => !open)
        : setOpen((open) => !open)
    }, [isMobile, setOpen, setOpenMobile])

    // Adds a keyboard shortcut to toggle the sidebar.
    React.useEffect(() => {
      const handleKeyDown = (event: KeyboardEvent) => {
        if (
          event.key === SIDEBAR_KEYBOARD_SHORTCUT &&
          (event.metaKey || event.ctrlKey)
        ) {
          event.preventDefault()
          toggleSidebar()
        }
      }

      window.addEventListener("keydown", handleKeyDown)
      return () => window.removeEventListener("keydown", handleKeyDown)
    }, [toggleSidebar])

    // We add a state so that we can do data-state="expanded" or "collapsed".
    // This makes it easier to style the sidebar with Tailwind classes.
    const state = open ? "expanded" : "collapsed"

    const contextValue = React.useMemo<SidebarContextProps>(
      () => ({
        state,
        open,
        setOpen,
        isMobile,
        openMobile,
        setOpenMobile,
        toggleSidebar,
      }),
      [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar]
    )

    return (
      <SidebarContext.Provider value={contextValue}>
        <TooltipProvider delayDuration={0}>
          <div
            style={
              {
                "--sidebar-width": SIDEBAR_WIDTH,
                "--sidebar-width-icon": SIDEBAR_WIDTH_ICON,
                ...style,
              } as React.CSSProperties
            }
            className={cn(
              "group/sidebar-wrapper flex min-h-svh w-full has-[[data-variant=inset]]:bg-sidebar",
              className
            )}
            ref={ref}
            {...props}
          >
            {children}
          </div>
        </TooltipProvider>
      </SidebarContext.Provider>
    )
  }
)
SidebarProvider.displayName = "SidebarProvider"

const Sidebar = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div"> & {
    side?: "left" | "right"
    variant?: "sidebar" | "floating" | "inset"
    collapsible?: "offcanvas" | "icon" | "none"
  }
>(
  (
    {
      side = "left",
      variant = "sidebar",
      collapsible = "offcanvas",
      className,
      children,
      ...props
    },
    ref
  ) => {
    const { isMobile, state, openMobile, setOpenMobile } = useSidebar()

    if (collapsible === "none") {
      return (
        <div
          className={cn(
            "flex h-full w-[--sidebar-width] flex-col bg-sidebar text-sidebar-foreground",
            className
          )}
          ref={ref}
          {...props}
        >
          {children}
        </div>
      )
    }

    if (isMobile) {
      return (
        <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>
          <SheetContent
            data-sidebar="sidebar"
            data-mobile="true"
            className="w-[--sidebar-width] bg-sidebar p-0 text-sidebar-foreground [&>button]:hidden"
            style={
              {
                "--sidebar-width": SIDEBAR_WIDTH_MOBILE,
              } as React.CSSProperties
            }
            side={side}
          >
            <SheetHeader className="sr-only">
              <SheetTitle>Sidebar</SheetTitle>
              <SheetDescription>Displays the mobile sidebar.</SheetDescription>
            </SheetHeader>
            <div className="flex h-full w-full flex-col">{children}</div>
          </SheetContent>
        </Sheet>
      )
    }

    return (
      <div
        ref={ref}
        className="group peer hidden text-sidebar-foreground md:block"
        data-state={state}
        data-collapsible={state === "collapsed" ? collapsible : ""}
        data-variant={variant}
        data-side={side}
      >
        {/* This is what handles the sidebar gap on desktop */}
        <div
          className={cn(
            "relative w-[--sidebar-width] bg-transparent transition-[width] duration-200 ease-linear",
            "group-data-[collapsible=offcanvas]:w-0",
            "group-data-[side=right]:rotate-180",
            variant === "floating" || variant === "inset"
              ? "group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4))]"
              : "group-data-[collapsible=icon]:w-[--sidebar-width-icon]"
          )}
        />
        <div
          className={cn(
            "fixed inset-y-0 z-10 hidden h-svh w-[--sidebar-width] transition-[left,right,width] duration-200 ease-linear md:flex",
            side === "left"
              ? "left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]"
              : "right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]",
            // Adjust the padding for floating and inset variants.
            variant === "floating" || variant === "inset"
              ? "p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4)_+2px)]"
              : "group-data-[collapsible=icon]:w-[--sidebar-width-icon] group-data-[side=left]:border-r group-data-[side=right]:border-l",
            className
          )}
          {...props}
        >
          <div
            data-sidebar="sidebar"
            className="flex h-full w-full flex-col bg-sidebar group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:border-sidebar-border group-data-[variant=floating]:shadow"
          >
            {children}
          </div>
        </div>
      </div>
    )
  }
)
Sidebar.displayName = "Sidebar"

const SidebarTrigger = React.forwardRef<
  React.ElementRef<typeof Button>,
  React.ComponentProps<typeof Button>
>(({ className, onClick, ...props }, ref) => {
  const { toggleSidebar } = useSidebar()

  return (
    <Button
      ref={ref}
      data-sidebar="trigger"
      variant="ghost"
      size="icon"
      className={cn("h-7 w-7", className)}
      onClick={(event) => {
        onClick?.(event)
        toggleSidebar()
      }}
      {...props}
    >
      <PanelLeft />
      <span className="sr-only">Toggle Sidebar</span>
    </Button>
  )
})
SidebarTrigger.displayName = "SidebarTrigger"

const SidebarRail = React.forwardRef<
  HTMLButtonElement,
  React.ComponentProps<"button">
>(({ className, ...props }, ref) => {
  const { toggleSidebar } = useSidebar()

  return (
    <button
      ref={ref}
      data-sidebar="rail"
      aria-label="Toggle Sidebar"
      tabIndex={-1}
      onClick={toggleSidebar}
      title="Toggle Sidebar"
      className={cn(
        "absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] hover:after:bg-sidebar-border group-data-[side=left]:-right-4 group-data-[side=right]:left-0 sm:flex",
        "[[data-side=left]_&]:cursor-w-resize [[data-side=right]_&]:cursor-e-resize",
        "[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize",
        "group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full group-data-[collapsible=offcanvas]:hover:bg-sidebar",
        "[[data-side=left][data-collapsible=offcanvas]_&]:-right-2",
        "[[data-side=right][data-collapsible=offcanvas]_&]:-left-2",
        className
      )}
      {...props}
    />
  )
})
SidebarRail.displayName = "SidebarRail"

const SidebarInset = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"main">
>(({ className, ...props }, ref) => {
  return (
    <main
      ref={ref}
      className={cn(
        "relative flex w-full flex-1 flex-col bg-background",
        "md:peer-data-[variant=inset]:m-2 md:peer-data-[state=collapsed]:peer-data-[variant=inset]:ml-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow",
        className
      )}
      {...props}
    />
  )
})
SidebarInset.displayName = "SidebarInset"

const SidebarInput = React.forwardRef<
  React.ElementRef<typeof Input>,
  React.ComponentProps<typeof Input>
>(({ className, ...props }, ref) => {
  return (
    <Input
      ref={ref}
      data-sidebar="input"
      className={cn(
        "h-8 w-full bg-background shadow-none focus-visible:ring-2 focus-visible:ring-sidebar-ring",
        className
      )}
      {...props}
    />
  )
})
SidebarInput.displayName = "SidebarInput"

const SidebarHeader = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div">
>(({ className, ...props }, ref) => {
  return (
    <div
      ref={ref}
      data-sidebar="header"
      className={cn("flex flex-col gap-2 p-2", className)}
      {...props}
    />
  )
})
SidebarHeader.displayName = "SidebarHeader"

const SidebarFooter = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div">
>(({ className, ...props }, ref) => {
  return (
    <div
      ref={ref}
      data-sidebar="footer"
      className={cn("flex flex-col gap-2 p-2", className)}
      {...props}
    />
  )
})
SidebarFooter.displayName = "SidebarFooter"

const SidebarSeparator = React.forwardRef<
  React.ElementRef<typeof Separator>,
  React.ComponentProps<typeof Separator>
>(({ className, ...props }, ref) => {
  return (
    <Separator
      ref={ref}
      data-sidebar="separator"
      className={cn("mx-2 w-auto bg-sidebar-border", className)}
      {...props}
    />
  )
})
SidebarSeparator.displayName = "SidebarSeparator"

const SidebarContent = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div">
>(({ className, ...props }, ref) => {
  return (
    <div
      ref={ref}
      data-sidebar="content"
      className={cn(
        "flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden",
        className
      )}
      {...props}
    />
  )
})
SidebarContent.displayName = "SidebarContent"

const SidebarGroup = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div">
>(({ className, ...props }, ref) => {
  return (
    <div
      ref={ref}
      data-sidebar="group"
      className={cn("relative flex w-full min-w-0 flex-col p-2", className)}
      {...props}
    />
  )
})
SidebarGroup.displayName = "SidebarGroup"

const SidebarGroupLabel = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div"> & { asChild?: boolean }
>(({ className, asChild = false, ...props }, ref) => {
  const Comp = asChild ? Slot : "div"

  return (
    <Comp
      ref={ref}
      data-sidebar="group-label"
      className={cn(
        "flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium text-sidebar-foreground/70 outline-none ring-sidebar-ring transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0",
        "group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0",
        className
      )}
      {...props}
    />
  )
})
SidebarGroupLabel.displayName = "SidebarGroupLabel"

const SidebarGroupAction = React.forwardRef<
  HTMLButtonElement,
  React.ComponentProps<"button"> & { asChild?: boolean }
>(({ className, asChild = false, ...props }, ref) => {
  const Comp = asChild ? Slot : "button"

  return (
    <Comp
      ref={ref}
      data-sidebar="group-action"
      className={cn(
        "absolute right-3 top-3.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0",
        // Increases the hit area of the button on mobile.
        "after:absolute after:-inset-2 after:md:hidden",
        "group-data-[collapsible=icon]:hidden",
        className
      )}
      {...props}
    />
  )
})
SidebarGroupAction.displayName = "SidebarGroupAction"

const SidebarGroupContent = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div">
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    data-sidebar="group-content"
    className={cn("w-full text-sm", className)}
    {...props}
  />
))
SidebarGroupContent.displayName = "SidebarGroupContent"

const SidebarMenu = React.forwardRef<
  HTMLUListElement,
  React.ComponentProps<"ul">
>(({ className, ...props }, ref) => (
  <ul
    ref={ref}
    data-sidebar="menu"
    className={cn("flex w-full min-w-0 flex-col gap-1", className)}
    {...props}
  />
))
SidebarMenu.displayName = "SidebarMenu"

const SidebarMenuItem = React.forwardRef<
  HTMLLIElement,
  React.ComponentProps<"li">
>(({ className, ...props }, ref) => (
  <li
    ref={ref}
    data-sidebar="menu-item"
    className={cn("group/menu-item relative", className)}
    {...props}
  />
))
SidebarMenuItem.displayName = "SidebarMenuItem"

const sidebarMenuButtonVariants = cva(
  "peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-none ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-[[data-sidebar=menu-action]]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:!size-8 group-data-[collapsible=icon]:!p-2 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0",
  {
    variants: {
      variant: {
        default: "hover:bg-sidebar-accent hover:text-sidebar-accent-foreground",
        outline:
          "bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]",
      },
      size: {
        default: "h-8 text-sm",
        sm: "h-7 text-xs",
        lg: "h-12 text-sm group-data-[collapsible=icon]:!p-0",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

const SidebarMenuButton = React.forwardRef<
  HTMLButtonElement,
  React.ComponentProps<"button"> & {
    asChild?: boolean
    isActive?: boolean
    tooltip?: string | React.ComponentProps<typeof TooltipContent>
  } & VariantProps<typeof sidebarMenuButtonVariants>
>(
  (
    {
      asChild = false,
      isActive = false,
      variant = "default",
      size = "default",
      tooltip,
      className,
      ...props
    },
    ref
  ) => {
    const Comp = asChild ? Slot : "button"
    const { isMobile, state } = useSidebar()

    const button = (
      <Comp
        ref={ref}
        data-sidebar="menu-button"
        data-size={size}
        data-active={isActive}
        className={cn(sidebarMenuButtonVariants({ variant, size }), className)}
        {...props}
      />
    )

    if (!tooltip) {
      return button
    }

    if (typeof tooltip === "string") {
      tooltip = {
        children: tooltip,
      }
    }

    return (
      <Tooltip>
        <TooltipTrigger asChild>{button}</TooltipTrigger>
        <TooltipContent
          side="right"
          align="center"
          hidden={state !== "collapsed" || isMobile}
          {...tooltip}
        />
      </Tooltip>
    )
  }
)
SidebarMenuButton.displayName = "SidebarMenuButton"

const SidebarMenuAction = React.forwardRef<
  HTMLButtonElement,
  React.ComponentProps<"button"> & {
    asChild?: boolean
    showOnHover?: boolean
  }
>(({ className, asChild = false, showOnHover = false, ...props }, ref) => {
  const Comp = asChild ? Slot : "button"

  return (
    <Comp
      ref={ref}
      data-sidebar="menu-action"
      className={cn(
        "absolute right-1 top-1.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 peer-hover/menu-button:text-sidebar-accent-foreground [&>svg]:size-4 [&>svg]:shrink-0",
        // Increases the hit area of the button on mobile.
        "after:absolute after:-inset-2 after:md:hidden",
        "peer-data-[size=sm]/menu-button:top-1",
        "peer-data-[size=default]/menu-button:top-1.5",
        "peer-data-[size=lg]/menu-button:top-2.5",
        "group-data-[collapsible=icon]:hidden",
        showOnHover &&
          "group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 peer-data-[active=true]/menu-button:text-sidebar-accent-foreground md:opacity-0",
        className
      )}
      {...props}
    />
  )
})
SidebarMenuAction.displayName = "SidebarMenuAction"

const SidebarMenuBadge = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div">
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    data-sidebar="menu-badge"
    className={cn(
      "pointer-events-none absolute right-1 flex h-5 min-w-5 select-none items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums text-sidebar-foreground",
      "peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground",
      "peer-data-[size=sm]/menu-button:top-1",
      "peer-data-[size=default]/menu-button:top-1.5",
      "peer-data-[size=lg]/menu-button:top-2.5",
      "group-data-[collapsible=icon]:hidden",
      className
    )}
    {...props}
  />
))
SidebarMenuBadge.displayName = "SidebarMenuBadge"

const SidebarMenuSkeleton = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div"> & {
    showIcon?: boolean
  }
>(({ className, showIcon = false, ...props }, ref) => {
  // Random width between 50 to 90%.
  const width = React.useMemo(() => {
    return `${Math.floor(Math.random() * 40) + 50}%`
  }, [])

  return (
    <div
      ref={ref}
      data-sidebar="menu-skeleton"
      className={cn("flex h-8 items-center gap-2 rounded-md px-2", className)}
      {...props}
    >
      {showIcon && (
        <Skeleton
          className="size-4 rounded-md"
          data-sidebar="menu-skeleton-icon"
        />
      )}
      <Skeleton
        className="h-4 max-w-[--skeleton-width] flex-1"
        data-sidebar="menu-skeleton-text"
        style={
          {
            "--skeleton-width": width,
          } as React.CSSProperties
        }
      />
    </div>
  )
})
SidebarMenuSkeleton.displayName = "SidebarMenuSkeleton"

const SidebarMenuSub = React.forwardRef<
  HTMLUListElement,
  React.ComponentProps<"ul">
>(({ className, ...props }, ref) => (
  <ul
    ref={ref}
    data-sidebar="menu-sub"
    className={cn(
      "mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l border-sidebar-border px-2.5 py-0.5",
      "group-data-[collapsible=icon]:hidden",
      className
    )}
    {...props}
  />
))
SidebarMenuSub.displayName = "SidebarMenuSub"

const SidebarMenuSubItem = React.forwardRef<
  HTMLLIElement,
  React.ComponentProps<"li">
>(({ ...props }, ref) => <li ref={ref} {...props} />)
SidebarMenuSubItem.displayName = "SidebarMenuSubItem"

const SidebarMenuSubButton = React.forwardRef<
  HTMLAnchorElement,
  React.ComponentProps<"a"> & {
    asChild?: boolean
    size?: "sm" | "md"
    isActive?: boolean
  }
>(({ asChild = false, size = "md", isActive, className, ...props }, ref) => {
  const Comp = asChild ? Slot : "a"

  return (
    <Comp
      ref={ref}
      data-sidebar="menu-sub-button"
      data-size={size}
      data-active={isActive}
      className={cn(
        "flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 text-sidebar-foreground outline-none ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 [&>svg]:text-sidebar-accent-foreground",
        "data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground",
        size === "sm" && "text-xs",
        size === "md" && "text-sm",
        "group-data-[collapsible=icon]:hidden",
        className
      )}
      {...props}
    />
  )
})
SidebarMenuSubButton.displayName = "SidebarMenuSubButton"

export {
  Sidebar,
  SidebarContent,
  SidebarFooter,
  SidebarGroup,
  SidebarGroupAction,
  SidebarGroupContent,
  SidebarGroupLabel,
  SidebarHeader,
  SidebarInput,
  SidebarInset,
  SidebarMenu,
  SidebarMenuAction,
  SidebarMenuBadge,
  SidebarMenuButton,
  SidebarMenuItem,
  SidebarMenuSkeleton,
  SidebarMenuSub,
  SidebarMenuSubButton,
  SidebarMenuSubItem,
  SidebarProvider,
  SidebarRail,
  SidebarSeparator,
  SidebarTrigger,
  useSidebar,
}

===== ./client/src/components/ui/skeleton.tsx =====
import { cn } from "@/lib/utils"

function Skeleton({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) {
  return (
    <div
      className={cn("animate-pulse rounded-md bg-muted", className)}
      {...props}
    />
  )
}

export { Skeleton }

===== ./client/src/components/ui/slider.tsx =====
import * as React from "react"
import * as SliderPrimitive from "@radix-ui/react-slider"

import { cn } from "@/lib/utils"

const Slider = React.forwardRef<
  React.ElementRef<typeof SliderPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof SliderPrimitive.Root>
>(({ className, ...props }, ref) => (
  <SliderPrimitive.Root
    ref={ref}
    className={cn(
      "relative flex w-full touch-none select-none items-center",
      className
    )}
    {...props}
  >
    <SliderPrimitive.Track className="relative h-2 w-full grow overflow-hidden rounded-full bg-secondary">
      <SliderPrimitive.Range className="absolute h-full bg-primary" />
    </SliderPrimitive.Track>
    <SliderPrimitive.Thumb className="block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50" />
  </SliderPrimitive.Root>
))
Slider.displayName = SliderPrimitive.Root.displayName

export { Slider }

===== ./client/src/components/ui/switch.tsx =====
import * as React from "react"
import * as SwitchPrimitives from "@radix-ui/react-switch"

import { cn } from "@/lib/utils"

const Switch = React.forwardRef<
  React.ElementRef<typeof SwitchPrimitives.Root>,
  React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>
>(({ className, ...props }, ref) => (
  <SwitchPrimitives.Root
    className={cn(
      "peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input",
      className
    )}
    {...props}
    ref={ref}
  >
    <SwitchPrimitives.Thumb
      className={cn(
        "pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0"
      )}
    />
  </SwitchPrimitives.Root>
))
Switch.displayName = SwitchPrimitives.Root.displayName

export { Switch }

===== ./client/src/components/ui/table.tsx =====
import * as React from "react"

import { cn } from "@/lib/utils"

const Table = React.forwardRef<
  HTMLTableElement,
  React.HTMLAttributes<HTMLTableElement>
>(({ className, ...props }, ref) => (
  <div className="relative w-full overflow-auto">
    <table
      ref={ref}
      className={cn("w-full caption-bottom text-sm", className)}
      {...props}
    />
  </div>
))
Table.displayName = "Table"

const TableHeader = React.forwardRef<
  HTMLTableSectionElement,
  React.HTMLAttributes<HTMLTableSectionElement>
>(({ className, ...props }, ref) => (
  <thead ref={ref} className={cn("[&_tr]:border-b", className)} {...props} />
))
TableHeader.displayName = "TableHeader"

const TableBody = React.forwardRef<
  HTMLTableSectionElement,
  React.HTMLAttributes<HTMLTableSectionElement>
>(({ className, ...props }, ref) => (
  <tbody
    ref={ref}
    className={cn("[&_tr:last-child]:border-0", className)}
    {...props}
  />
))
TableBody.displayName = "TableBody"

const TableFooter = React.forwardRef<
  HTMLTableSectionElement,
  React.HTMLAttributes<HTMLTableSectionElement>
>(({ className, ...props }, ref) => (
  <tfoot
    ref={ref}
    className={cn(
      "border-t bg-muted/50 font-medium [&>tr]:last:border-b-0",
      className
    )}
    {...props}
  />
))
TableFooter.displayName = "TableFooter"

const TableRow = React.forwardRef<
  HTMLTableRowElement,
  React.HTMLAttributes<HTMLTableRowElement>
>(({ className, ...props }, ref) => (
  <tr
    ref={ref}
    className={cn(
      "border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted",
      className
    )}
    {...props}
  />
))
TableRow.displayName = "TableRow"

const TableHead = React.forwardRef<
  HTMLTableCellElement,
  React.ThHTMLAttributes<HTMLTableCellElement>
>(({ className, ...props }, ref) => (
  <th
    ref={ref}
    className={cn(
      "h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0",
      className
    )}
    {...props}
  />
))
TableHead.displayName = "TableHead"

const TableCell = React.forwardRef<
  HTMLTableCellElement,
  React.TdHTMLAttributes<HTMLTableCellElement>
>(({ className, ...props }, ref) => (
  <td
    ref={ref}
    className={cn("p-4 align-middle [&:has([role=checkbox])]:pr-0", className)}
    {...props}
  />
))
TableCell.displayName = "TableCell"

const TableCaption = React.forwardRef<
  HTMLTableCaptionElement,
  React.HTMLAttributes<HTMLTableCaptionElement>
>(({ className, ...props }, ref) => (
  <caption
    ref={ref}
    className={cn("mt-4 text-sm text-muted-foreground", className)}
    {...props}
  />
))
TableCaption.displayName = "TableCaption"

export {
  Table,
  TableHeader,
  TableBody,
  TableFooter,
  TableHead,
  TableRow,
  TableCell,
  TableCaption,
}

===== ./client/src/components/ui/tabs.tsx =====
import * as React from "react"
import * as TabsPrimitive from "@radix-ui/react-tabs"

import { cn } from "@/lib/utils"

const Tabs = TabsPrimitive.Root

const TabsList = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.List>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.List
    ref={ref}
    className={cn(
      "inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",
      className
    )}
    {...props}
  />
))
TabsList.displayName = TabsPrimitive.List.displayName

const TabsTrigger = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.Trigger
    ref={ref}
    className={cn(
      "inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm",
      className
    )}
    {...props}
  />
))
TabsTrigger.displayName = TabsPrimitive.Trigger.displayName

const TabsContent = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.Content
    ref={ref}
    className={cn(
      "mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",
      className
    )}
    {...props}
  />
))
TabsContent.displayName = TabsPrimitive.Content.displayName

export { Tabs, TabsList, TabsTrigger, TabsContent }

===== ./client/src/components/ui/textarea.tsx =====
import * as React from "react"

import { cn } from "@/lib/utils"

const Textarea = React.forwardRef<
  HTMLTextAreaElement,
  React.ComponentProps<"textarea">
>(({ className, ...props }, ref) => {
  return (
    <textarea
      className={cn(
        "flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
        className
      )}
      ref={ref}
      {...props}
    />
  )
})
Textarea.displayName = "Textarea"

export { Textarea }

===== ./client/src/components/ui/toaster.tsx =====
import * as React from "react"
import {
  Toast,
  ToastClose,
  ToastDescription,
  ToastProvider,
  ToastTitle,
  ToastViewport,
} from "@/components/ui/toast"
import { useToast } from "@/hooks/use-toast"

export function Toaster() {
  const { toasts } = useToast()

  return (
    <ToastProvider>
      {toasts.map(function ({ id, title, description, action, ...props }) {
        return (
          <Toast key={id} {...props}>
            <div className="grid gap-1">
              {title && <ToastTitle>{title}</ToastTitle>}
              {description && (
                <ToastDescription>{description}</ToastDescription>
              )}
            </div>
            {action}
            <ToastClose />
          </Toast>
        )
      })}
      <ToastViewport />
    </ToastProvider>
  )
}
===== ./client/src/components/ui/toast.tsx =====
import * as React from "react"
import * as ToastPrimitives from "@radix-ui/react-toast"
import { cva, type VariantProps } from "class-variance-authority"
import { X } from "lucide-react"

import { cn } from "@/lib/utils"

const ToastProvider = ToastPrimitives.Provider

const ToastViewport = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Viewport>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Viewport>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Viewport
    ref={ref}
    className={cn(
      "fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]",
      className
    )}
    {...props}
  />
))
ToastViewport.displayName = ToastPrimitives.Viewport.displayName

const toastVariants = cva(
  "group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full",
  {
    variants: {
      variant: {
        default: "border bg-background text-foreground",
        destructive:
          "destructive border-destructive bg-destructive text-destructive-foreground",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

const Toast = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Root>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Root> &
    VariantProps<typeof toastVariants>
>(({ className, variant, ...props }, ref) => {
  return (
    <ToastPrimitives.Root
      ref={ref}
      className={cn(toastVariants({ variant }), className)}
      {...props}
    />
  )
})
Toast.displayName = ToastPrimitives.Root.displayName

const ToastAction = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Action>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Action>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Action
    ref={ref}
    className={cn(
      "inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive",
      className
    )}
    {...props}
  />
))
ToastAction.displayName = ToastPrimitives.Action.displayName

const ToastClose = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Close>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Close>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Close
    ref={ref}
    className={cn(
      "absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100 group-[.destructive]:text-red-300 group-[.destructive]:hover:text-red-50 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600",
      className
    )}
    toast-close=""
    {...props}
  >
    <X className="h-4 w-4" />
  </ToastPrimitives.Close>
))
ToastClose.displayName = ToastPrimitives.Close.displayName

const ToastTitle = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Title>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Title>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Title
    ref={ref}
    className={cn("text-sm font-semibold", className)}
    {...props}
  />
))
ToastTitle.displayName = ToastPrimitives.Title.displayName

const ToastDescription = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Description>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Description>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Description
    ref={ref}
    className={cn("text-sm opacity-90", className)}
    {...props}
  />
))
ToastDescription.displayName = ToastPrimitives.Description.displayName

type ToastProps = React.ComponentPropsWithoutRef<typeof Toast>

type ToastActionElement = React.ReactElement<typeof ToastAction>

export {
  type ToastProps,
  type ToastActionElement,
  ToastProvider,
  ToastViewport,
  Toast,
  ToastTitle,
  ToastDescription,
  ToastClose,
  ToastAction,
}
===== ./client/src/components/ui/toggle-group.tsx =====
"use client"

import * as React from "react"
import * as ToggleGroupPrimitive from "@radix-ui/react-toggle-group"
import { type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"
import { toggleVariants } from "@/components/ui/toggle"

const ToggleGroupContext = React.createContext<
  VariantProps<typeof toggleVariants>
>({
  size: "default",
  variant: "default",
})

const ToggleGroup = React.forwardRef<
  React.ElementRef<typeof ToggleGroupPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Root> &
    VariantProps<typeof toggleVariants>
>(({ className, variant, size, children, ...props }, ref) => (
  <ToggleGroupPrimitive.Root
    ref={ref}
    className={cn("flex items-center justify-center gap-1", className)}
    {...props}
  >
    <ToggleGroupContext.Provider value={{ variant, size }}>
      {children}
    </ToggleGroupContext.Provider>
  </ToggleGroupPrimitive.Root>
))

ToggleGroup.displayName = ToggleGroupPrimitive.Root.displayName

const ToggleGroupItem = React.forwardRef<
  React.ElementRef<typeof ToggleGroupPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Item> &
    VariantProps<typeof toggleVariants>
>(({ className, children, variant, size, ...props }, ref) => {
  const context = React.useContext(ToggleGroupContext)

  return (
    <ToggleGroupPrimitive.Item
      ref={ref}
      className={cn(
        toggleVariants({
          variant: context.variant || variant,
          size: context.size || size,
        }),
        className
      )}
      {...props}
    >
      {children}
    </ToggleGroupPrimitive.Item>
  )
})

ToggleGroupItem.displayName = ToggleGroupPrimitive.Item.displayName

export { ToggleGroup, ToggleGroupItem }

===== ./client/src/components/ui/toggle.tsx =====
import * as React from "react"
import * as TogglePrimitive from "@radix-ui/react-toggle"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const toggleVariants = cva(
  "inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 gap-2",
  {
    variants: {
      variant: {
        default: "bg-transparent",
        outline:
          "border border-input bg-transparent hover:bg-accent hover:text-accent-foreground",
      },
      size: {
        default: "h-10 px-3 min-w-10",
        sm: "h-9 px-2.5 min-w-9",
        lg: "h-11 px-5 min-w-11",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

const Toggle = React.forwardRef<
  React.ElementRef<typeof TogglePrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof TogglePrimitive.Root> &
    VariantProps<typeof toggleVariants>
>(({ className, variant, size, ...props }, ref) => (
  <TogglePrimitive.Root
    ref={ref}
    className={cn(toggleVariants({ variant, size, className }))}
    {...props}
  />
))

Toggle.displayName = TogglePrimitive.Root.displayName

export { Toggle, toggleVariants }

===== ./client/src/components/ui/tooltip.tsx =====
"use client"

import * as React from "react"
import * as TooltipPrimitive from "@radix-ui/react-tooltip"

import { cn } from "@/lib/utils"

const TooltipProvider = TooltipPrimitive.Provider

const Tooltip = TooltipPrimitive.Root

const TooltipTrigger = TooltipPrimitive.Trigger

const TooltipContent = React.forwardRef<
  React.ElementRef<typeof TooltipPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>
>(({ className, sideOffset = 4, ...props }, ref) => (
  <TooltipPrimitive.Content
    ref={ref}
    sideOffset={sideOffset}
    className={cn(
      "z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-tooltip-content-transform-origin]",
      className
    )}
    {...props}
  />
))
TooltipContent.displayName = TooltipPrimitive.Content.displayName

export { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }

===== ./client/src/hooks/useAuth.ts =====
import { useQuery } from "@tanstack/react-query";
// Define a type for the user object expected from the API
interface AuthenticatedUser {
id: string;
email: string;
firstName?: string;
lastName?: string;
profileImageUrl?: string;
role: 'admin' | 'nutritionist' | 'patient'; // <-- ADICIONADO "admin"
patientProfile?: { id: string };
}
export function useAuth() {
const { data: user, isLoading, error } = useQuery<AuthenticatedUser | null>({
queryKey: ["/api/auth/user"],
retry: false,
});
return {
user,
isLoading,
error,
isAuthenticated: !!user,
isAdmin: user?.role === 'admin', // <-- ADICIONADO
isNutritionist: user?.role === 'nutritionist',
isPatient: user?.role === 'patient',
};
}
===== ./client/src/hooks/use-infinite-scroll.tsx =====
import { useState, useEffect, useCallback } from 'react';

interface UseInfiniteScrollProps {
  fetchMore: () => Promise<void>;
  hasMore: boolean;
  threshold?: number;
  rootMargin?: string;
}

export function useInfiniteScroll({
  fetchMore,
  hasMore,
  threshold = 1.0,
  rootMargin = '0px',
}: UseInfiniteScrollProps) {
  const [isFetching, setIsFetching] = useState(false);
  const [targetRef, setTargetRef] = useState<Element | null>(null);

  const handleIntersection = useCallback(
    async (entries: IntersectionObserverEntry[]) => {
      const target = entries[0];
      if (target.isIntersecting && hasMore && !isFetching) {
        setIsFetching(true);
        try {
          await fetchMore();
        } finally {
          setIsFetching(false);
        }
      }
    },
    [fetchMore, hasMore, isFetching]
  );

  useEffect(() => {
    if (!targetRef) return;

    const observer = new IntersectionObserver(handleIntersection, {
      threshold,
      rootMargin,
    });

    observer.observe(targetRef);

    return () => {
      observer.disconnect();
    };
  }, [targetRef, handleIntersection, threshold, rootMargin]);

  const setRef = useCallback((node: Element | null) => {
    setTargetRef(node);
  }, []);

  return {
    isFetching,
    setRef,
  };
}
===== ./client/src/hooks/use-mobile.tsx =====
import * as React from "react"
import { getBreakpoint, isMobileBreakpoint, isTouchDevice, debounce, MOBILE_BREAKPOINTS } from "@/utils/mobile"

const MOBILE_BREAKPOINT = 768

export function useIsMobile() {
  const [isMobile, setIsMobile] = React.useState<boolean | undefined>(undefined)

  React.useEffect(() => {
    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`)
    const onChange = () => {
      setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)
    }
    mql.addEventListener("change", onChange)
    setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)
    return () => mql.removeEventListener("change", onChange)
  }, [])

  return !!isMobile
}

export function useBreakpoint() {
  const [breakpoint, setBreakpoint] = React.useState<keyof typeof MOBILE_BREAKPOINTS>(() => getBreakpoint())

  React.useEffect(() => {
    const handleResize = debounce(() => {
      setBreakpoint(getBreakpoint())
    }, 100)

    window.addEventListener('resize', handleResize)
    return () => window.removeEventListener('resize', handleResize)
  }, [])

  return breakpoint
}

export function useIsTouch() {
  const [isTouch, setIsTouch] = React.useState<boolean>(() => isTouchDevice())

  React.useEffect(() => {
    setIsTouch(isTouchDevice())
  }, [])

  return isTouch
}

export function useMobileOrientation() {
  const [orientation, setOrientation] = React.useState<'portrait' | 'landscape'>(() => {
    if (typeof window === 'undefined') return 'portrait'
    return window.innerHeight > window.innerWidth ? 'portrait' : 'landscape'
  })

  React.useEffect(() => {
    const handleOrientationChange = debounce(() => {
      setOrientation(window.innerHeight > window.innerWidth ? 'portrait' : 'landscape')
    }, 100)

    window.addEventListener('resize', handleOrientationChange)
    window.addEventListener('orientationchange', handleOrientationChange)

    return () => {
      window.removeEventListener('resize', handleOrientationChange)
      window.removeEventListener('orientationchange', handleOrientationChange)
    }
  }, [])

  return orientation
}

===== ./client/src/hooks/use-pwa.tsx =====
import { useState, useEffect } from 'react';
import { toast } from './use-toast';
import { isMobileDevice, isTouchDevice } from '@/utils/mobile';
import { Button } from '@/components/ui/button';

interface PWAInstallEvent extends Event {
  prompt: () => Promise<void>;
  userChoice: Promise<{ outcome: 'accepted' | 'dismissed' }>;
}

export function usePWA() {
  const [isInstalled, setIsInstalled] = useState(false);
  const [installPrompt, setInstallPrompt] = useState<PWAInstallEvent | null>(null);
  const [isSupported, setIsSupported] = useState(false);

  useEffect(() => {
    // Check if PWA is already installed
    const checkInstalled = () => {
      if (window.matchMedia('(display-mode: standalone)').matches) {
        setIsInstalled(true);
      }
    };

    // Check if PWA is supported
    const checkSupported = () => {
      setIsSupported('serviceWorker' in navigator && 'PushManager' in window);
    };

    // Listen for beforeinstallprompt event
    const handleBeforeInstallPrompt = (e: Event) => {
      e.preventDefault();
      setInstallPrompt(e as PWAInstallEvent);
    };

    // Listen for app installed event
    const handleAppInstalled = () => {
      setIsInstalled(true);
      setInstallPrompt(null);
    };

    checkInstalled();
    checkSupported();

    window.addEventListener('beforeinstallprompt', handleBeforeInstallPrompt);
    window.addEventListener('appinstalled', handleAppInstalled);

    return () => {
      window.removeEventListener('beforeinstallprompt', handleBeforeInstallPrompt);
      window.removeEventListener('appinstalled', handleAppInstalled);
    };
  }, []);

  const install = async (): Promise<boolean> => {
    if (!installPrompt) return false;

    try {
      await installPrompt.prompt();
      const { outcome } = await installPrompt.userChoice;
      
      if (outcome === 'accepted') {
        setInstallPrompt(null);
        return true;
      }
      return false;
    } catch (error) {
      console.error('Error installing PWA:', error);
      return false;
    }
  };

  return {
    isInstalled,
    isSupported,
    canInstall: !!installPrompt,
    install,
  };
}

export function registerServiceWorker(): Promise<ServiceWorkerRegistration | null> {
  if (!('serviceWorker' in navigator)) {
    console.log('Service Worker not supported');
    return Promise.resolve(null);
  }

  // Add a listener for messages from the service worker to handle the reload
  navigator.serviceWorker.addEventListener('message', (event) => {
    if (event.data && event.data.action === 'SW_UPDATED') {
      console.log('SW_UPDATED message received, reloading window...');
      window.location.reload();
    }
  });

  return navigator.serviceWorker
    .register('/sw.js')
    .then((registration) => {
      console.log('Service Worker registered successfully:', registration);
      
      // Check for updates
      registration.addEventListener('updatefound', () => {
        const newWorker = registration.installing;
        if (newWorker) {
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              // New content is available
              const isMobile = isMobileDevice() || isTouchDevice();
              
              console.log('New SW version available, isMobile:', isMobile);
              
              const handleUpdate = () => {
                console.log('Update button clicked, sending SKIP_WAITING message');
                newWorker.postMessage({ action: 'SKIP_WAITING' });
              };
              
              if (isMobile) {
                // Show toast notification for mobile users
                toast({
                  title: "🎉 Nova versão disponível!",
                  description: "Toque para atualizar o aplicativo agora.",
                  action: (
                    <Button
                      size="sm"
                      onClick={handleUpdate}
                    >
                      Atualizar
                    </Button>
                  ),
                });
              } else {
                // Fallback to confirm dialog for desktop
                if (confirm('Nova versão disponível. Atualizar agora?')) {
                  handleUpdate();
                }
              }
            }
          });
        }
      });

      return registration;
    })
    .catch((error) => {
      console.error('Service Worker registration failed:', error);
      return null;
    });
}
===== ./client/src/hooks/use-swipe.tsx =====
import { useState, useEffect, useCallback } from 'react';

interface SwipeInput {
  onSwipeLeft?: () => void;
  onSwipeRight?: () => void;
  onSwipeUp?: () => void;
  onSwipeDown?: () => void;
  minSwipeDistance?: number;
}

interface TouchPosition {
  x: number;
  y: number;
}

export function useSwipe({
  onSwipeLeft,
  onSwipeRight,
  onSwipeUp,
  onSwipeDown,
  minSwipeDistance = 50,
}: SwipeInput) {
  const [touchStartPos, setTouchStartPos] = useState<TouchPosition | null>(null);
  const [touchEndPos, setTouchEndPos] = useState<TouchPosition | null>(null);

  const onTouchStart = useCallback((e: TouchEvent) => {
    const touch = e.targetTouches[0];
    setTouchStartPos({
      x: touch.clientX,
      y: touch.clientY,
    });
  }, []);

  const onTouchEnd = useCallback(() => {
    if (!touchStartPos || !touchEndPos) return;

    const distanceX = touchStartPos.x - touchEndPos.x;
    const distanceY = touchStartPos.y - touchEndPos.y;
    const isLeftSwipe = distanceX > minSwipeDistance;
    const isRightSwipe = distanceX < -minSwipeDistance;
    const isUpSwipe = distanceY > minSwipeDistance;
    const isDownSwipe = distanceY < -minSwipeDistance;

    if (isLeftSwipe && onSwipeLeft) {
      onSwipeLeft();
    }
    if (isRightSwipe && onSwipeRight) {
      onSwipeRight();
    }
    if (isUpSwipe && onSwipeUp) {
      onSwipeUp();
    }
    if (isDownSwipe && onSwipeDown) {
      onSwipeDown();
    }
  }, [touchStartPos, touchEndPos, minSwipeDistance, onSwipeLeft, onSwipeRight, onSwipeUp, onSwipeDown]);

  const onTouchMove = useCallback((e: TouchEvent) => {
    const touch = e.targetTouches[0];
    setTouchEndPos({
      x: touch.clientX,
      y: touch.clientY,
    });
  }, []);

  useEffect(() => {
    document.addEventListener('touchstart', onTouchStart);
    document.addEventListener('touchmove', onTouchMove);
    document.addEventListener('touchend', onTouchEnd);

    return () => {
      document.removeEventListener('touchstart', onTouchStart);
      document.removeEventListener('touchmove', onTouchMove);
      document.removeEventListener('touchend', onTouchEnd);
    };
  }, [onTouchStart, onTouchMove, onTouchEnd]);

  return {
    touchStartPos,
    touchEndPos,
  };
}
===== ./client/src/hooks/use-toast.ts =====
import * as React from "react"

export const TOAST_LIMIT = 1
export const TOAST_REMOVE_DELAY = 1000000

type ToasterToast = {
  id: string
  title?: React.ReactNode
  description?: React.ReactNode
  action?: React.ReactElement
  variant?: "default" | "destructive"
  open?: boolean
  onOpenChange?: (open: boolean) => void
}

const actionTypes = {
  ADD_TOAST: "ADD_TOAST",
  UPDATE_TOAST: "UPDATE_TOAST",
  DISMISS_TOAST: "DISMISS_TOAST",
  REMOVE_TOAST: "REMOVE_TOAST",
} as const

let memoryState: State = { toasts: [] }

type ActionType = typeof actionTypes

type Action =
  | {
      type: ActionType["ADD_TOAST"]
      toast: ToasterToast
    }
  | {
      type: ActionType["UPDATE_TOAST"]
      toast: Partial<ToasterToast>
    }
  | {
      type: ActionType["DISMISS_TOAST"]
      toastId?: ToasterToast["id"]
    }
  | {
      type: ActionType["REMOVE_TOAST"]
      toastId?: ToasterToast["id"]
    }

interface State {
  toasts: ToasterToast[]
}

const toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()

const addToRemoveQueue = (toastId: string) => {
  if (toastTimeouts.has(toastId)) {
    return
  }

  const timeout = setTimeout(() => {
    toastTimeouts.delete(toastId)
    dispatch({
      type: "REMOVE_TOAST",
      toastId: toastId,
    })
  }, TOAST_REMOVE_DELAY)

  toastTimeouts.set(toastId, timeout)
}

export const reducer = (state: State, action: Action): State => {
  switch (action.type) {
    case "ADD_TOAST":
      return {
        ...state,
        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),
      }

    case "UPDATE_TOAST":
      return {
        ...state,
        toasts: state.toasts.map((t) =>
          t.id === action.toast.id ? { ...t, ...action.toast } : t
        ),
      }

    case "DISMISS_TOAST": {
      const { toastId } = action

      // ! Side effects ! - This could be extracted into a dismissToast() action,
      // but I'll keep it here for simplicity
      if (toastId) {
        addToRemoveQueue(toastId)
      } else {
        state.toasts.forEach((toast) => {
          addToRemoveQueue(toast.id)
        })
      }

      return {
        ...state,
        toasts: state.toasts.map((t) =>
          t.id === toastId || toastId === undefined
            ? {
                ...t,
                open: false,
              }
            : t
        ),
      }
    }
    case "REMOVE_TOAST":
      if (action.toastId === undefined) {
        return {
          ...state,
          toasts: [],
        }
      }
      return {
        ...state,
        toasts: state.toasts.filter((t) => t.id !== action.toastId),
      }
  }
}

const listeners: Array<(state: State) => void> = []

let count = 0

function genId() {
  count = (count + 1) % Number.MAX_SAFE_INTEGER
  return count.toString()
}

type ToastInput = Omit<ToasterToast, "id">

function toast({ ...props }: ToastInput) {
  const id = genId()

  const update = (props: ToasterToast) =>
    dispatch({
      type: "UPDATE_TOAST",
      toast: { ...props, id },
    })
  const dismiss = () => dispatch({ type: "DISMISS_TOAST", toastId: id })

  dispatch({
    type: "ADD_TOAST",
    toast: {
      ...props,
      id,
      open: true,
      onOpenChange: (open: boolean) => {
        if (!open) dismiss()
      },
    },
  })

  return {
    id: id,
    dismiss,
    update,
  }
}

function dispatch(action: Action) {
  memoryState = reducer(memoryState, action)
  listeners.forEach((listener) => {
    listener(memoryState)
  })
}

function useToast() {
  const [state, setState] = React.useState<State>(memoryState)

  React.useEffect(() => {
    listeners.push(setState)
    return () => {
      const index = listeners.indexOf(setState)
      if (index > -1) {
        listeners.splice(index, 1)
      }
    }
  }, [state])

  return {
    ...state,
    toast,
    dismiss: (toastId?: string) => dispatch({ type: "DISMISS_TOAST", toastId }),
  }
}

export { useToast, toast }
export type { ToasterToast }
===== ./client/src/index.css =====
@tailwind base;
@tailwind components;
@tailwind utilities;

:root {
  --background: hsl(0 0% 100%);
  --foreground: hsl(222.2 84% 4.9%);
  --card: hsl(0 0% 100%);
  --card-foreground: hsl(222.2 84% 4.9%);
  --popover: hsl(0 0% 100%);
  --popover-foreground: hsl(222.2 84% 4.9%);
  --primary: hsl(221.2 83.2% 53.3%);
  --primary-foreground: hsl(210 40% 98%);
  --secondary: hsl(210 40% 96%);
  --secondary-foreground: hsl(222.2 84% 4.9%);
  --muted: hsl(210 40% 96%);
  --muted-foreground: hsl(215.4 16.3% 46.9%);
  --accent: hsl(221.2 83.2% 53.3%);
  --accent-foreground: hsl(210 40% 98%);
  --destructive: hsl(0 84.2% 60.2%);
  --destructive-foreground: hsl(210 40% 98%);
  --border: hsl(214.3 31.8% 91.4%);
  --input: hsl(214.3 31.8% 91.4%);
  --ring: hsl(221.2 83.2% 53.3%);
  --chart-1: hsl(203.8863 88.2845% 53.1373%);
  --chart-2: hsl(159.7826 100% 36.0784%);
  --chart-3: hsl(42.0290 92.8251% 56.2745%);
  --chart-4: hsl(147.1429 78.5047% 41.9608%);
  --chart-5: hsl(341.4894 75.2000% 50.9804%);
  --sidebar: hsl(180 6.6667% 97.0588%);
  --sidebar-foreground: hsl(210 25% 7.8431%);
  --sidebar-primary: hsl(203.8863 88.2845% 53.1373%);
  --sidebar-primary-foreground: hsl(0 0% 100%);
  --sidebar-accent: hsl(211.5789 51.3514% 92.7451%);
  --sidebar-accent-foreground: hsl(203.8863 88.2845% 53.1373%);
  --sidebar-border: hsl(205.0000 25.0000% 90.5882%);
  --sidebar-ring: hsl(202.8169 89.1213% 53.1373%);
  --font-sans: Inter, sans-serif;
  --font-serif: Georgia, serif;
  --font-mono: Menlo, monospace;
  --radius: 0.5rem;
  
  /* DNutri Mockup Color Tokens */
  --dn-header-from: #8B5CF6;
  --dn-header-to: #A855F7;
  --dn-meal-from: #FF7A7A;
  --dn-meal-to: #FFB366;
  --shadow-2xs: 0px 2px 0px 0px hsl(202.8169 89.1213% 53.1373% / 0.00);
  --shadow-xs: 0px 2px 0px 0px hsl(202.8169 89.1213% 53.1373% / 0.00);
  --shadow-sm: 0px 2px 0px 0px hsl(202.8169 89.1213% 53.1373% / 0.00), 0px 1px 2px -1px hsl(202.8169 89.1213% 53.1373% / 0.00);
  --shadow: 0px 2px 0px 0px hsl(202.8169 89.1213% 53.1373% / 0.00), 0px 1px 2px -1px hsl(202.8169 89.1213% 53.1373% / 0.00);
  --shadow-md: 0px 2px 0px 0px hsl(202.8169 89.1213% 53.1373% / 0.00), 0px 2px 4px -1px hsl(202.8169 89.1213% 53.1373% / 0.00);
  --shadow-lg: 0px 2px 0px 0px hsl(202.8169 89.1213% 53.1373% / 0.00), 0px 4px 6px -1px hsl(202.8169 89.1213% 53.1373% / 0.00);
  --shadow-xl: 0px 2px 0px 0px hsl(202.8169 89.1213% 53.1373% / 0.00), 0px 8px 10px -1px hsl(202.8169 89.1213% 53.1373% / 0.00);
  --shadow-2xl: 0px 2px 0px 0px hsl(202.8169 89.1213% 53.1373% / 0.00);
  --tracking-normal: 0em;
  --spacing: 0.25rem;
}

.dark {
  --background: hsl(0 0% 0%);
  --foreground: hsl(200 6.6667% 91.1765%);
  --card: hsl(228 9.8039% 10%);
  --card-foreground: hsl(0 0% 85.0980%);
  --popover: hsl(0 0% 0%);
  --popover-foreground: hsl(200 6.6667% 91.1765%);
  --primary: hsl(203.7736 87.6033% 52.5490%);
  --primary-foreground: hsl(0 0% 100%);
  --secondary: hsl(195.0000 15.3846% 94.9020%);
  --secondary-foreground: hsl(210 25% 7.8431%);
  --muted: hsl(0 0% 9.4118%);
  --muted-foreground: hsl(210 3.3898% 46.2745%);
  --accent: hsl(203.7736 87.6033% 52.5490%);
  --accent-foreground: hsl(0 0% 100%);
  --destructive: hsl(0 84.2% 60.2%);
  --destructive-foreground: hsl(210 40% 98%);
  --border: hsl(210 5.2632% 14.9020%);
  --input: hsl(207.6923 27.6596% 18.4314%);
  --ring: hsl(221.2 83.2% 53.3%);
  --chart-1: hsl(203.8863 88.2845% 53.1373%);
  --chart-2: hsl(159.7826 100% 36.0784%);
  --chart-3: hsl(42.0290 92.8251% 56.2745%);
  --chart-4: hsl(147.1429 78.5047% 41.9608%);
  --chart-5: hsl(341.4894 75.2000% 50.9804%);
  --sidebar: hsl(228 9.8039% 10%);
  --sidebar-foreground: hsl(0 0% 85.0980%);
  --sidebar-primary: hsl(202.8169 89.1213% 53.1373%);
  --sidebar-primary-foreground: hsl(0 0% 100%);
  --sidebar-accent: hsl(205.7143 70% 7.8431%);
  --sidebar-accent-foreground: hsl(203.7736 87.6033% 52.5490%);
  --sidebar-border: hsl(205.7143 15.7895% 26.0784%);
  --sidebar-ring: hsl(202.8169 89.1213% 53.1373%);
  --font-sans: Inter, sans-serif;
  --font-serif: Georgia, serif;
  --font-mono: Menlo, monospace;
  --radius: 0.5rem;
  --shadow-2xs: 0px 2px 0px 0px hsl(202.8169 89.1213% 53.1373% / 0.00);
  --shadow-xs: 0px 2px 0px 0px hsl(202.8169 89.1213% 53.1373% / 0.00);
  --shadow-sm: 0px 2px 0px 0px hsl(202.8169 89.1213% 53.1373% / 0.00), 0px 1px 2px -1px hsl(202.8169 89.1213% 53.1373% / 0.00);
  --shadow: 0px 2px 0px 0px hsl(202.8169 89.1213% 53.1373% / 0.00), 0px 1px 2px -1px hsl(202.8169 89.1213% 53.1373% / 0.00);
  --shadow-md: 0px 2px 0px 0px hsl(202.8169 89.1213% 53.1373% / 0.00), 0px 2px 4px -1px hsl(202.8169 89.1213% 53.1373% / 0.00);
  --shadow-lg: 0px 2px 0px 0px hsl(202.8169 89.1213% 53.1373% / 0.00), 0px 4px 6px -1px hsl(202.8169 89.1213% 53.1373% / 0.00);
  --shadow-xl: 0px 2px 0px 0px hsl(202.8169 89.1213% 53.1373% / 0.00), 0px 8px 10px -1px hsl(202.8169 89.1213% 53.1373% / 0.00);
  --shadow-2xl: 0px 2px 0px 0px hsl(202.8169 89.1213% 53.1373% / 0.00);
}

@media print {
  .no-print {
    display: none !important;
  }
  .print-only {
    display: block !important;
  }
}

@layer base {
  * {
    @apply border-border;
  }

  body {
    @apply font-sans antialiased bg-background text-foreground;
    font-family: 'Inter', sans-serif;
  }
}

/* Mobile-specific styles */
@layer utilities {
  /* Safe area utilities for mobile devices */
  .safe-area-inset-top {
    padding-top: env(safe-area-inset-top);
  }
  
  .safe-area-inset-bottom {
    padding-bottom: env(safe-area-inset-bottom);
  }
  
  .safe-area-inset-left {
    padding-left: env(safe-area-inset-left);
  }
  
  .safe-area-inset-right {
    padding-right: env(safe-area-inset-right);
  }

  /* Touch-friendly sizing */
  .touch-target {
    @apply min-h-[44px] min-w-[44px];
  }

  /* Mobile optimized scrolling */
  .mobile-scroll {
    -webkit-overflow-scrolling: touch;
    scroll-behavior: smooth;
  }

  /* Hide scrollbar but keep functionality */
  .hide-scrollbar {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
  
  .hide-scrollbar::-webkit-scrollbar {
    display: none;
  }

  /* Mobile-first spacing */
  .mobile-container {
    @apply px-4 sm:px-6 lg:px-8;
  }

  /* Touch device optimization */
  .touch .hover\:bg-accent:hover {
    @apply bg-transparent;
  }
  
  .no-touch .hover\:bg-accent:hover {
    @apply bg-accent;
  }

  /* Mobile card optimization */
  .mobile-card {
    @apply rounded-lg border bg-card text-card-foreground shadow-sm;
    @apply p-4 sm:p-6;
  }
}
===== ./client/src/lib/authUtils.ts =====
export function isUnauthorizedError(error: Error): boolean {
  return /^401: .*Unauthorized/.test(error.message);
}
===== ./client/src/lib/pdf.ts =====
// This would normally use a library like jsPDF or react-pdf
// For now, we'll create a simple implementation that opens print dialog
// In a real application, you'd want to use a proper PDF generation library

export async function generatePDF(prescription: any, patient: any, nutritionist: any) {
  // For now, we'll just trigger the browser's print to PDF functionality
  // In a production app, you'd use jsPDF or similar
  window.print();
}

===== ./client/src/lib/queryClient.ts =====
import { QueryClient, QueryFunction } from "@tanstack/react-query";

async function throwIfResNotOk(res: Response) {
  if (!res.ok) {
    const text = (await res.text()) || res.statusText;
    throw new Error(`${res.status}: ${text}`);
  }
}

export async function apiRequest(
  method: string,
  url: string,
  data?: unknown | undefined,
): Promise<Response> {
  const res = await fetch(url, {
    method,
    headers: data ? { "Content-Type": "application/json" } : {},
    body: data ? JSON.stringify(data) : undefined,
    credentials: "include",
  });

  await throwIfResNotOk(res);
  return res;
}

type UnauthorizedBehavior = "returnNull" | "throw";
export const getQueryFn: <T>(options: {
  on401: UnauthorizedBehavior;
}) => QueryFunction<T> =
  ({ on401: unauthorizedBehavior }) =>
  async ({ queryKey }) => {
    const res = await fetch(queryKey.join("/") as string, {
      credentials: "include",
    });

    if (unauthorizedBehavior === "returnNull" && res.status === 401) {
      return null;
    }

    await throwIfResNotOk(res);
    return await res.json();
  };

export const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      queryFn: getQueryFn({ on401: "throw" }),
      refetchInterval: false,
      refetchOnWindowFocus: false,
      staleTime: Infinity,
      retry: false,
    },
    mutations: {
      retry: false,
    },
  },
});

===== ./client/src/lib/utils.ts =====
import { clsx, type ClassValue } from "clsx"
import { twMerge } from "tailwind-merge"

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}

===== ./client/src/main.tsx =====
import { createRoot } from "react-dom/client";
import App from "./App";
import "./index.css";
import { addTouchClass } from "./utils/mobile";
import { registerServiceWorker } from "./hooks/use-pwa";

// Initialize mobile optimizations
addTouchClass();

// Register service worker for PWA functionality
if (import.meta.env.PROD) {
  registerServiceWorker();
}

createRoot(document.getElementById("root")!).render(<App />);

===== ./client/src/pages/admin/create-user.tsx =====
import { useMutation, useQueryClient } from "@tanstack/react-query";
import { useLocation } from "wouter";
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";
import Header from "@/components/layout/header";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from "@/components/ui/form";
import { useToast } from "@/hooks/use-toast";
import { apiRequest } from "@/lib/queryClient";
import { DefaultMobileDrawer } from "@/components/layout/mobile-layout";

const createUserSchema = z.object({
  email: z.string().email("Email inválido."),
  firstName: z.string().min(1, "Nome é obrigatório."),
  lastName: z.string().min(1, "Sobrenome é obrigatório."),
  password: z.string().min(6, "A senha deve ter pelo menos 6 caracteres."),
  role: z.enum(["admin", "nutritionist"], {
    required_error: "Selecione um tipo de usuário.",
  }),
});

type CreateUserFormData = z.infer<typeof createUserSchema>;

export default function CreateUserPage() {
  const [, setLocation] = useLocation();
  const { toast } = useToast();
  const queryClient = useQueryClient();

  const form = useForm<CreateUserFormData>({
    resolver: zodResolver(createUserSchema),
    defaultValues: {
      email: "",
      firstName: "",
      lastName: "",
      password: "",
      role: undefined,
    },
  });

  const createUserMutation = useMutation({
    mutationFn: (data: CreateUserFormData) => apiRequest("POST", "/api/admin/users", data),
    onSuccess: () => {
      toast({
        title: "Usuário criado com sucesso!",
        description: "O novo usuário já pode acessar o sistema.",
      });
      queryClient.invalidateQueries({ queryKey: ["/api/admin/users"] });
      setLocation("/admin");
    },
    onError: (error: any) => {
      console.error("Erro ao criar usuário:", error);
      const errorMessage = error.message.includes("409")
        ? "Este email já está cadastrado no sistema."
        : "Não foi possível criar o usuário. Tente novamente.";
      toast({
        title: "Erro",
        description: errorMessage,
        variant: "destructive",
      });
    },
  });

  const onSubmit = (data: CreateUserFormData) => {
    createUserMutation.mutate(data);
  };

  return (
    <div className="min-h-screen bg-background">
      <Header
        title="Criar Novo Usuário"
        showBack={true}
        onBack={() => setLocation("/admin")}
        drawerContent={<DefaultMobileDrawer />}
      />
      <main className="max-w-2xl mx-auto p-4 lg:p-6">
        <Card>
          <CardHeader>
            <CardTitle>Informações do Usuário</CardTitle>
          </CardHeader>
          <CardContent>
            <Form {...form}>
              <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-6">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <FormField
                    control={form.control}
                    name="firstName"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Nome</FormLabel>
                        <FormControl>
                          <Input placeholder="Nome do usuário" {...field} />
                        </FormControl>
                        <FormMessage />
                      </FormItem>
                    )}
                  />
                  <FormField
                    control={form.control}
                    name="lastName"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Sobrenome</FormLabel>
                        <FormControl>
                          <Input placeholder="Sobrenome do usuário" {...field} />
                        </FormControl>
                        <FormMessage />
                      </FormItem>
                    )}
                  />
                </div>

                <FormField
                  control={form.control}
                  name="email"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>Email</FormLabel>
                      <FormControl>
                        <Input type="email" placeholder="email@exemplo.com" {...field} />
                      </FormControl>
                      <FormMessage />
                    </FormItem>
                  )}
                />

                <FormField
                  control={form.control}
                  name="password"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>Senha</FormLabel>
                      <FormControl>
                        <Input type="password" placeholder="••••••••" {...field} />
                      </FormControl>
                      <FormMessage />
                    </FormItem>
                  )}
                />

                <FormField
                  control={form.control}
                  name="role"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>Tipo de Usuário</FormLabel>
                      <Select onValueChange={field.onChange} value={field.value}>
                        <FormControl>
                          <SelectTrigger>
                            <SelectValue placeholder="Selecione o tipo de usuário" />
                          </SelectTrigger>
                        </FormControl>
                        <SelectContent>
                          <SelectItem value="admin">Administrador</SelectItem>
                          <SelectItem value="nutritionist">Nutricionista</SelectItem>
                        </SelectContent>
                      </Select>
                      <FormMessage />
                    </FormItem>
                  )}
                />

                <div className="flex flex-col sm:flex-row gap-3">
                  <Button
                    type="button"
                    variant="secondary"
                    className="flex-1"
                    onClick={() => setLocation("/admin")}
                  >
                    Cancelar
                  </Button>
                  <Button
                    type="submit"
                    className="flex-1"
                    disabled={createUserMutation.isPending}
                  >
                    {createUserMutation.isPending ? "Criando..." : "Criar Usuário"}
                  </Button>
                </div>
              </form>
            </Form>
          </CardContent>
        </Card>
      </main>
    </div>
  );
}
===== ./client/src/pages/admin/dashboard.tsx =====
import { useQuery } from "@tanstack/react-query";
import { useLocation } from "wouter";
import { Plus, Users, Shield, UserPlus, Settings, Edit } from "lucide-react";
import Header from "@/components/layout/header";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { DefaultMobileDrawer } from "@/components/layout/mobile-layout";
import type { User } from "@shared/schema";

export default function AdminDashboard() {
  const [, setLocation] = useLocation();

  const { data: users = [], isLoading } = useQuery<User[]>({
    queryKey: ["/api/admin/users"],
  });

  const userStats = {
    total: users.length,
    admins: users.filter(u => u.role === 'admin').length,
    nutritionists: users.filter(u => u.role === 'nutritionist').length,
    patients: users.filter(u => u.role === 'patient').length,
  };

  const formatDate = (dateString: string) => {
    return new Date(dateString).toLocaleDateString('pt-BR');
  };

  const getRoleBadgeVariant = (role: string) => {
    switch (role) {
      case 'admin': return 'destructive';
      case 'nutritionist': return 'default';
      case 'patient': return 'secondary';
      default: return 'outline';
    }
  };

  const getRoleLabel = (role: string) => {
    switch (role) {
      case 'admin': return 'Administrador';
      case 'nutritionist': return 'Nutricionista';
      case 'patient': return 'Paciente';
      default: return role;
    }
  };

  return (
    <div className="min-h-screen bg-background">
      <Header
        title="Painel Administrativo"
        drawerContent={<DefaultMobileDrawer />}
      />
      
      <main className="max-w-7xl mx-auto p-4 lg:p-6">
        <div className="flex justify-end mb-4">
          <div className="flex items-center space-x-3">
            <Button
              variant="outline"
              onClick={() => setLocation("/admin/profile")}
              className="flex items-center space-x-2"
              data-testid="button-profile"
            >
              <Settings className="h-4 w-4" />
              <span>Meu Perfil</span>
            </Button>
            <Button
              onClick={() => setLocation("/admin/create-user")}
              className="flex items-center space-x-2"
              data-testid="button-create-user"
            >
              <UserPlus className="h-4 w-4" />
              <span>Criar Usuário</span>
            </Button>
          </div>
        </div>

        {/* Estatísticas */}
        <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
          <Card>
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">Total de Usuários</CardTitle>
              <Users className="h-4 w-4 text-muted-foreground" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">{userStats.total}</div>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">Administradores</CardTitle>
              <Shield className="h-4 w-4 text-destructive" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">{userStats.admins}</div>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">Nutricionistas</CardTitle>
              <Users className="h-4 w-4 text-primary" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">{userStats.nutritionists}</div>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">Pacientes</CardTitle>
              <Users className="h-4 w-4 text-muted-foreground" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">{userStats.patients}</div>
            </CardContent>
          </Card>
        </div>

        {/* Lista de Usuários */}
        <Card>
          <CardHeader>
            <CardTitle>Usuários do Sistema</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="overflow-x-auto">
              <table className="w-full">
                <thead className="bg-muted/50">
                  <tr>
                    <th className="text-left p-4 font-medium text-muted-foreground">Usuário</th>
                    <th className="text-left p-4 font-medium text-muted-foreground">Tipo</th>
                    <th className="text-left p-4 font-medium text-muted-foreground">Criado em</th>
                    <th className="text-left p-4 font-medium text-muted-foreground">Ações</th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-border">
                  {isLoading ? (
                    <tr>
                      <td colSpan={4} className="p-8 text-center">
                        <div className="animate-spin rounded-full h-6 w-6 border-b-2 border-primary mx-auto mb-2"></div>
                        <p className="text-muted-foreground">Carregando usuários...</p>
                      </td>
                    </tr>
                  ) : users.length === 0 ? (
                    <tr>
                      <td colSpan={4} className="p-8 text-center">
                        <p className="text-muted-foreground">Nenhum usuário encontrado.</p>
                      </td>
                    </tr>
                  ) : (
                    users.map((user) => (
                      <tr key={user.id} className="hover:bg-muted/20 transition-colors">
                        <td className="p-4">
                          <div>
                            <div className="font-medium">
                              {user.firstName} {user.lastName}
                            </div>
                            <div className="text-sm text-muted-foreground">
                              {user.email}
                            </div>
                          </div>
                        </td>
                        <td className="p-4">
                          <Badge variant={getRoleBadgeVariant(user.role)}>
                            {getRoleLabel(user.role)}
                          </Badge>
                        </td>
                        <td className="p-4 text-muted-foreground">
                          {user.createdAt && formatDate(user.createdAt.toString())}
                        </td>
                        <td className="p-4">
                          <Button 
                            variant="ghost" 
                            size="sm"
                            onClick={() => setLocation(`/admin/users/${user.id}`)}
                            className="flex items-center space-x-2"
                            data-testid={`button-edit-user-${user.id}`}
                          >
                            <Edit className="h-4 w-4" />
                            <span>Editar</span>
                          </Button>
                        </td>
                      </tr>
                    ))
                  )}
                </tbody>
              </table>
            </div>
          </CardContent>
        </Card>
      </main>
    </div>
  );
}
===== ./client/src/pages/admin/edit-user.tsx =====
import { useState, useEffect } from "react";
import { useMutation, useQuery, useQueryClient } from "@tanstack/react-query";
import { useLocation } from "wouter";
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";
import { Trash2 } from "lucide-react";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from "@/components/ui/form";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent, AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle, AlertDialogTrigger } from "@/components/ui/alert-dialog";
import { useToast } from "@/hooks/use-toast";
import { useAuth } from "@/hooks/useAuth";
import { apiRequest } from "@/lib/queryClient";
import { MobileLayout, DefaultMobileDrawer } from "@/components/layout/mobile-layout";
import type { User } from "@shared/schema";

const updateUserSchema = z.object({
  firstName: z.string().min(1, "Nome é obrigatório."),
  lastName: z.string().min(1, "Sobrenome é obrigatório."),
  email: z.string().email("Email inválido."),
  role: z.enum(["admin", "nutritionist", "patient"], {
    required_error: "Selecione um tipo de usuário.",
  }),
});

const changePasswordSchema = z.object({
  newPassword: z.string().min(6, "A senha deve ter pelo menos 6 caracteres."),
  confirmPassword: z.string().min(1, "Confirmação de senha é obrigatória."),
}).refine(data => data.newPassword === data.confirmPassword, {
  message: "As senhas não coincidem.",
  path: ["confirmPassword"],
});

type UpdateUserFormData = z.infer<typeof updateUserSchema>;
type ChangePasswordFormData = z.infer<typeof changePasswordSchema>;

// Tipagem para dependencies
interface UserDependencies {
  hasPatients: boolean;
  hasPrescriptions: boolean;
  hasInvitations: boolean;
  canDelete: boolean;
}

interface EditUserPageProps {
  params: { id: string };
}

export default function EditUserPage({ params }: EditUserPageProps) {
  const [, setLocation] = useLocation();
  const { toast } = useToast();
  const { user: currentUser } = useAuth();
  const queryClient = useQueryClient();
  const [showDeleteDialog, setShowDeleteDialog] = useState(false);

  const { data: user, isLoading } = useQuery<User>({
    queryKey: ["/api/admin/users", params.id],
  });

  const { data: dependencies, isLoading: loadingDependencies } = useQuery<UserDependencies>({
    queryKey: ["/api/admin/users", params.id, "dependencies"],
    enabled: !!user && user.role !== 'admin' && user.id !== currentUser?.id,
  });

  const userForm = useForm<UpdateUserFormData>({
    resolver: zodResolver(updateUserSchema),
    defaultValues: {
      firstName: "",
      lastName: "",
      email: "",
      role: undefined,
    },
  });

  const passwordForm = useForm<ChangePasswordFormData>({
    resolver: zodResolver(changePasswordSchema),
    defaultValues: {
      newPassword: "",
      confirmPassword: "",
    },
  });

  // Atualizar o formulário quando os dados do usuário chegarem
  useEffect(() => {
    if (user) {
      userForm.reset({
        firstName: user.firstName || "",
        lastName: user.lastName || "",
        email: user.email || "",
        role: user.role as "admin" | "nutritionist" | "patient",
      });
    }
  }, [user, userForm]);

  const updateUserMutation = useMutation({
    mutationFn: (data: UpdateUserFormData) => 
      apiRequest("PUT", `/api/admin/users/${params.id}`, data),
    onSuccess: () => {
      toast({
        title: "Usuário atualizado com sucesso!",
        description: "As informações do usuário foram atualizadas.",
      });
      queryClient.invalidateQueries({ queryKey: ["/api/admin/users"] });
      queryClient.invalidateQueries({ queryKey: ["/api/admin/users", params.id] });
    },
    onError: (error: any) => {
      console.error("Erro ao atualizar usuário:", error);
      const errorMessage = error.message.includes("409")
        ? "Este email já está em uso por outro usuário."
        : "Não foi possível atualizar o usuário. Tente novamente.";
      toast({
        title: "Erro",
        description: errorMessage,
        variant: "destructive",
      });
    },
  });

  const changePasswordMutation = useMutation({
    mutationFn: (data: ChangePasswordFormData) => 
      apiRequest("PUT", `/api/admin/users/${params.id}/password`, {
        newPassword: data.newPassword,
      }),
    onSuccess: () => {
      toast({
        title: "Senha alterada com sucesso!",
        description: "A senha do usuário foi atualizada.",
      });
      passwordForm.reset();
    },
    onError: (error: any) => {
      console.error("Erro ao alterar senha:", error);
      toast({
        title: "Erro",
        description: "Não foi possível alterar a senha. Tente novamente.",
        variant: "destructive",
      });
    },
  });

  const deleteUserMutation = useMutation({
    mutationFn: () => apiRequest("DELETE", `/api/admin/users/${params.id}`),
    onSuccess: () => {
      toast({
        title: "Usuário excluído com sucesso!",
        description: "O usuário foi removido do sistema.",
      });
      queryClient.invalidateQueries({ queryKey: ["/api/admin/users"] });
      setLocation("/admin");
    },
    onError: (error: any) => {
      console.error("Erro ao excluir usuário:", error);
      let errorMessage = "Não foi possível excluir o usuário. Tente novamente.";
      
      if (error.message.includes("409")) {
        // Erro de dependência
        try {
          const errorBody = JSON.parse(error.message.split(": ")[1] || "{}");
          errorMessage = errorBody.message || "Este usuário possui dados associados que impedem a exclusão.";
        } catch {
          errorMessage = "Este usuário possui dados associados que impedem a exclusão.";
        }
      }
      
      toast({
        title: "Erro",
        description: errorMessage,
        variant: "destructive",
      });
    },
  });

  const onUpdateUser = (data: UpdateUserFormData) => {
    updateUserMutation.mutate(data);
  };

  const onChangePassword = (data: ChangePasswordFormData) => {
    changePasswordMutation.mutate(data);
  };

  const handleDeleteUser = () => {
    deleteUserMutation.mutate();
    setShowDeleteDialog(false);
  };

  const isCurrentUser = currentUser?.id === params.id;
  const isAdminUser = user?.role === 'admin';
  const canDelete = !isCurrentUser && !isAdminUser && (dependencies?.canDelete ?? false);

  const renderDeleteButton = () => {
    if (isCurrentUser || isAdminUser) return null;
    return (
      <AlertDialog open={showDeleteDialog} onOpenChange={setShowDeleteDialog}>
        <AlertDialogTrigger asChild>
          <Button 
            variant="destructive" 
            size="sm"
            disabled={!canDelete || loadingDependencies}
          >
            <Trash2 className="h-4 w-4 mr-2" />
            {loadingDependencies ? "Verificando..." : "Excluir Usuário"}
          </Button>
        </AlertDialogTrigger>
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle>Confirmar Exclusão</AlertDialogTitle>
            <AlertDialogDescription>
              Tem certeza de que deseja excluir o usuário <strong>{user?.firstName} {user?.lastName}</strong>?
              {dependencies?.hasPatients && (
                <div className="mt-2 p-2 bg-yellow-100 rounded text-yellow-800">
                  ⚠️ Este usuário possui pacientes associados. A exclusão não será possível.
                </div>
              )}
              {dependencies?.hasPrescriptions && (
                <div className="mt-2 p-2 bg-yellow-100 rounded text-yellow-800">
                  ⚠️ Este usuário possui prescrições associadas. A exclusão não será possível.
                </div>
              )}
              {dependencies?.hasInvitations && !dependencies?.hasPatients && !dependencies?.hasPrescriptions && (
                <div className="mt-2 p-2 bg-blue-100 rounded text-blue-800">
                  ℹ️ Este usuário possui convites que serão excluídos automaticamente.
                </div>
              )}
              {canDelete && (
                <div className="mt-2 text-red-600">
                  Esta ação não pode ser desfeita.
                </div>
              )}
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel>Cancelar</AlertDialogCancel>
            {canDelete && (
              <AlertDialogAction 
                onClick={handleDeleteUser}
                disabled={deleteUserMutation.isPending}
                className="bg-destructive text-destructive-foreground hover:bg-destructive/90"
              >
                {deleteUserMutation.isPending ? "Excluindo..." : "Excluir"}
              </AlertDialogAction>
            )}
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    );
  };

  if (isLoading) {
    return (
      <MobileLayout title="Carregando..." drawerContent={<DefaultMobileDrawer />}>
        <main className="max-w-2xl mx-auto">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto"></div>
        </main>
      </MobileLayout>
    );
  }

  if (!user) {
    return (
      <MobileLayout title="Usuário não encontrado" showBack={true} onBack={() => setLocation("/admin")} drawerContent={<DefaultMobileDrawer />}>
        <main className="max-w-2xl mx-auto">
          <p className="text-center text-muted-foreground">Usuário não encontrado.</p>
        </main>
      </MobileLayout>
    );
  }

  return (
    <MobileLayout
      title={`Editar: ${user.firstName} ${user.lastName}`}
      showBack={true}
      onBack={() => setLocation("/admin")}
      drawerContent={<DefaultMobileDrawer />}
    >
      <main className="max-w-2xl mx-auto">
        <div className="flex justify-end mb-4">
          {renderDeleteButton()}
        </div>
        <Tabs defaultValue="profile" className="space-y-6">
          <TabsList className="grid w-full grid-cols-2">
            <TabsTrigger value="profile">Informações do Usuário</TabsTrigger>
            <TabsTrigger value="password">Alterar Senha</TabsTrigger>
          </TabsList>

          <TabsContent value="profile">
            <Card>
              <CardHeader>
                <CardTitle>Informações do Usuário</CardTitle>
              </CardHeader>
              <CardContent>
                <Form {...userForm}>
                  <form onSubmit={userForm.handleSubmit(onUpdateUser)} className="space-y-6">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <FormField
                        control={userForm.control}
                        name="firstName"
                        render={({ field }) => (
                          <FormItem>
                            <FormLabel>Nome</FormLabel>
                            <FormControl>
                              <Input placeholder="Nome do usuário" {...field} />
                            </FormControl>
                            <FormMessage />
                          </FormItem>
                        )}
                      />
                      <FormField
                        control={userForm.control}
                        name="lastName"
                        render={({ field }) => (
                          <FormItem>
                            <FormLabel>Sobrenome</FormLabel>
                            <FormControl>
                              <Input placeholder="Sobrenome do usuário" {...field} />
                            </FormControl>
                            <FormMessage />
                          </FormItem>
                        )}
                      />
                    </div>

                    <FormField
                      control={userForm.control}
                      name="email"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Email</FormLabel>
                          <FormControl>
                            <Input type="email" placeholder="email@exemplo.com" {...field} />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />

                    <FormField
                      control={userForm.control}
                      name="role"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Tipo de Usuário</FormLabel>
                          <Select onValueChange={field.onChange} value={field.value}>
                            <FormControl>
                              <SelectTrigger>
                                <SelectValue placeholder="Selecione o tipo de usuário" />
                              </SelectTrigger>
                            </FormControl>
                            <SelectContent>
                              <SelectItem value="admin">Administrador</SelectItem>
                              <SelectItem value="nutritionist">Nutricionista</SelectItem>
                              <SelectItem value="patient">Paciente</SelectItem>
                            </SelectContent>
                          </Select>
                          <FormMessage />
                        </FormItem>
                      )}
                    />

                    <Button
                      type="submit"
                      className="w-full"
                      disabled={updateUserMutation.isPending}
                    >
                      {updateUserMutation.isPending ? "Atualizando..." : "Atualizar Usuário"}
                    </Button>
                  </form>
                </Form>
              </CardContent>
            </Card>
          </TabsContent>

          <TabsContent value="password">
            <Card>
              <CardHeader>
                <CardTitle>Alterar Senha do Usuário</CardTitle>
              </CardHeader>
              <CardContent>
                <Form {...passwordForm}>
                  <form onSubmit={passwordForm.handleSubmit(onChangePassword)} className="space-y-6">
                    <FormField
                      control={passwordForm.control}
                      name="newPassword"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Nova Senha</FormLabel>
                          <FormControl>
                            <Input type="password" placeholder="••••••••" autoComplete="new-password" {...field} />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />

                    <FormField
                      control={passwordForm.control}
                      name="confirmPassword"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Confirmar Nova Senha</FormLabel>
                          <FormControl>
                            <Input type="password" placeholder="••••••••" autoComplete="new-password" {...field} />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />

                    <Button
                      type="submit"
                      className="w-full"
                      disabled={changePasswordMutation.isPending}
                    >
                      {changePasswordMutation.isPending ? "Alterando..." : "Alterar Senha"}
                    </Button>
                  </form>
                </Form>
              </CardContent>
            </Card>
          </TabsContent>
        </Tabs>
      </main>
    </MobileLayout>
  );
}
===== ./client/src/pages/admin/profile.tsx =====
import { useMutation, useQueryClient } from "@tanstack/react-query";
import { useLocation } from "wouter";
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";
import { User, Lock } from "lucide-react";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from "@/components/ui/form";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { useToast } from "@/hooks/use-toast";
import { useAuth } from "@/hooks/useAuth";
import { apiRequest } from "@/lib/queryClient";
import { MobileLayout, DefaultMobileDrawer } from "@/components/layout/mobile-layout";

const changePasswordSchema = z.object({
  currentPassword: z.string().min(1, "Senha atual é obrigatória."),
  newPassword: z.string().min(6, "A nova senha deve ter pelo menos 6 caracteres."),
  confirmPassword: z.string().min(1, "Confirmação de senha é obrigatória."),
}).refine(data => data.newPassword === data.confirmPassword, {
  message: "As senhas não coincidem.",
  path: ["confirmPassword"],
});

const updateProfileSchema = z.object({
  firstName: z.string().min(1, "Nome é obrigatório."),
  lastName: z.string().min(1, "Sobrenome é obrigatório."),
  email: z.string().email("Email inválido."),
});

type ChangePasswordFormData = z.infer<typeof changePasswordSchema>;
type UpdateProfileFormData = z.infer<typeof updateProfileSchema>;

export default function AdminProfilePage() {
  const [, setLocation] = useLocation();
  const { toast } = useToast();
  const { user } = useAuth();
  const queryClient = useQueryClient();

  const passwordForm = useForm<ChangePasswordFormData>({
    resolver: zodResolver(changePasswordSchema),
    defaultValues: {
      currentPassword: "",
      newPassword: "",
      confirmPassword: "",
    },
  });

  const profileForm = useForm<UpdateProfileFormData>({
    resolver: zodResolver(updateProfileSchema),
    defaultValues: {
      firstName: user?.firstName || "",
      lastName: user?.lastName || "",
      email: user?.email || "",
    },
  });

  const changePasswordMutation = useMutation({
    mutationFn: (data: ChangePasswordFormData) => 
      apiRequest("PUT", "/api/auth/change-password", {
        currentPassword: data.currentPassword,
        newPassword: data.newPassword,
      }),
    onSuccess: () => {
      toast({
        title: "Senha alterada com sucesso!",
        description: "Sua senha foi atualizada.",
      });
      passwordForm.reset();
    },
    onError: (error: any) => {
      console.error("Erro ao alterar senha:", error);
      const errorMessage = error.message.includes("401")
        ? "Senha atual incorreta."
        : "Não foi possível alterar a senha. Tente novamente.";
      toast({
        title: "Erro",
        description: errorMessage,
        variant: "destructive",
      });
    },
  });

  const updateProfileMutation = useMutation({
    mutationFn: (data: UpdateProfileFormData) => 
      apiRequest("PUT", "/api/auth/profile", data),
    onSuccess: () => {
      toast({
        title: "Perfil atualizado com sucesso!",
        description: "Suas informações foram atualizadas.",
      });
      queryClient.invalidateQueries({ queryKey: ["/api/auth/user"] });
    },
    onError: (error: any) => {
      console.error("Erro ao atualizar perfil:", error);
      const errorMessage = error.message.includes("409")
        ? "Este email já está em uso por outro usuário."
        : "Não foi possível atualizar o perfil. Tente novamente.";
      toast({
        title: "Erro",
        description: errorMessage,
        variant: "destructive",
      });
    },
  });

  const onChangePassword = (data: ChangePasswordFormData) => {
    changePasswordMutation.mutate(data);
  };

  const onUpdateProfile = (data: UpdateProfileFormData) => {
    updateProfileMutation.mutate(data);
  };

  return (
    <MobileLayout
      title="Meu Perfil"
      showBack={true}
      onBack={() => setLocation("/admin")}
      drawerContent={<DefaultMobileDrawer />}
    >
      <main className="max-w-2xl mx-auto">
        <Tabs defaultValue="profile" className="space-y-6">
          <TabsList className="grid w-full grid-cols-2">
            <TabsTrigger value="profile" className="flex items-center space-x-2">
              <User className="h-4 w-4" />
              <span>Informações Pessoais</span>
            </TabsTrigger>
            <TabsTrigger value="password" className="flex items-center space-x-2">
              <Lock className="h-4 w-4" />
              <span>Alterar Senha</span>
            </TabsTrigger>
          </TabsList>

          <TabsContent value="profile">
            <Card>
              <CardHeader>
                <CardTitle>Informações Pessoais</CardTitle>
              </CardHeader>
              <CardContent>
                <Form {...profileForm}>
                  <form onSubmit={profileForm.handleSubmit(onUpdateProfile)} className="space-y-6">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <FormField
                        control={profileForm.control}
                        name="firstName"
                        render={({ field }) => (
                          <FormItem>
                            <FormLabel>Nome</FormLabel>
                            <FormControl>
                              <Input placeholder="Seu nome" {...field} />
                            </FormControl>
                            <FormMessage />
                          </FormItem>
                        )}
                      />
                      <FormField
                        control={profileForm.control}
                        name="lastName"
                        render={({ field }) => (
                          <FormItem>
                            <FormLabel>Sobrenome</FormLabel>
                            <FormControl>
                              <Input placeholder="Seu sobrenome" {...field} />
                            </FormControl>
                            <FormMessage />
                          </FormItem>
                        )}
                      />
                    </div>

                    <FormField
                      control={profileForm.control}
                      name="email"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Email</FormLabel>
                          <FormControl>
                            <Input type="email" placeholder="seu@email.com" {...field} />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />

                    <Button
                      type="submit"
                      className="w-full"
                      disabled={updateProfileMutation.isPending}
                    >
                      {updateProfileMutation.isPending ? "Atualizando..." : "Atualizar Perfil"}
                    </Button>
                  </form>
                </Form>
              </CardContent>
            </Card>
          </TabsContent>

          <TabsContent value="password">
            <Card>
              <CardHeader>
                <CardTitle>Alterar Senha</CardTitle>
              </CardHeader>
              <CardContent>
                <Form {...passwordForm}>
                  <form onSubmit={passwordForm.handleSubmit(onChangePassword)} className="space-y-6">
                    <FormField
                      control={passwordForm.control}
                      name="currentPassword"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Senha Atual</FormLabel>
                          <FormControl>
                            <Input type="password" placeholder="••••••••" {...field} />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />

                    <FormField
                      control={passwordForm.control}
                      name="newPassword"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Nova Senha</FormLabel>
                          <FormControl>
                            <Input type="password" placeholder="••••••••" {...field} />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />

                    <FormField
                      control={passwordForm.control}
                      name="confirmPassword"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Confirmar Nova Senha</FormLabel>
                          <FormControl>
                            <Input type="password" placeholder="••••••••" {...field} />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />

                    <Button
                      type="submit"
                      className="w-full"
                      disabled={changePasswordMutation.isPending}
                    >
                      {changePasswordMutation.isPending ? "Alterando..." : "Alterar Senha"}
                    </Button>
                  </form>
                </Form>
              </CardContent>
            </Card>
          </TabsContent>
        </Tabs>
      </main>
    </MobileLayout>
  );
}
===== ./client/src/pages/home.tsx =====
import { useAuth } from "@/hooks/useAuth";
import { useLocation } from "wouter";
import { useEffect } from "react";
import Header from "@/components/layout/header";

export default function Home() {
  const { isAdmin, isNutritionist, isPatient } = useAuth();
  const [, setLocation] = useLocation();

  useEffect(() => {
    if (isAdmin) {
      setLocation("/admin");
    } else if (isNutritionist) {
      setLocation("/patients");
    } else if (isPatient) {
      setLocation("/patient/prescription");
    }
  }, [isAdmin, isNutritionist, isPatient, setLocation]);

  return (
    <div className="min-h-screen bg-background">
      <Header />
      <main className="max-w-7xl mx-auto p-4 lg:p-6">
        <div className="text-center">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-4"></div>
          <p className="text-muted-foreground">Redirecionando...</p>
        </div>
      </main>
    </div>
  );
}
===== ./client/src/pages/landing.tsx =====
import { useState } from "react";
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";
import { useMutation, useQueryClient } from "@tanstack/react-query";
import { Eye, EyeOff, Loader2 } from "lucide-react";
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from "@/components/ui/form";
import { DiNutriLogo } from "@/components/ui/dinutri-logo";
import { useToast } from "@/hooks/use-toast";
import { apiRequest } from "@/lib/queryClient";

const loginSchema = z.object({
  email: z.string().email("Por favor, insira um email válido."),
  password: z.string().min(1, "A senha é obrigatória."),
});

type LoginFormData = z.infer<typeof loginSchema>;

export default function Landing() {
  const [showPassword, setShowPassword] = useState(false);
  const { toast } = useToast();
  const queryClient = useQueryClient();

  const form = useForm<LoginFormData>({
    resolver: zodResolver(loginSchema),
    defaultValues: {
      email: "",
      password: "",
    },
  });

  const loginMutation = useMutation({
    mutationFn: (data: LoginFormData) => apiRequest("POST", "/api/login", data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["/api/auth/user"] });
      toast({
        title: "Login realizado com sucesso!",
        description: "Redirecionando...",
      });
      // Recarrega a página para que o App.tsx possa redirecionar corretamente
      window.location.reload(); 
    },
    onError: (error) => {
      toast({
        title: "Erro de Login",
        description: "Email ou senha inválidos. Por favor, tente novamente.",
        variant: "destructive",
      });
      console.error("Login failed:", error);
    },
  });

  const onSubmit = (data: LoginFormData) => {
    loginMutation.mutate(data);
  };

  return (
    <>
      {/* Estilos CSS */}
      <style>{`
        @keyframes blob {
          0% {
            transform: translate(0px, 0px) scale(1);
          }
          33% {
            transform: translate(30px, -50px) scale(1.1);
          }
          66% {
            transform: translate(-20px, 20px) scale(0.9);
          }
          100% {
            transform: translate(0px, 0px) scale(1);
          }
        }
        .animate-blob {
          animation: blob 8s infinite;
        }
        .animation-delay-2000 {
          animation-delay: 2s;
        }
        .animation-delay-4000 {
          animation-delay: 4s;
        }
        
        /* Enhanced animations */
        @keyframes float {
          0%, 100% {
            transform: translateY(0px);
          }
          50% {
            transform: translateY(-20px);
          }
        }
        
        @keyframes pulse-glow {
          0%, 100% {
            box-shadow: 0 0 5px rgba(59, 130, 246, 0.3);
          }
          50% {
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.6), 0 0 30px rgba(147, 51, 234, 0.4);
          }
        }
        
        .animate-float {
          animation: float 6s ease-in-out infinite;
        }
        
        .animate-pulse-glow {
          animation: pulse-glow 3s ease-in-out infinite;
        }
      `}</style>

      <div className="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-purple-100 flex items-center justify-center p-4 relative overflow-hidden">
        {/* Enhanced Background decorative elements */}
        <div className="absolute inset-0 overflow-hidden">
          <div className="absolute -top-40 -right-40 w-96 h-96 bg-gradient-to-br from-blue-400 to-purple-500 rounded-full mix-blend-multiply filter blur-xl opacity-25 animate-blob"></div>
          <div className="absolute -bottom-40 -left-40 w-96 h-96 bg-gradient-to-br from-purple-400 to-indigo-500 rounded-full mix-blend-multiply filter blur-xl opacity-25 animate-blob animation-delay-2000"></div>
          <div className="absolute top-40 left-40 w-80 h-80 bg-gradient-to-br from-indigo-400 to-blue-500 rounded-full mix-blend-multiply filter blur-xl opacity-20 animate-blob animation-delay-4000"></div>
          <div className="absolute top-1/2 right-1/3 w-64 h-64 bg-gradient-to-br from-emerald-400 to-teal-500 rounded-full mix-blend-multiply filter blur-xl opacity-15 animate-blob animation-delay-2000"></div>
        </div>

        <div className="w-full max-w-md relative z-10">
          {/* Enhanced Logo Section */}
          <div className="flex flex-col items-center mb-8">
            <div className="mb-4 transform hover:scale-110 transition-transform duration-500 ease-out">
              <DiNutriLogo size="xl" variant="full" className="h-36 md:h-40 drop-shadow-lg" />
            </div>
            
            {/* Enhanced Tagline with gradient text */}
            <div className="text-center">
              <h1 className="text-3xl md:text-4xl font-bold bg-gradient-to-r from-gray-800 via-blue-800 to-purple-800 bg-clip-text text-transparent mb-2">
                Nutrição Inteligente
              </h1>
              <p className="text-gray-600 text-base md:text-lg font-medium">
                Sua plataforma completa de gestão nutricional
              </p>
            </div>
          </div>

          {/* Enhanced Card de login moderno */}
          <Card className="shadow-2xl border-0 bg-white/95 backdrop-blur-lg rounded-2xl overflow-hidden relative">
            {/* Card gradient border effect */}
            <div className="absolute inset-0 bg-gradient-to-r from-blue-500 via-purple-500 to-indigo-500 rounded-2xl blur-sm opacity-20"></div>
            <div className="relative bg-white/90 backdrop-blur-md rounded-2xl">
              <CardHeader className="space-y-4 text-center pb-6 pt-8 bg-gradient-to-br from-white via-blue-50/30 to-purple-50/30">
                <CardTitle className="text-2xl md:text-3xl font-bold bg-gradient-to-r from-gray-900 via-blue-900 to-purple-900 bg-clip-text text-transparent">
                  Bem-vindo de volta!
                </CardTitle>
                <CardDescription className="text-gray-600 text-base font-medium">
                  Acesse sua conta para continuar
                </CardDescription>
              </CardHeader>

            <CardContent className="space-y-6 p-8 bg-gradient-to-br from-white to-slate-50/50">
              <Form {...form}>
                <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-6">
                  <FormField
                    control={form.control}
                    name="email"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel className="text-gray-700 font-semibold text-base">Email</FormLabel>
                        <FormControl>
                          <Input
                            type="email"
                            placeholder="seu@email.com"
                            className="h-14 border-2 border-gray-200 focus:border-blue-500 focus:ring-4 focus:ring-blue-500 focus:ring-opacity-20 transition-all duration-300 rounded-xl text-base font-medium bg-white/80 backdrop-blur-sm"
                            {...field}
                          />
                        </FormControl>
                        <FormMessage />
                      </FormItem>
                    )}
                  />

                  <FormField
                    control={form.control}
                    name="password"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel className="text-gray-700 font-semibold text-base">Senha</FormLabel>
                        <FormControl>
                          <div className="relative">
                            <Input
                              type={showPassword ? "text" : "password"}
                              placeholder="••••••••"
                              className="h-14 border-2 border-gray-200 focus:border-blue-500 focus:ring-4 focus:ring-blue-500 focus:ring-opacity-20 transition-all duration-300 pr-14 rounded-xl text-base font-medium bg-white/80 backdrop-blur-sm"
                              {...field}
                            />
                            <Button
                              type="button"
                              variant="ghost"
                              size="sm"
                              className="absolute right-0 top-0 h-14 px-4 hover:bg-transparent text-gray-400 hover:text-gray-600 transition-colors duration-200"
                              onClick={() => setShowPassword(!showPassword)}
                            >
                              {showPassword ? (
                                <EyeOff className="h-5 w-5" />
                              ) : (
                                <Eye className="h-5 w-5" />
                              )}
                            </Button>
                          </div>
                        </FormControl>
                        <FormMessage />
                      </FormItem>
                    )}
                  />

                  <Button
                    type="submit"
                    className="w-full h-14 bg-gradient-to-r from-blue-600 via-purple-600 to-indigo-600 hover:from-blue-700 hover:via-purple-700 hover:to-indigo-700 text-white font-bold text-lg shadow-2xl hover:shadow-blue-500/25 transform hover:scale-[1.02] transition-all duration-300 rounded-xl border-0"
                    disabled={loginMutation.isPending}
                  >
                    {loginMutation.isPending ? (
                      <>
                        <Loader2 className="mr-3 h-6 w-6 animate-spin" />
                        Entrando...
                      </>
                    ) : (
                      "Entrar"
                    )}
                  </Button>
                </form>
              </Form>
            </CardContent>
            </div>
          </Card>

          {/* Enhanced Footer elegante */}
          <div className="text-center mt-8">
            <p className="text-sm text-gray-500 font-medium backdrop-blur-sm bg-white/30 py-2 px-4 rounded-full">
              © 2025 DiNutri. Todos os direitos reservados.
            </p>
          </div>
        </div>
      </div>
    </>
  );
}
===== ./client/src/pages/not-found.tsx =====
import { Card, CardContent } from "@/components/ui/card";
import { AlertCircle } from "lucide-react";

export default function NotFound() {
  return (
    <div className="min-h-screen w-full flex items-center justify-center bg-gray-50">
      <Card className="w-full max-w-md mx-4">
        <CardContent className="pt-6">
          <div className="flex mb-4 gap-2">
            <AlertCircle className="h-8 w-8 text-red-500" />
            <h1 className="text-2xl font-bold text-gray-900">404 Page Not Found</h1>
          </div>

          <p className="mt-4 text-sm text-gray-600">
            Did you forget to add the page to the router?
          </p>
        </CardContent>
      </Card>
    </div>
  );
}

===== ./client/src/pages/nutritionist/edit-patient.tsx =====
import { useEffect } from "react";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { useLocation } from "wouter";
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import Header from "@/components/layout/header";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Form, FormControl, FormField, FormItem, FormLabel, FormMessage, FormDescription } from "@/components/ui/form";
import { Checkbox } from "@/components/ui/checkbox";
import { useToast } from "@/hooks/use-toast";
import { apiRequest } from "@/lib/queryClient";
import { updatePatientSchema, type UpdatePatient, type Patient } from "@shared/schema";
import { DefaultMobileDrawer } from "@/components/layout/mobile-layout";

type FormData = UpdatePatient;

export default function EditPatientPage({ params }: { params: { id: string } }) {
  const [, setLocation] = useLocation();
  const { toast } = useToast();
  const queryClient = useQueryClient();

  const { data: patient, isLoading } = useQuery<Patient>({
    queryKey: ["/api/patients", params.id],
  });

  const form = useForm<FormData>({
    resolver: zodResolver(updatePatientSchema),
    defaultValues: {},
  });

  useEffect(() => {
    if (patient) {
      form.reset({
        ...patient,
        heightCm: patient.heightCm ?? undefined,
        weightKg: patient.weightKg ?? "",
        likedHealthyFoods: patient.likedHealthyFoods || [],
        dislikedFoods: patient.dislikedFoods || [],
        intolerances: patient.intolerances || [],
      });
    }
  }, [patient, form]);

  const updatePatientMutation = useMutation({
    mutationFn: (data: FormData) => apiRequest("PUT", `/api/patients/${params.id}`, data),
    onSuccess: () => {
      toast({
        title: "Sucesso!",
        description: "Os dados do paciente foram atualizados.",
      });
      queryClient.invalidateQueries({ queryKey: ["/api/patients", params.id] });
      queryClient.invalidateQueries({ queryKey: ["/api/patients"] });
      setLocation(`/patients/${params.id}`);
    },
    onError: (error: any) => {
      toast({
        title: "Erro",
        description: error.message || "Não foi possível atualizar o paciente.",
        variant: "destructive",
      });
    },
  });

  const onSubmit = (data: FormData) => {
    updatePatientMutation.mutate(data);
  };

  if (isLoading) {
    return (
      <div className="min-h-screen bg-background">
        <Header title="Carregando Paciente..." />
        <main className="max-w-4xl mx-auto p-4 lg:p-6 text-center">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto"></div>
        </main>
      </div>
    );
  }

  if (!patient) {
    return <div>Paciente não encontrado.</div>;
  }

  return (
    <div className="min-h-screen bg-background">
      <Header
        title={`Editando: ${patient.name}`}
        showBack={true}
        onBack={() => setLocation(`/patients/${params.id}`)}
        drawerContent={<DefaultMobileDrawer />}
      />
      <main className="max-w-4xl mx-auto p-4 lg:p-6">
        <Form {...form}>
          <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-8">
            <Card>
              <CardHeader><CardTitle>Dados Pessoais</CardTitle></CardHeader>
              <CardContent className="space-y-4">
                {/* Fields for personal data */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <FormField control={form.control} name="name" render={({ field }) => ( <FormItem> <FormLabel>Nome Completo</FormLabel> <FormControl><Input {...field} /></FormControl> <FormMessage /> </FormItem> )}/>
                  <FormField control={form.control} name="email" render={({ field }) => ( <FormItem> <FormLabel>E-mail</FormLabel> <FormControl><Input type="email" {...field} value={field.value ?? ""} /></FormControl> <FormMessage /> </FormItem> )}/>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <FormField control={form.control} name="birthDate" render={({ field }) => ( <FormItem> <FormLabel>Data de Nascimento</FormLabel> <FormControl><Input type="date" {...field} value={field.value ?? ""} /></FormControl> <FormMessage /> </FormItem> )}/>
                    <FormField control={form.control} name="sex" render={({ field }) => ( <FormItem> <FormLabel>Sexo</FormLabel> <Select onValueChange={field.onChange} value={field.value ?? ""}> <FormControl><SelectTrigger><SelectValue placeholder="Selecionar" /></SelectTrigger></FormControl> <SelectContent> <SelectItem value="F">Feminino</SelectItem> <SelectItem value="M">Masculino</SelectItem> <SelectItem value="Outro">Outro</SelectItem> </SelectContent> </Select> <FormMessage /> </FormItem> )}/>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <FormField control={form.control} name="heightCm" render={({ field }) => ( <FormItem> <FormLabel>Altura (cm)</FormLabel> <FormControl><Input type="number" {...field} value={field.value ?? ""} onChange={e => field.onChange(e.target.value === '' ? undefined : +e.target.value)} /></FormControl> <FormMessage /> </FormItem> )}/>
                    <FormField control={form.control} name="weightKg" render={({ field }) => ( <FormItem> <FormLabel>Peso (kg)</FormLabel> <FormControl><Input {...field} value={field.value ?? ""} /></FormControl> <FormDescription>Formato: 70.5</FormDescription> <FormMessage /> </FormItem> )}/>
                </div>
              </CardContent>
            </Card>

            <Card>
              <CardHeader><CardTitle>Anamnese Nutricional</CardTitle></CardHeader>
              <CardContent className="space-y-4">
                {/* Fields for anamnesis data */}
                <FormField control={form.control} name="goal" render={({ field }) => ( <FormItem> <FormLabel>Objetivo</FormLabel> <Select onValueChange={field.onChange} value={field.value ?? ""}> <FormControl><SelectTrigger><SelectValue placeholder="Selecionar" /></SelectTrigger></FormControl> <SelectContent> <SelectItem value="lose_weight">Perder peso</SelectItem> <SelectItem value="maintain_weight">Manter peso</SelectItem> <SelectItem value="gain_weight">Ganhar peso</SelectItem> </SelectContent> </Select> <FormMessage /> </FormItem> )}/>
                <FormField control={form.control} name="activityLevel" render={({ field }) => ( <FormItem> <FormLabel>Nível de Atividade</FormLabel> <Select onValueChange={field.onChange} value={field.value ?? ""}> <FormControl><SelectTrigger><SelectValue placeholder="Selecionar" /></SelectTrigger></FormControl> <SelectContent> <SelectItem value="1">1 - Sedentário</SelectItem> <SelectItem value="2">2 - Levemente ativo</SelectItem> <SelectItem value="3">3 - Moderadamente ativo</SelectItem> <SelectItem value="4">4 - Muito ativo</SelectItem> <SelectItem value="5">5 - Extremamente ativo</SelectItem> </SelectContent> </Select> <FormMessage /> </FormItem> )}/>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <FormField control={form.control} name="biotype" render={({ field }) => ( <FormItem> <FormLabel>Biotipo</FormLabel> <Select onValueChange={field.onChange} value={field.value ?? ""}> <FormControl><SelectTrigger><SelectValue placeholder="Selecionar" /></SelectTrigger></FormControl> <SelectContent> <SelectItem value="gain_weight_easily">Ganho peso facilmente</SelectItem> <SelectItem value="hard_to_gain">Dificuldade para ganhar peso</SelectItem> <SelectItem value="gain_muscle_easily">Ganho músculo facilmente</SelectItem> </SelectContent> </Select> <FormMessage /> </FormItem> )}/>
                  <FormField control={form.control} name="alcoholConsumption" render={({ field }) => ( <FormItem> <FormLabel>Consumo de Álcool</FormLabel> <Select onValueChange={field.onChange} value={field.value ?? ""}> <FormControl><SelectTrigger><SelectValue placeholder="Selecionar" /></SelectTrigger></FormControl> <SelectContent> <SelectItem value="no">Não bebo</SelectItem> <SelectItem value="moderate">Moderadamente</SelectItem> <SelectItem value="yes">Sim, frequentemente</SelectItem> </SelectContent> </Select> <FormMessage /> </FormItem> )}/>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <FormField control={form.control} name="mealsPerDayCurrent" render={({ field }) => ( <FormItem> <FormLabel>Refeições por dia (Atual)</FormLabel> <FormControl><Input type="number" {...field} value={field.value ?? ""} onChange={e => field.onChange(e.target.value === '' ? undefined : +e.target.value)} /></FormControl> <FormMessage /> </FormItem> )}/>
                  <FormField control={form.control} name="mealsPerDayWilling" render={({ field }) => ( <FormItem> <FormLabel>Refeições por dia (Disposto a fazer)</FormLabel> <FormControl><Input type="number" {...field} value={field.value ?? ""} onChange={e => field.onChange(e.target.value === '' ? undefined : +e.target.value)} /></FormControl> <FormMessage /> </FormItem> )}/>
                </div>

                <FormField control={form.control} name="canEatMorningSolids" render={({ field }) => ( <FormItem className="flex flex-row items-center justify-between rounded-lg border p-3 shadow-sm"> <div className="space-y-0.5"><FormLabel>Consegue comer sólidos pela manhã?</FormLabel></div> <FormControl><Checkbox checked={field.value ?? false} onCheckedChange={field.onChange} /></FormControl> </FormItem> )}/>

                <FormField control={form.control} name="likedHealthyFoods" render={({ field }) => ( <FormItem> <FormLabel>Alimentos saudáveis que gosta (separados por vírgula)</FormLabel> <FormControl><Textarea placeholder="Brócolis, quinoa..." {...field} value={Array.isArray(field.value) ? field.value.join(', ') : ''} onChange={e => field.onChange(e.target.value.split(',').map(s => s.trim()))} /></FormControl> <FormMessage /> </FormItem> )}/>

                <FormField control={form.control} name="dislikedFoods" render={({ field }) => ( <FormItem> <FormLabel>Alimentos que não gosta (separados por vírgula)</FormLabel> <FormControl><Textarea placeholder="Cebola, peixe..." {...field} value={Array.isArray(field.value) ? field.value.join(', ') : ''} onChange={e => field.onChange(e.target.value.split(',').map(s => s.trim()))} /></FormControl> <FormMessage /> </FormItem> )}/>

                <FormField control={form.control} name="diseases" render={({ field }) => ( <FormItem> <FormLabel>Doenças ou Condições de Saúde</FormLabel> <FormControl><Textarea placeholder="Diabetes, hipertensão..." {...field} value={field.value ?? ""} /></FormControl> <FormMessage /> </FormItem> )}/>

                <FormField control={form.control} name="medications" render={({ field }) => ( <FormItem> <FormLabel>Medicamentos em Uso</FormLabel> <FormControl><Textarea placeholder="Liste os medicamentos..." {...field} value={field.value ?? ""} /></FormControl> <FormMessage /> </FormItem> )}/>

                <FormField control={form.control} name="supplements" render={({ field }) => ( <FormItem> <FormLabel>Suplementos em Uso</FormLabel> <FormControl><Textarea placeholder="Whey protein, creatina..." {...field} value={field.value ?? ""} /></FormControl> <FormMessage /> </FormItem> )}/>

                <FormField control={form.control} name="hasIntolerance" render={({ field }) => ( <FormItem className="flex flex-row items-start space-x-3 space-y-0 pt-6"> <FormControl><Checkbox checked={field.value ?? false} onCheckedChange={field.onChange} /></FormControl> <div className="space-y-1 leading-none"><FormLabel>Possui intolerância alimentar?</FormLabel></div> <FormMessage /> </FormItem> )}/>
                {form.watch("hasIntolerance") && ( <FormField control={form.control} name="intolerances" render={({ field }) => ( <FormItem> <FormLabel>Quais intolerâncias?</FormLabel> <FormControl><Input placeholder="Lactose, glúten..." value={Array.isArray(field.value) ? field.value.join(', ') : ''} onChange={e => field.onChange(e.target.value.split(',').map(s => s.trim()))} /></FormControl> <FormMessage /> </FormItem> )}/> )}
                <FormField control={form.control} name="notes" render={({ field }) => ( <FormItem> <FormLabel>Observações Gerais</FormLabel> <FormControl><Textarea className="min-h-[100px]" {...field} value={field.value ?? ""} /></FormControl> <FormMessage /> </FormItem> )}/>
              </CardContent>
            </Card>

            <div className="flex justify-end space-x-4">
              <Button type="button" variant="outline" onClick={() => setLocation(`/patients/${params.id}`)}>Cancelar</Button>
              <Button type="submit" disabled={updatePatientMutation.isPending}>
                {updatePatientMutation.isPending ? "Salvando..." : "Salvar Alterações"}
              </Button>
            </div>
          </form>
        </Form>
      </main>
    </div>
  );
}
===== ./client/src/pages/nutritionist/new-patient.tsx =====
import { useState } from "react";
import { useMutation, useQueryClient } from "@tanstack/react-query";
import { useLocation } from "wouter";
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";
import Header from "@/components/layout/header";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Card, CardContent } from "@/components/ui/card";
import { Form, FormControl, FormDescription, FormField, FormItem, FormLabel, FormMessage } from "@/components/ui/form";
import { Checkbox } from "@/components/ui/checkbox";
import { Switch } from "@/components/ui/switch";
import { Label } from "@/components/ui/label";
import { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import { useToast } from "@/hooks/use-toast";
import { useAuth } from "@/hooks/useAuth";
import { apiRequest } from "@/lib/queryClient";
import { insertPatientSchema } from "@shared/schema";
import { DefaultMobileDrawer } from "@/components/layout/mobile-layout";
import { Copy, LinkIcon, UserPlus, User, Calendar, Activity, ClipboardList } from "lucide-react";

// O schema do formulário agora inclui todos os campos de anamnese
const formSchema = insertPatientSchema.omit({ ownerId: true, userId: true }).extend({
  heightCm: z.preprocess(
    (val) => (val === "" ? undefined : val),
    z.coerce.number().optional()
  ),
  weightKg: z.string().regex(/^\d+(\.\d{1,2})?$/, "Peso inválido. Ex: 65.50").optional().or(z.literal('')),
  password: z.string().min(6, "A senha deve ter no mínimo 6 caracteres."),
  // Transform string arrays for multi-select fields
  likedHealthyFoods: z.array(z.string()).default([]),
  dislikedFoods: z.array(z.string()).default([]),
  intolerances: z.array(z.string()).default([]),
});

type FormData = z.infer<typeof formSchema>;

export default function NewPatientPage() {
  const [, setLocation] = useLocation();
  const { toast } = useToast();
  const { user } = useAuth();
  const queryClient = useQueryClient();
  const [useInvitationLink, setUseInvitationLink] = useState(false);
  const [invitationLink, setInvitationLink] = useState<string | null>(null);

  const form = useForm<FormData>({
    resolver: zodResolver(formSchema),
    defaultValues: {
      name: "",
      email: "",
      password: "",
      birthDate: "",
      sex: undefined,
      heightCm: undefined,
      weightKg: "",
      notes: "",
      goal: undefined,
      activityLevel: undefined,
      likedHealthyFoods: [],
      dislikedFoods: [],
      hasIntolerance: false,
      intolerances: [],
      canEatMorningSolids: false,
      mealsPerDayCurrent: undefined,
      mealsPerDayWilling: undefined,
      alcoholConsumption: undefined,
      supplements: "",
      diseases: "",
      medications: "",
      biotype: undefined,
    },
  });

  const createInvitationMutation = useMutation({
    mutationFn: async () => {
      const res = await apiRequest("POST", "/api/invitations");
      return res.json();
    },
    onSuccess: (data: any) => {
      const token = data?.token;
      if (!token) {
        toast({
          title: "Erro",
          description: "Resposta inválida do servidor ao gerar convite.",
          variant: "destructive",
        });
        return;
      }
      const fullUrl = `${window.location.origin}/anamnese?token=${token}`;
      setInvitationLink(fullUrl);
      toast({ title: "Link de convite gerado!" });
    },
    onError: (err: any) => {
      console.error("Erro ao gerar convite:", err);
      const errorMessage = err?.message || "Não foi possível gerar o link de convite.";
      toast({
        title: "Erro",
        description: errorMessage,
        variant: "destructive",
      });
    },
  });

  const createPatientMutation = useMutation({
    mutationFn: async (data: FormData) => {
      const payload = { 
        ...data,
        ownerId: user?.id
      };
      
      // Normalize optional fields
      if (payload.weightKg === "") {
        delete (payload as any).weightKg;
      }

      const res = await apiRequest("POST", "/api/patients", payload);
      return res.json();
    },
    onSuccess: () => {
      toast({
        title: "Sucesso",
        description: "Paciente e seu acesso foram criados com sucesso!",
      });
      queryClient.invalidateQueries({ queryKey: ["/api/patients"] });
      setLocation("/patients");
    },
    onError: (error: any) => {
      console.error("Erro ao criar paciente:", error);
      const errorMessage = error?.message?.includes("409")
        ? "Já existe um usuário com este email."
        : error?.message || "Falha ao cadastrar paciente. Verifique os dados e tente novamente.";
      toast({
        title: "Erro",
        description: errorMessage,
        variant: "destructive",
      });
    },
  });

  const onSubmit = (data: FormData) => {
    if (!user?.id) {
      toast({
        title: "Erro",
        description: "Usuário não encontrado. Faça login novamente.",
        variant: "destructive",
      });
      return;
    }
    createPatientMutation.mutate(data);
  };

  const handleGenerateInvite = () => {
    createInvitationMutation.mutate();
  };

  const copyToClipboard = () => {
    if (invitationLink) {
      navigator.clipboard.writeText(invitationLink);
      toast({ title: "Link copiado para a área de transferência!" });
    }
  };

  return (
    <>
      {/* CSS Animations */}
      <style>{`
        @keyframes blob {
          0% {
            transform: translate(0px, 0px) scale(1);
          }
          33% {
            transform: translate(30px, -50px) scale(1.1);
          }
          66% {
            transform: translate(-20px, 20px) scale(0.9);
          }
          100% {
            transform: translate(0px, 0px) scale(1);
          }
        }
        .animate-blob {
          animation: blob 8s infinite;
        }
        .animation-delay-2000 {
          animation-delay: 2s;
        }
        .animation-delay-4000 {
          animation-delay: 4s;
        }
      `}</style>

      <div className="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-purple-100 relative overflow-hidden">
        {/* Enhanced Background decorative elements */}
        <div className="absolute inset-0 overflow-hidden">
          <div className="absolute -top-40 -right-40 w-96 h-96 bg-gradient-to-br from-blue-400 to-purple-500 rounded-full mix-blend-multiply filter blur-xl opacity-20 animate-blob"></div>
          <div className="absolute -bottom-40 -left-40 w-96 h-96 bg-gradient-to-br from-purple-400 to-indigo-500 rounded-full mix-blend-multiply filter blur-xl opacity-20 animate-blob animation-delay-2000"></div>
          <div className="absolute top-40 left-40 w-80 h-80 bg-gradient-to-br from-indigo-400 to-blue-500 rounded-full mix-blend-multiply filter blur-xl opacity-15 animate-blob animation-delay-4000"></div>
          <div className="absolute top-1/2 right-1/3 w-64 h-64 bg-gradient-to-br from-emerald-400 to-teal-500 rounded-full mix-blend-multiply filter blur-xl opacity-15 animate-blob animation-delay-2000"></div>
        </div>

        <Header 
          title="Novo Paciente"
          showBack={true}
          onBack={() => setLocation("/patients")}
          drawerContent={<DefaultMobileDrawer />}
        />
        
        <main className="max-w-4xl mx-auto p-4 lg:p-6 relative z-10">
          {/* Enhanced Header Section */}
          <div className="mb-8">
            <div className="bg-gradient-to-r from-blue-600 to-purple-600 rounded-2xl p-8 text-white shadow-xl">
              <div className="flex items-center gap-4">
                <div className="p-3 bg-white/20 rounded-xl backdrop-blur-sm">
                  <UserPlus className="h-8 w-8" />
                </div>
                <div>
                  <h1 className="text-3xl font-bold mb-2">Adicionar Novo Paciente</h1>
                  <p className="text-blue-100 text-lg opacity-90">Cadastre um novo paciente ou envie um convite para anamnese</p>
                </div>
              </div>
            </div>
          </div>

          <Card className="shadow-2xl border-0 bg-white/95 backdrop-blur-lg rounded-2xl overflow-hidden relative">
            {/* Card gradient border effect */}
            <div className="absolute inset-0 bg-gradient-to-r from-blue-500 via-purple-500 to-indigo-500 rounded-2xl blur-sm opacity-10"></div>
            <div className="relative bg-white/90 backdrop-blur-md rounded-2xl">
              <CardContent className="p-8">
                <div className="space-y-8">
                  <div className="flex items-center space-x-3 p-4 bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl border border-blue-100">
                    <Switch
                      id="use-invitation"
                      checked={useInvitationLink}
                      onCheckedChange={setUseInvitationLink}
                      className="data-[state=checked]:bg-gradient-to-r data-[state=checked]:from-blue-500 data-[state=checked]:to-purple-500"
                    />
                    <Label htmlFor="use-invitation" className="text-gray-700 font-medium cursor-pointer">
                      Enviar link de anamnese ao invés de preencher manualmente
                    </Label>
                  </div>
                  
                  {useInvitationLink ? (
                    <div className="space-y-6 text-center py-8">
                      <div className="mx-auto w-20 h-20 bg-gradient-to-r from-blue-100 to-purple-100 rounded-full flex items-center justify-center mb-6">
                        <LinkIcon className="h-10 w-10 text-blue-600" />
                      </div>
                      <div className="space-y-4">
                        <h3 className="text-xl font-semibold text-gray-900">Convite por Link de Anamnese</h3>
                        <p className="text-gray-600 max-w-md mx-auto leading-relaxed">
                          Ao gerar um link de convite, o paciente receberá um formulário completo de anamnese para preencher, 
                          criando automaticamente sua conta após o envio.
                        </p>
                      </div>
                      
                      <Button
                        onClick={handleGenerateInvite}
                        disabled={createInvitationMutation.isPending}
                        className="h-14 px-8 text-base bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white border-0 rounded-xl shadow-lg transition-all duration-200 transform hover:scale-[1.02] font-medium"
                      >
                        <LinkIcon className="h-5 w-5 mr-3" />
                        {createInvitationMutation.isPending ? "Gerando..." : "Gerar Link de Anamnese"}
                      </Button>
                    </div>
                  ) : (
                    <Form {...form}>
                      <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-8">
                        
                        {/* Dados Pessoais Section */}
                        <div className="space-y-6">
                          <div className="bg-gradient-to-r from-blue-500 to-indigo-500 rounded-xl p-4 text-white">
                            <div className="flex items-center gap-3">
                              <div className="p-2 bg-white/20 rounded-lg backdrop-blur-sm">
                                <User className="h-5 w-5" />
                              </div>
                              <h3 className="text-lg font-semibold">Dados Pessoais</h3>
                            </div>
                          </div>
                          
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <FormField
                              control={form.control}
                              name="name"
                              render={({ field }) => (
                                <FormItem>
                                  <FormLabel className="text-gray-700 font-semibold">Nome Completo *</FormLabel>
                                  <FormControl>
                                    <Input 
                                      placeholder="Nome do paciente" 
                                      className="h-12 border-2 border-gray-200 focus:border-blue-500 focus:ring-4 focus:ring-blue-500 focus:ring-opacity-20 transition-all duration-300 rounded-xl text-base bg-white/80 backdrop-blur-sm"
                                      {...field} 
                                    />
                                  </FormControl>
                                  <FormMessage />
                                </FormItem>
                              )}
                            />
                            <FormField
                              control={form.control}
                              name="email"
                              render={({ field }) => (
                                <FormItem>
                                  <FormLabel className="text-gray-700 font-semibold">E-mail *</FormLabel>
                                  <FormControl>
                                    <Input 
                                      type="email" 
                                      placeholder="email@exemplo.com" 
                                      className="h-12 border-2 border-gray-200 focus:border-blue-500 focus:ring-4 focus:ring-blue-500 focus:ring-opacity-20 transition-all duration-300 rounded-xl text-base bg-white/80 backdrop-blur-sm"
                                      value={field.value || ""} 
                                      onChange={field.onChange} 
                                      onBlur={field.onBlur} 
                                      name={field.name} 
                                      ref={field.ref} 
                                    />
                                  </FormControl>
                                  <FormMessage />
                                </FormItem>
                              )}
                            />
                          </div>

                          <FormField
                            control={form.control}
                            name="password"
                            render={({ field }) => (
                              <FormItem>
                                <FormLabel className="text-gray-700 font-semibold">Senha de Acesso *</FormLabel>
                                <FormControl>
                                  <Input 
                                    type="password" 
                                    placeholder="••••••••" 
                                    className="h-12 border-2 border-gray-200 focus:border-blue-500 focus:ring-4 focus:ring-blue-500 focus:ring-opacity-20 transition-all duration-300 rounded-xl text-base bg-white/80 backdrop-blur-sm"
                                    {...field} 
                                  />
                                </FormControl>
                                <FormMessage />
                              </FormItem>
                            )}
                          />

                          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <FormField
                              control={form.control}
                              name="birthDate"
                              render={({ field }) => (
                                <FormItem>
                                  <FormLabel className="text-gray-700 font-semibold">Data de Nascimento</FormLabel>
                                  <FormControl>
                                    <Input 
                                      type="date" 
                                      className="h-12 border-2 border-gray-200 focus:border-blue-500 focus:ring-4 focus:ring-blue-500 focus:ring-opacity-20 transition-all duration-300 rounded-xl text-base bg-white/80 backdrop-blur-sm"
                                      {...field} 
                                      value={field.value || ""} 
                                    />
                                  </FormControl>
                                  <FormMessage />
                                </FormItem>
                              )}
                            />
                            <FormField
                              control={form.control}
                              name="sex"
                              render={({ field }) => (
                                <FormItem>
                                  <FormLabel className="text-gray-700 font-semibold">Sexo</FormLabel>
                                  <Select onValueChange={field.onChange} value={field.value || ""}>
                                    <FormControl>
                                      <SelectTrigger className="h-12 border-2 border-gray-200 focus:border-blue-500 focus:ring-4 focus:ring-blue-500 focus:ring-opacity-20 transition-all duration-300 rounded-xl text-base bg-white/80 backdrop-blur-sm">
                                        <SelectValue placeholder="Selecionar" />
                                      </SelectTrigger>
                                    </FormControl>
                                    <SelectContent>
                                      <SelectItem value="F">Feminino</SelectItem>
                                      <SelectItem value="M">Masculino</SelectItem>
                                      <SelectItem value="Outro">Outro</SelectItem>
                                    </SelectContent>
                                  </Select>
                                  <FormMessage />
                                </FormItem>
                              )}
                            />
                            <FormField
                              control={form.control}
                              name="goal"
                              render={({ field }) => (
                                <FormItem>
                                  <FormLabel className="text-gray-700 font-semibold">Objetivo</FormLabel>
                                  <Select onValueChange={field.onChange} value={field.value || ""}>
                                    <FormControl>
                                      <SelectTrigger className="h-12 border-2 border-gray-200 focus:border-blue-500 focus:ring-4 focus:ring-blue-500 focus:ring-opacity-20 transition-all duration-300 rounded-xl text-base bg-white/80 backdrop-blur-sm">
                                        <SelectValue placeholder="Selecionar" />
                                      </SelectTrigger>
                                    </FormControl>
                                    <SelectContent>
                                      <SelectItem value="lose_weight">Perder peso</SelectItem>
                                      <SelectItem value="maintain_weight">Manter peso</SelectItem>
                                      <SelectItem value="gain_weight">Ganhar peso</SelectItem>
                                    </SelectContent>
                                  </Select>
                                  <FormMessage />
                                </FormItem>
                              )}
                            />
                          </div>

                          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <FormField
                              control={form.control}
                              name="heightCm"
                              render={({ field }) => (
                                <FormItem>
                                  <FormLabel className="text-gray-700 font-semibold">Altura (cm)</FormLabel>
                                  <FormControl>
                                    <Input
                                      type="number"
                                      placeholder="170"
                                      className="h-12 border-2 border-gray-200 focus:border-blue-500 focus:ring-4 focus:ring-blue-500 focus:ring-opacity-20 transition-all duration-300 rounded-xl text-base bg-white/80 backdrop-blur-sm"
                                      value={field.value ?? ""}
                                      onChange={(e) => field.onChange(e.target.value === "" ? undefined : Number(e.target.value))}
                                      onBlur={field.onBlur}
                                      name={field.name}
                                      ref={field.ref}
                                    />
                                  </FormControl>
                                  <FormDescription className="text-gray-500">Altura em centímetros (opcional)</FormDescription>
                                  <FormMessage />
                                </FormItem>
                              )}
                            />
                            <FormField
                              control={form.control}
                              name="weightKg"
                              render={({ field }) => (
                                <FormItem>
                                  <FormLabel className="text-gray-700 font-semibold">Peso (kg)</FormLabel>
                                  <FormControl>
                                    <Input
                                      placeholder="70.5"
                                      className="h-12 border-2 border-gray-200 focus:border-blue-500 focus:ring-4 focus:ring-blue-500 focus:ring-opacity-20 transition-all duration-300 rounded-xl text-base bg-white/80 backdrop-blur-sm"
                                      value={field.value || ""}
                                      onChange={field.onChange}
                                      onBlur={field.onBlur}
                                      name={field.name}
                                      ref={field.ref}
                                    />
                                  </FormControl>
                                  <FormDescription className="text-gray-500">Formato: 70.5 (opcional)</FormDescription>
                                  <FormMessage />
                                </FormItem>
                              )}
                            />
                          </div>
                        </div>

                        {/* Anamnese Básica Section */}
                        <div className="space-y-6">
                          <div className="bg-gradient-to-r from-emerald-500 to-teal-500 rounded-xl p-4 text-white">
                            <div className="flex items-center gap-3">
                              <div className="p-2 bg-white/20 rounded-lg backdrop-blur-sm">
                                <ClipboardList className="h-5 w-5" />
                              </div>
                              <h3 className="text-lg font-semibold">Anamnese Básica</h3>
                            </div>
                          </div>
                          
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <FormField
                              control={form.control}
                              name="activityLevel"
                              render={({ field }) => (
                                <FormItem>
                                  <FormLabel className="text-gray-700 font-semibold">Nível de Atividade</FormLabel>
                                  <Select onValueChange={field.onChange} value={field.value || ""}>
                                    <FormControl>
                                      <SelectTrigger className="h-12 border-2 border-gray-200 focus:border-emerald-500 focus:ring-4 focus:ring-emerald-500 focus:ring-opacity-20 transition-all duration-300 rounded-xl text-base bg-white/80 backdrop-blur-sm">
                                        <SelectValue placeholder="Selecionar" />
                                      </SelectTrigger>
                                    </FormControl>
                                    <SelectContent>
                                      <SelectItem value="1">1 - Sedentário</SelectItem>
                                      <SelectItem value="2">2 - Levemente ativo</SelectItem>
                                      <SelectItem value="3">3 - Moderadamente ativo</SelectItem>
                                      <SelectItem value="4">4 - Muito ativo</SelectItem>
                                      <SelectItem value="5">5 - Extremamente ativo</SelectItem>
                                    </SelectContent>
                                  </Select>
                                  <FormMessage />
                                </FormItem>
                              )}
                            />
                            <FormField
                              control={form.control}
                              name="hasIntolerance"
                              render={({ field }) => (
                                <FormItem className="flex flex-row items-start space-x-3 space-y-0 pt-8">
                                  <FormControl>
                                    <Checkbox
                                      checked={field.value || false}
                                      onCheckedChange={field.onChange}
                                      className="data-[state=checked]:bg-emerald-500 data-[state=checked]:border-emerald-500"
                                    />
                                  </FormControl>
                                  <div className="space-y-1 leading-none">
                                    <FormLabel className="text-gray-700 font-semibold cursor-pointer">Possui intolerância alimentar?</FormLabel>
                                  </div>
                                  <FormMessage />
                                </FormItem>
                              )}
                            />
                          </div>

                          {form.watch("hasIntolerance") && (
                            <FormField
                              control={form.control}
                              name="intolerances"
                              render={({ field }) => (
                                <FormItem>
                                  <FormLabel className="text-gray-700 font-semibold">Quais intolerâncias? (separar por vírgula)</FormLabel>
                                  <FormControl>
                                    <Input
                                      placeholder="Lactose, glúten, etc."
                                      className="h-12 border-2 border-gray-200 focus:border-emerald-500 focus:ring-4 focus:ring-emerald-500 focus:ring-opacity-20 transition-all duration-300 rounded-xl text-base bg-white/80 backdrop-blur-sm"
                                      value={field.value?.join(", ") || ""}
                                      onChange={(e) => field.onChange(e.target.value.split(",").map(s => s.trim()).filter(Boolean))}
                                      onBlur={field.onBlur}
                                      name={field.name}
                                      ref={field.ref}
                                    />
                                  </FormControl>
                                  <FormMessage />
                                </FormItem>
                              )}
                            />
                          )}
                        </div>

                        <FormField
                          control={form.control}
                          name="notes"
                          render={({ field }) => (
                            <FormItem>
                              <FormLabel className="text-gray-700 font-semibold">Observações</FormLabel>
                              <FormControl>
                                <Textarea 
                                  placeholder="Observações sobre o paciente..."
                                  className="min-h-[120px] border-2 border-gray-200 focus:border-blue-500 focus:ring-4 focus:ring-blue-500 focus:ring-opacity-20 transition-all duration-300 rounded-xl text-base bg-white/80 backdrop-blur-sm resize-none"
                                  value={field.value || ""}
                                  onChange={field.onChange}
                                  onBlur={field.onBlur}
                                  name={field.name}
                                  ref={field.ref}
                                />
                              </FormControl>
                              <FormMessage />
                            </FormItem>
                          )}
                        />

                        <div className="flex flex-col sm:flex-row justify-end gap-4 pt-6 border-t border-gray-200">
                          <Button
                            type="button"
                            variant="outline"
                            onClick={() => setLocation("/patients")}
                            className="h-12 px-8 text-base border-2 border-gray-300 hover:border-gray-400 hover:bg-gray-50 transition-all duration-200 rounded-xl font-medium"
                          >
                            Cancelar
                          </Button>
                          <Button 
                            type="submit"
                            disabled={createPatientMutation.isPending}
                            className="h-12 px-8 text-base bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white border-0 rounded-xl shadow-lg transition-all duration-200 transform hover:scale-[1.02] font-medium"
                          >
                            {createPatientMutation.isPending ? "Criando..." : "Criar Paciente"}
                          </Button>
                        </div>
                      </form>
                    </Form>
                  )}
                </div>
              </CardContent>
            </div>
          </Card>
        </main>

        {/* Enhanced Dialog for invitation link */}
        <Dialog open={!!invitationLink} onOpenChange={() => setInvitationLink(null)}>
          <DialogContent className="sm:max-w-md bg-white/95 backdrop-blur-lg border-0 shadow-2xl rounded-2xl">
            <DialogHeader className="text-center space-y-4 pb-4">
              <div className="mx-auto w-16 h-16 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center">
                <LinkIcon className="h-8 w-8 text-white" />
              </div>
              <DialogTitle className="text-2xl font-bold bg-gradient-to-r from-gray-900 via-blue-900 to-purple-900 bg-clip-text text-transparent">
                Link de Anamnese Gerado
              </DialogTitle>
              <DialogDescription className="text-gray-600 text-base">
                Envie este link para o paciente preencher sua anamnese nutricional completa.
              </DialogDescription>
            </DialogHeader>
            <div className="space-y-6">
              <div className="p-4 bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl border border-blue-100 font-mono text-sm break-all overflow-auto max-h-32">
                {invitationLink}
              </div>
              <div className="flex flex-col sm:flex-row gap-3">
                <Button 
                  variant="outline" 
                  onClick={() => setInvitationLink(null)}
                  className="flex-1 h-12 border-2 border-gray-300 hover:border-gray-400 hover:bg-gray-50 transition-all duration-200 rounded-xl font-medium"
                >
                  Fechar
                </Button>
                <Button 
                  onClick={copyToClipboard}
                  className="flex-1 h-12 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white border-0 rounded-xl shadow-lg transition-all duration-200 transform hover:scale-[1.02] font-medium"
                >
                  <Copy className="h-4 w-4 mr-2" />
                  Copiar Link
                </Button>
              </div>
            </div>
          </DialogContent>
        </Dialog>
      </div>
    </>
  );
}
===== ./client/src/pages/nutritionist/patient-details.tsx =====
import { useState } from "react";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { ArrowLeft, CheckCircle, Eye, FileText, Plus, Trash2, Users, XCircle, Link as LinkIcon, Copy, History, User, Calendar, Ruler, Weight, Target, Activity, Heart, Stethoscope, Pill, Camera, Image, Smile } from "lucide-react";
import { useLocation } from "wouter";
import { apiRequest } from "@/lib/queryClient";
import { useToast } from "@/hooks/use-toast";
import Header from "@/components/layout/header";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Input } from "@/components/ui/input";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogFooter } from "@/components/ui/dialog";
import { AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent, AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle, AlertDialogTrigger } from "@/components/ui/alert-dialog";
import { DefaultMobileDrawer } from "@/components/layout/mobile-layout";
import type { Patient, Prescription, AnamnesisRecord, FoodDiaryEntryWithPrescription, MealData, MoodType } from "@shared/schema";

export default function PatientDetails({ params }: { params: { id: string } }) {
  const [, setLocation] = useLocation();
  const { toast } = useToast();
  const queryClient = useQueryClient();
  const [prescriptionToDelete, setPrescriptionToDelete] = useState<string | null>(null);
  const [followUpLink, setFollowUpLink] = useState<string | null>(null);

  const { data: patient, isLoading: patientLoading } = useQuery<Patient>({
    queryKey: ["/api/patients", params.id],
  });

  const { data: prescriptions, isLoading: prescriptionsLoading } = useQuery<Prescription[]>({
    queryKey: ["/api/patients", params.id, "prescriptions"],
    enabled: !!patient,
  });

  const { data: anamnesisHistory, isLoading: historyLoading } = useQuery<AnamnesisRecord[]>({
    queryKey: ["/api/patients", params.id, "anamnesis-records"],
    enabled: !!patient,
  });

  const { data: foodDiaryEntries, isLoading: foodDiaryLoading } = useQuery<FoodDiaryEntryWithPrescription[]>({
    queryKey: ["/api/patients", params.id, "food-diary", "entries"],
    enabled: !!patient,
  });

  const createPrescriptionMutation = useMutation({
    mutationFn: async () => {
      const newPrescription = {
        patientId: params.id,
        title: `Prescrição ${new Date().toLocaleDateString('pt-BR')}`,
        meals: [],
        generalNotes: "",
      };
      const response = await apiRequest("POST", "/api/prescriptions", newPrescription);
      return await response.json();
    },
    onSuccess: (prescription) => {
      queryClient.invalidateQueries({ queryKey: ["/api/patients", params.id, "prescriptions"] });
      setLocation(`/prescriptions/${prescription.id}/edit`);
    },
    onError: () => {
      toast({
        title: "Erro",
        description: "Falha ao criar prescrição.",
        variant: "destructive",
      });
    },
  });

  const duplicatePrescriptionMutation = useMutation({
    mutationFn: async (prescriptionId: string) => {
      const title = `Cópia - ${new Date().toLocaleDateString('pt-BR')}`;
      const response = await apiRequest("POST", `/api/prescriptions/${prescriptionId}/duplicate`, { title });
      return await response.json();
    },
    onSuccess: (prescription) => {
      queryClient.invalidateQueries({ queryKey: ["/api/patients", params.id, "prescriptions"] });
      setLocation(`/prescriptions/${prescription.id}/edit`);
    },
    onError: () => {
      toast({
        title: "Erro",
        description: "Falha ao duplicar prescrição.",
        variant: "destructive",
      });
    },
  });

  const deletePrescriptionMutation = useMutation({
    mutationFn: async (prescriptionId: string) => {
      const response = await apiRequest("DELETE", `/api/prescriptions/${prescriptionId}`);
      if (response.status === 204) {
        return null;
      }
      return await response.json();
    },
    onSuccess: () => {
      toast({
        title: "Prescrição excluída",
        description: "A prescrição foi excluída com sucesso.",
      });
      queryClient.invalidateQueries({ queryKey: ["/api/patients", params.id, "prescriptions"] });
      setPrescriptionToDelete(null);
    },
    onError: (error: any) => {
      console.error("Erro ao excluir prescrição:", error);
      const errorMessage = error.message.includes("403")
        ? "Não é possível excluir prescrições publicadas."
        : "Não foi possível excluir a prescrição. Tente novamente.";
      toast({
        title: "Erro",
        description: errorMessage,
        variant: "destructive",
      });
      setPrescriptionToDelete(null);
    },
  });

  const requestFollowUpMutation = useMutation({
    mutationFn: () => apiRequest("POST", `/api/patients/${params.id}/request-follow-up`),
    onSuccess: async (res) => {
      const { followUpUrl } = await res.json();
      setFollowUpLink(followUpUrl);
    },
    onError: () => {
      toast({
        title: "Erro",
        description: "Falha ao gerar link de anamnese de retorno.",
        variant: "destructive",
      });
    }
  });

  const calculateAge = (birthDate: string) => {
    if (!birthDate) return null;
    const birth = new Date(birthDate);
    const today = new Date();
    const age = today.getFullYear() - birth.getFullYear();
    const monthDiff = today.getMonth() - birth.getMonth();
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
      return age - 1;
    }
    return age;
  };

  const formatDate = (dateString: string) => {
    return new Date(dateString).toLocaleDateString('pt-BR');
  };

  const getMoodEmoji = (mood: MoodType | null | undefined) => {
    if (!mood) return null;
    switch (mood) {
      case 'very_sad': return '😢';
      case 'sad': return '😟';
      case 'neutral': return '😐';
      case 'happy': return '😊';
      case 'very_happy': return '😄';
      default: return null;
    }
  };

  const getMoodLabel = (mood: MoodType | null | undefined) => {
    if (!mood) return null;
    switch (mood) {
      case 'very_sad': return 'Muito triste';
      case 'sad': return 'Triste';
      case 'neutral': return 'Neutro';
      case 'happy': return 'Feliz';
      case 'very_happy': return 'Muito feliz';
      default: return null;
    }
  };

  const handleDeletePrescription = (prescriptionId: string) => {
    deletePrescriptionMutation.mutate(prescriptionId);
  };

  if (patientLoading) {
    return (
      <div className="min-h-screen bg-background">
        <Header title="Carregando..." />
        <main className="max-w-7xl mx-auto p-4 lg:p-6 text-center">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto"></div>
        </main>
      </div>
    );
  }

  if (!patient) {
    return (
      <div className="min-h-screen bg-background">
        <Header 
          title="Paciente não encontrado" 
          showBack={true} 
          onBack={() => setLocation("/patients")} 
        />
        <main className="max-w-7xl mx-auto p-4 lg:p-6">
          <p className="text-center text-muted-foreground">Paciente não encontrado.</p>
        </main>
      </div>
    );
  }
  
  const hasAccountLinked = !!patient.userId;

  return (
    <div className="min-h-screen bg-background">
      <Header
        title={patient.name}
        subtitle={patient.email || undefined}
        showBack={true}
        onBack={() => setLocation("/patients")}
        drawerContent={<DefaultMobileDrawer />}
      />
      
      <main className="max-w-7xl mx-auto p-4 lg:p-6">
        {/* Enhanced Header Section */}
        <div className="mb-8 p-6 rounded-xl bg-gradient-to-r from-blue-600 via-purple-600 to-indigo-600 text-white shadow-xl">
          <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
            <div>
              <h1 className="text-2xl font-bold mb-2">Detalhes do Paciente</h1>
              <p className="text-blue-100 opacity-90">Visualize e gerencie as informações completas do paciente</p>
            </div>
            <Button
              onClick={() => createPrescriptionMutation.mutate()}
              disabled={createPrescriptionMutation.isPending || !hasAccountLinked}
              title={!hasAccountLinked ? "Paciente precisa ter um login para criar prescrições" : "Nova Prescrição"}
              data-testid="button-new-prescription"
              className="bg-white/20 hover:bg-white/30 border-white/30 text-white font-medium px-6 py-3 rounded-lg transition-all duration-200 shadow-lg hover:shadow-xl transform hover:scale-105 backdrop-blur-sm"
            >
              <Plus className="h-5 w-5 mr-2" />
              {createPrescriptionMutation.isPending ? "Criando..." : "Nova Prescrição"}
            </Button>
          </div>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          {/* Patient Info */}
          <div className="lg:col-span-1 space-y-6">
            <Card className="shadow-lg border-0 bg-gradient-to-br from-white to-blue-50/30 dark:from-gray-900 dark:to-gray-800/50 overflow-hidden">
              <CardHeader className="bg-gradient-to-r from-blue-600 to-purple-600 text-white pb-6">
                <div className="flex items-center gap-3">
                  <div className="p-2 bg-white/20 rounded-lg backdrop-blur-sm">
                    <User className="h-6 w-6" />
                  </div>
                  <div>
                    <CardTitle className="text-xl font-bold">Informações do Paciente</CardTitle>
                    <p className="text-blue-100 text-sm opacity-90">{patient.name}</p>
                  </div>
                </div>
              </CardHeader>
              <CardContent className="p-6">
                <div className="space-y-4">
                  {patient.birthDate && (
                    <div className="flex items-center gap-3 p-3 rounded-lg bg-gradient-to-r from-slate-50 to-blue-50 dark:from-slate-900/20 dark:to-blue-900/20 border border-slate-200/50 dark:border-slate-700/50">
                      <div className="p-2 bg-slate-100 dark:bg-slate-800 rounded-lg">
                        <Calendar className="h-4 w-4 text-slate-600 dark:text-slate-300" />
                      </div>
                      <div className="flex-1">
                        <span className="text-sm font-medium text-gray-600 dark:text-gray-300">Idade</span>
                        <p className="font-semibold text-gray-900 dark:text-white" data-testid="text-patient-age">{calculateAge(patient.birthDate)} anos</p>
                      </div>
                    </div>
                  )}
                  {patient.sex && (
                    <div className="flex items-center gap-3 p-3 rounded-lg bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 border border-blue-200/50 dark:border-blue-700/50">
                      <div className="p-2 bg-blue-100 dark:bg-blue-800 rounded-lg">
                        <User className="h-4 w-4 text-blue-600 dark:text-blue-300" />
                      </div>
                      <div className="flex-1">
                        <span className="text-sm font-medium text-gray-600 dark:text-gray-300">Sexo</span>
                        <p className="font-semibold text-gray-900 dark:text-white" data-testid="text-patient-sex">{patient.sex === 'F' ? 'Feminino' : patient.sex === 'M' ? 'Masculino' : 'Outro'}</p>
                      </div>
                    </div>
                  )}
                  {patient.heightCm && (
                    <div className="flex items-center gap-3 p-3 rounded-lg bg-gradient-to-r from-indigo-50 to-blue-50 dark:from-indigo-900/20 dark:to-blue-900/20 border border-indigo-200/50 dark:border-indigo-700/50">
                      <div className="p-2 bg-indigo-100 dark:bg-indigo-800 rounded-lg">
                        <Ruler className="h-4 w-4 text-indigo-600 dark:text-indigo-300" />
                      </div>
                      <div className="flex-1">
                        <span className="text-sm font-medium text-gray-600 dark:text-gray-300">Altura</span>
                        <p className="font-semibold text-gray-900 dark:text-white" data-testid="text-patient-height">{patient.heightCm} cm</p>
                      </div>
                    </div>
                  )}
                  {patient.weightKg && (
                    <div className="flex items-center gap-3 p-3 rounded-lg bg-gradient-to-r from-blue-50 to-slate-50 dark:from-blue-900/20 dark:to-slate-900/20 border border-blue-200/50 dark:border-blue-700/50">
                      <div className="p-2 bg-blue-100 dark:bg-blue-800 rounded-lg">
                        <Weight className="h-4 w-4 text-blue-600 dark:text-blue-300" />
                      </div>
                      <div className="flex-1">
                        <span className="text-sm font-medium text-gray-600 dark:text-gray-300">Peso</span>
                        <p className="font-semibold text-gray-900 dark:text-white" data-testid="text-patient-weight">{patient.weightKg} kg</p>
                      </div>
                    </div>
                  )}
                </div>
                {patient.notes && (
                  <div className="mt-6 p-4 rounded-lg bg-gradient-to-r from-gray-50 to-slate-50 dark:from-gray-800/50 dark:to-slate-800/50 border border-gray-200/50 dark:border-gray-700/50">
                    <h4 className="text-sm font-medium text-gray-600 dark:text-gray-300 mb-2">Observações</h4>
                    <p className="text-sm text-gray-700 dark:text-gray-300" data-testid="text-patient-notes">{patient.notes}</p>
                  </div>
                )}
                <div className="mt-6 space-y-3">
                  <Button 
                    variant="default" 
                    className="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-medium py-2.5 rounded-lg transition-all duration-200 shadow-md hover:shadow-lg transform hover:scale-[1.02]"
                    onClick={() => setLocation(`/patients/${patient.id}/edit`)}
                  >
                    <User className="h-4 w-4 mr-2" />
                    Editar Dados
                  </Button>
                  <Button 
                    variant="outline" 
                    className="w-full border-2 border-gray-200 dark:border-gray-700 hover:border-blue-300 dark:hover:border-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/20 font-medium py-2.5 rounded-lg transition-all duration-200 transform hover:scale-[1.02]"
                    onClick={() => requestFollowUpMutation.mutate()}
                    disabled={requestFollowUpMutation.isPending}
                  >
                    <FileText className="h-4 w-4 mr-2" />
                    {requestFollowUpMutation.isPending ? "Gerando link..." : "Solicitar Anamnese de Retorno"}
                  </Button>
                </div>
              </CardContent>
            </Card>

            {/* Anamnese Section with Tabs */}
            <Tabs defaultValue="current" className="w-full">
              <TabsList className="grid w-full grid-cols-2 bg-gray-100 dark:bg-gray-800 p-1 rounded-lg">
                <TabsTrigger value="current" className="rounded-md data-[state=active]:bg-white data-[state=active]:shadow-sm data-[state=active]:text-blue-600 font-medium transition-all">Anamnese Atual</TabsTrigger>
                <TabsTrigger value="history" className="rounded-md data-[state=active]:bg-white data-[state=active]:shadow-sm data-[state=active]:text-blue-600 font-medium transition-all">Histórico</TabsTrigger>
              </TabsList>
              <TabsContent value="current">
                <Card className="shadow-lg border-0 bg-gradient-to-br from-white to-emerald-50/30 dark:from-gray-900 dark:to-gray-800/50 overflow-hidden">
                  <CardHeader className="bg-gradient-to-r from-emerald-600 to-teal-600 text-white pb-6">
                    <div className="flex items-center gap-3">
                      <div className="p-2 bg-white/20 rounded-lg backdrop-blur-sm">
                        <Stethoscope className="h-6 w-6" />
                      </div>
                      <CardTitle className="text-xl font-bold">Anamnese Nutricional</CardTitle>
                    </div>
                  </CardHeader>
                  <CardContent className="p-6">
                    <div className="space-y-4">
                      {patient.goal && (
                        <div className="flex items-center gap-3 p-4 rounded-lg bg-gradient-to-r from-slate-50 to-blue-50 dark:from-slate-900/20 dark:to-blue-900/20 border border-slate-200/50 dark:border-slate-700/50">
                          <div className="p-2 bg-slate-100 dark:bg-slate-800 rounded-lg">
                            <Target className="h-5 w-5 text-slate-600 dark:text-slate-300" />
                          </div>
                          <div>
                            <span className="text-sm font-medium text-gray-600 dark:text-gray-300">Objetivo</span>
                            <p className="font-semibold text-gray-900 dark:text-white">
                              {patient.goal === 'lose_weight' ? 'Perder peso' : 
                               patient.goal === 'maintain_weight' ? 'Manter peso' : 
                               patient.goal === 'gain_weight' ? 'Ganhar peso' : patient.goal}
                            </p>
                          </div>
                        </div>
                      )}
                      
                      {patient.activityLevel && (
                        <div className="flex items-center gap-3 p-4 rounded-lg bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 border border-blue-200/50 dark:border-blue-700/50">
                          <div className="p-2 bg-blue-100 dark:bg-blue-800 rounded-lg">
                            <Activity className="h-5 w-5 text-blue-600 dark:text-blue-300" />
                          </div>
                          <div>
                            <span className="text-sm font-medium text-gray-600 dark:text-gray-300">Nível de Atividade</span>
                            <p className="font-semibold text-gray-900 dark:text-white">
                              {patient.activityLevel === '1' ? '1 - Sedentário' :
                               patient.activityLevel === '2' ? '2 - Levemente ativo' :
                               patient.activityLevel === '3' ? '3 - Moderadamente ativo' :
                               patient.activityLevel === '4' ? '4 - Muito ativo' :
                               patient.activityLevel === '5' ? '5 - Extremamente ativo' : patient.activityLevel}
                            </p>
                          </div>
                        </div>
                      )}

                      {patient.biotype && (
                        <div className="flex items-center gap-3 p-4 rounded-lg bg-gradient-to-r from-indigo-50 to-blue-50 dark:from-indigo-900/20 dark:to-blue-900/20 border border-indigo-200/50 dark:border-indigo-700/50">
                          <div className="p-2 bg-indigo-100 dark:bg-indigo-800 rounded-lg">
                            <User className="h-5 w-5 text-indigo-600 dark:text-indigo-300" />
                          </div>
                          <div>
                            <span className="text-sm font-medium text-gray-600 dark:text-gray-300">Biotipo</span>
                            <p className="font-semibold text-gray-900 dark:text-white">
                              {patient.biotype === 'gain_weight_easily' ? 'Ganho peso facilmente' :
                               patient.biotype === 'hard_to_gain' ? 'Dificuldade para ganhar peso' :
                               patient.biotype === 'gain_muscle_easily' ? 'Ganho músculo facilmente' : patient.biotype}
                            </p>
                          </div>
                        </div>
                      )}

                      {(patient.mealsPerDayCurrent || patient.mealsPerDayWilling) && (
                        <div className="flex items-center gap-3 p-4 rounded-lg bg-gradient-to-r from-blue-50 to-slate-50 dark:from-blue-900/20 dark:to-slate-900/20 border border-blue-200/50 dark:border-blue-700/50">
                          <div className="p-2 bg-blue-100 dark:bg-blue-800 rounded-lg">
                            <FileText className="h-5 w-5 text-blue-600 dark:text-blue-300" />
                          </div>
                          <div>
                            <span className="text-sm font-medium text-gray-600 dark:text-gray-300">Refeições por dia</span>
                            <p className="font-semibold text-gray-900 dark:text-white">
                              {patient.mealsPerDayCurrent && `Atual: ${patient.mealsPerDayCurrent}`}
                              {patient.mealsPerDayCurrent && patient.mealsPerDayWilling && ' | '}
                              {patient.mealsPerDayWilling && `Disposto: ${patient.mealsPerDayWilling}`}
                            </p>
                          </div>
                        </div>
                      )}

                      {patient.alcoholConsumption && (
                        <div className="flex items-center gap-3 p-4 rounded-lg bg-gradient-to-r from-slate-50 to-indigo-50 dark:from-slate-900/20 dark:to-indigo-900/20 border border-slate-200/50 dark:border-slate-700/50">
                          <div className="p-2 bg-slate-100 dark:bg-slate-800 rounded-lg">
                            <Heart className="h-5 w-5 text-slate-600 dark:text-slate-300" />
                          </div>
                          <div>
                            <span className="text-sm font-medium text-gray-600 dark:text-gray-300">Consumo de Álcool</span>
                            <p className="font-semibold text-gray-900 dark:text-white">
                              {patient.alcoholConsumption === 'no' ? 'Não bebe' :
                               patient.alcoholConsumption === 'moderate' ? 'Moderadamente' :
                               patient.alcoholConsumption === 'yes' ? 'Sim, frequentemente' : patient.alcoholConsumption}
                            </p>
                          </div>
                        </div>
                      )}

                      {patient.canEatMorningSolids !== undefined && (
                        <div className="flex items-center gap-3 p-4 rounded-lg bg-gradient-to-r from-indigo-50 to-slate-50 dark:from-indigo-900/20 dark:to-slate-900/20 border border-indigo-200/50 dark:border-indigo-700/50">
                          <div className="p-2 bg-indigo-100 dark:bg-indigo-800 rounded-lg">
                            <FileText className="h-5 w-5 text-indigo-600 dark:text-indigo-300" />
                          </div>
                          <div>
                            <span className="text-sm font-medium text-gray-600 dark:text-gray-300">Come sólidos pela manhã</span>
                            <p className="font-semibold text-gray-900 dark:text-white">{patient.canEatMorningSolids ? 'Sim' : 'Não'}</p>
                          </div>
                        </div>
                      )}

                      {patient.likedHealthyFoods && Array.isArray(patient.likedHealthyFoods) && patient.likedHealthyFoods.length > 0 && (
                        <div className="p-4 rounded-lg bg-gradient-to-r from-emerald-50 to-teal-50 dark:from-emerald-900/20 dark:to-teal-900/20 border border-emerald-200/50 dark:border-emerald-700/50">
                          <div className="flex items-center gap-2 mb-2">
                            <Heart className="h-4 w-4 text-emerald-600 dark:text-emerald-300" />
                            <span className="text-sm font-medium text-gray-600 dark:text-gray-300">Alimentos saudáveis que gosta</span>
                          </div>
                          <div className="flex flex-wrap gap-2">
                            {patient.likedHealthyFoods.map((food, index) => (
                              <span key={index} className="px-2 py-1 text-xs bg-emerald-100 dark:bg-emerald-800 text-emerald-700 dark:text-emerald-200 rounded-full">
                                {food}
                              </span>
                            ))}
                          </div>
                        </div>
                      )}

                      {patient.dislikedFoods && Array.isArray(patient.dislikedFoods) && patient.dislikedFoods.length > 0 && (
                        <div className="p-4 rounded-lg bg-gradient-to-r from-red-50 to-rose-50 dark:from-red-900/20 dark:to-rose-900/20 border border-red-200/50 dark:border-red-700/50">
                          <div className="flex items-center gap-2 mb-2">
                            <XCircle className="h-4 w-4 text-red-600 dark:text-red-300" />
                            <span className="text-sm font-medium text-gray-600 dark:text-gray-300">Alimentos que não gosta</span>
                          </div>
                          <div className="flex flex-wrap gap-2">
                            {patient.dislikedFoods.map((food, index) => (
                              <span key={index} className="px-2 py-1 text-xs bg-red-100 dark:bg-red-800 text-red-700 dark:text-red-200 rounded-full">
                                {food}
                              </span>
                            ))}
                          </div>
                        </div>
                      )}

                      {patient.hasIntolerance && patient.intolerances && Array.isArray(patient.intolerances) && patient.intolerances.length > 0 && (
                        <div className="p-4 rounded-lg bg-gradient-to-r from-orange-50 to-amber-50 dark:from-orange-900/20 dark:to-amber-900/20 border border-orange-200/50 dark:border-orange-700/50">
                          <div className="flex items-center gap-2 mb-2">
                            <XCircle className="h-4 w-4 text-orange-600 dark:text-orange-300" />
                            <span className="text-sm font-medium text-gray-600 dark:text-gray-300">Intolerâncias</span>
                          </div>
                          <div className="flex flex-wrap gap-2">
                            {patient.intolerances.map((intolerance, index) => (
                              <span key={index} className="px-2 py-1 text-xs bg-orange-100 dark:bg-orange-800 text-orange-700 dark:text-orange-200 rounded-full">
                                {intolerance}
                              </span>
                            ))}
                          </div>
                        </div>
                      )}

                      {patient.diseases && (
                        <div className="flex items-center gap-3 p-4 rounded-lg bg-gradient-to-r from-slate-50 to-blue-50 dark:from-slate-900/20 dark:to-blue-900/20 border border-slate-200/50 dark:border-slate-700/50">
                          <div className="p-2 bg-slate-100 dark:bg-slate-800 rounded-lg">
                            <Stethoscope className="h-5 w-5 text-slate-600 dark:text-slate-300" />
                          </div>
                          <div>
                            <span className="text-sm font-medium text-gray-600 dark:text-gray-300">Doenças/Condições</span>
                            <p className="font-semibold text-gray-900 dark:text-white">{patient.diseases}</p>
                          </div>
                        </div>
                      )}

                      {patient.medications && (
                        <div className="flex items-center gap-3 p-4 rounded-lg bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 border border-blue-200/50 dark:border-blue-700/50">
                          <div className="p-2 bg-blue-100 dark:bg-blue-800 rounded-lg">
                            <Pill className="h-5 w-5 text-blue-600 dark:text-blue-300" />
                          </div>
                          <div>
                            <span className="text-sm font-medium text-gray-600 dark:text-gray-300">Medicamentos</span>
                            <p className="font-semibold text-gray-900 dark:text-white">{patient.medications}</p>
                          </div>
                        </div>
                      )}

                      {patient.supplements && (
                        <div className="flex items-center gap-3 p-4 rounded-lg bg-gradient-to-r from-indigo-50 to-blue-50 dark:from-indigo-900/20 dark:to-blue-900/20 border border-indigo-200/50 dark:border-indigo-700/50">
                          <div className="p-2 bg-indigo-100 dark:bg-indigo-800 rounded-lg">
                            <Plus className="h-5 w-5 text-indigo-600 dark:text-indigo-300" />
                          </div>
                          <div>
                            <span className="text-sm font-medium text-gray-600 dark:text-gray-300">Suplementos</span>
                            <p className="font-semibold text-gray-900 dark:text-white">{patient.supplements}</p>
                          </div>
                        </div>
                      )}
                    </div>
                  </CardContent>
                </Card>
              </TabsContent>
              <TabsContent value="history">
                <Card className="shadow-lg border-0 bg-gradient-to-br from-white to-gray-50/30 dark:from-gray-900 dark:to-gray-800/50 overflow-hidden">
                  <CardHeader className="bg-gradient-to-r from-gray-600 to-slate-600 text-white pb-6">
                    <div className="flex items-center gap-3">
                      <div className="p-2 bg-white/20 rounded-lg backdrop-blur-sm">
                        <History className="h-6 w-6" />
                      </div>
                      <CardTitle className="text-xl font-bold">Histórico de Anamneses</CardTitle>
                    </div>
                  </CardHeader>
                  <CardContent className="p-6">
                    {historyLoading ? (
                      <div className="text-center py-8">
                        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-3"></div>
                        <p className="text-gray-600 dark:text-gray-300">Carregando histórico...</p>
                      </div>
                    ) : !anamnesisHistory || anamnesisHistory.length === 0 ? (
                      <div className="text-center py-8">
                        <History className="h-12 w-12 text-gray-400 mx-auto mb-3" />
                        <p className="text-gray-600 dark:text-gray-300">Nenhum registro encontrado.</p>
                      </div>
                    ) : (
                      <div className="space-y-4">
                        {anamnesisHistory.map(record => (
                          <div key={record.id} className="p-4 rounded-lg bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 border border-blue-200/50 dark:border-blue-700/50 hover:shadow-md transition-all duration-200">
                            <div className="flex items-center gap-2 mb-3">
                              <Calendar className="h-4 w-4 text-blue-600 dark:text-blue-300" />
                              <p className="font-semibold text-gray-900 dark:text-white">Data: {new Date(record.createdAt!).toLocaleDateString('pt-BR')}</p>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                              <div className="flex items-center gap-2">
                                <Weight className="h-3 w-3 text-orange-600 dark:text-orange-300" />
                                <span className="text-gray-600 dark:text-gray-300">Peso: <span className="font-medium text-gray-900 dark:text-white">{record.weightKg || 'N/A'} kg</span></span>
                              </div>
                              {record.goal && (
                                <div className="flex items-center gap-2">
                                  <Target className="h-3 w-3 text-emerald-600 dark:text-emerald-300" />
                                  <span className="text-gray-600 dark:text-gray-300">Objetivo: <span className="font-medium text-gray-900 dark:text-white">{
                                    record.goal === 'lose_weight' ? 'Perder peso' : 
                                    record.goal === 'maintain_weight' ? 'Manter peso' : 
                                    record.goal === 'gain_weight' ? 'Ganhar peso' : record.goal
                                  }</span></span>
                                </div>
                              )}
                              {record.protocolAdherence && (
                                <div className="flex items-center gap-2">
                                  <CheckCircle className="h-3 w-3 text-purple-600 dark:text-purple-300" />
                                  <span className="text-gray-600 dark:text-gray-300">Adesão: <span className="font-medium text-gray-900 dark:text-white">{
                                    record.protocolAdherence === 'total' ? 'Total' :
                                    record.protocolAdherence === 'partial' ? 'Parcial' :
                                    record.protocolAdherence === 'low' ? 'Baixa' : record.protocolAdherence
                                  }</span></span>
                                </div>
                              )}
                            </div>
                            {record.nextProtocolRequests && (
                              <div className="mt-3 p-3 bg-white/60 dark:bg-gray-800/60 rounded-md">
                                <p className="text-xs font-medium text-gray-600 dark:text-gray-300 mb-1">Solicitações para próximo plano:</p>
                                <p className="text-sm text-gray-700 dark:text-gray-300">{record.nextProtocolRequests}</p>
                              </div>
                            )}
                          </div>
                        ))}
                      </div>
                    )}
                  </CardContent>
                </Card>
              </TabsContent>
            </Tabs>

            <Card className="shadow-lg border-0 bg-gradient-to-br from-white to-green-50/30 dark:from-gray-900 dark:to-gray-800/50 overflow-hidden">
              <CardHeader className="bg-gradient-to-r from-green-600 to-emerald-600 text-white pb-6">
                <div className="flex items-center gap-3">
                  <div className="p-2 bg-white/20 rounded-lg backdrop-blur-sm">
                    <Users className="h-6 w-6" />
                  </div>
                  <CardTitle className="text-xl font-bold">Acesso do Paciente</CardTitle>
                </div>
              </CardHeader>
              <CardContent className="p-6">
                {hasAccountLinked ? (
                  <div className="flex items-center gap-4 p-4 rounded-lg bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 border border-green-200/50 dark:border-green-700/50">
                    <div className="p-3 bg-green-100 dark:bg-green-800 rounded-full">
                      <CheckCircle className="h-6 w-6 text-green-600 dark:text-green-300" />
                    </div>
                    <div>
                      <p className="font-semibold text-green-800 dark:text-green-200">Paciente tem acesso ao sistema</p>
                      <p className="text-sm text-green-600 dark:text-green-300">Prescrições podem ser criadas</p>
                    </div>
                  </div>
                ) : (
                  <div className="space-y-4">
                    <div className="flex items-center gap-4 p-4 rounded-lg bg-gradient-to-r from-amber-50 to-yellow-50 dark:from-amber-900/20 dark:to-yellow-900/20 border border-amber-200/50 dark:border-amber-700/50">
                      <div className="p-3 bg-amber-100 dark:bg-amber-800 rounded-full">
                        <XCircle className="h-6 w-6 text-amber-600 dark:text-amber-300" />
                      </div>
                      <div>
                        <p className="font-semibold text-amber-800 dark:text-amber-200">Paciente ainda não possui acesso</p>
                        <p className="text-sm text-amber-600 dark:text-amber-300">Cadastro pendente no sistema</p>
                      </div>
                    </div>
                    <div className="p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200/50 dark:border-blue-700/50">
                      <div className="flex items-start gap-2">
                        <FileText className="h-4 w-4 text-blue-600 dark:text-blue-300 mt-0.5" />
                        <p className="text-sm text-blue-700 dark:text-blue-300">
                          Para criar prescrições, o paciente precisa primeiro fazer o cadastro no sistema usando o link de cadastro fornecido.
                        </p>
                      </div>
                    </div>
                  </div>
                )}
              </CardContent>
            </Card>
          </div>

          {/* Prescriptions */}
          <div className="lg:col-span-2">
            <Card className="shadow-lg border-0 bg-gradient-to-br from-white to-purple-50/30 dark:from-gray-900 dark:to-gray-800/50 overflow-hidden">
              <CardHeader className="bg-gradient-to-r from-purple-600 to-indigo-600 text-white pb-6">
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-3">
                    <div className="p-2 bg-white/20 rounded-lg backdrop-blur-sm">
                      <FileText className="h-6 w-6" />
                    </div>
                    <CardTitle className="text-xl font-bold">Prescrições Nutricionais</CardTitle>
                  </div>
                </div>
              </CardHeader>
              <CardContent className="p-6">
                {prescriptionsLoading ? (
                  <div className="text-center py-12">
                    <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600 mx-auto mb-4"></div>
                    <p className="text-gray-600 dark:text-gray-300 font-medium">Carregando prescrições...</p>
                  </div>
                ) : prescriptions && prescriptions.length > 0 ? (
                  <div className="space-y-4">
                    {prescriptions.map((prescription) => (
                      <div key={prescription.id} className="p-4 sm:p-5 rounded-lg bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 border border-blue-200/50 dark:border-blue-700/50 hover:shadow-md transition-all duration-200 transform hover:scale-[1.01] overflow-hidden">
                        <div className="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3 mb-3">
                          <div className="flex items-center gap-3 min-w-0 flex-1">
                            <div className="p-2 bg-blue-100 dark:bg-blue-800 rounded-lg flex-shrink-0">
                              <FileText className="h-5 w-5 text-blue-600 dark:text-blue-300" />
                            </div>
                            <div className="min-w-0 flex-1">
                              <h3 className="font-semibold text-gray-900 dark:text-white text-lg truncate" data-testid={`text-prescription-title-${prescription.id}`}>
                                {prescription.title}
                              </h3>
                              <p className="text-sm text-gray-600 dark:text-gray-300">
                                Criada em {new Date(prescription.createdAt!).toLocaleDateString('pt-BR')}
                              </p>
                            </div>
                          </div>
                          <Badge 
                            variant={prescription.status === 'published' ? 'default' : 'secondary'}
                            className={`${prescription.status === 'published' 
                              ? 'bg-green-100 text-green-800 border-green-200 dark:bg-green-800 dark:text-green-100 dark:border-green-700' 
                              : 'bg-gray-100 text-gray-700 border-gray-200 dark:bg-gray-700 dark:text-gray-200 dark:border-gray-600'
                            } px-3 py-1 font-medium flex-shrink-0 self-start`}
                            data-testid={`badge-prescription-status-${prescription.id}`}
                          >
                            {prescription.status === 'published' ? 'Publicado' : 'Rascunho'}
                          </Badge>
                        </div>
                        {prescription.generalNotes && (
                          <div className="mt-3 p-3 bg-white/60 dark:bg-gray-800/60 rounded-md">
                            <p className="text-sm text-gray-700 dark:text-gray-300">{prescription.generalNotes}</p>
                          </div>
                        )}
                        <div className="flex flex-wrap items-center gap-2 mt-4">
                          <Button
                            variant="ghost"
                            size="sm"
                            onClick={() => setLocation(`/prescriptions/${prescription.id}/edit`)}
                            data-testid={`button-edit-prescription-${prescription.id}`}
                            className="bg-blue-100 hover:bg-blue-200 text-blue-700 border border-blue-200 dark:bg-blue-800 dark:hover:bg-blue-700 dark:text-blue-200 dark:border-blue-700 transition-all duration-200 rounded-lg"
                          >
                            <Eye className="h-4 w-4 mr-1" />
                            {prescription.status === 'published' ? 'Visualizar' : 'Editar'}
                          </Button>
                          <Button
                            variant="ghost"
                            size="sm"
                            onClick={() => duplicatePrescriptionMutation.mutate(prescription.id)}
                            disabled={duplicatePrescriptionMutation.isPending}
                            data-testid={`button-duplicate-prescription-${prescription.id}`}
                            className="bg-purple-100 hover:bg-purple-200 text-purple-700 border border-purple-200 dark:bg-purple-800 dark:hover:bg-purple-700 dark:text-purple-200 dark:border-purple-700 transition-all duration-200 rounded-lg"
                          >
                            <FileText className="h-4 w-4 mr-1" />
                            {duplicatePrescriptionMutation.isPending ? 'Duplicando...' : 'Duplicar'}
                          </Button>
                          <AlertDialog>
                            <AlertDialogTrigger asChild>
                              <Button
                                variant="ghost"
                                size="sm"
                                className="bg-red-50 hover:bg-red-100 text-red-700 border border-red-200 dark:bg-red-900/30 dark:hover:bg-red-900/50 dark:text-red-300 dark:border-red-700/50 transition-all duration-200 rounded-lg"
                                data-testid={`button-delete-prescription-${prescription.id}`}
                              >
                                <Trash2 className="h-4 w-4 mr-1" />
                                Excluir
                              </Button>
                            </AlertDialogTrigger>
                            <AlertDialogContent>
                              <AlertDialogHeader>
                                <AlertDialogTitle>Confirmar Exclusão</AlertDialogTitle>
                                <AlertDialogDescription>
                                  Tem certeza de que deseja excluir a prescrição "{prescription.title}"?
                                  <div className="mt-2 text-red-600">
                                    Esta ação não pode ser desfeita.
                                  </div>
                                </AlertDialogDescription>
                              </AlertDialogHeader>
                              <AlertDialogFooter>
                                <AlertDialogCancel>Cancelar</AlertDialogCancel>
                                <AlertDialogAction
                                  onClick={() => handleDeletePrescription(prescription.id)}
                                  disabled={deletePrescriptionMutation.isPending}
                                  className="bg-destructive text-destructive-foreground hover:bg-destructive/90"
                                >
                                  {deletePrescriptionMutation.isPending ? "Excluindo..." : "Excluir"}
                                </AlertDialogAction>
                              </AlertDialogFooter>
                            </AlertDialogContent>
                          </AlertDialog>
                        </div>
                      </div>
                    ))}
                  </div>
                ) : (
                  <div className="text-center py-12">
                    <div className="p-4 bg-gray-100 dark:bg-gray-800 rounded-full w-20 h-20 mx-auto mb-4 flex items-center justify-center">
                      <FileText className="h-10 w-10 text-gray-400 dark:text-gray-500" />
                    </div>
                    <h3 className="text-lg font-semibold text-gray-900 dark:text-white mb-2">Nenhuma prescrição criada</h3>
                    <p className="text-gray-600 dark:text-gray-300 mb-6 max-w-md mx-auto">
                      Comece criando a primeira prescrição nutricional para este paciente.
                    </p>
                    {hasAccountLinked ? (
                      <Button
                        onClick={() => createPrescriptionMutation.mutate()}
                        disabled={createPrescriptionMutation.isPending}
                        data-testid="button-create-first-prescription"
                        className="bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white font-medium px-6 py-3 rounded-lg transition-all duration-200 shadow-lg hover:shadow-xl transform hover:scale-105"
                      >
                        <Plus className="h-5 w-5 mr-2" />
                        {createPrescriptionMutation.isPending ? "Criando..." : "Criar Primeira Prescrição"}
                      </Button>
                    ) : (
                      <div className="p-4 bg-amber-50 dark:bg-amber-900/20 rounded-lg border border-amber-200/50 dark:border-amber-700/50 max-w-md mx-auto">
                        <div className="flex items-center gap-2 text-amber-700 dark:text-amber-300">
                          <XCircle className="h-5 w-5" />
                          <p className="font-medium">O paciente precisa ter um login para criar prescrições.</p>
                        </div>
                      </div>
                    )}
                  </div>
                )}
              </CardContent>
            </Card>
          </div>
        </div>

        {/* Food Diary Section */}
        <div className="mt-8">
          <Card className="shadow-lg border-0 bg-gradient-to-br from-white to-orange-50/30 dark:from-gray-900 dark:to-gray-800/50 overflow-hidden">
            <CardHeader className="bg-gradient-to-r from-orange-600 to-amber-600 text-white pb-6">
              <div className="flex items-center gap-3">
                <div className="p-2 bg-white/20 rounded-lg backdrop-blur-sm">
                  <Camera className="h-6 w-6" />
                </div>
                <CardTitle className="text-xl font-bold">Diário Alimentar</CardTitle>
              </div>
            </CardHeader>
            <CardContent className="p-6">
              {foodDiaryLoading ? (
                <div className="text-center py-12">
                  <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-orange-600 mx-auto mb-4"></div>
                  <p className="text-gray-600 dark:text-gray-300 font-medium">Carregando diário alimentar...</p>
                </div>
              ) : foodDiaryEntries && foodDiaryEntries.length > 0 ? (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                  {foodDiaryEntries.map((entry) => {
                    // Find the meal name from the prescription meals
                    const mealName = entry.prescriptionMeals?.find((meal: MealData) => meal.id === entry.mealId)?.name || `Refeição ${entry.mealId}`;
                    
                    return (
                      <div key={entry.id} className="bg-gradient-to-br from-white to-orange-50 dark:from-gray-800 dark:to-orange-900/10 rounded-lg border border-orange-200/50 dark:border-orange-700/50 overflow-hidden shadow-md hover:shadow-lg transition-all duration-200">
                        <div className="aspect-square relative">
                          <img 
                            src={entry.imageUrl} 
                            alt="Foto da refeição" 
                            className="w-full h-full object-cover"
                            onError={(e) => {
                              const img = e.target as HTMLImageElement;
                              img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2Y5ZmFmYiIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM2YjcyODAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5JbWFnZW0gbsOjbyBlbmNvbnRyYWRhPC90ZXh0Pjwvc3ZnPg==';
                            }}
                          />
                          <div className="absolute top-2 right-2 bg-black/50 text-white text-xs px-2 py-1 rounded backdrop-blur-sm">
                            {formatDate(entry.date)}
                          </div>
                        </div>
                        <div className="p-4">
                          <div className="flex items-center gap-2 mb-2">
                            <Image className="h-4 w-4 text-orange-600 dark:text-orange-300" />
                            <span className="font-semibold text-gray-900 dark:text-white">{mealName}</span>
                          </div>
                          {entry.prescriptionTitle && (
                            <div className="mb-2">
                              <span className="text-xs text-gray-500 dark:text-gray-400">
                                Prescrição: {entry.prescriptionTitle}
                              </span>
                            </div>
                          )}
                          
                          {/* Mood Information */}
                          {(entry.moodBefore || entry.moodAfter) && (
                            <div className="mb-3 p-3 rounded-lg bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20 border border-blue-200/50 dark:border-blue-700/50">
                              <div className="flex items-center gap-2 mb-2">
                                <Smile className="h-4 w-4 text-purple-600 dark:text-purple-300" />
                                <span className="text-sm font-medium text-gray-700 dark:text-gray-200">Humor</span>
                              </div>
                              <div className="space-y-1 text-sm">
                                {entry.moodBefore && (
                                  <div className="flex items-center gap-2">
                                    <span className="text-xs text-gray-500 dark:text-gray-400">Antes:</span>
                                    <span className="text-lg">{getMoodEmoji(entry.moodBefore)}</span>
                                    <span className="text-gray-700 dark:text-gray-300">{getMoodLabel(entry.moodBefore)}</span>
                                  </div>
                                )}
                                {entry.moodAfter && (
                                  <div className="flex items-center gap-2">
                                    <span className="text-xs text-gray-500 dark:text-gray-400">Depois:</span>
                                    <span className="text-lg">{getMoodEmoji(entry.moodAfter)}</span>
                                    <span className="text-gray-700 dark:text-gray-300">{getMoodLabel(entry.moodAfter)}</span>
                                  </div>
                                )}
                              </div>
                              {entry.moodNotes && (
                                <div className="mt-2 text-xs text-gray-600 dark:text-gray-400">
                                  <span className="font-medium">Observações do humor:</span> {entry.moodNotes}
                                </div>
                              )}
                            </div>
                          )}

                          {entry.notes && (
                            <div className="mt-2">
                              <p className="text-sm text-gray-600 dark:text-gray-300">
                                <span className="font-medium">Observações da refeição:</span> {entry.notes}
                              </p>
                            </div>
                          )}
                          <div className="mt-3 text-xs text-gray-500 dark:text-gray-400">
                            Enviado em {new Date(entry.createdAt!).toLocaleDateString('pt-BR')} às {new Date(entry.createdAt!).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              ) : (
                <div className="text-center py-12">
                  <div className="p-4 bg-gray-100 dark:bg-gray-800 rounded-full w-20 h-20 mx-auto mb-4 flex items-center justify-center">
                    <Camera className="h-10 w-10 text-gray-400 dark:text-gray-500" />
                  </div>
                  <h3 className="text-lg font-semibold text-gray-900 dark:text-white mb-2">Nenhuma foto enviada</h3>
                  <p className="text-gray-600 dark:text-gray-300 mb-6 max-w-md mx-auto">
                    O paciente ainda não enviou fotos das refeições. As imagens aparecerão aqui quando forem enviadas.
                  </p>
                </div>
              )}
            </CardContent>
          </Card>
        </div>
      </main>

      {/* Dialog for showing follow-up link */}
      <Dialog open={!!followUpLink} onOpenChange={() => setFollowUpLink(null)}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>Link de Anamnese de Retorno</DialogTitle>
            <DialogDescription>Envie este link para o paciente.</DialogDescription>
          </DialogHeader>
          <div className="flex items-center space-x-2">
            <Input value={followUpLink || ""} readOnly />
            <Button variant="outline" size="icon" onClick={() => navigator.clipboard.writeText(followUpLink!)}>
              <Copy className="h-4 w-4" />
            </Button>
          </div>
        </DialogContent>
      </Dialog>
    </div>
  );
}
===== ./client/src/pages/nutritionist/patients.tsx =====
import { useState } from "react";
import { useQuery, useMutation } from "@tanstack/react-query";
import { useLocation } from "wouter";
import { Search, Plus, Eye, FileText, Link as LinkIcon, Copy, MoreVertical, Users } from "lucide-react";
import Header from "@/components/layout/header";
import { MobileLayout, DefaultMobileDrawer } from "@/components/layout/mobile-layout";
import { MobileCard, MobileCardHeader, MobileCardTitle, MobileCardContent } from "@/components/mobile/card";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogFooter } from "@/components/ui/dialog";
import { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuTrigger } from "@/components/ui/dropdown-menu";
import { useToast } from "@/hooks/use-toast";
import { useIsMobile } from "@/hooks/use-mobile";
import { apiRequest } from "@/lib/queryClient";
import type { Patient } from "@shared/schema";
import { cn } from "@/lib/utils";

function PatientCard({ patient, onViewDetails, onNewPrescription }: {
  patient: Patient;
  onViewDetails: () => void;
  onNewPrescription: () => void;
}) {
  const calculateAge = (birthDate: string | null) => {
    if (!birthDate) return null;
    const birth = new Date(birthDate);
    const today = new Date();
    let age = today.getFullYear() - birth.getFullYear();
    const monthDiff = today.getMonth() - birth.getMonth();
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
      age--;
    }
    return age;
  };

  const age = calculateAge(patient.birthDate);

  return (
    <Card 
      className="cursor-pointer transition-all duration-300 hover:shadow-xl hover:shadow-blue-100/50 hover:-translate-y-1 bg-gradient-to-br from-white to-blue-50/30 dark:from-gray-900 dark:to-gray-800/50 border-0 shadow-lg overflow-hidden group"
      onClick={onViewDetails}
      data-testid={`card-patient-${patient.id}`}
    >
      <CardContent className="p-6 flex items-center justify-between relative">
        {/* Gradient border effect on hover */}
        <div className="absolute inset-0 bg-gradient-to-r from-blue-500/10 via-purple-500/10 to-indigo-500/10 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
        
        <div className="flex-1 min-w-0 relative z-10">
          <div className="flex items-center gap-3 mb-3">
            <div className="p-2 bg-gradient-to-r from-blue-500 to-purple-500 rounded-lg">
              <Users className="h-5 w-5 text-white" />
            </div>
            <div className="flex-1 min-w-0">
              <p className="text-lg font-bold text-gray-900 dark:text-white truncate" data-testid={`text-patient-name-${patient.id}`}> 
                {patient.name}
              </p>
              <p className="text-sm text-gray-600 dark:text-gray-300 truncate" data-testid={`text-patient-email-${patient.id}`}> 
                {patient.email}
              </p>
            </div>
          </div>
          
          <div className="flex items-center gap-2 flex-wrap">
            <Badge 
              variant={patient.userId ? "default" : "secondary"}
              className={patient.userId ? 
                "bg-gradient-to-r from-green-500 to-emerald-500 text-white border-0 shadow-sm" : 
                "bg-gradient-to-r from-amber-400 to-orange-400 text-white border-0 shadow-sm"
              }
            >
              {patient.userId ? "Ativo" : "Cadastro Pendente"}
            </Badge>
            {age !== null && (
              <Badge 
                variant="outline" 
                className="bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 border-blue-200 dark:border-blue-700 text-blue-700 dark:text-blue-300"
              >
                {age} anos
              </Badge>
            )}
          </div>
        </div>
        
        <DropdownMenu>
          <DropdownMenuTrigger asChild>
            <Button 
              variant="ghost" 
              size="sm" 
              className="h-10 w-10 p-0 ml-3 flex-shrink-0 hover:bg-gradient-to-r hover:from-blue-500/10 hover:to-purple-500/10 transition-all duration-200 relative z-10" 
              onClick={(e) => e.stopPropagation()}
            >
              <MoreVertical className="h-4 w-4" />
              <span className="sr-only">Opções</span>
            </Button>
          </DropdownMenuTrigger>
          <DropdownMenuContent align="end" className="bg-white/95 backdrop-blur-md border-0 shadow-xl">
            <DropdownMenuItem 
              onClick={(e) => { e.stopPropagation(); onViewDetails(); }}
              className="hover:bg-blue-50 transition-colors"
            >
              <Eye className="h-4 w-4 mr-2 text-blue-600" /> Ver detalhes
            </DropdownMenuItem>
            <DropdownMenuItem 
              onClick={(e) => { e.stopPropagation(); onNewPrescription(); }}
              disabled={!patient.userId}
              className="hover:bg-purple-50 transition-colors disabled:opacity-50"
            >
              <FileText className="h-4 w-4 mr-2 text-purple-600" /> Nova prescrição
            </DropdownMenuItem>
          </DropdownMenuContent>
        </DropdownMenu>
      </CardContent>
    </Card>
  );
}

export default function PatientsPage() {
  const [searchQuery, setSearchQuery] = useState("");
  const [, setLocation] = useLocation();
  const { toast } = useToast();
  const isMobile = useIsMobile();
  const [invitationLink, setInvitationLink] = useState<string | null>(null);

  const { data: patients = [], isLoading } = useQuery<Patient[]>({
    queryKey: ["/api/patients"],
  });

  const createInvitationMutation = useMutation({
    mutationFn: async () => {
      const res = await apiRequest("POST", "/api/invitations");
      return res.json();
    },
    onSuccess: (data) => {
      const { token } = data;
      const fullUrl = `${window.location.origin}/anamnese?token=${token}`;
      setInvitationLink(fullUrl);
      toast({ title: "Link de convite gerado!" });
    },
    onError: () => {
      toast({
        title: "Erro",
        description: "Não foi possível gerar o link de convite.",
        variant: "destructive",
      });
    },
  });

  const handleCopyToClipboard = () => {
    if (!invitationLink) return;
    navigator.clipboard.writeText(invitationLink);
    toast({ description: "Link copiado para a área de transferência!" });
  }; 

  const filteredPatients = patients.filter(patient =>
    patient.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
    (patient.email && patient.email.toLowerCase().includes(searchQuery.toLowerCase()))
  );

  const calculateAge = (birthDate: string) => {
    if (!birthDate) return null;
    const birth = new Date(birthDate);
    const today = new Date();
    const age = today.getFullYear() - birth.getFullYear();
    const monthDiff = today.getMonth() - birth.getMonth();
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
      return age - 1;
    }
    return age;
  };

  const mobileContent = (
    <MobileLayout 
      title="Meus Pacientes" 
      drawerContent={<DefaultMobileDrawer />}
    >
      <div className="space-y-6 py-4 relative">
        {/* Enhanced Header Section */}
        <div className="relative">
          <div className="bg-gradient-to-r from-blue-600 to-purple-600 rounded-2xl p-6 text-white shadow-lg">
            <div className="flex items-center gap-3 mb-2">
              <div className="p-2 bg-white/20 rounded-lg backdrop-blur-sm">
                <Users className="h-6 w-6" />
              </div>
              <div>
                <h1 className="text-xl font-bold">Meus Pacientes</h1>
                <p className="text-blue-100 text-sm opacity-90">Gerencie seus pacientes com facilidade</p>
              </div>
            </div>
          </div>
        </div>

        {/* Enhanced Search and Actions */}
        <div className="space-y-4">
          <div className="relative">
            <Search className="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400 h-5 w-5" />
            <Input
              type="search"
              placeholder="Buscar pacientes..."
              className="pl-12 h-12 bg-white/90 backdrop-blur-sm border-0 shadow-lg rounded-xl text-base"
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              data-testid="input-search-patients"
            />
          </div>
          <div className="flex gap-3">
            <Button 
              variant="outline"
              onClick={() => createInvitationMutation.mutate()}
              disabled={createInvitationMutation.isPending}
              className="flex-1 h-12 text-sm bg-white/90 backdrop-blur-sm border-2 border-blue-200 hover:border-blue-300 hover:bg-blue-50 transition-all duration-200 rounded-xl shadow-md"
              data-testid="button-invite-patient"
            >
              <LinkIcon className="h-4 w-4 mr-2 text-blue-600" />
              {createInvitationMutation.isPending ? "Gerando..." : "Convidar"}
            </Button>
            <Button 
              onClick={() => setLocation("/patients/new")}
              className="flex-1 h-12 text-sm bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white border-0 rounded-xl shadow-lg transition-all duration-200 transform hover:scale-[1.02]"
              data-testid="button-new-patient"
            >
              <Plus className="h-4 w-4 mr-2" />
              Adicionar
            </Button>
          </div>
        </div>

        {/* Enhanced Patients List */}
        <div className="space-y-4">
          {isLoading ? (
            <div className="flex flex-col items-center justify-center py-16">
              <div className="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center mb-4 animate-pulse">
                <div className="w-6 h-6 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
              </div>
              <p className="text-gray-600 font-medium">Carregando pacientes...</p>
            </div>
          ) : filteredPatients.length === 0 ? (
            <div className="text-center py-16">
              <div className="w-20 h-20 bg-gradient-to-r from-blue-100 to-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <Users className="h-10 w-10 text-gray-400" />
              </div>
              <p className="text-gray-600 font-medium text-lg mb-2">
                {searchQuery ? "Nenhum paciente encontrado" : "Nenhum paciente cadastrado"}
              </p>
              <p className="text-gray-400 text-sm">
                {searchQuery ? "Tente ajustar sua busca" : "Comece adicionando seu primeiro paciente"}
              </p>
            </div>
          ) : (
            filteredPatients.map((patient) => (
              <PatientCard
                key={patient.id}
                patient={patient}
                onViewDetails={() => setLocation(`/patients/${patient.id}`)}
                onNewPrescription={() => setLocation(`/patients/${patient.id}`)}
              />
            ))
          )}
        </div>
      </div>
    </MobileLayout>
  );

  const desktopContent = (
    <>
      {/* Modern CSS Animations */}
      <style>{`
        @keyframes blob {
          0% {
            transform: translate(0px, 0px) scale(1);
          }
          33% {
            transform: translate(30px, -50px) scale(1.1);
          }
          66% {
            transform: translate(-20px, 20px) scale(0.9);
          }
          100% {
            transform: translate(0px, 0px) scale(1);
          }
        }
        .animate-blob {
          animation: blob 8s infinite;
        }
        .animation-delay-2000 {
          animation-delay: 2s;
        }
        .animation-delay-4000 {
          animation-delay: 4s;
        }
      `}</style>

      <div className="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-purple-100 relative overflow-hidden">
        {/* Enhanced Background decorative elements */}
        <div className="absolute inset-0 overflow-hidden">
          <div className="absolute -top-40 -right-40 w-96 h-96 bg-gradient-to-br from-blue-400 to-purple-500 rounded-full mix-blend-multiply filter blur-xl opacity-20 animate-blob"></div>
          <div className="absolute -bottom-40 -left-40 w-96 h-96 bg-gradient-to-br from-purple-400 to-indigo-500 rounded-full mix-blend-multiply filter blur-xl opacity-20 animate-blob animation-delay-2000"></div>
          <div className="absolute top-40 left-40 w-80 h-80 bg-gradient-to-br from-indigo-400 to-blue-500 rounded-full mix-blend-multiply filter blur-xl opacity-15 animate-blob animation-delay-4000"></div>
        </div>

        <Header title="Meus Pacientes" />
        <main className="max-w-7xl mx-auto p-4 lg:p-6 relative z-10">
          {/* Enhanced Header Section */}
          <div className="mb-8">
            <div className="bg-gradient-to-r from-blue-600 to-purple-600 rounded-2xl p-8 text-white shadow-xl">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-4">
                  <div className="p-3 bg-white/20 rounded-xl backdrop-blur-sm">
                    <Users className="h-8 w-8" />
                  </div>
                  <div>
                    <h1 className="text-3xl font-bold mb-2">Meus Pacientes</h1>
                    <p className="text-blue-100 text-lg opacity-90">Gerencie todos os seus pacientes em um só lugar</p>
                  </div>
                </div>
                <div className="text-right">
                  <div className="text-3xl font-bold">{patients.length}</div>
                  <div className="text-blue-100 text-sm opacity-75">Total de Pacientes</div>
                </div>
              </div>
            </div>
          </div>

          {/* Enhanced Search and Actions Section */}
          <div className="mb-8 flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between">
            <div className="flex-1 relative">
              <Search className="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400 h-5 w-5" />
              <Input
                type="search"
                placeholder="Buscar pacientes por nome ou email..."
                className="pl-12 h-12 bg-white/90 backdrop-blur-sm border-0 shadow-lg rounded-xl text-base"
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                data-testid="input-search-patients"
              />
            </div>
            <div className="flex gap-4">
              <Button 
                variant="outline"
                onClick={() => createInvitationMutation.mutate()}
                disabled={createInvitationMutation.isPending}
                className="flex items-center space-x-2 h-12 px-6 bg-white/90 backdrop-blur-sm border-2 border-blue-200 hover:border-blue-300 hover:bg-blue-50 transition-all duration-200 rounded-xl shadow-md"
                data-testid="button-invite-patient"
              >
                <LinkIcon className="h-5 w-5 text-blue-600" />
                <span className="font-medium">{createInvitationMutation.isPending ? "Gerando..." : "Convidar Paciente"}</span>
              </Button>
              <Button 
                onClick={() => setLocation("/patients/new")}
                className="flex items-center space-x-2 h-12 px-6 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white border-0 rounded-xl shadow-lg transition-all duration-200 transform hover:scale-[1.02] font-medium"
                data-testid="button-new-patient"
              >
                <Plus className="h-5 w-5" />
                <span>Adicionar Manualmente</span>
              </Button>
            </div>
          </div>
        {/* Enhanced Table Card */}
        <Card className="shadow-xl border-0 bg-white/95 backdrop-blur-lg rounded-2xl overflow-hidden">
          <CardHeader className="bg-gradient-to-r from-slate-50 to-blue-50 border-b border-slate-200/50 pb-6">
            <div className="flex items-center gap-3">
              <div className="p-2 bg-gradient-to-r from-blue-500 to-purple-500 rounded-lg">
                <Users className="h-5 w-5 text-white" />
              </div>
              <div>
                <CardTitle className="text-xl font-bold text-gray-900">Lista de Pacientes</CardTitle>
                <CardDescription className="text-gray-600">Gerencie seus pacientes e acesse seus detalhes com facilidade.</CardDescription>
              </div>
            </div>
          </CardHeader>
          <CardContent className="p-0">
            <div className="overflow-x-auto">
              <table className="w-full">
                <thead className="bg-gradient-to-r from-gray-50 to-slate-50 border-b border-gray-200">
                  <tr>
                    <th className="text-left p-6 font-semibold text-gray-700">Paciente</th>
                    <th className="text-left p-6 font-semibold text-gray-700 hidden sm:table-cell">Idade</th>
                    <th className="text-left p-6 font-semibold text-gray-700 hidden md:table-cell">Status</th>
                    <th className="text-left p-6 font-semibold text-gray-700">Ações</th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-gray-100">
                  {isLoading ? (
                    <tr>
                      <td colSpan={4} className="p-12 text-center">
                        <div className="flex flex-col items-center">
                          <div className="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center mb-4 animate-pulse">
                            <div className="w-6 h-6 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                          </div>
                          <p className="text-gray-600 font-medium">Carregando pacientes...</p>
                        </div>
                      </td>
                    </tr>
                  ) : filteredPatients.length === 0 ? (
                    <tr>
                      <td colSpan={4} className="p-12 text-center">
                        <div className="flex flex-col items-center">
                          <div className="w-20 h-20 bg-gradient-to-r from-blue-100 to-purple-100 rounded-full flex items-center justify-center mb-4">
                            <Users className="h-10 w-10 text-gray-400" />
                          </div>
                          <p className="text-gray-600 font-medium text-lg mb-2">
                            {searchQuery ? "Nenhum paciente encontrado" : "Nenhum paciente cadastrado"}
                          </p>
                          <p className="text-gray-400">
                            {searchQuery ? "Tente ajustar sua busca" : "Comece adicionando seu primeiro paciente"}
                          </p>
                        </div>
                      </td>
                    </tr>
                  ) : (
                    filteredPatients.map((patient) => (
                      <tr key={patient.id} className="hover:bg-gradient-to-r hover:from-blue-50/50 hover:to-purple-50/50 transition-all duration-200 cursor-pointer group" onClick={() => setLocation(`/patients/${patient.id}`)}>
                        <td className="p-6">
                          <div className="flex items-center gap-3">
                            <div className="p-2 bg-gradient-to-r from-blue-500 to-purple-500 rounded-lg opacity-80 group-hover:opacity-100 transition-opacity">
                              <Users className="h-4 w-4 text-white" />
                            </div>
                            <div>
                              <div className="font-semibold text-gray-900 group-hover:text-blue-700 transition-colors" data-testid={`text-patient-name-${patient.id}`}> 
                                {patient.name}
                              </div>
                              <div className="text-sm text-gray-500" data-testid={`text-patient-email-${patient.id}`}> 
                                {patient.email}
                              </div>
                            </div>
                          </div>
                        </td>
                        <td className="p-6 hidden sm:table-cell">
                          <span className="text-gray-600 font-medium">
                            {patient.birthDate ? `${calculateAge(patient.birthDate)} anos` : "-"}
                          </span>
                        </td>
                        <td className="p-6 hidden md:table-cell">
                          <Badge 
                            variant={patient.userId ? "default" : "secondary"}
                            className={patient.userId ? 
                              "bg-gradient-to-r from-green-500 to-emerald-500 text-white border-0 shadow-sm" : 
                              "bg-gradient-to-r from-amber-400 to-orange-400 text-white border-0 shadow-sm"
                            }
                          >
                            {patient.userId ? "Ativo" : "Pendente"}
                          </Badge>
                        </td>
                        <td className="p-6">
                          <div className="flex items-center space-x-2">
                            <Button
                              variant="ghost"
                              size="sm"
                              onClick={(e) => { e.stopPropagation(); setLocation(`/patients/${patient.id}`); }}
                              title="Ver detalhes"
                              className="h-9 w-9 p-0 hover:bg-blue-100 hover:text-blue-600 transition-all duration-200"
                              data-testid={`button-view-patient-${patient.id}`}
                            >
                              <Eye className="h-4 w-4" />
                            </Button>
                            <Button
                              variant="ghost"
                              size="sm"
                              disabled={!patient.userId}
                              title={!patient.userId ? "Paciente precisa ter um login" : "Nova prescrição"}
                              onClick={(e) => { e.stopPropagation(); setLocation(`/patients/${patient.id}`); }}
                              className="h-9 w-9 p-0 hover:bg-purple-100 hover:text-purple-600 transition-all duration-200 disabled:opacity-50"
                              data-testid={`button-new-prescription-${patient.id}`}
                            >
                              <FileText className="h-4 w-4" />
                            </Button>
                          </div>
                        </td>
                      </tr>
                    ))
                  )}
                </tbody>
              </table>
            </div>
          </CardContent>
        </Card>
        </main>
      </div>
    </>
  );

  return (
    <>
      {isMobile ? mobileContent : desktopContent}

      <Dialog open={!!invitationLink} onOpenChange={(isOpen) => !isOpen && setInvitationLink(null)}>
        <DialogContent className="bg-white/95 backdrop-blur-lg border-0 shadow-2xl rounded-2xl">
          <DialogHeader>
            <div className="flex items-center gap-3 mb-2">
              <div className="p-2 bg-gradient-to-r from-green-500 to-emerald-500 rounded-lg">
                <LinkIcon className="h-5 w-5 text-white" />
              </div>
              <div>
                <DialogTitle className="text-xl font-bold text-gray-900">Link de Convite Gerado</DialogTitle>
                <DialogDescription className="text-gray-600">
                  Envie este link para o seu paciente. Ele será válido para um único cadastro.
                </DialogDescription>
              </div>
            </div>
          </DialogHeader>
          <div className="flex items-center space-x-3 p-4 bg-gradient-to-r from-gray-50 to-blue-50 rounded-xl border border-gray-200">
            <Input 
              value={invitationLink || ""} 
              readOnly 
              className="bg-white/80 border-0 shadow-sm text-sm"
            />
            <Button 
              variant="outline" 
              onClick={handleCopyToClipboard} 
              size="icon"
              className="flex-shrink-0 h-10 w-10 bg-white hover:bg-blue-50 border-2 border-blue-200 hover:border-blue-300 transition-all duration-200"
            >
              <Copy className="h-4 w-4 text-blue-600" />
            </Button>
          </div>
          <DialogFooter>
            <Button 
              variant="secondary" 
              onClick={() => setInvitationLink(null)}
              className="bg-gray-100 hover:bg-gray-200 text-gray-700 border-0 rounded-lg"
            >
              Fechar
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </>
  );
}
===== ./client/src/pages/nutritionist/prescription-editor.tsx =====
import { useState, useEffect } from "react";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { useLocation } from "wouter";
import { Plus, Copy } from "lucide-react";
import Header from "@/components/layout/header";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Card, CardContent } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import MealEditor from "@/components/prescription/meal-editor";
import { useToast } from "@/hooks/use-toast";
import { apiRequest } from "@/lib/queryClient";
import type { Prescription, Patient, MealData } from "@shared/schema";
import { v4 as uuidv4 } from 'uuid';
import { DefaultMobileDrawer } from "@/components/layout/mobile-layout";

interface PrescriptionEditorPageProps {
  params: { id: string };
}

export default function PrescriptionEditorPage({ params }: PrescriptionEditorPageProps) {
  const [, setLocation] = useLocation();
  const { toast } = useToast();
  const queryClient = useQueryClient();

  const [title, setTitle] = useState("");
  const [generalNotes, setGeneralNotes] = useState("");
  const [meals, setMeals] = useState<MealData[]>([]);

  const { data: prescription, isLoading } = useQuery<Prescription>({
    queryKey: ["/api/prescriptions", params.id],
  });

  // Update state when prescription data changes
  useEffect(() => {
    if (prescription) {
      setTitle(prescription.title);
      setGeneralNotes(prescription.generalNotes || "");
      setMeals(prescription.meals || []);
    }
  }, [prescription]);

  const { data: patient } = useQuery<Patient>({
    queryKey: ["/api/patients", prescription?.patientId],
    enabled: !!prescription?.patientId,
  });

  const updatePrescriptionMutation = useMutation({
    mutationFn: async (data: { title: string; meals: MealData[]; generalNotes: string }) => {
      return await apiRequest("PUT", `/api/prescriptions/${params.id}`, data);
    },
    onSuccess: () => {
      toast({
        title: "Sucesso",
        description: "Prescrição salva como rascunho.",
      });
      queryClient.invalidateQueries({ queryKey: ["/api/prescriptions", params.id] });
    },
    onError: () => {
      toast({
        title: "Erro",
        description: "Falha ao salvar prescrição.",
        variant: "destructive",
      });
    },
  });

  const publishPrescriptionMutation = useMutation({
    mutationFn: async () => {
      // First update, then publish
      await updatePrescriptionMutation.mutateAsync({ title, meals, generalNotes });
      return await apiRequest("POST", `/api/prescriptions/${params.id}/publish`);
    },
    onSuccess: () => {
      toast({
        title: "Sucesso",
        description: "Prescrição publicada com sucesso!",
      });
      queryClient.invalidateQueries({ queryKey: ["/api/prescriptions", params.id] });
      if (patient) {
        setLocation(`/patients/${patient.id}`);
      }
    },
    onError: () => {
      toast({
        title: "Erro",
        description: "Falha ao publicar prescrição.",
        variant: "destructive",
      });
    },
  });

  const addMeal = () => {
    const newMeal: MealData = {
      id: uuidv4(),
      name: "Nova Refeição",
      items: [],
      notes: "",
    };
    setMeals([...meals, newMeal]);
  };

  const updateMeal = (mealId: string, updatedMeal: MealData) => {
    setMeals(meals.map(meal => meal.id === mealId ? updatedMeal : meal));
  };

  const deleteMeal = (mealId: string) => {
    setMeals(meals.filter(meal => meal.id !== mealId));
  };

  const moveMeal = (fromIndex: number, toIndex: number) => {
    const newMeals = [...meals];
    const [moved] = newMeals.splice(fromIndex, 1);
    newMeals.splice(toIndex, 0, moved);
    setMeals(newMeals);
  };

  const handleSaveDraft = () => {
    updatePrescriptionMutation.mutate({ title, meals, generalNotes });
  };

  const handlePublish = () => {
    if (!title.trim()) {
      toast({
        title: "Erro",
        description: "O título da prescrição é obrigatório.",
        variant: "destructive",
      });
      return;
    }
    publishPrescriptionMutation.mutate();
  };

  if (isLoading) {
    return (
      <div className="min-h-screen bg-background">
        <Header title="Carregando..." />
        <main className="max-w-4xl mx-auto p-4 lg:p-6 text-center">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto"></div>
        </main>
      </div>
    );
  }

  if (!prescription) {
    return (
      <div className="min-h-screen bg-background">
        <Header 
          title="Prescrição não encontrada"
          showBack={true}
          onBack={() => setLocation("/")}
        />
        <main className="max-w-4xl mx-auto p-4 lg:p-6">
          <p className="text-center text-muted-foreground">Prescrição não encontrada.</p>
        </main>
      </div>
    );
  }

  const isSaving = updatePrescriptionMutation.isPending || publishPrescriptionMutation.isPending;

  return (
    <div className="min-h-screen bg-background">
      <Header
        title={title || "Editor de Prescrição"}
        subtitle={patient?.name}
        showBack={true}
        onBack={() => setLocation(`/patients/${prescription.patientId}`)}
        drawerContent={<DefaultMobileDrawer />}
      />
      <main className="max-w-5xl mx-auto p-3 sm:p-4 lg:p-8">
        {/* Enhanced Header Section */}
        <Card className="mb-6 shadow-xl border-0 bg-gradient-to-br from-blue-50 via-card to-purple-50 dark:from-blue-950/20 dark:via-card dark:to-purple-950/20">
          <CardContent className="p-4 sm:p-6 lg:p-8">
            <div className="space-y-4 lg:space-y-0 lg:flex lg:justify-between lg:items-center lg:gap-6">
              <div className="flex-1 w-full space-y-3">
                <Input
                  className="text-2xl sm:text-3xl font-bold h-auto p-3 sm:p-4 border-none bg-transparent outline-none focus-visible:ring-2 focus-visible:ring-ring/20 focus-visible:bg-muted/10 rounded-lg"
                  value={title}
                  onChange={(e) => setTitle(e.target.value)}
                  placeholder="Título da prescrição"
                  data-testid="input-prescription-title"
                />
                <div className="flex flex-wrap items-center gap-2 sm:gap-3 text-sm text-muted-foreground">
                  <span className="font-medium text-foreground">{patient?.name}</span>
                  <span className="hidden sm:inline">•</span>
                  <Badge 
                    variant={prescription.status === 'published' ? 'default' : 'secondary'} 
                    className="px-3 py-1 font-medium shadow-sm"
                  >
                    {prescription.status === 'published' ? 'Publicado' : 'Rascunho'}
                  </Badge>
                </div>
              </div>
              
              {/* Mobile Button Layout */}
              <div className="flex flex-col sm:flex-row items-stretch sm:items-center gap-3 w-full lg:w-auto">
                <Button
                  variant="outline"
                  onClick={() => setLocation(`/patients/${prescription.patientId}`)}
                  disabled={isSaving}
                  data-testid="button-close-editor"
                  className="w-full sm:flex-none shadow-sm border-2 hover:bg-muted/20"
                >
                  Fechar
                </Button>
                <Button
                  variant="secondary"
                  onClick={handleSaveDraft}
                  disabled={isSaving}
                  data-testid="button-save-draft"
                  className="w-full sm:flex-none shadow-md bg-gradient-to-r from-secondary via-secondary to-secondary/90 hover:from-secondary/90 hover:via-secondary hover:to-secondary"
                >
                  {updatePrescriptionMutation.isPending ? "Salvando..." : "Salvar Rascunho"}
                </Button>
                <Button
                  onClick={handlePublish}
                  disabled={isSaving}
                  data-testid="button-publish"
                  className="w-full sm:flex-none shadow-lg bg-gradient-to-r from-primary via-primary to-primary/90 hover:from-primary/90 hover:via-primary hover:to-primary"
                >
                  {publishPrescriptionMutation.isPending ? "Publicando..." : "Publicar"}
                </Button>
              </div>
            </div>
          </CardContent>
        </Card>
        
        {/* Enhanced Prescription Controls */}
        <Card className="mb-6 shadow-lg bg-gradient-to-r from-emerald-50 via-card to-teal-50 dark:from-emerald-950/20 dark:via-card dark:to-teal-950/20 border-2 border-emerald-100 dark:border-emerald-900/30">
          <CardContent className="p-4 sm:p-6">
            <div className="space-y-3 sm:space-y-0 sm:flex sm:gap-4">
              <Button
                onClick={addMeal}
                className="w-full sm:flex-1 lg:flex-none flex items-center justify-center space-x-2 shadow-lg bg-gradient-to-r from-emerald-600 via-emerald-500 to-green-600 hover:from-emerald-700 hover:via-emerald-600 hover:to-green-700 text-white"
                size="lg"
                data-testid="button-add-meal"
              >
                <Plus className="h-5 w-5" />
                <span>Adicionar Refeição</span>
              </Button>
              <Button
                variant="outline"
                className="w-full sm:flex-1 lg:flex-none flex items-center justify-center space-x-2 shadow-md border-2 border-teal-200 dark:border-teal-800 bg-gradient-to-r from-teal-50 via-background to-cyan-50 dark:from-teal-950/30 dark:via-background dark:to-cyan-950/30 hover:from-teal-100 hover:via-muted hover:to-cyan-100 dark:hover:from-teal-900/50 dark:hover:via-muted dark:hover:to-cyan-900/50"
                size="lg"
                data-testid="button-duplicate-prescription"
              >
                <Copy className="h-5 w-5" />
                <span className="hidden sm:inline">Duplicar Prescrição Anterior</span>
                <span className="sm:hidden">Duplicar</span>
              </Button>
            </div>
          </CardContent>
        </Card>

        {/* Enhanced Meals List */}
        <div className="space-y-6">
          {meals.length === 0 ? (
            <Card className="shadow-xl bg-gradient-to-br from-amber-50 via-card to-orange-50 dark:from-amber-950/20 dark:via-card dark:to-orange-950/20 border-2 border-amber-100 dark:border-amber-900/30">
              <CardContent className="p-8 sm:p-12 text-center">
                <div className="max-w-md mx-auto space-y-4">
                  <p className="text-muted-foreground text-lg">Nenhuma refeição adicionada ainda.</p>
                  <Button 
                    onClick={addMeal} 
                    data-testid="button-add-first-meal" 
                    size="lg" 
                    className="shadow-lg bg-gradient-to-r from-amber-600 via-orange-500 to-red-500 hover:from-amber-700 hover:via-orange-600 hover:to-red-600 text-white"
                  >
                    <Plus className="h-5 w-5 mr-2" />
                    Adicionar Primeira Refeição
                  </Button>
                </div>
              </CardContent>
            </Card>
          ) : (
            meals.map((meal, index) => (
              <MealEditor
                key={meal.id}
                meal={meal}
                onUpdate={(updatedMeal) => updateMeal(meal.id, updatedMeal)}
                onDelete={() => deleteMeal(meal.id)}
                onMoveUp={index > 0 ? () => moveMeal(index, index - 1) : undefined}
                onMoveDown={index < meals.length - 1 ? () => moveMeal(index, index + 1) : undefined}
              />
            ))
          )}
        </div>

        {/* Enhanced General Notes */}
        <Card className="mt-8 shadow-xl bg-gradient-to-br from-indigo-50 via-card to-purple-50 dark:from-indigo-950/20 dark:via-card dark:to-purple-950/20 border-2 border-indigo-100 dark:border-indigo-900/30">
          <CardContent className="p-6 sm:p-8">
            <div className="space-y-4">
              <label className="block text-lg sm:text-xl font-semibold text-foreground">Observações Gerais</label>
              <Textarea
                className="min-h-[120px] text-base leading-relaxed bg-background/80 border-2 border-indigo-200 dark:border-indigo-800 focus-visible:ring-2 focus-visible:ring-indigo-300 focus-visible:border-indigo-400 dark:focus-visible:ring-indigo-700 dark:focus-visible:border-indigo-600 shadow-inner"
                placeholder="Observações gerais sobre a prescrição..."
                value={generalNotes}
                onChange={(e) => setGeneralNotes(e.target.value)}
                data-testid="textarea-general-notes"
              />
            </div>
          </CardContent>
        </Card>
      </main>
    </div>
  );
}
===== ./client/src/pages/patient/patient-register.tsx =====
import { useEffect, useMemo } from "react";
import { useMutation, useQuery } from "@tanstack/react-query";
import { useLocation, Link } from "wouter";
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from "@/components/ui/form";
import { useToast } from "@/hooks/use-toast";
import { apiRequest } from "@/lib/queryClient";
import { insertPatientSchema } from "@shared/schema";
import { DiNutriLogo } from "@/components/ui/dinutri-logo";
import { Alert, AlertDescription, AlertTitle } from "@/components/ui/alert";
import { AlertCircle } from "lucide-react";

// Schema for the patient self-registration form, now with password
const formSchema = insertPatientSchema.omit({ ownerId: true, userId: true }).extend({
  heightCm: z.preprocess(
    (val) => (val === "" ? undefined : val),
    z.coerce.number().optional()
  ),
  weightKg: z.string().regex(/^\d+(\.\d{1,2})?$/, "Peso inválido. Ex: 65.50").optional().or(z.literal('')),
  password: z.string().min(6, "A senha deve ter no mínimo 6 caracteres."),
  confirmPassword: z.string(),
}).refine(data => data.password === data.confirmPassword, {
  message: "As senhas não correspondem.",
  path: ["confirmPassword"], // O erro aparecerá no campo de confirmação
});

type FormData = z.infer<typeof formSchema>;

export default function PatientRegisterPage() {
  const [location, setLocation] = useLocation();
  const { toast } = useToast();
  
  // Extrai o token da URL
  const token = useMemo(() => new URLSearchParams(window.location.search).get("token"), [location]);

  // Valida o token de convite na montagem da página
  const { isLoading: isValidationLoading, isError: isTokenInvalid } = useQuery({
    queryKey: ["/api/invitations/validate", token],
    queryFn: () => fetch(`/api/invitations/validate?token=${token}`).then(res => {
      if (!res.ok) throw new Error("Token inválido");
      return res.json();
    }),
    enabled: !!token,
    retry: false,
  });

  const form = useForm<FormData>({
    resolver: zodResolver(formSchema),
    defaultValues: {
      name: "",
      email: "",
      password: "",
      confirmPassword: "",
      birthDate: "",
      sex: undefined,
      heightCm: undefined,
      weightKg: "",
      notes: "",
    },
  });

  const registerPatientMutation = useMutation({
    mutationFn: (data: Omit<FormData, 'confirmPassword'> & { token: string }) => {
      return apiRequest("POST", "/api/patient/register", data);
    },
    onSuccess: () => {
      toast({
        title: "Cadastro concluído com sucesso!",
        description: "Você já pode acessar sua conta.",
      });
      // Recarrega a página para que o App.tsx redirecione para a home do paciente
      window.location.href = "/";
    },
    onError: (err: any) => {
      console.error("Erro no registro:", err);
      const errorMessage = err.message.includes("409")
        ? "Este email já está cadastrado no sistema."
        : "Não foi possível concluir seu cadastro. Tente novamente.";
      toast({
        title: "Erro no Cadastro",
        description: errorMessage,
        variant: "destructive",
      });
    },
  });

  const onSubmit = (data: FormData) => {
    if (!token) return;
    const { confirmPassword, ...payload } = data;
    registerPatientMutation.mutate({ ...payload, token });
  };

  if (isValidationLoading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-4"></div>
          <p className="text-muted-foreground">Validando convite...</p>
        </div>
      </div>
    );
  }

  if (isTokenInvalid || !token) {
    return (
       <div className="min-h-screen bg-gray-50 flex items-center justify-center p-4">
        <Alert variant="destructive" className="max-w-md">
          <AlertCircle className="h-4 w-4" />
          <AlertTitle>Link de Convite Inválido</AlertTitle>
          <AlertDescription>
            Este link é inválido, expirou ou já foi utilizado. Por favor, solicite um novo convite ao seu nutricionista.
            <div className="mt-4">
              <Button asChild variant="link" className="p-0">
                <Link to="/">Voltar para a página de login</Link>
              </Button>
            </div>
          </AlertDescription>
        </Alert>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50 py-12 px-4">
       <div className="flex justify-center mb-6">
          <DiNutriLogo variant="full" className="h-16" />
        </div>
      <main className="max-w-2xl mx-auto">
        <Card>
          <CardHeader>
            <CardTitle>Complete seu Cadastro</CardTitle>
            <CardDescription>Preencha seus dados para criar sua conta de paciente.</CardDescription>
          </CardHeader>
          <CardContent>
            <Form {...form}>
              <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-6">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div className="md:col-span-2">
                    <FormField
                      control={form.control}
                      name="name"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Nome Completo</FormLabel>
                          <FormControl>
                            <Input placeholder="Seu nome completo" {...field} />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                  </div>
                  <div className="md:col-span-2">
                    <FormField
                      control={form.control}
                      name="email"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Email</FormLabel>
                          <FormControl>
                            <Input type="email" placeholder="seu@email.com" value={field.value || ""} onChange={field.onChange} onBlur={field.onBlur} name={field.name} ref={field.ref} />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                  </div>
                   <div className="md:col-span-1">
                    <FormField
                      control={form.control}
                      name="password"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Crie sua Senha</FormLabel>
                          <FormControl>
                            <Input type="password" placeholder="••••••••" {...field} />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                  </div>
                  <div className="md:col-span-1">
                     <FormField
                      control={form.control}
                      name="confirmPassword"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Confirme sua Senha</FormLabel>
                          <FormControl>
                            <Input type="password" placeholder="••••••••" {...field} />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                  </div>
                  <div>
                    <FormField
                      control={form.control}
                      name="birthDate"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Data de Nascimento</FormLabel>
                          <FormControl>
                            <Input type="date" {...field} value={field.value || ""} />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                  </div>
                  <div>
                    <FormField
                      control={form.control}
                      name="sex"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Sexo</FormLabel>
                          <Select onValueChange={field.onChange} value={field.value || ""}>
                            <FormControl>
                              <SelectTrigger><SelectValue placeholder="Selecionar" /></SelectTrigger>
                            </FormControl>
                            <SelectContent>
                              <SelectItem value="F">Feminino</SelectItem>
                              <SelectItem value="M">Masculino</SelectItem>
                              <SelectItem value="Outro">Outro</SelectItem>
                            </SelectContent>
                          </Select>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                  </div>
                  <div>
                    <FormField
                      control={form.control}
                      name="heightCm"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Altura (cm)</FormLabel>
                          <FormControl>
                            <Input 
                              type="number" 
                              placeholder="165"
                              value={field.value ?? ''}
                              onChange={(e) => field.onChange(e.target.value)}
                            />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                  </div>
                  <div>
                    <FormField
                      control={form.control}
                      name="weightKg"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Peso (kg) - Opcional</FormLabel>
                          <FormControl>
                            <Input 
                              type="number" 
                              step="0.01" 
                              placeholder="64.50"
                              {...field}
                            />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                  </div>
                </div>
                <FormField
                  control={form.control}
                  name="notes"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>Observações</FormLabel>
                      <FormControl>
                        <Textarea placeholder="Alguma observação para seu nutricionista?" className="h-24" {...field} value={field.value || ""} />
                      </FormControl>
                      <FormMessage />
                    </FormItem>
                  )}
                />
                <Button type="submit" className="w-full" disabled={registerPatientMutation.isPending}>
                  {registerPatientMutation.isPending ? "Finalizando..." : "Finalizar Cadastro e Entrar"}
                </Button>
              </form>
            </Form>
          </CardContent>
        </Card>
      </main>
    </div>
  );
}
===== ./client/src/pages/patient/prescription-print.tsx =====
import { useQuery } from "@tanstack/react-query";
import { useLocation } from "wouter";
import { ArrowLeft, Printer, FileDown } from "lucide-react";
import { Button } from "@/components/ui/button";
import { generatePDF } from "@/lib/pdf";
import type { Prescription, Patient, User } from "@shared/schema";

interface PrescriptionPrintPageProps {
  params: { id: string };
}

export default function PrescriptionPrintPage({ params }: PrescriptionPrintPageProps) {
  const [, setLocation] = useLocation();

  const { data: prescription, isLoading } = useQuery<Prescription>({
    queryKey: ["/api/prescriptions", params.id],
  });

  const { data: patient } = useQuery<Patient>({
    queryKey: ["/api/patients", prescription?.patientId],
    enabled: !!prescription?.patientId,
  });

  // Mock nutritionist data - in real app, fetch from prescription.nutritionistId
  const nutritionist = {
    name: "Dr. Ana Silva",
    crn: "12345",
  };

  const handlePrint = () => {
    window.print();
  };

  const handleExportPDF = async () => {
    if (!prescription || !patient) return;
    try {
      await generatePDF(prescription, patient, nutritionist);
    } catch (error) {
      console.error("Error generating PDF:", error);
    }
  };

  const formatDate = (dateString: string) => {
    return new Date(dateString).toLocaleDateString('pt-BR', {
      year: 'numeric',
      month: 'long', 
      day: 'numeric',
    });
  };

  const calculateAge = (birthDate: string) => {
    if (!birthDate) return null;
    const birth = new Date(birthDate);
    const today = new Date();
    const age = today.getFullYear() - birth.getFullYear();
    const monthDiff = today.getMonth() - birth.getMonth();
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
      return age - 1;
    }
    return age;
  };

  if (isLoading) {
    return (
      <div className="min-h-screen bg-white text-gray-900">
        <div className="max-w-4xl mx-auto p-8">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
        </div>
      </div>
    );
  }

  if (!prescription || !patient) {
    return (
      <div className="min-h-screen bg-white text-gray-900">
        <div className="max-w-4xl mx-auto p-8">
          <p className="text-center text-gray-600">Prescrição não encontrada.</p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-white text-gray-900">
      {/* Printer Header (No Printer Controls) */}
      <header className="no-print bg-card border-b border-border px-4 py-3">
        <div className="max-w-7xl mx-auto flex items-center justify-between">
          <div className="flex items-center space-x-4">
            <Button
              variant="ghost"
              size="sm"
              onClick={() => setLocation("/patient/prescription")}
              data-testid="button-back"
            >
              <ArrowLeft className="h-4 w-4" />
            </Button>
            <h1 className="text-xl font-bold">Visualização para Impressão</h1>
          </div>
          <div className="flex items-center space-x-3">
            <Button
              onClick={handlePrint}
              className="flex items-center space-x-2"
              data-testid="button-print"
            >
              <Printer className="h-4 w-4" />
              <span>Imprimir</span>
            </Button>
            <Button
              variant="secondary"
              onClick={handleExportPDF}
              className="flex items-center space-x-2"
              data-testid="button-export-pdf"
            >
              <FileDown className="h-4 w-4" />
              <span>Salvar PDF</span>
            </Button>
          </div>
        </div>
      </header>

      <main className="max-w-4xl mx-auto p-8">
        {/* Printer Document */}
        <div className="bg-white">
          {/* Document Header */}
          <div className="text-center mb-8 border-b-2 border-gray-200 pb-6">
            <h1 className="text-3xl font-bold text-gray-800 mb-2">PRESCRIÇÃO NUTRICIONAL</h1>
            <div className="text-lg text-gray-600">
              <div>{nutritionist.name}</div>
              <div className="text-sm">CRN: {nutritionist.crn} • Nutricionista</div>
            </div>
          </div>

          {/* Patient Info */}
          <div className="mb-8 bg-gray-50 p-6 rounded">
            <h2 className="text-xl font-semibold mb-4">Dados do Paciente</h2>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
              <div><strong>Nome:</strong> <span data-testid="text-patient-name">{patient.name}</span></div>
              <div><strong>Email:</strong> <span data-testid="text-patient-email">{patient.email}</span></div>
              {patient.birthDate && (
                <div><strong>Idade:</strong> <span data-testid="text-patient-age">{calculateAge(patient.birthDate)} anos</span></div>
              )}
              {patient.sex && (
                <div><strong>Sexo:</strong> <span data-testid="text-patient-sex">{patient.sex === 'F' ? 'Feminino' : patient.sex === 'M' ? 'Masculino' : 'Outro'}</span></div>
              )}
              {patient.heightCm && (
                <div><strong>Altura:</strong> <span data-testid="text-patient-height">{patient.heightCm} cm</span></div>
              )}
              {patient.weightKg && (
                <div><strong>Peso:</strong> <span data-testid="text-patient-weight">{patient.weightKg} kg</span></div>
              )}
            </div>
          </div>

          {/* Prescription Title */}
          <div className="mb-8 text-center">
            <h2 className="text-2xl font-bold text-gray-800" data-testid="text-prescription-title">
              {prescription.title}
            </h2>
            <p className="text-gray-600 mt-2">
              Publicado em {prescription.publishedAt && formatDate(prescription.publishedAt.toString())}
            </p>
          </div>

          {/* Meals */}
          <div className="space-y-8">
            {prescription.meals.map((meal) => (
              <div key={meal.id} className="break-inside-avoid">
                <div className="bg-blue-50 p-4 rounded-t-lg border-l-4 border-blue-500">
                  <h3 className="text-xl font-semibold text-gray-800" data-testid={`text-meal-name-${meal.id}`}>
                    {meal.name}
                  </h3>
                </div>
                <div className="border border-t-0 border-gray-200 rounded-b-lg p-4">
                  <ul className="space-y-3">
                    {meal.items.map((item) => (
                      <li key={item.id} className="flex justify-between items-center py-2 border-b border-gray-100 last:border-b-0">
                        <span className="font-medium" data-testid={`text-item-description-${item.id}`}>
                          {item.description}
                        </span>
                        <span className="text-gray-600" data-testid={`text-item-amount-${item.id}`}>
                          {item.amount}
                        </span>
                      </li>
                    ))}
                  </ul>
                  {meal.notes && (
                    <div className="mt-4 p-3 bg-yellow-50 rounded border-l-4 border-yellow-400">
                      <p className="text-sm text-gray-700" data-testid={`text-meal-notes-${meal.id}`}>
                        <strong>Observação:</strong> {meal.notes}
                      </p>
                    </div>
                  )}
                </div>
              </div>
            ))}
          </div>

          {/* General Notes */}
          {prescription.generalNotes && (
            <div className="mt-8 p-6 bg-gray-50 rounded-lg border border-gray-200">
              <h3 className="text-lg font-semibold mb-3">Observações Gerais</h3>
              <p className="text-gray-700" data-testid="text-general-notes">
                {prescription.generalNotes}
              </p>
            </div>
          )}

          {/* Footer */}
          <div className="mt-12 pt-6 border-t-2 border-gray-200 text-center text-sm text-gray-600">
            <p>Esta prescrição foi elaborada especificamente para {patient.name}.</p>
            <p className="mt-2">Em caso de dúvidas, entre em contato com seu nutricionista.</p>
            <p className="mt-4 font-semibold">{nutritionist.name} - CRN: {nutritionist.crn}</p>
          </div>
        </div>
      </main>
    </div>
  );
}

===== ./client/src/pages/patient/prescription-view.tsx =====
import { useState, useEffect } from "react";
import { useQuery } from "@tanstack/react-query";
import { useLocation } from "wouter";
import { Printer, ArrowLeft, Utensils, Info } from "lucide-react";
import Header from "@/components/layout/header";
import { Button } from "@/components/ui/button";
import { Card, CardContent } from "@/components/ui/card";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from "@/components/ui/dialog";
import { Tabs, TabsList, TabsTrigger } from "@/components/ui/tabs";
import MealViewer from "@/components/prescription/meal-viewer";
import MealMenuScreen from "@/components/meal/meal-menu-screen";
import { useAuth } from "@/hooks/useAuth";
import { useToast } from "@/hooks/use-toast";
import { isUnauthorizedError } from "@/lib/authUtils";
import type { Prescription, MealData, MealItemData, Patient } from "@shared/schema";
import { MobileLayout, DefaultMobileDrawer } from "@/components/layout/mobile-layout";
import { useIsMobile } from "@/hooks/use-mobile";
import { HeaderDNutri } from "@/components/ui/header-dinutri";
import { MealCard } from "@/components/ui/meal-card";
import { DNutriBottomNav } from "@/components/ui/dinutri-bottom-nav";
import { ProfileModal } from "@/components/ui/profile-modal";

export default function PatientPrescriptionView() {
  const { user, isAuthenticated, isLoading } = useAuth();
  const [, setLocation] = useLocation();
  const { toast } = useToast();
  const isMobile = useIsMobile();
  
  const [selectedPrescription, setSelectedPrescription] = useState<Prescription | null>(null);
  const [selectedMeal, setSelectedMeal] = useState<MealData | null>(null);
  const [showFullScreenMenu, setShowFullScreenMenu] = useState(false);
  const [isSubstitutesModalOpen, setIsSubstitutesModalOpen] = useState(false);
  const [selectedItemForSubstitutes, setSelectedItemForSubstitutes] = useState<MealItemData | null>(null);
  const [isProfileModalOpen, setIsProfileModalOpen] = useState(false);

  useEffect(() => {
    if (!isLoading && !isAuthenticated) {
      toast({
        title: "Não autorizado",
        description: "Você precisa estar logado. Redirecionando...",
        variant: "destructive",
      });
      setTimeout(() => {
        window.location.href = "/api/login";
      }, 500);
      return;
    }
  }, [isAuthenticated, isLoading, toast]);

  const { data: prescriptions = [], isLoading: prescriptionLoading, error } = useQuery<Prescription[]>({
    queryKey: ["/api/patient/my-prescriptions"],
    enabled: !!user,
    retry: false,
  });

  // Buscar dados do paciente para obter patientId - corrigido
  const { data: currentPatient } = useQuery<Patient>({
    queryKey: ["/api/patient/my-profile"],
    enabled: !!user && user.role === 'patient',
    retry: false,
  });

  // Adicione esta lógica logo após o useQuery do currentPatient
  const goalMap = {
    lose_weight: "Perder Peso",
    maintain_weight: "Manter Peso",
    gain_weight: "Ganhar Peso",
  };

  const patientGoal = currentPatient?.goal as keyof typeof goalMap | undefined;
  const goalText = patientGoal && goalMap[patientGoal] 
    ? `Objetivo: ${goalMap[patientGoal]}` 
    : "Seu Plano Alimentar";

  useEffect(() => {
    if (prescriptions.length > 0 && !selectedPrescription) {
      setSelectedPrescription(prescriptions[0]);
    }
  }, [prescriptions, selectedPrescription]);

  useEffect(() => {
    if (error && isUnauthorizedError(error as Error)) {
      toast({
        title: "Não autorizado",
        description: "Você foi desconectado. Fazendo login novamente...",
        variant: "destructive",
      });
      setTimeout(() => {
        window.location.href = "/api/login";
      }, 500);
    }
  }, [error, toast]);
  
  const handleOpenSubstitutes = (item: MealItemData) => {
    setSelectedItemForSubstitutes(item);
    setIsSubstitutesModalOpen(true);
  };

  const handleSelectPrescription = (prescriptionId: string) => {
    const pres = prescriptions.find(p => p.id === prescriptionId);
    if (pres) {
      setSelectedPrescription(pres);
      setSelectedMeal(null); // Reset meal selection when changing prescription
    }
  };
  
  const handlePrint = () => {
    if (selectedPrescription) {
      setLocation(`/prescriptions/${selectedPrescription.id}/print`);
    }
  };

  // Ao clicar na refeição, abrir diretamente na tela cheia
  const handleMealClick = (meal: MealData) => {
    setSelectedMeal(meal);
    setShowFullScreenMenu(true);
  };

  const handleCloseFullScreenMenu = () => {
    setShowFullScreenMenu(false);
    setSelectedMeal(null);
  };

  const pageContent = () => {
    if (isLoading || prescriptionLoading) {
      return (
        <div className="text-center p-8">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-4"></div>
          <p className="text-muted-foreground">Carregando prescrições...</p>
        </div>
      );
    }
  
    if (prescriptions.length === 0) {
      return (
        <Card className="mt-6">
          <CardContent className="p-8 text-center">
            <p className="text-muted-foreground mb-4">Você ainda não possui uma prescrição publicada.</p>
            <p className="text-sm text-muted-foreground">Entre em contato com seu nutricionista.</p>
          </CardContent>
        </Card>
      );
    }

    // Se uma refeição foi selecionada, mostrar a tela completa do menu da refeição
    if (selectedMeal && selectedPrescription && showFullScreenMenu) {
      return (
        <MealMenuScreen
          meal={selectedMeal}
          prescriptionId={selectedPrescription.id}
          patientId={currentPatient?.id || ""}
          onClose={handleCloseFullScreenMenu}
        />
      );
    }

    // Lista de refeições
    return (
      <div className="p-4 md:p-0">
        <Tabs value={selectedPrescription?.id} onValueChange={handleSelectPrescription} className="w-full">
          <TabsList>
            {prescriptions.map(p => (
              <TabsTrigger key={p.id} value={p.id}>{p.title}</TabsTrigger>
            ))}
          </TabsList>
        
          <div className="space-y-4 mt-6">
            {selectedPrescription?.meals.map(meal => (
              <MealCard
                key={meal.id}
                title={meal.name}
                icon={Utensils}
                onClick={() => handleMealClick(meal)}
              />
            ))}
          </div>
        </Tabs>
      </div>
    );
  };
  
  if (isMobile) {
    // Se estiver mostrando a tela completa do menu da refeição, renderizar fora do layout customizado
    if (selectedMeal && selectedPrescription && showFullScreenMenu) {
      return (
        <MealMenuScreen
          meal={selectedMeal}
          prescriptionId={selectedPrescription.id}
          patientId={currentPatient?.id || ""}
          onClose={handleCloseFullScreenMenu}
        />
      );
    }

    // Layout customizado para o mockup
    return (
      <div className="min-h-screen bg-background">
        {/* Header customizado com gradiente */}
        <HeaderDNutri 
          onProfileClick={() => setIsProfileModalOpen(true)} 
          goalText={goalText} 
        />
        
        {/* Área de conteúdo com cantos superiores arredondados */}
        <main className="bg-white rounded-t-2xl -mt-2 min-h-screen pt-6 pb-20">
          {pageContent()}
        </main>

        {/* Bottom navigation customizada */}
        <DNutriBottomNav 
          activeItem="prescription" 
          onItemClick={(item) => {
            if (item === "home") setLocation("/");
            else if (item === "prescription") setLocation("/patient/prescription");
            else if (item === "profile") {
              // Open profile modal instead of logout confirmation
              setIsProfileModalOpen(true);
            }
          }}
        />

        {/* Profile Modal */}
        <ProfileModal 
          open={isProfileModalOpen}
          onOpenChange={setIsProfileModalOpen}
          patient={currentPatient || null}
        />

        {/* Modal de substituições */}
        <Dialog open={isSubstitutesModalOpen} onOpenChange={setIsSubstitutesModalOpen}>
          <DialogContent>
            <DialogHeader>
              <DialogTitle>Opções de Substituição para: {selectedItemForSubstitutes?.description}</DialogTitle>
            </DialogHeader>
            <div className="space-y-2 max-h-[60vh] overflow-y-auto">
              {selectedItemForSubstitutes?.substitutes?.map((sub, index) => (
                <Card key={index}><CardContent className="p-3">{sub}</CardContent></Card>
              ))}
            </div>
          </DialogContent>
        </Dialog>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-background">
      <Header
        title="Minha Prescrição"
        rightElement={
          <Button
            onClick={handlePrint}
            className="flex items-center space-x-2"
            disabled={!selectedPrescription}
            data-testid="button-print-prescription"
          >
            <Printer className="h-4 w-4" />
            <span>Imprimir</span>
          </Button>
        }
      />
      <main className="max-w-xl mx-auto p-4 lg:p-6">
        {pageContent()}
      </main>

      {/* Modal de substituições */}
      <Dialog open={isSubstitutesModalOpen} onOpenChange={setIsSubstitutesModalOpen}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>Opções de Substituição para: {selectedItemForSubstitutes?.description}</DialogTitle>
          </DialogHeader>
          <div className="space-y-2 max-h-[60vh] overflow-y-auto">
            {selectedItemForSubstitutes?.substitutes?.map((sub, index) => (
              <Card key={index}><CardContent className="p-3">{sub}</CardContent></Card>
            ))}
          </div>
        </DialogContent>
      </Dialog>
    </div>
  );
}
===== ./client/src/pages/public/anamnese.tsx =====
import { useMemo } from "react";
import { useMutation, useQuery } from "@tanstack/react-query";
import { useLocation, Link } from "wouter";
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Form, FormControl, FormField, FormItem, FormLabel, FormMessage, FormDescription } from "@/components/ui/form";
import { Checkbox } from "@/components/ui/checkbox";
import { useToast } from "@/hooks/use-toast";
import { apiRequest } from "@/lib/queryClient";
import { insertPatientSchema } from "@shared/schema";
import { DiNutriLogo } from "@/components/ui/dinutri-logo";
import { Alert, AlertDescription, AlertTitle } from "@/components/ui/alert";
import { AlertCircle } from "lucide-react";

// Schema for the anamnese form with all fields
const formSchema = insertPatientSchema.omit({ ownerId: true, userId: true }).extend({
  heightCm: z.preprocess(
    (val) => (val === "" ? undefined : val),
    z.coerce.number().optional()
  ),
  weightKg: z.string().regex(/^\d+(\.\d{1,2})?$/, "Peso inválido. Ex: 65.50").optional().or(z.literal('')),
  password: z.string().min(6, "A senha deve ter no mínimo 6 caracteres."),
  confirmPassword: z.string(),
  // Transform string arrays for multi-select fields
  likedHealthyFoods: z.array(z.string()).default([]),
  dislikedFoods: z.array(z.string()).default([]),
  intolerances: z.array(z.string()).default([]),
}).refine(data => data.password === data.confirmPassword, {
  message: "As senhas não correspondem.",
  path: ["confirmPassword"],
});

type FormData = z.infer<typeof formSchema>;

export default function AnamnesePage() {
  const [location, setLocation] = useLocation();
  const { toast } = useToast();
  
  // Extract token from URL
  const token = useMemo(() => new URLSearchParams(window.location.search).get("token"), [location]);

  // Validate invitation token
  const { isLoading: isValidationLoading, isError: isTokenInvalid } = useQuery({
    queryKey: ["/api/invitations/validate", token],
    queryFn: () => fetch(`/api/invitations/validate?token=${token}`).then(res => {
      if (!res.ok) throw new Error("Token inválido");
      return res.json();
    }),
    enabled: !!token,
    retry: false,
  });

  const form = useForm<FormData>({
    resolver: zodResolver(formSchema),
    defaultValues: {
      name: "",
      email: "",
      password: "",
      confirmPassword: "",
      birthDate: "",
      sex: undefined,
      heightCm: undefined,
      weightKg: "",
      notes: "",
      goal: undefined,
      activityLevel: undefined,
      likedHealthyFoods: [],
      dislikedFoods: [],
      hasIntolerance: false,
      intolerances: [],
      canEatMorningSolids: false,
      mealsPerDayCurrent: undefined,
      mealsPerDayWilling: undefined,
      alcoholConsumption: undefined,
      supplements: "",
      diseases: "",
      medications: "",
      biotype: undefined,
    },
  });

  const registerPatientMutation = useMutation({
    mutationFn: (data: Omit<FormData, 'confirmPassword'> & { token: string }) => {
      return apiRequest("POST", "/api/patient/register", data);
    },
    onSuccess: () => {
      toast({
        title: "Anamnese concluída com sucesso!",
        description: "Sua conta foi criada e você já pode acessá-la.",
      });
      // Reload page to let App.tsx redirect to patient home
      window.location.href = "/";
    },
    onError: (err: any) => {
      console.error("Erro no registro:", err);
      const errorMessage = err.message.includes("409")
        ? "Este email já está cadastrado no sistema."
        : "Não foi possível concluir sua anamnese. Tente novamente.";
      toast({
        title: "Erro no Cadastro",
        description: errorMessage,
        variant: "destructive",
      });
    },
  });

  const onSubmit = (data: FormData) => {
    if (!token) return;
    const { confirmPassword, ...payload } = data;
    registerPatientMutation.mutate({ ...payload, token });
  };

  if (isValidationLoading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-4"></div>
          <p className="text-muted-foreground">Validando convite...</p>
        </div>
      </div>
    );
  }

  if (isTokenInvalid || !token) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center p-4">
        <Alert variant="destructive" className="max-w-md">
          <AlertCircle className="h-4 w-4" />
          <AlertTitle>Link de Convite Inválido</AlertTitle>
          <AlertDescription>
            Este link é inválido, expirou ou já foi utilizado. Por favor, solicite um novo convite ao seu nutricionista.
            <div className="mt-4">
              <Button asChild variant="link" className="p-0">
                <Link to="/">Voltar para a página de login</Link>
              </Button>
            </div>
          </AlertDescription>
        </Alert>
      </div>
    );
  }

  return (
    <>
      {/* Estilos para os blobs animados e efeitos 3D dos cards */}
      <style>{`
        @keyframes blob {
          0% { transform: translate(0px, 0px) scale(1); }
          33% { transform: translate(30px, -50px) scale(1.1); }
          66% { transform: translate(-20px, 20px) scale(0.9); }
          100% { transform: translate(0px, 0px) scale(1); }
        }
        .animate-blob { animation: blob 7s infinite; }
        .animation-delay-2000 { animation-delay: 2s; }
        .animation-delay-4000 { animation-delay: 4s; }
        
        /* Efeitos 3D para os cards */
        .card-3d {
          perspective: 1000px;
          transform-style: preserve-3d;
          transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .card-3d:hover {
          transform: translateY(-8px) rotateX(2deg) rotateY(-2deg);
        }
        
        .card-3d::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(147, 51, 234, 0.05) 100%);
          border-radius: inherit;
          opacity: 0;
          transition: opacity 0.3s ease;
          pointer-events: none;
          z-index: 1;
        }
        
        .card-3d:hover::before {
          opacity: 1;
        }
        
        .card-3d > * {
          position: relative;
          z-index: 2;
        }
        
        /* Sombras aprimoradas */
        .shadow-3d {
          box-shadow: 
            0 4px 6px -1px rgba(0, 0, 0, 0.1),
            0 2px 4px -1px rgba(0, 0, 0, 0.06),
            0 10px 25px -3px rgba(59, 130, 246, 0.1),
            0 0 0 1px rgba(255, 255, 255, 0.05);
        }
        
        .shadow-3d:hover {
          box-shadow: 
            0 20px 25px -5px rgba(0, 0, 0, 0.1),
            0 10px 10px -5px rgba(0, 0, 0, 0.04),
            0 25px 50px -12px rgba(59, 130, 246, 0.25),
            0 0 0 1px rgba(255, 255, 255, 0.1);
        }
        
        /* Gradientes sutis para diferentes cards */
        .card-personal {
          background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 250, 252, 0.95) 100%);
          border: 1px solid rgba(59, 130, 246, 0.1);
        }
        
        .card-goals {
          background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(240, 253, 244, 0.95) 100%);
          border: 1px solid rgba(34, 197, 94, 0.1);
        }
        
        .card-preferences {
          background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 247, 237, 0.95) 100%);
          border: 1px solid rgba(251, 146, 60, 0.1);
        }
        
        .card-health {
          background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(252, 231, 243, 0.95) 100%);
          border: 1px solid rgba(236, 72, 153, 0.1);
        }
        
        /* Animação de entrada suave */
        .card-enter {
          animation: cardSlideIn 0.6s ease-out forwards;
        }
        
        @keyframes cardSlideIn {
          from {
            opacity: 0;
            transform: translateY(30px);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }
        
        .card-enter:nth-child(1) { animation-delay: 0.1s; }
        .card-enter:nth-child(2) { animation-delay: 0.2s; }
        .card-enter:nth-child(3) { animation-delay: 0.3s; }
        .card-enter:nth-child(4) { animation-delay: 0.4s; }
        .card-enter:nth-child(5) { animation-delay: 0.5s; }
      `}</style>

      <div className="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-100 flex flex-col items-center justify-center p-4 relative overflow-hidden">
        {/* Elementos decorativos do fundo */}
        <div className="absolute inset-0 overflow-hidden -z-10">
          <div className="absolute -top-40 -right-40 w-80 h-80 bg-blue-400 rounded-full mix-blend-multiply filter blur-xl opacity-20 animate-blob"></div>
          <div className="absolute -bottom-40 -left-40 w-80 h-80 bg-purple-400 rounded-full mix-blend-multiply filter blur-xl opacity-20 animate-blob animation-delay-2000"></div>
        </div>

        {/* Logo Destacada */}
        <div className="flex justify-center mb-6 mt-8">
          <DiNutriLogo variant="full" className="h-24" />
        </div>

        <main className="w-full max-w-4xl mx-auto space-y-8">
          <Card className="card-3d shadow-3d rounded-3xl border-0 bg-white/95 backdrop-blur-md card-enter">
            <CardHeader className="text-center pb-6">
              <CardTitle className="text-3xl font-bold bg-gradient-to-r from-slate-800 to-slate-600 bg-clip-text text-transparent">
                Anamnese Nutricional
              </CardTitle>
              <CardDescription className="text-lg text-muted-foreground mt-2">
                Parabéns pela escolha de cuidar da sua saúde! Preencha os campos abaixo para criarmos seu plano.
              </CardDescription>
            </CardHeader>
          </Card>

          <Form {...form}>
            <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-8">
              
              <Card className="card-3d card-personal shadow-3d rounded-3xl border-0 backdrop-blur-md card-enter">
                <CardHeader className="pb-6">
                  <CardTitle className="text-xl font-semibold text-slate-800 flex items-center gap-3">
                    <div className="w-8 h-8 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center text-white font-bold text-sm">1</div>
                    Dados Pessoais e Acesso
                  </CardTitle>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <FormField
                      control={form.control}
                      name="name"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Nome Completo</FormLabel>
                          <FormControl>
                            <Input placeholder="Seu nome completo" {...field} />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                    <FormField
                      control={form.control}
                      name="email"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>E-mail</FormLabel>
                          <FormControl>
                            <Input type="email" placeholder="seu@email.com" value={field.value || ""} onChange={field.onChange} onBlur={field.onBlur} name={field.name} ref={field.ref} />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                  </div>

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <FormField
                      control={form.control}
                      name="password"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Crie sua Senha</FormLabel>
                          <FormControl>
                            <Input type="password" placeholder="••••••••" {...field} />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                    <FormField
                      control={form.control}
                      name="confirmPassword"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Confirme sua Senha</FormLabel>
                          <FormControl>
                            <Input type="password" placeholder="••••••••" {...field} />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                  </div>

                  <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <FormField
                      control={form.control}
                      name="birthDate"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Data de Nascimento</FormLabel>
                          <FormControl>
                            <Input type="date" {...field} value={field.value || ""} />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                    <FormField
                      control={form.control}
                      name="sex"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Sexo</FormLabel>
                          <Select onValueChange={field.onChange} value={field.value || ""}>
                            <FormControl>
                              <SelectTrigger><SelectValue placeholder="Selecionar" /></SelectTrigger>
                            </FormControl>
                            <SelectContent>
                              <SelectItem value="F">Feminino</SelectItem>
                              <SelectItem value="M">Masculino</SelectItem>
                              <SelectItem value="Outro">Outro</SelectItem>
                            </SelectContent>
                          </Select>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                    <FormField
                      control={form.control}
                      name="heightCm"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Altura (cm)</FormLabel>
                          <FormControl>
                            <Input
                              type="number"
                              placeholder="170"
                              value={field.value ?? ""}
                              onChange={(e) => field.onChange(e.target.value === "" ? undefined : Number(e.target.value))}
                              onBlur={field.onBlur}
                              name={field.name}
                              ref={field.ref}
                            />
                          </FormControl>
                          <FormDescription>Altura em centímetros (opcional)</FormDescription>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                  </div>

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <FormField
                      control={form.control}
                      name="weightKg"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Peso (kg)</FormLabel>
                          <FormControl>
                            <Input
                              placeholder="70.5"
                              value={field.value || ""}
                              onChange={field.onChange}
                              onBlur={field.onBlur}
                              name={field.name}
                              ref={field.ref}
                            />
                          </FormControl>
                          <FormDescription>Formato: 70.5 (opcional)</FormDescription>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                  </div>
                </CardContent>
              </Card>

              <Card className="card-3d card-goals shadow-3d rounded-3xl border-0 backdrop-blur-md card-enter">
                <CardHeader className="pb-6">
                  <CardTitle className="text-xl font-semibold text-slate-800 flex items-center gap-3">
                    <div className="w-8 h-8 bg-gradient-to-br from-green-500 to-green-600 rounded-full flex items-center justify-center text-white font-bold text-sm">2</div>
                    Objetivos e Hábitos
                  </CardTitle>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <FormField
                      control={form.control}
                      name="goal"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Objetivo</FormLabel>
                          <Select onValueChange={field.onChange} value={field.value || ""}>
                            <FormControl>
                              <SelectTrigger><SelectValue placeholder="Selecionar" /></SelectTrigger>
                            </FormControl>
                            <SelectContent>
                              <SelectItem value="lose_weight">Perder peso</SelectItem>
                              <SelectItem value="maintain_weight">Manter peso</SelectItem>
                              <SelectItem value="gain_weight">Ganhar peso</SelectItem>
                            </SelectContent>
                          </Select>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                    <FormField
                      control={form.control}
                      name="activityLevel"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Nível de Atividade Física</FormLabel>
                          <Select onValueChange={field.onChange} value={field.value || ""}>
                            <FormControl>
                              <SelectTrigger><SelectValue placeholder="Selecionar" /></SelectTrigger>
                            </FormControl>
                            <SelectContent>
                              <SelectItem value="1">1 - Sedentário</SelectItem>
                              <SelectItem value="2">2 - Levemente ativo</SelectItem>
                              <SelectItem value="3">3 - Moderadamente ativo</SelectItem>
                              <SelectItem value="4">4 - Muito ativo</SelectItem>
                              <SelectItem value="5">5 - Extremamente ativo</SelectItem>
                            </SelectContent>
                          </Select>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                  </div>

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <FormField
                      control={form.control}
                      name="biotype"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Biotipo</FormLabel>
                          <Select onValueChange={field.onChange} value={field.value || ""}>
                            <FormControl>
                              <SelectTrigger><SelectValue placeholder="Selecionar" /></SelectTrigger>
                            </FormControl>
                            <SelectContent>
                              <SelectItem value="gain_weight_easily">Ganho peso facilmente</SelectItem>
                              <SelectItem value="hard_to_gain">Dificuldade para ganhar peso</SelectItem>
                              <SelectItem value="gain_muscle_easily">Ganho músculo facilmente</SelectItem>
                            </SelectContent>
                          </Select>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                    <FormField
                      control={form.control}
                      name="mealsPerDayCurrent"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Quantas refeições faz por dia atualmente?</FormLabel>
                          <FormControl>
                            <Input
                              type="number"
                              min="1"
                              max="10"
                              placeholder="3"
                              value={field.value ?? ""}
                              onChange={(e) => field.onChange(e.target.value === "" ? undefined : Number(e.target.value))}
                              onBlur={field.onBlur}
                              name={field.name}
                              ref={field.ref}
                            />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                  </div>

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <FormField
                      control={form.control}
                      name="mealsPerDayWilling"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Quantas refeições estaria disposto a fazer?</FormLabel>
                          <FormControl>
                            <Input
                              type="number"
                              min="1"
                              max="10"
                              placeholder="5"
                              value={field.value ?? ""}
                              onChange={(e) => field.onChange(e.target.value === "" ? undefined : Number(e.target.value))}
                              onBlur={field.onBlur}
                              name={field.name}
                              ref={field.ref}
                            />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                    <FormField
                      control={form.control}
                      name="canEatMorningSolids"
                      render={({ field }) => (
                        <FormItem className="flex flex-row items-start space-x-3 space-y-0">
                          <FormControl>
                            <Checkbox
                              checked={field.value || false}
                              onCheckedChange={field.onChange}
                            />
                          </FormControl>
                          <div className="space-y-1 leading-none">
                            <FormLabel>Consegue comer sólidos pela manhã?</FormLabel>
                          </div>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                  </div>

                  <FormField
                    control={form.control}
                    name="alcoholConsumption"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Consumo de Álcool</FormLabel>
                        <Select onValueChange={field.onChange} value={field.value || ""}>
                          <FormControl>
                            <SelectTrigger><SelectValue placeholder="Selecionar" /></SelectTrigger>
                          </FormControl>
                          <SelectContent>
                            <SelectItem value="no">Não bebo</SelectItem>
                            <SelectItem value="moderate">Moderadamente</SelectItem>
                            <SelectItem value="yes">Sim, frequentemente</SelectItem>
                          </SelectContent>
                        </Select>
                        <FormMessage />
                      </FormItem>
                    )}
                  />
                </CardContent>
              </Card>

              <Card className="card-3d card-preferences shadow-3d rounded-3xl border-0 backdrop-blur-md card-enter">
                <CardHeader className="pb-6">
                  <CardTitle className="text-xl font-semibold text-slate-800 flex items-center gap-3">
                    <div className="w-8 h-8 bg-gradient-to-br from-orange-500 to-orange-600 rounded-full flex items-center justify-center text-white font-bold text-sm">3</div>
                    Preferências e Restrições
                  </CardTitle>
                </CardHeader>
                <CardContent className="space-y-4">
                  <FormField
                    control={form.control}
                    name="hasIntolerance"
                    render={({ field }) => (
                      <FormItem className="flex flex-row items-start space-x-3 space-y-0">
                        <FormControl>
                          <Checkbox
                            checked={field.value || false}
                            onCheckedChange={field.onChange}
                          />
                        </FormControl>
                        <div className="space-y-1 leading-none">
                          <FormLabel>Possui alguma intolerância alimentar?</FormLabel>
                        </div>
                        <FormMessage />
                      </FormItem>
                    )}
                  />

                  {form.watch("hasIntolerance") && (
                    <FormField
                      control={form.control}
                      name="intolerances"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Quais intolerâncias? (separar por vírgula)</FormLabel>
                          <FormControl>
                            <Input
                              placeholder="Lactose, glúten, etc."
                              value={field.value?.join(", ") || ""}
                              onChange={(e) => field.onChange(e.target.value.split(",").map(s => s.trim()).filter(Boolean))}
                              onBlur={field.onBlur}
                              name={field.name}
                              ref={field.ref}
                            />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                  )}

                  <FormField
                    control={form.control}
                    name="likedHealthyFoods"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Alimentos saudáveis que você gosta (separar por vírgula)</FormLabel>
                        <FormControl>
                          <Textarea
                            placeholder="Brócolis, quinoa, salmão, abacate..."
                            value={field.value?.join(", ") || ""}
                            onChange={(e) => field.onChange(e.target.value.split(",").map(s => s.trim()).filter(Boolean))}
                            onBlur={field.onBlur}
                            name={field.name}
                            ref={field.ref}
                          />
                        </FormControl>
                        <FormMessage />
                      </FormItem>
                    )}
                  />

                  <FormField
                    control={form.control}
                    name="dislikedFoods"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Alimentos que não gosta (separar por vírgula)</FormLabel>
                        <FormControl>
                          <Textarea
                            placeholder="Cebola, peixe, couve-flor..."
                            value={field.value?.join(", ") || ""}
                            onChange={(e) => field.onChange(e.target.value.split(",").map(s => s.trim()).filter(Boolean))}
                            onBlur={field.onBlur}
                            name={field.name}
                            ref={field.ref}
                          />
                        </FormControl>
                        <FormMessage />
                      </FormItem>
                    )}
                  />
                </CardContent>
              </Card>
              
              <Card className="card-3d card-health shadow-3d rounded-3xl border-0 backdrop-blur-md card-enter">
                <CardHeader className="pb-6">
                  <CardTitle className="text-xl font-semibold text-slate-800 flex items-center gap-3">
                    <div className="w-8 h-8 bg-gradient-to-br from-pink-500 to-pink-600 rounded-full flex items-center justify-center text-white font-bold text-sm">4</div>
                    Saúde e Informações Adicionais
                  </CardTitle>
                </CardHeader>
                <CardContent className="space-y-4">
                  <FormField
                    control={form.control}
                    name="diseases"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Doenças ou condições de saúde</FormLabel>
                        <FormControl>
                          <Textarea
                            placeholder="Diabetes, hipertensão, hipotireoidismo..."
                            value={field.value || ""}
                            onChange={field.onChange}
                            onBlur={field.onBlur}
                            name={field.name}
                            ref={field.ref}
                          />
                        </FormControl>
                        <FormMessage />
                      </FormItem>
                    )}
                  />

                  <FormField
                    control={form.control}
                    name="medications"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Medicamentos em uso</FormLabel>
                        <FormControl>
                          <Textarea
                            placeholder="Liste os medicamentos que utiliza regularmente..."
                            value={field.value || ""}
                            onChange={field.onChange}
                            onBlur={field.onBlur}
                            name={field.name}
                            ref={field.ref}
                          />
                        </FormControl>
                        <FormMessage />
                      </FormItem>
                    )}
                  />

                  <FormField
                    control={form.control}
                    name="supplements"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Suplementos em uso</FormLabel>
                        <FormControl>
                          <Textarea
                            placeholder="Whey protein, vitamina D, ômega 3..."
                            value={field.value || ""}
                            onChange={field.onChange}
                            onBlur={field.onBlur}
                            name={field.name}
                            ref={field.ref}
                          />
                        </FormControl>
                        <FormMessage />
                      </FormItem>
                    )}
                  />

                  <FormField
                    control={form.control}
                    name="notes"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Observações Adicionais</FormLabel>
                        <FormControl>
                          <Textarea
                            placeholder="Compartilhe qualquer informação adicional que possa ser relevante..."
                            className="min-h-[100px]"
                            value={field.value || ""}
                            onChange={field.onChange}
                            onBlur={field.onBlur}
                            name={field.name}
                            ref={field.ref}
                          />
                        </FormControl>
                        <FormMessage />
                      </FormItem>
                    )}
                  />
                </CardContent>
              </Card>

              <div className="flex justify-end space-x-4 pt-6 pb-8">
                <Button asChild variant="ghost" className="px-8 py-3 text-lg rounded-2xl">
                  <Link to="/">Cancelar</Link>
                </Button>
                <Button
                  type="submit"
                  disabled={registerPatientMutation.isPending}
                  className="min-w-[200px] text-lg py-6 px-8 rounded-2xl bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 shadow-xl hover:shadow-2xl transform hover:scale-105 transition-all duration-300"
                  size="lg"
                >
                  {registerPatientMutation.isPending ? "Finalizando..." : "Concluir e Criar Conta"}
                </Button>
              </div>

            </form>
          </Form>
        </main>
      </div>
    </>
  );
}
===== ./client/src/pages/public/follow-up-anamnese.tsx =====
import { useMemo } from "react";
import { useMutation } from "@tanstack/react-query";
import { useLocation, Link } from "wouter";
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Form, FormControl, FormField, FormItem, FormLabel, FormMessage, FormDescription } from "@/components/ui/form";
import { Checkbox } from "@/components/ui/checkbox";
import { useToast } from "@/hooks/use-toast";
import { apiRequest } from "@/lib/queryClient";
import { insertAnamnesisRecordSchema } from "@shared/schema";
import { DiNutriLogo } from "@/components/ui/dinutri-logo";
import { Alert, AlertDescription, AlertTitle } from "@/components/ui/alert";
import { AlertCircle } from "lucide-react";

// Schema for the follow-up anamnese form (without account creation fields)
const formSchema = insertAnamnesisRecordSchema.omit({ patientId: true }).extend({
  weightKg: z.string().regex(/^\d+(\.\d{1,2})?$/, "Peso inválido. Ex: 65.50").optional().or(z.literal('')),
  // Transform string arrays for multi-select fields
  likedHealthyFoods: z.array(z.string()).default([]),
  dislikedFoods: z.array(z.string()).default([]),
  intolerances: z.array(z.string()).default([]),
  // New feedback fields
  protocolAdherence: z.enum(["total", "partial", "low"]).optional(),
  nextProtocolRequests: z.string().optional(),
});

type FormData = z.infer<typeof formSchema>;

export default function FollowUpAnamnesePage() {
  const [location, setLocation] = useLocation();
  const { toast } = useToast();
  
  // Extract patientId from URL
  const patientId = useMemo(() => new URLSearchParams(window.location.search).get("patientId"), [location]);

  if (!patientId) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-50 to-green-50 flex items-center justify-center p-4">
        <Card className="w-full max-w-md">
          <CardContent className="p-6">
            <Alert>
              <AlertCircle className="h-4 w-4" />
              <AlertTitle>Link inválido</AlertTitle>
              <AlertDescription>
                Este link de anamnese de retorno não é válido ou expirou.
              </AlertDescription>
            </Alert>
          </CardContent>
        </Card>
      </div>
    );
  }

  const form = useForm<FormData>({
    resolver: zodResolver(formSchema),
    defaultValues: {
      weightKg: "",
      notes: "",
      goal: undefined,
      activityLevel: undefined,
      likedHealthyFoods: [],
      dislikedFoods: [],
      hasIntolerance: false,
      intolerances: [],
      canEatMorningSolids: false,
      mealsPerDayCurrent: undefined,
      mealsPerDayWilling: undefined,
      alcoholConsumption: undefined,
      supplements: "",
      diseases: "",
      medications: "",
      biotype: undefined,
      protocolAdherence: undefined,
      nextProtocolRequests: "",
    },
  });

  const submitAnamneseMutation = useMutation({
    mutationFn: (data: FormData) => {
      return apiRequest("POST", `/api/patients/${patientId}/anamnesis-records`, data);
    },
    onSuccess: () => {
      toast({
        title: "Anamnese de retorno enviada!",
        description: "Suas informações foram atualizadas com sucesso.",
      });
      // Redirect to home
      setLocation("/");
    },
    onError: (err: any) => {
      console.error("Erro ao enviar anamnese:", err);
      toast({
        title: "Erro ao enviar anamnese",
        description: err.message || "Não foi possível enviar as informações. Tente novamente.",
        variant: "destructive",
      });
    },
  });

  const onSubmit = (data: FormData) => {
    submitAnamneseMutation.mutate(data);
  };

  const healthyFoodOptions = [
    "Verduras (alface, rúcula, espinafre)",
    "Legumes (cenoura, beterraba, abobrinha)",
    "Frutas (maçã, banana, laranja)",
    "Grãos integrais (aveia, quinoa, arroz integral)",
    "Proteínas magras (frango, peixe, ovos)",
    "Oleaginosas (castanhas, amêndoas, nozes)"
  ];

  const dislikedFoodOptions = [
    "Verduras folhosas",
    "Legumes cozidos",
    "Frutas ácidas",
    "Peixes",
    "Frutos do mar",
    "Queijos",
    "Ovos",
    "Carne vermelha"
  ];

  const intoleranceOptions = [
    "Lactose",
    "Glúten",
    "Ovo",
    "Soja",
    "Amendoim",
    "Frutos do mar",
    "Nozes"
  ];

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-green-50">
      <div className="container mx-auto py-8 px-4">
        <DiNutriLogo variant="full" className="h-16" />
      </div>
      <main className="max-w-4xl mx-auto">
        <Card>
          <CardHeader className="text-center">
            <CardTitle className="text-2xl">Anamnese de Retorno</CardTitle>
            <CardDescription>
              Atualize suas informações nutricionais para que possamos acompanhar melhor sua evolução.
            </CardDescription>
          </CardHeader>
          <CardContent>
            <Form {...form}>
              <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-6">
                
                {/* Current Status */}
                <div className="space-y-4">
                  <h3 className="text-lg font-semibold">Dados Atuais</h3>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <FormField
                      control={form.control}
                      name="weightKg"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Peso atual (kg)</FormLabel>
                          <FormControl>
                            <Input placeholder="Ex: 65.5" {...field} />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                  </div>
                </div>

                {/* Goals and Activity */}
                <div className="space-y-4">
                  <h3 className="text-lg font-semibold">Objetivos e Atividade</h3>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <FormField
                      control={form.control}
                      name="goal"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Objetivo principal</FormLabel>
                          <Select onValueChange={field.onChange} value={field.value || undefined}>
                            <FormControl>
                              <SelectTrigger>
                                <SelectValue placeholder="Selecione seu objetivo" />
                              </SelectTrigger>
                            </FormControl>
                            <SelectContent>
                              <SelectItem value="lose_weight">Perder peso</SelectItem>
                              <SelectItem value="maintain_weight">Manter peso</SelectItem>
                              <SelectItem value="gain_weight">Ganhar peso</SelectItem>
                            </SelectContent>
                          </Select>
                          <FormMessage />
                        </FormItem>
                      )}
                    />

                    <FormField
                      control={form.control}
                      name="activityLevel"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Nível de atividade física</FormLabel>
                          <Select onValueChange={field.onChange} value={field.value || undefined}>
                            <FormControl>
                              <SelectTrigger>
                                <SelectValue placeholder="Selecione seu nível" />
                              </SelectTrigger>
                            </FormControl>
                            <SelectContent>
                              <SelectItem value="1">1 - Sedentário</SelectItem>
                              <SelectItem value="2">2 - Levemente ativo</SelectItem>
                              <SelectItem value="3">3 - Moderadamente ativo</SelectItem>
                              <SelectItem value="4">4 - Muito ativo</SelectItem>
                              <SelectItem value="5">5 - Extremamente ativo</SelectItem>
                            </SelectContent>
                          </Select>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                  </div>
                </div>

                {/* Food Preferences */}
                <div className="space-y-4">
                  <h3 className="text-lg font-semibold">Preferências Alimentares</h3>
                  
                  <FormField
                    control={form.control}
                    name="likedHealthyFoods"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Alimentos saudáveis que você gosta</FormLabel>
                        <FormDescription>
                          Marque os alimentos saudáveis que você consome ou gostaria de consumir mais
                        </FormDescription>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                          {healthyFoodOptions.map((food) => (
                            <div key={food} className="flex items-center space-x-2">
                              <Checkbox
                                checked={field.value?.includes(food)}
                                onCheckedChange={(checked) => {
                                  const currentValue = field.value || [];
                                  if (checked) {
                                    field.onChange([...currentValue, food]);
                                  } else {
                                    field.onChange(currentValue.filter((value) => value !== food));
                                  }
                                }}
                              />
                              <label className="text-sm">{food}</label>
                            </div>
                          ))}
                        </div>
                        <FormMessage />
                      </FormItem>
                    )}
                  />

                  <FormField
                    control={form.control}
                    name="dislikedFoods"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Alimentos que você não gosta ou evita</FormLabel>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                          {dislikedFoodOptions.map((food) => (
                            <div key={food} className="flex items-center space-x-2">
                              <Checkbox
                                checked={field.value?.includes(food)}
                                onCheckedChange={(checked) => {
                                  const currentValue = field.value || [];
                                  if (checked) {
                                    field.onChange([...currentValue, food]);
                                  } else {
                                    field.onChange(currentValue.filter((value) => value !== food));
                                  }
                                }}
                              />
                              <label className="text-sm">{food}</label>
                            </div>
                          ))}
                        </div>
                        <FormMessage />
                      </FormItem>
                    )}
                  />
                </div>

                {/* Health Information */}
                <div className="space-y-4">
                  <h3 className="text-lg font-semibold">Informações de Saúde</h3>
                  
                  <FormField
                    control={form.control}
                    name="hasIntolerance"
                    render={({ field }) => (
                      <FormItem className="flex flex-row items-start space-x-3 space-y-0">
                        <FormControl>
                          <Checkbox
                            checked={field.value || false}
                            onCheckedChange={field.onChange}
                          />
                        </FormControl>
                        <div className="space-y-1 leading-none">
                          <FormLabel>
                            Tenho intolerâncias ou alergias alimentares
                          </FormLabel>
                        </div>
                      </FormItem>
                    )}
                  />

                  {form.watch("hasIntolerance") && (
                    <FormField
                      control={form.control}
                      name="intolerances"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Quais intolerâncias você tem?</FormLabel>
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                            {intoleranceOptions.map((intolerance) => (
                              <div key={intolerance} className="flex items-center space-x-2">
                                <Checkbox
                                  checked={field.value?.includes(intolerance)}
                                  onCheckedChange={(checked) => {
                                    const currentValue = field.value || [];
                                    if (checked) {
                                      field.onChange([...currentValue, intolerance]);
                                    } else {
                                      field.onChange(currentValue.filter((value) => value !== intolerance));
                                    }
                                  }}
                                />
                                <label className="text-sm">{intolerance}</label>
                              </div>
                            ))}
                          </div>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                  )}

                  <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <FormField
                      control={form.control}
                      name="diseases"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Doenças/Condições</FormLabel>
                          <FormControl>
                            <Textarea
                              placeholder="Diabetes, hipertensão, etc."
                              className="resize-none"
                              value={field.value || ""}
                              onChange={field.onChange}
                            />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />

                    <FormField
                      control={form.control}
                      name="medications"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Medicamentos atuais</FormLabel>
                          <FormControl>
                            <Textarea
                              placeholder="Liste os medicamentos que usa"
                              className="resize-none"
                              value={field.value || ""}
                              onChange={field.onChange}
                            />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />

                    <FormField
                      control={form.control}
                      name="supplements"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>Suplementos</FormLabel>
                          <FormControl>
                            <Textarea
                              placeholder="Vitaminas, proteínas, etc."
                              className="resize-none"
                              value={field.value || ""}
                              onChange={field.onChange}
                            />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                  </div>
                </div>

                {/* Protocol Feedback */}
                <div className="space-y-4">
                  <h3 className="text-lg font-semibold">Feedback do Plano Nutricional</h3>
                  
                  <FormField
                    control={form.control}
                    name="protocolAdherence"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Como foi sua adesão ao protocolo nutricional anterior?</FormLabel>
                        <Select onValueChange={field.onChange} value={field.value || undefined}>
                          <FormControl>
                            <SelectTrigger>
                              <SelectValue placeholder="Selecione sua adesão" />
                            </SelectTrigger>
                          </FormControl>
                          <SelectContent>
                            <SelectItem value="total">Total - Segui completamente as orientações</SelectItem>
                            <SelectItem value="partial">Parcial - Segui a maior parte das orientações</SelectItem>
                            <SelectItem value="low">Baixa - Tive dificuldades para seguir as orientações</SelectItem>
                          </SelectContent>
                        </Select>
                        <FormMessage />
                      </FormItem>
                    )}
                  />

                  <FormField
                    control={form.control}
                    name="nextProtocolRequests"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Que alimentos ou preparações você gostaria de incluir no próximo plano?</FormLabel>
                        <FormControl>
                          <Textarea
                            placeholder="Descreva alimentos específicos, pratos ou preparações que você gostaria de incluir no seu próximo plano nutricional..."
                            className="min-h-[80px]"
                            value={field.value || ""}
                            onChange={field.onChange}
                          />
                        </FormControl>
                        <FormMessage />
                      </FormItem>
                    )}
                  />
                </div>

                {/* Additional Notes */}
                <div className="space-y-4">
                  <h3 className="text-lg font-semibold">Observações Adicionais</h3>
                  <FormField
                    control={form.control}
                    name="notes"
                    render={({ field }) => (
                      <FormItem>
                        <FormLabel>Observações</FormLabel>
                        <FormControl>
                          <Textarea
                            placeholder="Conte-nos sobre mudanças em sua rotina, dificuldades, progressos ou qualquer outra informação relevante..."
                            className="min-h-[100px]"
                            value={field.value || ""}
                            onChange={field.onChange}
                          />
                        </FormControl>
                        <FormMessage />
                      </FormItem>
                    )}
                  />
                </div>

                <div className="flex gap-4">
                  <Button type="submit" className="flex-1" disabled={submitAnamneseMutation.isPending}>
                    {submitAnamneseMutation.isPending ? "Enviando..." : "Enviar Anamnese"}
                  </Button>
                  <Button type="button" variant="outline" asChild>
                    <Link href="/">Cancelar</Link>
                  </Button>
                </div>
              </form>
            </Form>
          </CardContent>
        </Card>
      </main>
    </div>
  );
}
===== ./client/src/utils/mobile.ts =====
export const MOBILE_BREAKPOINTS = {
  xs: 0,
  sm: 640,
  md: 768,
  lg: 1024,
  xl: 1280,
  '2xl': 1536,
} as const;

export const MOBILE_BREAKPOINT = MOBILE_BREAKPOINTS.md;

export function isMobileDevice(): boolean {
  if (typeof window === 'undefined') return false;
  return window.innerWidth < MOBILE_BREAKPOINT;
}

export function isTouchDevice(): boolean {
  if (typeof window === 'undefined') return false;
  return 'ontouchstart' in window || navigator.maxTouchPoints > 0;
}

export function getBreakpoint(): keyof typeof MOBILE_BREAKPOINTS {
  if (typeof window === 'undefined') return 'md';
  
  const width = window.innerWidth;
  
  if (width >= MOBILE_BREAKPOINTS['2xl']) return '2xl';
  if (width >= MOBILE_BREAKPOINTS.xl) return 'xl';
  if (width >= MOBILE_BREAKPOINTS.lg) return 'lg';
  if (width >= MOBILE_BREAKPOINTS.md) return 'md';
  if (width >= MOBILE_BREAKPOINTS.sm) return 'sm';
  return 'xs';
}

export function isBreakpoint(breakpoint: keyof typeof MOBILE_BREAKPOINTS): boolean {
  if (typeof window === 'undefined') return false;
  return window.innerWidth >= MOBILE_BREAKPOINTS[breakpoint];
}

export function isMobileBreakpoint(): boolean {
  return !isBreakpoint('md');
}

export function addTouchClass(): void {
  if (typeof document === 'undefined') return;
  
  if (isTouchDevice()) {
    document.documentElement.classList.add('touch');
  } else {
    document.documentElement.classList.add('no-touch');
  }
}

// Debounce function for resize events
export function debounce<T extends (...args: any[]) => any>(
  func: T,
  wait: number
): (...args: Parameters<T>) => void {
  let timeout: NodeJS.Timeout;
  return (...args: Parameters<T>) => {
    clearTimeout(timeout);
    timeout = setTimeout(() => func(...args), wait);
  };
}
===== ./drizzle.config.ts =====
import { defineConfig } from "drizzle-kit";

if (!process.env.DATABASE_URL) {
  throw new Error("DATABASE_URL, ensure the database is provisioned");
}

export default defineConfig({
  out: "./migrations",
  schema: "./shared/schema.ts",
  dialect: "postgresql",
  dbCredentials: {
    url: process.env.DATABASE_URL,
  },
});

===== ./postcss.config.js =====
export default {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}

===== ./scripts/check-schema.ts =====
#!/usr/bin/env node
/**
 * Database Schema Verification Script
 * 
 * This script checks if the invitations table has all required columns
 * and helps diagnose schema-related issues.
 */

import { db } from './server/db.js';
import { sql } from 'drizzle-orm';

async function checkInvitationsSchema() {
  try {
    console.log('🔍 Checking invitations table schema...\n');
    
    // Check if table exists
    const tableExists = await db.execute(sql`
      SELECT EXISTS (
        SELECT FROM information_schema.tables 
        WHERE table_name = 'invitations'
      );
    `);
    
    if (!tableExists[0].exists) {
      console.log('❌ Error: invitations table does not exist!');
      return;
    }
    
    // Get current columns
    const columns = await db.execute(sql`
      SELECT column_name, data_type, is_nullable, column_default
      FROM information_schema.columns
      WHERE table_name = 'invitations'
      ORDER BY ordinal_position;
    `);
    
    console.log('📋 Current columns in invitations table:');
    console.log('----------------------------------------');
    columns.forEach(col => {
      console.log(`${col.column_name} (${col.data_type}) - Nullable: ${col.is_nullable} - Default: ${col.column_default || 'none'}`);
    });
    
    // Check for required columns
    const requiredColumns = ['id', 'nutritionist_id', 'token', 'status', 'created_at'];
    const newColumns = ['expires_at', 'email', 'role', 'used'];
    const existingColumns = columns.map(col => col.column_name);
    
    console.log('\n🔍 Schema Analysis:');
    console.log('------------------');
    
    // Check basic columns
    const missingRequired = requiredColumns.filter(col => !existingColumns.includes(col));
    if (missingRequired.length > 0) {
      console.log(`❌ Missing required columns: ${missingRequired.join(', ')}`);
    } else {
      console.log('✅ All basic required columns present');
    }
    
    // Check new columns
    const missingNew = newColumns.filter(col => !existingColumns.includes(col));
    if (missingNew.length > 0) {
      console.log(`⚠️  Missing new schema columns: ${missingNew.join(', ')}`);
      console.log('   📝 Run the migration in migrations/0003_add_missing_invitation_columns.sql');
    } else {
      console.log('✅ All new schema columns present');
    }
    
    // Test invitation creation capability
    console.log('\n🧪 Testing schema compatibility...');
    try {
      // Try to get a sample invitation to test query capability
      const testQuery = await db.execute(sql`
        SELECT id, nutritionist_id, token, status, created_at
        FROM invitations 
        LIMIT 1;
      `);
      console.log('✅ Basic queries work');
      
      // Try to query new columns if they exist
      if (missingNew.length === 0) {
        const newSchemaTest = await db.execute(sql`
          SELECT expires_at, email, role, used
          FROM invitations 
          LIMIT 1;
        `);
        console.log('✅ New schema queries work');
      }
      
    } catch (error) {
      console.log(`❌ Query test failed: ${error.message}`);
    }
    
    console.log('\n📊 Summary:');
    console.log('-----------');
    if (missingNew.length === 0) {
      console.log('✅ Database schema is up to date');
      console.log('✅ Invitation creation should work normally');
    } else {
      console.log('⚠️  Database needs migration');
      console.log('📝 Apply migrations/0003_add_missing_invitation_columns.sql');
      console.log('🔄 Application will use legacy mode until migration is applied');
    }
    
  } catch (error) {
    console.error('❌ Error checking schema:', error);
  }
}

// Run the check
checkInvitationsSchema()
  .then(() => {
    console.log('\n✨ Schema check complete');
    process.exit(0);
  })
  .catch(error => {
    console.error('💥 Fatal error:', error);
    process.exit(1);
  });
===== ./scripts/create-admin.ts =====
import "dotenv/config";
import bcrypt from "bcrypt";
import { storage } from "../server/storage.js";

const SALT_ROUNDS = 10;

async function createFirstAdmin() {
  // Verificar se a DATABASE_URL está configurada
  if (!process.env.DATABASE_URL) {
    console.error("❌ DATABASE_URL não está configurada no arquivo .env");
    console.log("📝 Verifique se o arquivo .env existe na raiz do projeto");
    console.log("Current working directory:", process.cwd());
    process.exit(1);
  }

  console.log("🔌 DATABASE_URL encontrada:", process.env.DATABASE_URL?.substring(0, 50) + "...");

  const email = process.env.ADMIN_EMAIL || "admin@dinutri.com";
  const password = process.env.ADMIN_PASSWORD || "admin123456";
  const firstName = process.env.ADMIN_FIRST_NAME || "Administrador";
  const lastName = process.env.ADMIN_LAST_NAME || "Sistema";

  try {
    console.log("🔌 Conectando ao banco de dados...");
    
    // Verifica se já existe um admin
    const existingUser = await storage.getUserByEmail(email);
    if (existingUser) {
      console.log("⚠️  Usuário administrador já existe:", email);
      console.log("👤 Role:", existingUser.role);
      return;
    }

    console.log("🔐 Criando hash da senha...");
    // Cria o hash da senha
    const hashedPassword = await bcrypt.hash(password, SALT_ROUNDS);

    console.log("👤 Criando usuário administrador...");
    // Cria o usuário administrador
    const admin = await storage.upsertUser({
      email,
      firstName,
      lastName,
      hashedPassword,
      role: "admin",
    });

    console.log("\n✅ Usuário administrador criado com sucesso!");
    console.log("📧 Email:", email);
    console.log("🔑 Senha:", password);
    console.log("👤 Nome:", `${firstName} ${lastName}`);
    console.log("🔐 Role:", admin.role);
    console.log("\n⚠️  IMPORTANTE: Altere a senha após o primeiro login!");

  } catch (error) {
    console.error("❌ Erro ao criar usuário administrador:", error);
    process.exit(1);
  }
}

createFirstAdmin();
===== ./scripts/generate-sw-version.js =====
import fs from 'fs';
import path from 'path';

// Generate a version based on current timestamp
const timestamp = Date.now();
const version = timestamp.toString();
const buildDate = new Date(timestamp).toISOString();
const swTemplatePath = path.resolve(process.cwd(), 'client/public/sw.js');
const swDistPath = path.resolve(process.cwd(), 'dist/public/sw.js');

// Read the service worker template
let swContent = fs.readFileSync(swTemplatePath, 'utf8');

// Replace the static cache version with the dynamic one
swContent = swContent.replace(
  /const CACHE_NAME = 'dinutri-v1';/,
  `const CACHE_NAME = 'dinutri-v${version}';`
);

// Add build timestamp comment at the top
swContent = `// Service Worker generated at: ${buildDate}\n// Cache version: dinutri-v${version}\n${swContent}`;

// Ensure the dist/public directory exists
const distDir = path.dirname(swDistPath);
if (!fs.existsSync(distDir)) {
  fs.mkdirSync(distDir, { recursive: true });
}

// Write the updated service worker to the dist directory
fs.writeFileSync(swDistPath, swContent, 'utf8');

console.log(`Service Worker updated with cache version: dinutri-v${version} (${buildDate})`);
===== ./server/auth.ts =====
// Arquivo: server/auth.ts

import passport from "passport";
import { Strategy as LocalStrategy } from "passport-local";
import bcrypt from "bcrypt";
import session from "express-session";
import type { Express, RequestHandler } from "express";
import connectPg from "connect-pg-simple";
import { storage } from "./storage.js";
import type { User } from "../shared/schema.js";

// Função para configurar a sessão (sem alterações)
export function getSession() {
  const sessionTtl = 7 * 24 * 60 * 60 * 1000; // 1 week
  const pgStore = connectPg(session);
  const sessionStore = new pgStore({
    conString: process.env.DATABASE_URL,
    createTableIfMissing: false,
    ttl: sessionTtl,
    tableName: "sessions",
  });
  return session({
    secret: process.env.SESSION_SECRET!,
    store: sessionStore,
    resave: false,
    saveUninitialized: false,
    cookie: {
      httpOnly: true,
      secure: process.env.NODE_ENV === 'production',
      maxAge: sessionTtl,
    },
  });
}

// Middleware que verifica se o usuário está logado (sem alterações)
export const isAuthenticated: RequestHandler = (req, res, next) => {
  if (req.isAuthenticated()) {
    return next();
  }
  res.status(401).json({ message: "Unauthorized" });
};

// Função principal que configura a nova autenticação local
export async function setupAuth(app: Express) {
  // Configuração da estratégia de autenticação local (email/senha)
  const strategy = new LocalStrategy(
    { usernameField: 'email' }, // O campo de "usuário" é o email
    async (email, password, done) => {
      try {
        const user = await storage.getUserByEmail(email);

        // Se o usuário não existe ou não tem senha cadastrada
        if (!user || !user.hashedPassword) {
          return done(null, false, { message: 'Credenciais inválidas.' });
        }

        // Compara a senha fornecida com a senha criptografada no banco
        const isMatch = await bcrypt.compare(password, user.hashedPassword);

        if (!isMatch) {
          return done(null, false, { message: 'Credenciais inválidas.' });
        }

        // Se tudo estiver correto, retorna o usuário
        return done(null, user);
      } catch (error) {
        return done(error);
      }
    }
  );

  // Usa a estratégia no Passport
  passport.use(strategy);

  // Ensina o Passport a salvar o usuário na sessão (apenas o ID)
  passport.serializeUser((user, done) => {
    done(null, (user as User).id);
  });

  // Ensina o Passport a recuperar o usuário da sessão a partir do ID
  passport.deserializeUser(async (id: string, done) => {
    try {
      const user = await storage.getUser(id);
      done(null, user);
    } catch (err) {
      done(err, null);
    }
  });

  // Configura os middlewares de sessão e do Passport no Express
  app.set("trust proxy", 1);
  app.use(getSession());
  app.use(passport.initialize());
  app.use(passport.session());
}
===== ./server/db.ts =====
// ARQUIVO: ./server/db.ts
import { Pool, neonConfig } from '@neondatabase/serverless';
import { drizzle } from 'drizzle-orm/neon-serverless';
import ws from 'ws';
import * as schema from '../shared/schema.js';

neonConfig.webSocketConstructor = ws;

if (!process.env.DATABASE_URL) {
  throw new Error(
    'DATABASE_URL must be set. Did you forget to provision a database?',
  );
}

export const pool = new Pool({ connectionString: process.env.DATABASE_URL });
export const db = drizzle({ client: pool, schema });

===== ./server/index.ts =====
import "dotenv/config";
import express, { type Request, Response, NextFunction, type Express } from "express";
import { registerRoutes } from "./routes.js";
import path from "path";
import fs from "fs";

// --- Funções movidas de vite.ts para cá ---
export function log(message: string, source = "express") {
  const formattedTime = new Date().toLocaleTimeString("en-US", {
    hour: "numeric",
    minute: "2-digit",
    second: "2-digit",
    hour12: true,
  });
  console.log(`${formattedTime} [${source}] ${message}`);
}

export function serveStatic(app: Express) {
  // @ts-ignore
  const distPath = path.resolve(import.meta.dirname, "..", "dist", "public");

  if (!fs.existsSync(distPath)) {
    log(`A pasta de build não foi encontrada em: ${distPath}. Servindo placeholder.`);
    app.use("*", (_req, res) => {
      res.status(404).send("Build folder not found. Run 'npm run build'.");
    });
    return;
  }

  app.use(express.static(distPath));
  app.use("*", (_req, res) => {
    res.sendFile(path.resolve(distPath, "index.html"));
  });
}
// --- Fim das funções movidas ---


const app = express();
app.use(express.json());
app.use(express.urlencoded({ extended: false }));

app.use((req, res, next) => {
  const start = Date.now();
  const path = req.path;
  res.on("finish", () => {
    const duration = Date.now() - start;
    if (path.startsWith("/api")) {
      log(`${req.method} ${path} ${res.statusCode} in ${duration}ms`);
    }
  });
  next();
});

// A função serverless do Vercel espera uma exportação padrão (default export) que seja uma função ou um servidor.
// Removemos o app.listen() e exportamos o app diretamente.
export default async function handler(req: Request, res: Response) {
  // Registra as rotas no aplicativo Express
  await registerRoutes(app);

  // Middleware de tratamento de erros
  app.use((err: any, _req: Request, res: Response, _next: NextFunction) => {
    const status = err.status || err.statusCode || 500;
    const message = err.message || "Internal Server Error";
    res.status(status).json({ message });
  });

  // Em produção, serve os arquivos estáticos do build
  if (process.env.NODE_ENV !== 'development') {
    serveStatic(app);
  }

  // Retorna o aplicativo Express para ser usado como uma função serverless
  app(req, res);
}

// Em ambiente de desenvolvimento, iniciamos o servidor normalmente
if (process.env.NODE_ENV === 'development') {
  (async () => {
    const server = await registerRoutes(app);

    app.use((err: any, _req: Request, res: Response, _next: NextFunction) => {
      const status = err.status || err.statusCode || 500;
      const message = err.message || "Internal Server Error";
      res.status(status).json({ message });
    });

    const { setupVite } = await import("./vite.js");
    await setupVite(app, server);

    const port = parseInt(process.env.PORT || '5000', 10);
    server.listen({
      port,
      host: "0.0.0.0",
      reusePort: true,
    }, () => {
      log(`serving on port ${port}`);
    });
  })();
}


===== ./server/routes.ts =====
import type { Express } from "express";
import { createServer, type Server } from "http";
import passport from "passport";
import bcrypt from "bcrypt";
import bodyParser from "body-parser";
import { storage } from "./storage.js";
import { setupAuth, isAuthenticated } from "./auth.js";
import { insertPatientSchema, updatePatientSchema, insertPrescriptionSchema, updatePrescriptionSchema, insertMoodEntrySchema, insertAnamnesisRecordSchema, insertFoodDiaryEntrySchema } from "../shared/schema.js";
import { z } from "zod";
import { handleUpload, type HandleUploadBody } from '@vercel/blob/client';

const SALT_ROUNDS = 10;

// Middleware to check if the user is an admin
const isAdmin = (req: any, res: any, next: any) => {
  if (req.user.role !== 'admin') {
    return res.status(403).json({ message: "Acesso negado. Apenas administradores." });
  }
  next();
};

export async function registerRoutes(app: Express): Promise<Server> {
  await setupAuth(app);
  
  // Middleware para parsear o corpo da requisição de upload
  app.use(bodyParser.json());

  // --- AUTHENTICATION ROUTES ---
  app.post('/api/login', passport.authenticate('local'), (req, res) => {
    res.json(req.user);
  });

  app.get("/api/logout", (req, res, next) => {
    req.logout((err) => {
      if (err) { return next(err); }
      req.session.destroy(() => {
        res.clearCookie('connect.sid');
        // Redireciona para a página inicial após o logout
        res.redirect('/');
      });
    });
  });

  app.get("/api/auth/user", (req, res) => {
    if (req.isAuthenticated()) {
      res.json(req.user);
    } else {
      res.status(401).json({ message: "Não autorizado" });
    }
  });
  
  app.put('/api/auth/change-password', isAuthenticated, async (req: any, res) => {
    try {
        const { currentPassword, newPassword } = req.body;
        const user = await storage.getUser(req.user.id);

        if (!user || !user.hashedPassword) {
            return res.status(401).json({ message: "Usuário não encontrado ou sem senha." });
        }

        const isMatch = await bcrypt.compare(currentPassword, user.hashedPassword);
        if (!isMatch) {
            return res.status(401).json({ message: "Senha atual incorreta." });
        }
        
        const newHashedPassword = await bcrypt.hash(newPassword, SALT_ROUNDS);
        await storage.updateUserPassword(req.user.id, newHashedPassword);

        res.status(200).json({ message: "Senha alterada com sucesso." });
    } catch (error) {
        console.error("Erro ao alterar senha:", error);
        res.status(500).json({ message: "Falha ao alterar a senha." });
    }
  });

  app.put('/api/auth/profile', isAuthenticated, async (req: any, res) => {
      try {
          const updatedUser = await storage.updateUserProfile(req.user.id, req.body);
          res.json(updatedUser);
      } catch (error: any) {
          console.error("Erro ao atualizar perfil:", error);
          if (error.message?.includes('unique constraint')) {
              return res.status(409).json({ message: "Este email já está em uso." });
          }
          res.status(500).json({ message: "Falha ao atualizar o perfil." });
      }
  });

  // --- USER ROUTES ---
  app.get('/api/users/:id', isAuthenticated, async (req: any, res) => {
    try {
        if (req.user.role !== 'admin' && req.user.id !== req.params.id) {
            return res.status(403).json({ message: "Acesso negado." });
        }
        const user = await storage.getUser(req.params.id);
        if (user) {
            res.json(user);
        } else {
            res.status(404).json({ message: "Usuário não encontrado." });
        }
    } catch (error) {
        console.error("Erro ao buscar usuário:", error);
        res.status(500).json({ message: "Falha ao buscar usuário." });
    }
  });

  // --- ADMIN ROUTES ---
  app.get('/api/admin/users', isAuthenticated, isAdmin, async (req, res) => {
    try {
        const users = await storage.getAllUsers();
        res.json(users);
    } catch (error) {
        console.error("Erro ao buscar usuários:", error);
        res.status(500).json({ message: "Falha ao buscar usuários." });
    }
  });

  app.get('/api/admin/users/:id/dependencies', isAuthenticated, isAdmin, async (req, res) => {
    try {
      const { id } = req.params;
      const hasPatients = await storage.userHasPatients(id);
      const hasPrescriptions = await storage.userHasPrescriptions(id);
      const hasInvitations = await storage.userHasInvitations(id);
      
      const canDelete = !hasPatients && !hasPrescriptions;

      res.json({ hasPatients, hasPrescriptions, hasInvitations, canDelete });
    } catch (error) {
      console.error("Erro ao verificar dependências do usuário:", error);
      res.status(500).json({ message: "Falha ao verificar dependências." });
    }
  });

  app.post('/api/admin/users', isAuthenticated, isAdmin, async (req, res) => {
    try {
        const { email, password, firstName, lastName, role } = req.body;

        const existingUser = await storage.getUserByEmail(email);
        if (existingUser) {
            return res.status(409).json({ message: "Email já cadastrado." });
        }

        const hashedPassword = await bcrypt.hash(password, SALT_ROUNDS);
        const newUser = await storage.upsertUser({ email, hashedPassword, firstName, lastName, role });
        res.status(201).json(newUser);
    } catch (error) {
        console.error("Erro ao criar usuário:", error);
        res.status(500).json({ message: "Falha ao criar usuário." });
    }
  });

  app.put('/api/admin/users/:id', isAuthenticated, isAdmin, async (req, res) => {
      try {
        const updatedUser = await storage.updateUserProfile(req.params.id, req.body);
        res.json(updatedUser);
      } catch (error: any) {
        console.error("Erro ao atualizar usuário:", error);
        if (error.message?.includes('unique constraint')) {
            return res.status(409).json({ message: "Este email já está em uso." });
        }
        res.status(500).json({ message: "Falha ao atualizar usuário." });
      }
  });

  app.put('/api/admin/users/:id/password', isAuthenticated, isAdmin, async (req, res) => {
      try {
          const { newPassword } = req.body;
          if (!newPassword || newPassword.length < 6) {
              return res.status(400).json({ message: "A nova senha deve ter pelo menos 6 caracteres." });
          }
          const hashedPassword = await bcrypt.hash(newPassword, SALT_ROUNDS);
          await storage.updateUserPassword(req.params.id, hashedPassword);
          res.status(200).json({ message: "Senha atualizada com sucesso." });
      } catch (error) {
          console.error("Erro ao alterar senha:", error);
          res.status(500).json({ message: "Falha ao alterar senha." });
      }
  });
  
  app.delete('/api/admin/users/:id', isAuthenticated, isAdmin, async (req, res) => {
    try {
      await storage.deleteUser(req.params.id);
      res.status(204).send();
    } catch (error: any) {
      console.error("Erro ao deletar usuário:", error);
      if (error.message.includes("possui")) {
          return res.status(409).json({ message: error.message });
      }
      res.status(500).json({ message: "Falha ao deletar usuário." });
    }
  });
  

  // --- PATIENT ROUTES ---
  app.post("/api/patient/register", async (req, res, next) => {
    try {
      const newUser = await storage.createPatientFromInvitation(req.body);
      
      req.login(newUser, (err) => {
        if (err) {
          return next(err);
        }
        res.status(201).json(newUser);
      });
    } catch (error: any) {
      if (error instanceof z.ZodError) {
        return res.status(400).json({ message: "Dados inválidos.", errors: error.flatten() });
      }
      if (error.message?.includes("409")) {
        return res.status(409).json({ message: "Este email já está cadastrado." });
      }
      console.error("Erro ao registrar paciente:", error);
      res.status(400).json({ message: error.message || "Falha ao registrar paciente." });
    }
  });
  
  app.post('/api/patients', isAuthenticated, async (req: any, res) => {
    try {
      const patientData = insertPatientSchema.parse({
        ...req.body,
        ownerId: req.user.id,
      });

      const existingUser = await storage.getUserByEmail(patientData.email!);
      if(existingUser) {
        return res.status(409).json({ message: "Já existe um usuário com este email." });
      }
      
      const hashedPassword = await bcrypt.hash(req.body.password, SALT_ROUNDS);
      const newUser = await storage.upsertUser({
        email: patientData.email!,
        firstName: patientData.name.split(' ')[0],
        lastName: patientData.name.split(' ').slice(1).join(' '),
        hashedPassword,
        role: 'patient',
      });

      const newPatient = await storage.createPatient({ ...patientData, userId: newUser.id });

      res.status(201).json(newPatient);
    } catch (error) {
      if (error instanceof z.ZodError) {
        return res.status(400).json({ message: "Dados do paciente inválidos.", errors: error.flatten() });
      }
      console.error("Erro ao criar paciente:", error);
      res.status(500).json({ message: "Falha ao criar paciente." });
    }
  });

  app.get('/api/patients', isAuthenticated, async (req: any, res) => {
    try {
      const patients = await storage.getPatientsByOwner(req.user.id);
      res.json(patients);
    } catch (error) {
      console.error("Erro ao buscar pacientes:", error);
      res.status(500).json({ message: "Falha ao buscar pacientes." });
    }
  });

  app.get('/api/patients/:id', isAuthenticated, async (req: any, res) => {
    try {
      const patient = await storage.getPatient(req.params.id);
      if (patient && (req.user.role === 'admin' || patient.ownerId === req.user.id)) {
        res.json(patient);
      } else {
        res.status(404).json({ message: "Paciente não encontrado ou acesso não autorizado." });
      }
    } catch (error) {
      console.error("Erro ao buscar detalhes do paciente:", error);
      res.status(500).json({ message: "Falha ao buscar detalhes do paciente." });
    }
  });

  app.put('/api/patients/:id', isAuthenticated, async (req: any, res) => {
    try {
      // Valida os dados recebidos usando o novo schema
      const patientData = updatePatientSchema.parse(req.body);

      const patient = await storage.getPatient(req.params.id);
      
      // Garante que o nutricionista só possa editar seus próprios pacientes
      if (!patient || patient.ownerId !== req.user.id) {
        return res.status(404).json({ message: "Paciente não encontrado ou acesso não autorizado." });
      }

      const updatedPatient = await storage.updatePatient(req.params.id, patientData);
      res.json(updatedPatient);
    } catch (error) {
      if (error instanceof z.ZodError) {
        return res.status(400).json({ message: "Dados do paciente inválidos.", errors: error.flatten() });
      }
      console.error("Erro ao atualizar paciente:", error);
      res.status(500).json({ message: "Falha ao atualizar paciente." });
    }
  });
  
  app.get('/api/patient/my-profile', isAuthenticated, async (req: any, res) => {
    try {
      const patientProfile = await storage.getPatientByUserId(req.user.id);
      if (patientProfile) {
        res.json(patientProfile);
      } else {
        res.status(404).json({ message: 'Perfil de paciente não encontrado.' });
      }
    } catch (error) {
      console.error("Erro ao buscar perfil do paciente:", error);
      res.status(500).json({ message: 'Falha ao buscar perfil do paciente.' });
    }
  });

  app.post('/api/patients/:id/request-follow-up', isAuthenticated, async (req: any, res) => {
    try {
      // Futuramente, podemos gerar um token único aqui. Por simplicidade,
      // por enquanto vamos apenas gerar uma URL simples.
      const patientId = req.params.id;
      const patient = await storage.getPatient(patientId);

      if (!patient || patient.ownerId !== req.user.id) {
        return res.status(404).json({ message: "Paciente não encontrado." });
      }

      // Este link não é seguro por token, mas serve para o fluxo inicial.
      // Uma implementação robusta usaria um token de uso único.
      const followUpUrl = `${req.protocol}://${req.get('host')}/anamnese/retorno?patientId=${patientId}`;
      
      res.json({ followUpUrl });
    } catch (error) {
      console.error("Erro ao solicitar anamnese de retorno:", error);
      res.status(500).json({ message: "Falha ao gerar link." });
    }
  });

  app.post('/api/patients/:id/anamnesis-records', isAuthenticated, async (req: any, res) => {
    try {
        const patientId = req.params.id;
        // Apenas o próprio paciente (no futuro) ou o nutricionista dono podem adicionar um registro.
        const patient = await storage.getPatient(patientId);
        if (!patient || (req.user.role === 'nutritionist' && patient.ownerId !== req.user.id)) {
            return res.status(403).json({ message: "Acesso negado." });
        }

        const recordData = insertAnamnesisRecordSchema.parse({
            ...req.body,
            patientId: patientId,
        });
        const newRecord = await storage.createAnamnesisRecord(recordData);
        // Atualiza o peso mais recente na tabela principal do paciente para fácil acesso
        if (recordData.weightKg) {
            await storage.updatePatient(patientId, { weightKg: recordData.weightKg });
        }
        res.status(201).json(newRecord);
    } catch (error) {
        if (error instanceof z.ZodError) {
            return res.status(400).json({ message: "Dados inválidos.", errors: error.flatten() });
        }
        console.error("Erro ao salvar anamnese de retorno:", error);
        res.status(500).json({ message: "Falha ao salvar anamnese de retorno." });
    }
  });

  app.get('/api/patients/:id/anamnesis-records', isAuthenticated, async (req: any, res) => {
    try {
        const patientId = req.params.id;
        const patient = await storage.getPatient(patientId);
        if (!patient || patient.ownerId !== req.user.id) {
            return res.status(404).json({ message: "Paciente não encontrado." });
        }
        const records = await storage.getAnamnesisRecords(patientId);
        res.json(records);
    } catch (error) {
        console.error("Erro ao buscar histórico:", error);
        res.status(500).json({ message: "Falha ao buscar histórico de anamnese." });
    }
  });

  // --- PRESCRIPTION ROUTES ---
  app.post('/api/prescriptions', isAuthenticated, async (req: any, res) => {
    try {
      const prescriptionData = insertPrescriptionSchema.parse({
        ...req.body,
        nutritionistId: req.user.id,
      });
      const newPrescription = await storage.createPrescription(prescriptionData);
      res.status(201).json(newPrescription);
    } catch (error) {
      if (error instanceof z.ZodError) {
        return res.status(400).json({ message: "Dados da prescrição inválidos.", errors: error.flatten() });
      }
      console.error("Erro ao criar prescrição:", error);
      res.status(500).json({ message: "Falha ao criar prescrição." });
    }
  });

  app.get('/api/patients/:patientId/prescriptions', isAuthenticated, async (req, res) => {
    try {
      const prescriptions = await storage.getPrescriptionsByPatient(req.params.patientId);
      res.json(prescriptions);
    } catch (error) {
      console.error("Erro ao buscar prescrições:", error);
      res.status(500).json({ message: "Falha ao buscar prescrições." });
    }
  });
  
  app.get('/api/prescriptions/:id', isAuthenticated, async (req, res) => {
    try {
      const prescription = await storage.getPrescription(req.params.id);
      res.json(prescription);
    } catch (error) {
      console.error("Erro ao buscar prescrição:", error);
      res.status(500).json({ message: "Falha ao buscar prescrição." });
    }
  });

  app.put('/api/prescriptions/:id', isAuthenticated, async (req: any, res) => {
    try {
      const prescriptionData = updatePrescriptionSchema.parse(req.body);
      const updatedPrescription = await storage.updatePrescription(req.params.id, prescriptionData);
      res.json(updatedPrescription);
    } catch (error) {
      if (error instanceof z.ZodError) {
        return res.status(400).json({ message: "Dados da prescrição inválidos.", errors: error.flatten() });
      }
      console.error("Erro ao atualizar prescrição:", error);
      res.status(500).json({ message: "Falha ao atualizar prescrição." });
    }
  });
  
  app.post('/api/prescriptions/:id/publish', isAuthenticated, async (req, res) => {
    try {
      const prescription = await storage.publishPrescription(req.params.id);
      res.json(prescription);
    } catch (error) {
      console.error("Error publishing prescription:", error);
      res.status(500).json({ message: "Failed to publish prescription" });
    }
  });

  app.post('/api/prescriptions/:id/duplicate', isAuthenticated, async (req, res) => {
    try {
      const { title } = req.body;
      const prescription = await storage.duplicatePrescription(req.params.id, title);
      res.json(prescription);
    } catch (error) {
      console.error("Error duplicating prescription:", error);
      res.status(500).json({ message: "Failed to duplicate prescription" });
    }
  });

  app.delete('/api/prescriptions/:id', isAuthenticated, async (req, res) => {
    try {
      await storage.deletePrescription(req.params.id);
      res.status(204).send();
    } catch (error: any) {
      if (error.message.includes("403")) {
        return res.status(403).json({ message: error.message });
      }
      res.status(500).json({ message: "Failed to delete prescription" });
    }
  });

  app.get('/api/patient/my-prescriptions', isAuthenticated, async (req: any, res) => {
    try {
      const prescriptions = await storage.getPublishedPrescriptionsForUser(req.user.id);
      res.json(prescriptions);
    } catch (error) {
      console.error("Error fetching patient prescriptions:", error);
      res.status(500).json({ message: "Failed to fetch prescriptions" });
    }
  });

  // --- INVITATION ROUTES ---
  app.post('/api/invitations', isAuthenticated, async (req: any, res) => {
    try {
      const invitation = await storage.createInvitation(req.user.id);
      res.json(invitation);
    } catch (error) {
      console.error("Erro ao criar convite:", error);
      res.status(500).json({ message: "Falha ao criar convite." });
    }
  });
  
  app.get('/api/invitations/validate', async (req, res) => {
    const { token } = req.query;
    if (typeof token !== 'string') {
      return res.status(400).json({ message: 'Token inválido.' });
    }
    const invitation = await storage.getInvitationByToken(token);
    if (invitation && invitation.status === 'pending') {
      res.status(200).json({ valid: true });
    } else {
      res.status(404).json({ message: 'Convite inválido ou expirado.' });
    }
  });

  // --- MOOD ROUTES ---
  app.post('/api/mood-entries', isAuthenticated, async (req: any, res) => {
    try {
      const patientProfile = await storage.getPatientByUserId(req.user.id);
      if (!patientProfile) {
        return res.status(403).json({ message: "Perfil de paciente não encontrado." });
      }
      const moodData = insertMoodEntrySchema.parse({
        ...req.body,
        patientId: patientProfile.id,
      });
      const newMoodEntry = await storage.createMoodEntry(moodData);
      res.status(201).json(newMoodEntry);
    } catch (error) {
      if (error instanceof z.ZodError) {
        return res.status(400).json({ message: "Dados de humor inválidos.", errors: error.flatten() });
      }
      console.error("Erro ao criar registro de humor:", error);
      res.status(500).json({ message: "Falha ao criar registro de humor." });
    }
  });

  app.put('/api/mood-entries/:id', isAuthenticated, async (req, res) => {
    try {
      const updateData = insertMoodEntrySchema.partial().parse(req.body);
      const moodEntry = await storage.updateMoodEntry(req.params.id, updateData);
      res.json(moodEntry);
    } catch (error) {
      if (error instanceof z.ZodError) {
        return res.status(400).json({ message: "Invalid mood entry data.", errors: error.flatten() });
      }
      console.error("Error updating mood entry:", error);
      res.status(500).json({ message: "Failed to update mood entry" });
    }
  });

  app.get('/api/mood-entries/:prescriptionId/:mealId/:date', isAuthenticated, async (req, res) => {
    try {
      const { prescriptionId, mealId, date } = req.params;
      const moodEntry = await storage.getMoodEntry(prescriptionId, mealId, date);
      if (moodEntry) {
        res.json(moodEntry);
      } else {
        res.status(404).json({ message: 'Nenhum registro de humor encontrado para esta data.' });
      }
    } catch(error) {
      console.error("Error fetching mood entry:", error);
      res.status(500).json({ message: "Failed to fetch mood entry" });
    }
  });

  app.get('/api/patients/:patientId/mood-entries', isAuthenticated, async (req: any, res) => {
    try {
      const { patientId } = req.params;
      const { startDate, endDate } = req.query;
      
      const moodEntries = await storage.getMoodEntriesByPatient(
        patientId,
        startDate as string,
        endDate as string
      );
      
      res.json(moodEntries);
    } catch (error) {
      console.error("Error fetching mood entries for patient:", error);
      res.status(500).json({ message: "Failed to fetch mood entries" });
    }
  });

  app.get('/api/prescriptions/:prescriptionId/mood-entries', isAuthenticated, async (req: any, res) => {
    try {
      const { prescriptionId } = req.params;
      const moodEntries = await storage.getMoodEntriesByPrescription(prescriptionId);
      res.json(moodEntries);
    } catch (error) {
      console.error("Error fetching mood entries for prescription:", error);
      res.status(500).json({ message: "Failed to fetch mood entries" });
    }
  });

  // --- FOOD DIARY ROUTES ---
  app.post('/api/food-diary/upload', isAuthenticated, async (req: any, res) => {
    try {
        const body = req.body as HandleUploadBody;
    
        const jsonResponse = await handleUpload({
          body,
          request: req,
          onBeforeGenerateToken: async (pathname: string) => {
            const blobPath = `food-diary/${req.user.id}/${pathname}`;
            return {
              allowedContentTypes: ['image/jpeg', 'image/png', 'image/gif', 'image/webp'],
              pathname: blobPath,
              tokenPayload: JSON.stringify({
                userId: req.user.id,
              }),
            };
          },
          onUploadCompleted: async ({ blob, tokenPayload }) => {
            console.log('blob upload completed', blob, tokenPayload);
          },
        });
    
        return res.status(200).json(jsonResponse);
      } catch (error) {
        console.error("Error in upload handler:", error);
        return res.status(400).json({ error: (error as Error).message });
      }
  });

  app.post('/api/food-diary/entries', isAuthenticated, async (req: any, res) => {
    try {
      const patientProfile = await storage.getPatientByUserId(req.user.id);
      if (!patientProfile) {
        return res.status(403).json({ message: "Perfil de paciente não encontrado." });
      }
      
      const entryData = insertFoodDiaryEntrySchema.parse({
        ...req.body,
        patientId: patientProfile.id,
      });

      const newEntry = await storage.createFoodDiaryEntry(entryData);
      res.status(201).json(newEntry);
    } catch (error) {
      if (error instanceof z.ZodError) {
        return res.status(400).json({ 
          message: "Dados inválidos", 
          errors: error.errors 
        });
      }
      console.error("Error creating food diary entry:", error);
      res.status(500).json({ message: "Falha ao criar entrada no diário alimentar." });
    }
  });

  app.get('/api/patients/:patientId/food-diary/entries', isAuthenticated, async (req: any, res) => {
    try {
      const { patientId } = req.params;
      
      // Verify that the nutritionist owns this patient
      const patient = await storage.getPatient(patientId);
      if (!patient || patient.ownerId !== req.user.id) {
        return res.status(404).json({ message: "Paciente não encontrado ou acesso não autorizado." });
      }

      const entries = await storage.getFoodDiaryEntriesByPatient(patientId);
      res.json(entries);
    } catch (error) {
      console.error("Error fetching food diary entries:", error);
      res.status(500).json({ message: "Falha ao buscar entradas do diário alimentar." });
    }
  });

  return createServer(app);
}
===== ./server/storage.ts =====
import {
  users,
  patients,
  prescriptions,
  invitations,
  moodEntries,
  anamnesisRecords,
  foodDiaryEntries,
  type User,
  type UpsertUser,
  type Patient,
  type InsertPatient,
  type Prescription,
  type InsertPrescription,
  type UpdatePrescription,
  type MoodEntry,
  type InsertMoodEntry,
  type AnamnesisRecord,
  type FoodDiaryEntry,
  type FoodDiaryEntryWithPrescription,
  type InsertFoodDiaryEntry,
  insertAnamnesisRecordSchema,
  insertFoodDiaryEntrySchema,
} from "../shared/schema.js";
import { db } from "./db.js";
import { eq, desc, and, gte, lte, sql, SQL } from "drizzle-orm";
import { randomBytes } from "crypto";
import { nanoid } from "nanoid";
import bcrypt from "bcrypt";

const SALT_ROUNDS = 10;

export interface IStorage {
  // User operations
  getUser(id: string): Promise<User | undefined>;
  getUserByEmail(email: string): Promise<User | undefined>;
  getAllUsers(): Promise<User[]>;
  upsertUser(user: Partial<UpsertUser>): Promise<User>;
  updateUserPassword(id: string, hashedPassword: string): Promise<void>;
  updateUserProfile(id: string, profileData: { firstName: string; lastName: string; email: string; role?: string }): Promise<User>;
  deleteUser(id: string): Promise<void>;
  userHasPatients(userId: string): Promise<boolean>;
  userHasPrescriptions(userId: string): Promise<boolean>;
  userHasInvitations(userId: string): Promise<boolean>;
  deleteUserInvitations(userId: string): Promise<void>;
  transferPatients(fromUserId: string, toUserId: string): Promise<void>;
  
  // Patient operations
  getPatientsByOwner(ownerId: string): Promise<Patient[]>;
  getPatient(id: string): Promise<Patient | undefined>;
  getPatientByUserId(userId: string): Promise<Patient | undefined>;
  createPatient(patient: InsertPatient): Promise<Patient>;
  createPatientFromInvitation(data: any): Promise<User>;
  updatePatient(id: string, patient: Partial<InsertPatient>): Promise<Patient>;
  
  // Invitation operations
  createInvitation(nutritionistId: string): Promise<{ token: string }>;
  getInvitationByToken(token: string): Promise<{ nutritionistId: string, status: string } | undefined>;
  updateInvitationStatus(token: string, status: 'accepted'): Promise<void>;

  // Prescription operations
  getPrescriptionsByPatient(patientId: string): Promise<Prescription[]>;
  getPrescription(id: string): Promise<Prescription | undefined>;
  getLatestPublishedPrescription(patientId: string): Promise<Prescription | undefined>;
  getLatestPublishedPrescriptionForUser(userId: string): Promise<Prescription | undefined>;
  getPublishedPrescriptionsForUser(userId: string): Promise<Prescription[]>;
  createPrescription(prescription: InsertPrescription): Promise<Prescription>;
  updatePrescription(id: string, prescription: UpdatePrescription): Promise<Prescription>;
  publishPrescription(id: string): Promise<Prescription>;
  duplicatePrescription(id: string, title: string): Promise<Prescription>;
  deletePrescription(id: string): Promise<void>;

  // Mood operations (NEW)
  getMoodEntry(prescriptionId: string, mealId: string, date: string): Promise<MoodEntry | undefined>;
  createMoodEntry(moodEntry: InsertMoodEntry): Promise<MoodEntry>;
  updateMoodEntry(id: string, moodEntry: Partial<InsertMoodEntry>): Promise<MoodEntry>;
  getMoodEntriesByPatient(patientId: string, startDate?: string, endDate?: string): Promise<MoodEntry[]>;
  getMoodEntriesByPrescription(prescriptionId: string): Promise<MoodEntry[]>;

  // Anamnesis Record operations
  createAnamnesisRecord(record: any): Promise<AnamnesisRecord>;
  getAnamnesisRecords(patientId: string): Promise<AnamnesisRecord[]>;

  // Food Diary operations
  createFoodDiaryEntry(entry: InsertFoodDiaryEntry): Promise<FoodDiaryEntry>;
  getFoodDiaryEntriesByPatient(patientId: string): Promise<FoodDiaryEntryWithPrescription[]>;
}

export class DatabaseStorage implements IStorage {
  // Helper function to normalize patient data
  private normalizePatientData(patient: Partial<Patient>): Patient {
    return {
      ...patient,
      id: patient.id!,
      ownerId: patient.ownerId!,
      userId: patient.userId ?? null,
      name: patient.name!,
      email: patient.email ?? null,
      birthDate: patient.birthDate ?? null,
      sex: patient.sex ?? null,
      heightCm: patient.heightCm ?? null,
      weightKg: patient.weightKg ?? null,
      notes: patient.notes ?? null,
      goal: patient.goal ?? null,
      activityLevel: patient.activityLevel ?? null,
      likedHealthyFoods: patient.likedHealthyFoods || [],
      dislikedFoods: patient.dislikedFoods || [],
      hasIntolerance: patient.hasIntolerance ?? null,
      intolerances: patient.intolerances || [],
      canEatMorningSolids: patient.canEatMorningSolids ?? null,
      mealsPerDayCurrent: patient.mealsPerDayCurrent ?? null,
      mealsPerDayWilling: patient.mealsPerDayWilling ?? null,
      alcoholConsumption: patient.alcoholConsumption ?? null,
      supplements: patient.supplements ?? null,
      diseases: patient.diseases ?? null,
      medications: patient.medications ?? null,
      biotype: patient.biotype ?? null,
      createdAt: patient.createdAt ?? new Date(),
      updatedAt: patient.updatedAt ?? new Date(),
    };
  }

  // User operations
  async getUser(id: string): Promise<User | undefined> {
    const [user] = await db.select().from(users).where(eq(users.id, id));
    return user;
  }

  async getUserByEmail(email: string): Promise<User | undefined> {
    const [user] = await db.select().from(users).where(eq(users.email, email));
    return user;
  }

  async getAllUsers(): Promise<User[]> {
    return await db
      .select()
      .from(users)
      .orderBy(desc(users.createdAt));
  }

  async updateUserPassword(id: string, hashedPassword: string): Promise<void> {
    await db
      .update(users)
      .set({ 
        hashedPassword, 
        updatedAt: new Date() 
      })
      .where(eq(users.id, id));
  }

  async updateUserProfile(id: string, profileData: { firstName: string; lastName: string; email: string; role?: string }): Promise<User> {
    const updateData: any = {
      firstName: profileData.firstName,
      lastName: profileData.lastName,
      email: profileData.email,
      updatedAt: new Date()
    };

    if (profileData.role) {
      updateData.role = profileData.role;
    }

    const [updatedUser] = await db
      .update(users)
      .set(updateData)
      .where(eq(users.id, id))
      .returning();
    return updatedUser;
  }

  async deleteUser(id: string): Promise<void> {
    try {
      if (await this.userHasPatients(id)) {
        throw new Error("Não é possível excluir este usuário pois ele possui pacientes associados. Primeiro transfira ou exclua os pacientes.");
      }
      if (await this.userHasPrescriptions(id)) {
        throw new Error("Não é possível excluir este usuário pois ele possui prescrições associadas.");
      }
      if (await this.userHasInvitations(id)) {
        await this.deleteUserInvitations(id);
      }
      await db.delete(users).where(eq(users.id, id));
    } catch (error) {
      console.error("Error deleting user:", error);
      throw error;
    }
  }

  async userHasPatients(userId: string): Promise<boolean> {
    const result = await db
      .select({ count: sql<number>`count(*)` })
      .from(patients)
      .where(eq(patients.ownerId, userId));
    return result[0].count > 0;
  }

  async userHasPrescriptions(userId: string): Promise<boolean> {
    const result = await db
      .select({ count: sql<number>`count(*)` })
      .from(prescriptions)
      .where(eq(prescriptions.nutritionistId, userId));
    return result[0].count > 0;
  }

  async userHasInvitations(userId: string): Promise<boolean> {
    const result = await db
      .select({ count: sql<number>`count(*)` })
      .from(invitations)
      .where(eq(invitations.nutritionistId, userId));
    return result[0].count > 0;
  }

  async deleteUserInvitations(userId: string): Promise<void> {
    await db
      .delete(invitations)
      .where(eq(invitations.nutritionistId, userId));
  }

  async transferPatients(fromUserId: string, toUserId: string): Promise<void> {
    await db
      .update(patients)
      .set({ 
        ownerId: toUserId,
        updatedAt: new Date()
      })
      .where(eq(patients.ownerId, fromUserId));
  }

  async upsertUser(userData: Partial<UpsertUser>): Promise<User> {
    if (!userData.email) {
      throw new Error("Email is required to upsert a user.");
    }
    const userWithId = {
      id: nanoid(),
      email: userData.email,
      firstName: userData.firstName ?? null,
      lastName: userData.lastName ?? null,
      profileImageUrl: userData.profileImageUrl ?? null,
      role: userData.role ?? "patient" as const,
      hashedPassword: userData.hashedPassword ?? null,
    };
    const [user] = await db
      .insert(users)
      .values(userWithId)
      .onConflictDoUpdate({
        target: users.email,
        set: {
          firstName: userData.firstName ?? null,
          lastName: userData.lastName ?? null,
          profileImageUrl: userData.profileImageUrl ?? null,
          role: userData.role ?? "patient" as const,
          hashedPassword: userData.hashedPassword ?? null,
          updatedAt: new Date(),
        },
      })
      .returning();
    return user;
  }

  // Patient operations
  async getPatientsByOwner(ownerId: string): Promise<Patient[]> {
    const patientList = await db
      .select()
      .from(patients)
      .where(eq(patients.ownerId, ownerId))
      .orderBy(desc(patients.createdAt));
    return patientList.map(p => this.normalizePatientData(p));
  }

  async getPatient(id: string): Promise<Patient | undefined> {
    const [patient] = await db.select().from(patients).where(eq(patients.id, id));
    return patient ? this.normalizePatientData(patient) : undefined;
  }

  async getPatientByUserId(userId: string): Promise<Patient | undefined> {
    const [patient] = await db.select().from(patients).where(eq(patients.userId, userId));
    return patient ? this.normalizePatientData(patient) : undefined;
  }

  async createPatient(patient: InsertPatient): Promise<Patient> {
    const patientWithId = {
      id: nanoid(),
      ...patient,
    };
    try {
      const [newPatient] = await db.insert(patients).values(patientWithId).returning();
      return this.normalizePatientData(newPatient);
    } catch (error: any) {
      if (error.code === '42703') { // PostgreSQL error for undefined column
        console.warn("Schema mismatch detected. Creating patient with legacy fields.");
        const legacyPatientData = (({ goal, activityLevel, likedHealthyFoods, dislikedFoods, hasIntolerance, intolerances, canEatMorningSolids, mealsPerDayCurrent, mealsPerDayWilling, alcoholConsumption, supplements, diseases, medications, biotype, ...rest }) => rest)(patientWithId);
        const [newPatient] = await db.insert(patients).values(legacyPatientData).returning();
        return this.normalizePatientData(newPatient);
      }
      throw error;
    }
  }

  async createPatientFromInvitation(data: any): Promise<User> {
    const invitation = await this.getInvitationByToken(data.token);
    if (!invitation || invitation.status !== 'pending') {
      throw new Error("Convite inválido ou já utilizado.");
    }
    const existingUser = await this.getUserByEmail(data.email);
    if (existingUser) {
      throw new Error("409: Conflict - Email já cadastrado.");
    }
    const hashedPassword = await bcrypt.hash(data.password, SALT_ROUNDS);
    const newUser = await this.upsertUser({
      email: data.email,
      firstName: data.name.split(' ')[0],
      lastName: data.name.split(' ').slice(1).join(' '),
      hashedPassword: hashedPassword,
      role: "patient",
    });
    await this.createPatient({
      ...data,
      ownerId: invitation.nutritionistId,
      userId: newUser.id,
    });
    await this.updateInvitationStatus(data.token, 'accepted');
    return newUser;
  }

  async updatePatient(id: string, patient: Partial<InsertPatient>): Promise<Patient> {
    const updateData = { ...patient, updatedAt: new Date() };
    try {
      const [updatedPatient] = await db.update(patients).set(updateData).where(eq(patients.id, id)).returning();
      return this.normalizePatientData(updatedPatient);
    } catch (error: any) {
      if (error.code === '42703') {
        console.warn("Schema mismatch detected. Updating patient with legacy fields.");
        const legacyPatientData = (({ goal, activityLevel, likedHealthyFoods, dislikedFoods, hasIntolerance, intolerances, canEatMorningSolids, mealsPerDayCurrent, mealsPerDayWilling, alcoholConsumption, supplements, diseases, medications, biotype, ...rest }) => rest)(updateData);
        const [updatedPatient] = await db.update(patients).set(legacyPatientData).where(eq(patients.id, id)).returning();
        return this.normalizePatientData(updatedPatient);
      }
      throw error;
    }
  }
  
  // Invitation operations
  async createInvitation(nutritionistId: string): Promise<{ token: string }> {
    try {
      const token = randomBytes(32).toString("hex");
      const expiresAt = new Date();
      expiresAt.setDate(expiresAt.getDate() + 7);
      const invitationWithId = {
        id: nanoid(),
        nutritionistId,
        token,
        email: "placeholder@email.com",
        role: "patient" as const,
        expiresAt,
      };
      const [newInvitation] = await db.insert(invitations).values(invitationWithId).returning({ token: invitations.token });
      if (!newInvitation) {
        throw new Error("Falha ao criar o convite.");
      }
      return newInvitation;
    } catch (error) {
      console.error("Erro em createInvitation:", error);
      throw new Error("Não foi possível criar o convite.");
    }
  }

  async getInvitationByToken(token: string): Promise<{ nutritionistId: string, status: string } | undefined> {
    const [invitation] = await db
      .select({ nutritionistId: invitations.nutritionistId, status: invitations.status })
      .from(invitations)
      .where(and(eq(invitations.token, token), eq(invitations.status, "pending")));
    return invitation as { nutritionistId: string, status: string } | undefined;
  }

  async updateInvitationStatus(token: string, status: 'accepted'): Promise<void> {
    await db
      .update(invitations)
      .set({ status, used: true })
      .where(eq(invitations.token, token));
  }

  // Prescription operations
  async getPrescriptionsByPatient(patientId: string): Promise<Prescription[]> {
    return await db
      .select()
      .from(prescriptions)
      .where(eq(prescriptions.patientId, patientId))
      .orderBy(desc(prescriptions.createdAt));
  }

  async getPrescription(id: string): Promise<Prescription | undefined> {
    const [prescription] = await db
      .select()
      .from(prescriptions)
      .where(eq(prescriptions.id, id));
    return prescription;
  }

  async getLatestPublishedPrescription(patientId: string): Promise<Prescription | undefined> {
    const [prescription] = await db
      .select()
      .from(prescriptions)
      .where(and(eq(prescriptions.patientId, patientId), eq(prescriptions.status, "published")))
      .orderBy(desc(prescriptions.publishedAt))
      .limit(1);
    return prescription;
  }

  async getLatestPublishedPrescriptionForUser(userId: string): Promise<Prescription | undefined> {
    const [patient] = await db.select({ id: patients.id }).from(patients).where(eq(patients.userId, userId));
    if (!patient) return undefined;
    return this.getLatestPublishedPrescription(patient.id);
  }

  async getPublishedPrescriptionsForUser(userId: string): Promise<Prescription[]> {
    const patient = await this.getPatientByUserId(userId);
    if (!patient) {
      return [];
    }
    return await db
      .select()
      .from(prescriptions)
      .where(and(eq(prescriptions.patientId, patient.id), eq(prescriptions.status, "published")))
      .orderBy(desc(prescriptions.publishedAt));
  }

  async createPrescription(prescription: InsertPrescription): Promise<Prescription> {
    const prescriptionWithId = {
      id: nanoid(),
      ...prescription,
      meals: prescription.meals as any,
    };
    const [newPrescription] = await db.insert(prescriptions).values(prescriptionWithId).returning();
    return newPrescription;
  }

  async updatePrescription(id: string, prescription: UpdatePrescription): Promise<Prescription> {
    const [updatedPrescription] = await db
      .update(prescriptions)
      .set({ ...prescription, updatedAt: new Date(), meals: prescription.meals as any })
      .where(eq(prescriptions.id, id))
      .returning();
    return updatedPrescription;
  }

  async publishPrescription(id: string): Promise<Prescription> {
    const [publishedPrescription] = await db
      .update(prescriptions)
      .set({ status: "published", publishedAt: new Date(), updatedAt: new Date() })
      .where(eq(prescriptions.id, id))
      .returning();
    return publishedPrescription;
  }

  async duplicatePrescription(id: string, title: string): Promise<Prescription> {
    const original = await this.getPrescription(id);
    if (!original) throw new Error("Prescription not found");
    const duplicatedWithId = {
      id: nanoid(),
      patientId: original.patientId,
      nutritionistId: original.nutritionistId,
      title,
      status: "draft" as const,
      meals: original.meals as any,
      generalNotes: original.generalNotes,
    };
    const [duplicated] = await db.insert(prescriptions).values(duplicatedWithId).returning();
    return duplicated;
  }

  async deletePrescription(id: string): Promise<void> {
    await db.delete(prescriptions).where(eq(prescriptions.id, id));
  }

  // Mood operations
  async getMoodEntry(prescriptionId: string, mealId: string, date: string): Promise<MoodEntry | undefined> {
    const [moodEntry] = await db.select().from(moodEntries).where(and(eq(moodEntries.prescriptionId, prescriptionId), eq(moodEntries.mealId, mealId), eq(moodEntries.date, date)));
    return moodEntry as MoodEntry | undefined;
  }

  async createMoodEntry(moodEntry: InsertMoodEntry): Promise<MoodEntry> {
    const moodEntryWithId = { id: nanoid(), ...moodEntry };
    const [newMoodEntry] = await db.insert(moodEntries).values(moodEntryWithId).returning();
    return newMoodEntry as MoodEntry;
  }

  async updateMoodEntry(id: string, moodEntry: Partial<InsertMoodEntry>): Promise<MoodEntry> {
    const [updatedMoodEntry] = await db.update(moodEntries).set({ ...moodEntry, updatedAt: new Date() }).where(eq(moodEntries.id, id)).returning();
    return updatedMoodEntry as MoodEntry;
  }

  async getMoodEntriesByPatient(patientId: string, startDate?: string, endDate?: string): Promise<MoodEntry[]> {
    let whereConditions: SQL[] = [eq(moodEntries.patientId, patientId)];
    if (startDate) {
      whereConditions.push(gte(moodEntries.date, startDate));
    }
    if (endDate) {
      whereConditions.push(lte(moodEntries.date, endDate));
    }

    const result = await db
      .select()
      .from(moodEntries)
      .where(and(...whereConditions))
      .orderBy(desc(moodEntries.createdAt));
      
    return result as MoodEntry[];
  }

  async getMoodEntriesByPrescription(prescriptionId: string): Promise<MoodEntry[]> {
    const result = await db
      .select()
      .from(moodEntries)
      .where(eq(moodEntries.prescriptionId, prescriptionId))
      .orderBy(desc(moodEntries.date), desc(moodEntries.createdAt));
      
    return result as MoodEntry[];
  }

  async createAnamnesisRecord(record: any): Promise<AnamnesisRecord> {
    const recordWithId = { id: nanoid(), ...record };
    const [newRecord] = await db.insert(anamnesisRecords).values(recordWithId).returning();
    return newRecord;
  }

  async getAnamnesisRecords(patientId: string): Promise<AnamnesisRecord[]> {
    return await db
      .select()
      .from(anamnesisRecords)
      .where(eq(anamnesisRecords.patientId, patientId))
      .orderBy(desc(anamnesisRecords.createdAt));
  }

  async createFoodDiaryEntry(entry: InsertFoodDiaryEntry): Promise<FoodDiaryEntry> {
    const entryWithId = { id: nanoid(), ...entry };
    const [newEntry] = await db.insert(foodDiaryEntries).values(entryWithId).returning();
    return newEntry;
  }

  async getFoodDiaryEntriesByPatient(patientId: string): Promise<FoodDiaryEntryWithPrescription[]> {
    const entries = await db.select({
      id: foodDiaryEntries.id,
      patientId: foodDiaryEntries.patientId,
      prescriptionId: foodDiaryEntries.prescriptionId,
      mealId: foodDiaryEntries.mealId,
      imageUrl: foodDiaryEntries.imageUrl,
      notes: foodDiaryEntries.notes,
      date: foodDiaryEntries.date,
      createdAt: foodDiaryEntries.createdAt,
      prescriptionTitle: prescriptions.title,
      prescriptionMeals: prescriptions.meals,
      moodBefore: moodEntries.moodBefore,
      moodAfter: moodEntries.moodAfter,
      moodNotes: moodEntries.notes,
    })
      .from(foodDiaryEntries)
      .leftJoin(prescriptions, eq(foodDiaryEntries.prescriptionId, prescriptions.id))
      .leftJoin(moodEntries, and(
        eq(foodDiaryEntries.patientId, moodEntries.patientId),
        eq(foodDiaryEntries.prescriptionId, moodEntries.prescriptionId),
        eq(foodDiaryEntries.mealId, moodEntries.mealId),
        eq(foodDiaryEntries.date, moodEntries.date)
      ))
      .where(eq(foodDiaryEntries.patientId, patientId))
      .orderBy(desc(foodDiaryEntries.createdAt));
    
    return entries.map(entry => ({
      id: entry.id,
      patientId: entry.patientId,
      prescriptionId: entry.prescriptionId,
      mealId: entry.mealId,
      imageUrl: entry.imageUrl,
      notes: entry.notes,
      date: entry.date,
      createdAt: entry.createdAt,
      prescriptionTitle: entry.prescriptionTitle,
      prescriptionMeals: entry.prescriptionMeals,
      moodBefore: entry.moodBefore,
      moodAfter: entry.moodAfter,
      moodNotes: entry.moodNotes,
    })) as any[];
  }
}

export const storage = new DatabaseStorage();
===== ./server/vite.ts =====
// Arquivo: server/vite.ts

import { type Express } from "express";
import { createServer as createViteServer, createLogger } from "vite";
import { type Server } from "http";
import viteConfig from "../vite.config.js";
import { nanoid } from "nanoid";
import fs from "fs";
import path from "path";

const viteLogger = createLogger();

export async function setupVite(app: Express, server: Server) {
  const serverOptions = {
    middlewareMode: true,
    hmr: { server },
    allowedHosts: true as const,
  };

  const vite = await createViteServer({
    ...viteConfig,
    configFile: false,
    customLogger: {
      ...viteLogger,
      error: (msg, options) => {
        viteLogger.error(msg, options);
        process.exit(1);
      },
    },
    server: serverOptions,
    appType: "custom",
  });

  app.use(vite.middlewares);
  app.use("*", async (req, res, next) => {
    const url = req.originalUrl;

    try {
      const clientTemplate = path.resolve(
        // @ts-ignore
        import.meta.dirname,
        "..",
        "client",
        "index.html",
      );

      let template = await fs.promises.readFile(clientTemplate, "utf-8");
      template = template.replace(
        `src="/src/main.tsx"`,
        `src="/src/main.tsx?v=${nanoid()}"`,
      );
      const page = await vite.transformIndexHtml(url, template);
      res.status(200).set({ "Content-Type": "text/html" }).end(page);
    } catch (e) {
      vite.ssrFixStacktrace(e as Error);
      next(e);
    }
  });
}
===== ./shared/schema.ts =====
import { pgTable, varchar, text, timestamp, boolean, integer, jsonb, index } from "drizzle-orm/pg-core";
import { relations } from "drizzle-orm";
import { createInsertSchema } from "drizzle-zod";
import { z } from "zod";

// Session storage table (RE-ADICIONADA - ESSENCIAL PARA LOGIN)
export const sessions = pgTable(
  "sessions",
  {
    sid: varchar("sid").primaryKey(),
    sess: jsonb("sess").notNull(),
    expire: timestamp("expire").notNull(),
  },
  (table) => [index("IDX_session_expire").on(table.expire)],
);

// Users table
export const users = pgTable("users", {
  id: varchar("id").primaryKey(),
  email: varchar("email").unique().notNull(),
  firstName: varchar("first_name"),
  lastName: varchar("last_name"),
  profileImageUrl: varchar("profile_image_url"),
  role: varchar("role", { enum: ["admin", "nutritionist", "patient"] }).notNull().default("patient"),
  hashedPassword: varchar("hashed_password"),
  createdAt: timestamp("created_at").defaultNow(),
  updatedAt: timestamp("updated_at").defaultNow(),
});

// Patients table
export const patients = pgTable("patients", {
  id: varchar("id").primaryKey(),
  ownerId: varchar("owner_id").references(() => users.id).notNull(),
  userId: varchar("user_id").references(() => users.id),
  name: varchar("name").notNull(),
  email: varchar("email"),
  birthDate: varchar("birth_date"),
  sex: varchar("sex", { enum: ["M", "F", "Outro"] }),
  heightCm: integer("height_cm"),
  weightKg: varchar("weight_kg"),
  notes: text("notes"),
  // New anamnese fields
  goal: varchar("goal", { enum: ["lose_weight", "maintain_weight", "gain_weight"] }),
  activityLevel: varchar("activity_level", { enum: ["1", "2", "3", "4", "5"] }),
  likedHealthyFoods: jsonb("liked_healthy_foods").$type<string[]>().default([]),
  dislikedFoods: jsonb("disliked_foods").$type<string[]>().default([]),
  hasIntolerance: boolean("has_intolerance"),
  intolerances: jsonb("intolerances").$type<string[]>().default([]),
  canEatMorningSolids: boolean("can_eat_morning_solids"),
  mealsPerDayCurrent: integer("meals_per_day_current"),
  mealsPerDayWilling: integer("meals_per_day_willing"),
  alcoholConsumption: varchar("alcohol_consumption", { enum: ["yes", "no", "moderate"] }),
  supplements: text("supplements"),
  diseases: text("diseases"),
  medications: text("medications"),
  biotype: varchar("biotype", { enum: ["gain_weight_easily", "hard_to_gain", "gain_muscle_easily"] }),
  createdAt: timestamp("created_at").defaultNow(),
  updatedAt: timestamp("updated_at").defaultNow(),
});

// Invitations table
export const invitations = pgTable("invitations", {
  id: varchar("id").primaryKey(),
  email: varchar("email").notNull(),
  nutritionistId: varchar("nutritionist_id").references(() => users.id).notNull(),
  role: varchar("role", { enum: ["patient"] }).notNull().default("patient"),
  token: varchar("token").unique().notNull(),
  status: varchar("status", { enum: ["pending", "accepted", "expired"] }).notNull().default("pending"),
  expiresAt: timestamp("expires_at").notNull(),
  used: boolean("used").default(false),
  createdAt: timestamp("created_at").defaultNow(),
});

// Prescriptions table
export const prescriptions = pgTable("prescriptions", {
  id: varchar("id").primaryKey(),
  patientId: varchar("patient_id").references(() => patients.id, { onDelete: 'cascade' }).notNull(),
  nutritionistId: varchar("nutritionist_id").references(() => users.id).notNull(),
  title: text("title").notNull(),
  status: varchar("status", { enum: ["draft", "published"] }).notNull().default("draft"),
  meals: jsonb("meals").$type<MealData[]>().notNull().default([]),
  generalNotes: text("general_notes"),
  publishedAt: timestamp("published_at"),
  createdAt: timestamp("created_at").defaultNow(),
  updatedAt: timestamp("updated_at").defaultNow(),
});

// Mood entries table
export const moodEntries = pgTable("mood_entries", {
  id: varchar("id").primaryKey(),
  patientId: varchar("patient_id").references(() => patients.id, { onDelete: 'cascade' }).notNull(),
  prescriptionId: varchar("prescription_id").references(() => prescriptions.id, { onDelete: 'cascade' }).notNull(),
  mealId: varchar("meal_id").notNull(), // ID da refeição dentro da prescrição
  moodBefore: varchar("mood_before", { enum: ["very_sad", "sad", "neutral", "happy", "very_happy"] }),
  moodAfter: varchar("mood_after", { enum: ["very_sad", "sad", "neutral", "happy", "very_happy"] }),
  notes: text("notes"),
  date: varchar("date").notNull(), // Format: YYYY-MM-DD
  createdAt: timestamp("created_at").defaultNow(),
  updatedAt: timestamp("updated_at").defaultNow(),
});

// Anamnesis Records table
export const anamnesisRecords = pgTable("anamnesis_records", {
  id: varchar("id").primaryKey(),
  patientId: varchar("patient_id").references(() => patients.id, { onDelete: 'cascade' }).notNull(),
  
  // Anamnesis fields - a snapshot in time
  weightKg: varchar("weight_kg"),
  notes: text("notes"),
  goal: varchar("goal", { enum: ["lose_weight", "maintain_weight", "gain_weight"] }),
  activityLevel: varchar("activity_level", { enum: ["1", "2", "3", "4", "5"] }),
  likedHealthyFoods: jsonb("liked_healthy_foods").$type<string[]>().default([]),
  dislikedFoods: jsonb("disliked_foods").$type<string[]>().default([]),
  hasIntolerance: boolean("has_intolerance"),
  intolerances: jsonb("intolerances").$type<string[]>().default([]),
  canEatMorningSolids: boolean("can_eat_morning_solids"),
  mealsPerDayCurrent: integer("meals_per_day_current"),
  mealsPerDayWilling: integer("meals_per_day_willing"),
  alcoholConsumption: varchar("alcohol_consumption", { enum: ["yes", "no", "moderate"] }),
  supplements: text("supplements"),
  diseases: text("diseases"),
  medications: text("medications"),
  biotype: varchar("biotype", { enum: ["gain_weight_easily", "hard_to_gain", "gain_muscle_easily"] }),
  
  // Feedback fields for follow-up anamnesis
  protocolAdherence: varchar("protocol_adherence", { enum: ["total", "partial", "low"] }),
  nextProtocolRequests: text("next_protocol_requests"),
  
  createdAt: timestamp("created_at").defaultNow(),
});

// Food Diary Entries table
export const foodDiaryEntries = pgTable("food_diary_entries", {
  id: varchar("id").primaryKey(),
  patientId: varchar("patient_id").references(() => patients.id, { onDelete: 'cascade' }).notNull(),
  prescriptionId: varchar("prescription_id").references(() => prescriptions.id, { onDelete: 'cascade' }).notNull(),
  mealId: varchar("meal_id").notNull(),
  imageUrl: text("image_url").notNull(),
  notes: text("notes"),
  date: varchar("date").notNull(), // Format: YYYY-MM-DD
  createdAt: timestamp("created_at").defaultNow(),
});

// Relations
export const usersRelations = relations(users, ({ one, many }) => ({
  patientProfile: one(patients, {
    fields: [users.id],
    references: [patients.userId],
  }),
  ownedPatients: many(patients, { relationName: 'ownedPatients' }),
  prescriptions: many(prescriptions),
  invitations: many(invitations),
}));

export const patientsRelations = relations(patients, ({ one, many }) => ({
  owner: one(users, {
    fields: [patients.ownerId],
    references: [users.id],
    relationName: 'ownedPatients'
  }),
  user: one(users, {
    fields: [patients.userId],
    references: [users.id],
  }),
  prescriptions: many(prescriptions),
  moodEntries: many(moodEntries),
  anamnesisRecords: many(anamnesisRecords),
  foodDiaryEntries: many(foodDiaryEntries),
}));

export const invitationsRelations = relations(invitations, ({ one }) => ({
  nutritionist: one(users, {
    fields: [invitations.nutritionistId],
    references: [users.id],
  }),
}));

export const prescriptionsRelations = relations(prescriptions, ({ one, many }) => ({
  patient: one(patients, {
    fields: [prescriptions.patientId],
    references: [patients.id],
  }),
  nutritionist: one(users, {
    fields: [prescriptions.nutritionistId],
    references: [users.id],
  }),
  moodEntries: many(moodEntries),
  foodDiaryEntries: many(foodDiaryEntries),
}));

export const moodEntriesRelations = relations(moodEntries, ({ one }) => ({
  patient: one(patients, {
    fields: [moodEntries.patientId],
    references: [patients.id],
  }),
  prescription: one(prescriptions, {
    fields: [moodEntries.prescriptionId],
    references: [prescriptions.id],
  }),
}));

export const anamnesisRecordsRelations = relations(anamnesisRecords, ({ one }) => ({
  patient: one(patients, {
    fields: [anamnesisRecords.patientId],
    references: [patients.id],
  }),
}));

export const foodDiaryEntriesRelations = relations(foodDiaryEntries, ({ one }) => ({
  patient: one(patients, {
    fields: [foodDiaryEntries.patientId],
    references: [patients.id],
  }),
  prescription: one(prescriptions, {
    fields: [foodDiaryEntries.prescriptionId],
    references: [prescriptions.id],
  }),
}));

// Types for prescription meals structure
export interface MealItemData {
  id: string;
  description: string;
  amount: string;
  substitutes?: string[];
}

export interface MealData {
  id: string;
  name: string;
  items: MealItemData[];
  notes?: string;
}

// Mood types - ajustado para aceitar null (que é o que o Drizzle retorna)
export type MoodType = "very_sad" | "sad" | "neutral" | "happy" | "very_happy";

// Type para MoodEntry que aceita null do banco de dados
export type MoodEntry = {
  id: string;
  patientId: string;
  prescriptionId: string;
  mealId: string;
  moodBefore: MoodType | null;
  moodAfter: MoodType | null;
  notes: string | null;
  date: string;
  createdAt: Date | null;
  updatedAt: Date | null;
};

// Zod schemas
export const insertUserSchema = createInsertSchema(users).pick({
  email: true,
  firstName: true,
  lastName: true,
  profileImageUrl: true,
  role: true,
  hashedPassword: true,
});

export const insertPatientSchema = createInsertSchema(patients).omit({
  id: true,
  createdAt: true,
  updatedAt: true,
});

export const insertPrescriptionSchema = createInsertSchema(prescriptions).omit({
  id: true,
  createdAt: true,
  updatedAt: true,
});

export const updatePrescriptionSchema = createInsertSchema(prescriptions).omit({
  id: true,
  patientId: true,
  nutritionistId: true,
  createdAt: true,
  updatedAt: true,
}).partial();

export const insertMoodEntrySchema = createInsertSchema(moodEntries).omit({
  id: true,
  createdAt: true,
  updatedAt: true,
});

export const insertAnamnesisRecordSchema = createInsertSchema(anamnesisRecords).omit({
  id: true,
  createdAt: true,
});

export const insertFoodDiaryEntrySchema = createInsertSchema(foodDiaryEntries).omit({
  id: true,
  createdAt: true,
});

export const updatePatientSchema = insertPatientSchema.partial();

// Types
export type UpsertUser = z.infer<typeof insertUserSchema>;
export type User = typeof users.$inferSelect;
export type InsertPatient = z.infer<typeof insertPatientSchema>;
export type UpdatePatient = z.infer<typeof updatePatientSchema>;
export type Patient = typeof patients.$inferSelect;
export type InsertPrescription = z.infer<typeof insertPrescriptionSchema>;
export type UpdatePrescription = z.infer<typeof updatePrescriptionSchema>;
export type Prescription = typeof prescriptions.$inferSelect;
export type Invitation = typeof invitations.$inferSelect;
export type InsertMoodEntry = z.infer<typeof insertMoodEntrySchema>;
export type AnamnesisRecord = typeof anamnesisRecords.$inferSelect;
export type FoodDiaryEntry = typeof foodDiaryEntries.$inferSelect;
export type InsertFoodDiaryEntry = z.infer<typeof insertFoodDiaryEntrySchema>;

// Extended type for food diary entries with prescription and mood information
export interface FoodDiaryEntryWithPrescription extends FoodDiaryEntry {
  prescriptionTitle?: string | null;
  prescriptionMeals?: MealData[] | null;
  moodBefore?: MoodType | null;
  moodAfter?: MoodType | null;
  moodNotes?: string | null;
}
===== ./tailwind.config.ts =====
import type { Config } from "tailwindcss";

export default {
  darkMode: ["class"],
  content: ["./client/index.html", "./client/src/**/*.{js,jsx,ts,tsx}"],
  theme: {
    extend: {
      screens: {
        'xs': '475px',
        'touch': {'raw': '(hover: none)'},
        'no-touch': {'raw': '(hover: hover)'},
      },
      borderRadius: {
        lg: "var(--radius)",
        md: "calc(var(--radius) - 2px)",
        sm: "calc(var(--radius) - 4px)",
      },
      colors: {
        background: "var(--background)",
        foreground: "var(--foreground)",
        card: {
          DEFAULT: "var(--card)",
          foreground: "var(--card-foreground)",
        },
        popover: {
          DEFAULT: "var(--popover)",
          foreground: "var(--popover-foreground)",
        },
        primary: {
          DEFAULT: "var(--primary)",
          foreground: "var(--primary-foreground)",
        },
        secondary: {
          DEFAULT: "var(--secondary)",
          foreground: "var(--secondary-foreground)",
        },
        muted: {
          DEFAULT: "var(--muted)",
          foreground: "var(--muted-foreground)",
        },
        accent: {
          DEFAULT: "var(--accent)",
          foreground: "var(--accent-foreground)",
        },
        destructive: {
          DEFAULT: "var(--destructive)",
          foreground: "var(--destructive-foreground)",
        },
        border: "var(--border)",
        input: "var(--input)",
        ring: "var(--ring)",
        chart: {
          "1": "var(--chart-1)",
          "2": "var(--chart-2)",
          "3": "var(--chart-3)",
          "4": "var(--chart-4)",
          "5": "var(--chart-5)",
        },
        sidebar: {
          DEFAULT: "var(--sidebar-background)",
          foreground: "var(--sidebar-foreground)",
          primary: "var(--sidebar-primary)",
          "primary-foreground": "var(--sidebar-primary-foreground)",
          accent: "var(--sidebar-accent)",
          "accent-foreground": "var(--sidebar-accent-foreground)",
          border: "var(--sidebar-border)",
          ring: "var(--sidebar-ring)",
        },
      },
      fontFamily: {
        sans: ["Inter", "sans-serif"],
        serif: ["var(--font-serif)"],
        mono: ["var(--font-mono)"],
      },
      spacing: {
        'safe-top': 'env(safe-area-inset-top)',
        'safe-bottom': 'env(safe-area-inset-bottom)',
        'safe-left': 'env(safe-area-inset-left)',
        'safe-right': 'env(safe-area-inset-right)',
      },
      minHeight: {
        'touch': '44px',
      },
      minWidth: {
        'touch': '44px',
      },
      keyframes: {
        "accordion-down": {
          from: {
            height: "0",
          },
          to: {
            height: "var(--radix-accordion-content-height)",
          },
        },
        "accordion-up": {
          from: {
            height: "var(--radix-accordion-content-height)",
          },
          to: {
            height: "0",
          },
        },
        "slide-in-from-left": {
          from: {
            transform: "translateX(-100%)",
          },
          to: {
            transform: "translateX(0)",
          },
        },
        "slide-out-to-left": {
          from: {
            transform: "translateX(0)",
          },
          to: {
            transform: "translateX(-100%)",
          },
        },
        "fade-in": {
          from: {
            opacity: "0",
          },
          to: {
            opacity: "1",
          },
        },
        "bounce-in": {
          "0%": {
            transform: "scale(0.8)",
            opacity: "0",
          },
          "50%": {
            transform: "scale(1.05)",
            opacity: "0.8",
          },
          "100%": {
            transform: "scale(1)",
            opacity: "1",
          },
        },
      },
      animation: {
        "accordion-down": "accordion-down 0.2s ease-out",
        "accordion-up": "accordion-up 0.2s ease-out",
        "slide-in-from-left": "slide-in-from-left 0.3s ease-out",
        "slide-out-to-left": "slide-out-to-left 0.3s ease-out",
        "fade-in": "fade-in 0.2s ease-out",
        "bounce-in": "bounce-in 0.4s ease-out",
      },
    },
  },
  plugins: [require("tailwindcss-animate"), require("@tailwindcss/typography")],
} satisfies Config;

===== ./vite.config.ts =====
import { defineConfig } from "vite";
import react from "@vitejs/plugin-react";
import path from "path";
import runtimeErrorOverlay from "@replit/vite-plugin-runtime-error-modal";
import { exec } from "child_process";
import { promisify } from "util";

const execAsync = promisify(exec);

// Plugin to generate versioned service worker
const generateVersionedSW = () => ({
  name: 'generate-versioned-sw',
  async closeBundle() {
    try {
      console.log('Generating versioned service worker...');
      const { stdout } = await execAsync('node scripts/generate-sw-version.js');
      console.log(stdout);
    } catch (error) {
      console.error('Failed to generate versioned service worker:', error);
    }
  }
});

export default defineConfig({
  plugins: [
    react(),
    runtimeErrorOverlay(),
    generateVersionedSW(),
    ...(process.env.NODE_ENV !== "production" &&
    process.env.REPL_ID !== undefined
      ? [
          await import("@replit/vite-plugin-cartographer").then((m) =>
            m.cartographer(),
          ),
        ]
      : []),
  ],
  resolve: {
    alias: {
      "@": path.resolve(import.meta.dirname, "client", "src"),
      "@shared": path.resolve(import.meta.dirname, "shared"),
      "@assets": path.resolve(import.meta.dirname, "attached_assets"),
    },
  },
  root: path.resolve(import.meta.dirname, "client"),
  build: {
    outDir: path.resolve(import.meta.dirname, "dist/public"),
    emptyOutDir: true,
  },
  server: {
    fs: {
      strict: true,
      deny: ["**/.*"],
    },
  },
});
